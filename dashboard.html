<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SAYKYO CLUB - Dashboard</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Exo+2:wght@300;400;600;700;900&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<style>
:root {
  --primary: #00c8ff;
  --primary-dark: #0088cc;
  --accent: #7b2fff;
  --accent2: #ff6b35;
  --success: #00e5a0;
  --warning: #ffd60a;
  --error: #ff4d6d;
  --glass-bg: rgba(10,20,45,0.7);
  --glass-border: rgba(255,255,255,0.1);
  --text: #e8f4ff;
  --text-muted: rgba(232,244,255,0.5);
  --bg-dark: #060c18;
  --sidebar-w: 260px;
}
* { margin:0; padding:0; box-sizing:border-box; }
html,body { height:100%; overflow:hidden; }
body { font-family:'Exo 2',sans-serif; background:var(--bg-dark); color:var(--text); display:flex; }

/* BG */
.bg-scene { position:fixed;inset:0;z-index:0;
  background: radial-gradient(ellipse at 15% 40%, rgba(0,100,200,0.2) 0%,transparent 50%),
              radial-gradient(ellipse at 85% 70%, rgba(123,47,255,0.15) 0%,transparent 50%), #060c18;
}
.grid-overlay { position:fixed;inset:0;z-index:0;opacity:0.03;
  background-image:linear-gradient(rgba(0,200,255,1) 1px,transparent 1px),
                   linear-gradient(90deg,rgba(0,200,255,1) 1px,transparent 1px);
  background-size:40px 40px;
}

/* SIDEBAR */
.sidebar {
  position:fixed; left:0;top:0;bottom:0; width:var(--sidebar-w);
  background: rgba(6,12,28,0.9);
  backdrop-filter:blur(30px);
  border-right: 1px solid var(--glass-border);
  z-index:100; display:flex; flex-direction:column;
  transition: transform 0.3s ease;
}
.sidebar-header {
  padding: 24px 20px 20px;
  border-bottom: 1px solid var(--glass-border);
}
.logo-text { font-family:'Space Mono',monospace; font-size:1.4rem; font-weight:700; letter-spacing:4px;
  background:linear-gradient(135deg,#fff,var(--primary),var(--accent));
  -webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;
}
.logo-sub { font-size:0.6rem;letter-spacing:6px;color:var(--primary);opacity:0.7; }

.admin-info {
  display:flex;align-items:center;gap:10px;
  padding:16px 20px; border-bottom:1px solid var(--glass-border);
}
.admin-avatar { width:38px;height:38px;border-radius:50%;border:2px solid var(--primary);object-fit:cover; }
.admin-name { font-size:0.85rem;font-weight:600; }
.admin-role { font-size:0.7rem;color:var(--primary);letter-spacing:1px; }

.nav-menu { flex:1;overflow-y:auto;padding:12px 0; }
.nav-item {
  display:flex;align-items:center;gap:12px;
  padding:12px 20px; cursor:pointer;
  font-size:0.9rem; font-weight:500;
  transition:all 0.2s ease; position:relative;
  color:var(--text-muted); border-left:3px solid transparent;
}
.nav-item:hover { background:rgba(0,200,255,0.06); color:var(--text); border-left-color:rgba(0,200,255,0.3); }
.nav-item.active { background:rgba(0,200,255,0.1); color:var(--primary); border-left-color:var(--primary); }
.nav-item .nav-icon { font-size:1.1rem;width:22px;text-align:center; }
.nav-divider { height:1px;background:var(--glass-border);margin:8px 20px; }
.nav-section { padding:6px 20px;font-size:0.65rem;letter-spacing:2px;color:var(--text-muted);text-transform:uppercase;margin-top:6px; }

.sidebar-footer { padding:16px 20px;border-top:1px solid var(--glass-border); }
.btn-logout {
  width:100%;padding:10px;background:rgba(255,77,109,0.1);border:1px solid rgba(255,77,109,0.3);
  border-radius:10px;color:#ff4d6d;font-family:'Exo 2',sans-serif;font-size:0.85rem;
  cursor:pointer;transition:all 0.2s ease;display:flex;align-items:center;justify-content:center;gap:8px;
}
.btn-logout:hover { background:rgba(255,77,109,0.2); }

/* MAIN */
.main {
  flex:1; margin-left:var(--sidebar-w);
  display:flex;flex-direction:column;
  height:100vh; overflow:hidden;
  position:relative;z-index:1;
}

/* TOPBAR */
.topbar {
  display:flex;align-items:center;justify-content:space-between;
  padding:16px 24px;
  background:rgba(6,12,28,0.8);
  backdrop-filter:blur(20px);
  border-bottom:1px solid var(--glass-border);
  flex-shrink:0;
}
.page-title { font-size:1.3rem;font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis; }
.page-subtitle { font-size:0.8rem;color:var(--text-muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis; }
@media(max-width:600px){ .page-subtitle { display:none; } }
.topbar-actions { display:flex;gap:10px;align-items:center; }
.menu-toggle { display:none;background:none;border:none;color:var(--text);font-size:1.3rem;cursor:pointer;padding:6px;flex-shrink:0; }
.btn-back { display:none;align-items:center;gap:6px;flex-shrink:0;background:rgba(255,255,255,0.06);border:1px solid rgba(255,255,255,0.12);border-radius:10px;padding:7px 14px;color:var(--text-muted);font-family:'Exo 2',sans-serif;font-size:0.85rem;font-weight:600;cursor:pointer;transition:all 0.2s ease;white-space:nowrap; }
.btn-back:hover { background:rgba(0,200,255,0.1);border-color:rgba(0,200,255,0.3);color:var(--primary); }
.btn-back.visible { display:inline-flex; }

/* CONTENT */
.content {
  flex:1; overflow-y:auto; padding:24px;
}

/* CARDS */
.dashboard-grid {
  display:grid; grid-template-columns:repeat(auto-fill,minmax(240px,1fr)); gap:16px; margin-bottom:24px;
}
.stat-card {
  background:var(--glass-bg); backdrop-filter:blur(20px);
  border:1px solid var(--glass-border); border-radius:20px;
  padding:22px; cursor:pointer; transition:all 0.3s ease;
  position:relative; overflow:hidden;
}
.stat-card::before {
  content:''; position:absolute;top:0;left:0;right:0;height:2px;
  background:var(--card-accent,var(--primary));
}
.stat-card:hover { transform:translateY(-3px); box-shadow:0 12px 30px rgba(0,0,0,0.3); border-color:rgba(255,255,255,0.2); }
.stat-icon { font-size:2rem;margin-bottom:12px; }
.stat-value { font-size:2rem;font-weight:900;color:var(--card-accent,var(--primary)); }
.stat-label { font-size:0.8rem;color:var(--text-muted);text-transform:uppercase;letter-spacing:1px;margin-top:4px; }

/* GLASS PANELS */
.glass-panel {
  background:var(--glass-bg); backdrop-filter:blur(20px);
  border:1px solid var(--glass-border); border-radius:20px;
  overflow:hidden;
}
.panel-header {
  display:flex;align-items:center;justify-content:space-between;
  padding:18px 22px; border-bottom:1px solid var(--glass-border);
}
.panel-title { font-size:1rem;font-weight:700; }
.panel-body { padding:20px; }

/* FORMS */
.form-grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(220px,1fr)); gap:14px; }
.form-group { display:flex;flex-direction:column;gap:6px; }
.form-group label { font-size:0.75rem;color:var(--text-muted);letter-spacing:1px;text-transform:uppercase; }
.glass-input {
  background:rgba(255,255,255,0.05); border:1px solid rgba(255,255,255,0.1);
  border-radius:12px; padding:12px 14px; color:var(--text);
  font-family:'Exo 2',sans-serif; font-size:0.9rem; outline:none; width:100%;
  transition:all 0.3s ease;
}
.glass-input:focus { border-color:var(--primary); background:rgba(0,200,255,0.08); box-shadow:0 0 0 3px rgba(0,200,255,0.1); }
.glass-input::placeholder { color:rgba(232,244,255,0.25); }
select.glass-input option { background:#0d1a35; }
textarea.glass-input { resize:vertical; min-height:80px; }

/* TOGGLE */
.toggle-wrap { display:flex;align-items:center;gap:10px; }
.toggle { position:relative;display:inline-block;width:44px;height:24px; }
.toggle input { opacity:0;width:0;height:0; }
.toggle-slider {
  position:absolute;inset:0; background:rgba(255,255,255,0.1);
  border-radius:24px; cursor:pointer; transition:0.3s;
  border:1px solid rgba(255,255,255,0.15);
}
.toggle-slider:before {
  content:''; position:absolute;height:18px;width:18px;
  left:2px;bottom:2px; background:#fff; border-radius:50%; transition:0.3s;
}
.toggle input:checked + .toggle-slider { background:var(--primary); }
.toggle input:checked + .toggle-slider:before { transform:translateX(20px); }
.toggle-label { font-size:0.85rem;color:var(--text-muted); }

/* BUTTONS */
.btn { padding:10px 18px; border-radius:12px; font-family:'Exo 2',sans-serif; font-size:0.85rem; font-weight:600; cursor:pointer; border:none; transition:all 0.2s ease; letter-spacing:0.5px; display:inline-flex;align-items:center;gap:8px; }
.btn-primary { background:linear-gradient(135deg,var(--primary-dark),var(--primary)); color:#fff; box-shadow:0 4px 15px rgba(0,200,255,0.3); }
.btn-primary:hover { transform:translateY(-1px); box-shadow:0 6px 20px rgba(0,200,255,0.5); }
.btn-secondary { background:rgba(255,255,255,0.08); border:1px solid var(--glass-border); color:var(--text); }
.btn-secondary:hover { background:rgba(255,255,255,0.12); }
.btn-danger { background:rgba(255,77,109,0.15); border:1px solid rgba(255,77,109,0.3); color:var(--error); }
.btn-danger:hover { background:rgba(255,77,109,0.25); }
.btn-success { background:linear-gradient(135deg,#00a86b,var(--success)); color:#000; }
.btn-accent { background:linear-gradient(135deg,var(--accent),#a855f7); color:#fff; }
.btn-sm { padding:7px 12px; font-size:0.8rem; border-radius:9px; }
.btn-icon { padding:8px; border-radius:9px; }
.btn-full { width:100%; justify-content:center; }

/* TABLE */
.data-table { width:100%; border-collapse:collapse; }
.data-table th { padding:10px 14px; text-align:left; font-size:0.75rem; letter-spacing:1px; text-transform:uppercase; color:var(--text-muted); border-bottom:1px solid var(--glass-border); }
.data-table td { padding:12px 14px; font-size:0.88rem; border-bottom:1px solid rgba(255,255,255,0.04); vertical-align:middle; }
.data-table tr:hover td { background:rgba(0,200,255,0.04); }
.badge { padding:3px 10px; border-radius:20px; font-size:0.72rem; font-weight:600; letter-spacing:0.5px; }
.badge-active { background:rgba(0,229,160,0.15); color:var(--success); border:1px solid rgba(0,229,160,0.3); }
.badge-inactive { background:rgba(255,77,109,0.15); color:var(--error); border:1px solid rgba(255,77,109,0.3); }
.badge-rpe { background:rgba(0,200,255,0.15); color:var(--primary); border:1px solid rgba(0,200,255,0.3); }
.badge-rir { background:rgba(123,47,255,0.15); color:#a78bfa; border:1px solid rgba(123,47,255,0.3); }

/* AVATAR SELECTOR */
.avatar-grid {
  display:grid; grid-template-columns:repeat(3,1fr); gap:60px;
  max-height:360px; overflow-y:auto; padding:8px 4px;
}
@media (min-width:600px) {
  .avatar-grid { grid-template-columns:repeat(auto-fill,minmax(72px,1fr)); gap:12px; }
}
.avatar-option {
  cursor:pointer; border-radius:50%; border:3px solid transparent;
  transition:all 0.2s ease; overflow:hidden;
  aspect-ratio:1; display:flex;align-items:center;justify-content:center;
}
.avatar-option img { width:100%;height:100%;object-fit:cover;border-radius:50%; }
.avatar-option:hover { border-color:rgba(0,200,255,0.5); transform:scale(1.08); }
.avatar-option.selected { border-color:var(--primary); box-shadow:0 0 15px rgba(0,200,255,0.4); transform:scale(1.05); }
.selected-avatar-preview {
  width:60px;height:60px;border-radius:50%;border:3px solid var(--primary);
  overflow:hidden;cursor:pointer;transition:all 0.2s ease;
  box-shadow:0 0 20px rgba(0,200,255,0.3);
}
.selected-avatar-preview img { width:100%;height:100%;object-fit:cover; }
.selected-avatar-preview:hover { transform:scale(1.05); }

/* TABS */
.tabs { display:flex; gap:4px; background:rgba(0,0,0,0.3); border-radius:14px; padding:4px; }
.tab { padding:8px 16px; border-radius:10px; cursor:pointer; font-size:0.85rem; font-weight:600; color:var(--text-muted); transition:all 0.2s ease; }
.tab.active { background:rgba(0,200,255,0.15); color:var(--primary); box-shadow:0 0 10px rgba(0,200,255,0.1); }

/* MONTH/WEEK/DAY builder */
.routine-builder { display:flex;gap:16px;height:100%; }
.rb-col { flex:1;display:flex;flex-direction:column;gap:10px; }
.rb-col-title { font-size:0.75rem;text-transform:uppercase;letter-spacing:1px;color:var(--text-muted);padding-bottom:8px;border-bottom:1px solid var(--glass-border); }
.rb-item {
  padding:10px 14px; background:rgba(255,255,255,0.04);
  border:1px solid var(--glass-border); border-radius:12px;
  cursor:pointer; font-size:0.88rem; transition:all 0.2s ease;
  display:flex;justify-content:space-between;align-items:center;
}
.rb-item:hover { background:rgba(0,200,255,0.06); border-color:rgba(0,200,255,0.2); }
.rb-item.active { background:rgba(0,200,255,0.1); border-color:var(--primary); color:var(--primary); }
.rb-item .rb-count { font-size:0.7rem;color:var(--text-muted);background:rgba(255,255,255,0.08);padding:2px 8px;border-radius:10px; }

/* EXERCISE SLOT */
.exercise-slot {
  background:rgba(255,255,255,0.04); border:1px solid var(--glass-border);
  border-radius:14px; padding:14px; margin-bottom:10px;
  position:relative;
}
.exercise-slot-header { display:flex;justify-content:space-between;align-items:center;margin-bottom:12px; }
.exercise-slot-title { font-weight:600;font-size:0.9rem; }
.slot-mini-grid { display:grid;grid-template-columns:repeat(auto-fill,minmax(120px,1fr));gap:8px; }

/* STATS/CHARTS */
.chart-container { position:relative; height:280px; }
.stats-filters { display:flex;gap:10px;flex-wrap:wrap;margin-bottom:16px; }
.stats-grid { display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:16px; }
.stats-card { background:var(--glass-bg);backdrop-filter:blur(20px);border:1px solid var(--glass-border);border-radius:16px;padding:18px; }

/* ANAMNESIS */
.anamnesis-card { background:rgba(0,200,255,0.05);border:1px solid rgba(0,200,255,0.15);border-radius:12px;padding:14px;margin-bottom:10px; }
.anamnesis-q { font-size:0.8rem;color:var(--text-muted);margin-bottom:4px; }
.anamnesis-a { font-size:0.92rem;font-weight:600; }

/* SEARCH + PAGINATION */
.table-toolbar { display:flex;align-items:center;gap:10px;padding:14px 16px;border-bottom:1px solid var(--glass-border);flex-wrap:wrap; }
.search-box { position:relative;flex:1;min-width:180px; }
.search-box input { width:100%;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:10px;padding:8px 12px 8px 34px;color:var(--text);font-family:'Exo 2',sans-serif;font-size:0.85rem;outline:none;transition:all 0.2s ease; }
.search-box input:focus { border-color:var(--primary);background:rgba(0,200,255,0.07);box-shadow:0 0 0 2px rgba(0,200,255,0.1); }
.search-box input::placeholder { color:rgba(232,244,255,0.3); }
.search-box .search-icon { position:absolute;left:10px;top:50%;transform:translateY(-50%);font-size:0.9rem;pointer-events:none; }
.pagination { display:flex;align-items:center;gap:6px;padding:12px 16px;border-top:1px solid var(--glass-border);justify-content:flex-end;flex-wrap:wrap; }
.page-info { font-size:0.78rem;color:var(--text-muted);margin-right:auto; }
.page-btn { width:32px;height:32px;border-radius:8px;border:1px solid rgba(255,255,255,0.1);background:rgba(255,255,255,0.05);color:var(--text);font-family:'Exo 2',sans-serif;font-size:0.82rem;font-weight:600;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all 0.2s ease; }
.page-btn:hover:not(:disabled) { background:rgba(0,200,255,0.1);border-color:rgba(0,200,255,0.3);color:var(--primary); }
.page-btn.active { background:rgba(0,200,255,0.15);border-color:var(--primary);color:var(--primary); }
.page-btn:disabled { opacity:0.3;cursor:not-allowed; }
.per-page-select { background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:8px;padding:5px 8px;color:var(--text);font-family:'Exo 2',sans-serif;font-size:0.8rem;outline:none;cursor:pointer; }
.per-page-select option { background:#0d1a35; }

/* SCROLLBAR */
.rev-info-card { background:rgba(255,255,255,0.04);border:1px solid rgba(255,255,255,0.07);border-radius:10px;padding:10px; }
.ric-label { font-size:0.68rem;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:4px; }
.ric-val { font-size:0.88rem;font-weight:700; }
::-webkit-scrollbar { width:5px; }
::-webkit-scrollbar-track { background:transparent; }
::-webkit-scrollbar-thumb { background:rgba(0,200,255,0.2);border-radius:3px; }
::-webkit-scrollbar-thumb:hover { background:rgba(0,200,255,0.4); }

/* OVERLAY */
.overlay-backdrop {
  position:fixed;inset:0;background:rgba(0,0,0,0.7);backdrop-filter:blur(10px);
  z-index:500;display:flex;align-items:center;justify-content:center;
  animation:fadeIn 0.2s ease;
}
@keyframes fadeIn { from{opacity:0} to{opacity:1} }
.overlay-panel {
  background:rgba(8,16,36,0.95);border:1px solid var(--glass-border);
  border-radius:24px;padding:28px;width:95%;max-width:800px;
  max-height:90vh;overflow-y:auto;
  animation:slideUp 0.3s cubic-bezier(0.16,1,0.3,1);
}
@keyframes slideUp { from{opacity:0;transform:translateY(30px)} to{opacity:1;transform:translateY(0)} }
.overlay-header { display:flex;justify-content:space-between;align-items:center;margin-bottom:22px; }
.overlay-title { font-size:1.2rem;font-weight:700; }
.btn-close { background:rgba(255,255,255,0.08);border:none;color:var(--text);width:32px;height:32px;border-radius:8px;cursor:pointer;font-size:1.1rem;display:flex;align-items:center;justify-content:center; }
.btn-close:hover { background:rgba(255,77,109,0.2);color:var(--error); }

/* MOBILE */
@media (max-width: 768px) {
  .sidebar { transform:translateX(-100%); }
  .sidebar.open { transform:translateX(0); }
  .main { margin-left:0; }
  .menu-toggle { display:block; }
  .dashboard-grid { grid-template-columns:repeat(2,1fr); }
  .form-grid { grid-template-columns:1fr; }
  .stats-grid { grid-template-columns:1fr; }
  .routine-builder { flex-direction:column; }
  .rutinas-layout { grid-template-columns:1fr !important; height:auto !important; }
  .rutinas-layout > .glass-panel:first-child { max-height:220px; }
}
.rutinas-layout {
  display:grid; grid-template-columns:280px 1fr; gap:16px; height:calc(100vh - 160px);
}

/* LOADING */
.page-loading { display:flex;flex-direction:column;align-items:center;justify-content:center;height:200px;gap:12px;color:var(--text-muted); }
.spinner-lg { width:40px;height:40px;border:3px solid rgba(0,200,255,0.2);border-top-color:var(--primary);border-radius:50%;animation:spin 0.8s linear infinite; }
@keyframes spin { to{transform:rotate(360deg)} }

.empty-state { text-align:center;padding:40px;color:var(--text-muted); }
.empty-icon { font-size:3rem;margin-bottom:12px; }
.empty-text { font-size:0.9rem; }

/* NOTIFICATION BELL */
.notif-btn {
  position:relative; background:rgba(255,255,255,0.06); border:1px solid rgba(255,255,255,0.12);
  border-radius:12px; width:40px; height:40px; display:flex; align-items:center; justify-content:center;
  cursor:pointer; transition:all 0.2s ease; font-size:1.1rem; flex-shrink:0;
}
.notif-btn:hover { background:rgba(0,200,255,0.12); border-color:rgba(0,200,255,0.3); }
.notif-badge {
  position:absolute; top:-6px; right:-6px;
  min-width:18px; height:18px; padding:0 4px;
  background:var(--error); color:#fff; font-size:0.65rem; font-weight:800;
  border-radius:9px; display:none; align-items:center; justify-content:center;
  box-shadow:0 0 10px rgba(255,77,109,0.8);
  animation: pulse-badge 1.5s ease-in-out infinite;
}
.notif-badge.visible { display:flex; }
@keyframes pulse-badge {
  0%,100% { box-shadow:0 0 10px rgba(255,77,109,0.8); transform:scale(1); }
  50% { box-shadow:0 0 20px rgba(255,77,109,1); transform:scale(1.1); }
}

/* PUSH TOAST */
.push-toast {
  position:fixed; top:20px; right:20px; z-index:9999;
  background:rgba(8,18,40,0.95); border:1px solid rgba(0,200,255,0.3);
  border-radius:16px; padding:14px 18px; max-width:320px;
  box-shadow:0 8px 32px rgba(0,0,0,0.6), 0 0 0 1px rgba(0,200,255,0.1);
  animation:toastSlide 0.4s cubic-bezier(0.16,1,0.3,1);
  cursor:pointer; display:flex; align-items:flex-start; gap:12px;
}
@keyframes toastSlide { from{opacity:0;transform:translateX(100%)} to{opacity:1;transform:translateX(0)} }
.toast-icon { font-size:1.4rem; flex-shrink:0; }
.toast-title { font-size:0.82rem; font-weight:700; color:var(--primary); margin-bottom:2px; }
.toast-body { font-size:0.78rem; color:var(--text-muted); line-height:1.4; }
.toast-close { position:absolute;top:8px;right:10px;font-size:0.8rem;color:var(--text-muted);cursor:pointer;background:none;border:none;color:var(--text-muted); }

/* TRAINING-START TOAST */
.training-toast {
  position:fixed; top:20px; right:20px; z-index:9999;
  background:rgba(0,18,8,0.97);
  border:1px solid rgba(0,229,160,0.4);
  border-radius:16px; padding:14px 18px; max-width:320px;
  box-shadow:0 8px 32px rgba(0,0,0,0.6), 0 0 24px rgba(0,229,160,0.15);
  animation:trainingToastIn 0.45s cubic-bezier(0.16,1,0.3,1);
  display:flex; align-items:center; gap:12px; overflow:hidden;
  cursor:pointer;
}
@keyframes trainingToastIn { from{opacity:0;transform:translateX(110%)} to{opacity:1;transform:translateX(0)} }
@keyframes trainingToastOut { from{opacity:1;transform:translateX(0)} to{opacity:0;transform:translateX(110%)} }
.training-toast.dismissing { animation:trainingToastOut 0.3s ease forwards; }
.training-toast-bar {
  position:absolute; bottom:0; left:0; height:3px;
  background:linear-gradient(90deg, var(--success), var(--primary));
  border-radius:0 0 16px 16px;
  animation:trainingBarCountdown 10s linear forwards;
}
@keyframes trainingBarCountdown { from{width:100%} to{width:0%} }
.tt-avatar {
  width:40px; height:40px; border-radius:50%; flex-shrink:0;
  border:2px solid var(--success); object-fit:cover;
  box-shadow:0 0 12px rgba(0,229,160,0.4);
}
.tt-pulse {
  width:40px; height:40px; border-radius:50%; flex-shrink:0;
  background:rgba(0,229,160,0.12); border:2px solid var(--success);
  display:flex; align-items:center; justify-content:center;
  font-size:1.2rem;
  box-shadow:0 0 12px rgba(0,229,160,0.4);
  animation:ttAvatarPulse 1.8s ease-in-out infinite;
}
@keyframes ttAvatarPulse {
  0%,100% { box-shadow:0 0 12px rgba(0,229,160,0.4); }
  50%      { box-shadow:0 0 24px rgba(0,229,160,0.7); }
}
.tt-title { font-size:0.8rem; font-weight:800; color:var(--success); margin-bottom:2px; letter-spacing:0.3px; }
.tt-body  { font-size:0.78rem; color:var(--text-muted); line-height:1.4; }
.tt-close { position:absolute;top:8px;right:10px;background:none;border:none;color:rgba(0,229,160,0.5);font-size:0.85rem;cursor:pointer; transition:color 0.2s; }
.tt-close:hover { color:var(--success); }

/* NOTIF PANEL */
.notif-item {
  padding:14px; border-radius:14px; background:rgba(255,255,255,0.04);
  border:1px solid rgba(255,255,255,0.08); margin-bottom:10px;
  transition:all 0.2s ease; position:relative;
}
.notif-item.unread { background:rgba(0,200,255,0.06); border-color:rgba(0,200,255,0.2); }
.notif-item.unread::before { content:''; position:absolute;top:14px;left:-4px;width:8px;height:8px;border-radius:50%;background:var(--primary);box-shadow:0 0 8px var(--primary); }
.notif-item:hover { background:rgba(0,200,255,0.08); }
.notif-from { font-size:0.75rem;color:var(--text-muted);margin-bottom:4px; }
.notif-msg { font-size:0.9rem;font-weight:600;margin-bottom:6px; }
.notif-time { font-size:0.72rem;color:var(--text-muted); }

/* GROUP CARDS */
.group-card {
  background:var(--glass-bg); backdrop-filter:blur(20px);
  border:1px solid var(--glass-border); border-radius:20px;
  padding:22px; transition:all 0.3s ease; position:relative; overflow:hidden;
}
.group-card::before { content:''; position:absolute;top:0;left:0;right:0;height:2px;background:var(--card-color,var(--primary)); }
.group-card:hover { transform:translateY(-2px); box-shadow:0 12px 30px rgba(0,0,0,0.3); }
.group-header { display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:14px; }
.group-name { font-size:1.1rem;font-weight:800;margin-bottom:4px; }
.group-desc { font-size:0.8rem;color:var(--text-muted); }
.group-stats { display:flex;gap:12px;margin:12px 0; }
.group-stat { text-align:center; }
.group-stat-val { font-size:1.2rem;font-weight:800;color:var(--primary); }
.group-stat-lbl { font-size:0.65rem;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.5px; }
.group-admins { display:flex;flex-wrap:wrap;gap:6px;margin-top:10px; }
.group-admin-chip { display:flex;align-items:center;gap:6px;background:rgba(0,200,255,0.08);border:1px solid rgba(0,200,255,0.2);border-radius:20px;padding:4px 10px;font-size:0.75rem; }
.group-admin-chip.owner { background:rgba(123,47,255,0.1);border-color:rgba(123,47,255,0.3);color:#c4b5fd; }
.member-chip { display:inline-flex;align-items:center;gap:6px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:20px;padding:4px 10px;font-size:0.75rem;margin:3px; }
.member-chip img { width:20px;height:20px;border-radius:50%; }
.color-picker { display:flex;gap:8px;flex-wrap:wrap;margin-top:8px; }
.color-swatch { width:28px;height:28px;border-radius:50%;cursor:pointer;border:3px solid transparent;transition:all 0.2s;flex-shrink:0; }
.color-swatch.selected,.color-swatch:hover { transform:scale(1.2);border-color:rgba(255,255,255,0.6); }

/* ‚îÄ‚îÄ FLOATING HELP BUTTON ‚îÄ‚îÄ */
.help-fab{
  position:fixed;bottom:24px;right:20px;z-index:9999;
  width:48px;height:48px;border-radius:50%;
  background:linear-gradient(135deg,rgba(0,136,204,.9),rgba(0,200,255,.9));
  border:1.5px solid rgba(0,200,255,.5);
  box-shadow:0 4px 20px rgba(0,200,255,.35),0 0 0 0 rgba(0,200,255,.4);
  display:flex;align-items:center;justify-content:center;
  font-family:'Space Mono',monospace;font-size:1.15rem;font-weight:700;color:#fff;
  cursor:grab;text-decoration:none;
  animation:fabPulse 3s ease-in-out infinite;
  transition:transform .2s,box-shadow .2s
}
.help-fab.dragging{cursor:grabbing;animation:none;transform:scale(1.1)}
.help-fab:not(.dragging):hover{transform:scale(1.12);box-shadow:0 6px 28px rgba(0,200,255,.55),0 0 0 8px rgba(0,200,255,.1)}
@keyframes fabPulse{0%,100%{box-shadow:0 4px 20px rgba(0,200,255,.35),0 0 0 0 rgba(0,200,255,.4)}50%{box-shadow:0 4px 20px rgba(0,200,255,.35),0 0 0 8px rgba(0,200,255,.05)}}
.help-fab-tooltip{
  position:fixed;z-index:9998;
  background:rgba(6,14,38,.95);border:1px solid rgba(0,200,255,.25);
  border-radius:10px;padding:7px 12px;
  font-family:'Exo 2',sans-serif;font-size:.72rem;font-weight:700;color:rgba(232,244,255,.8);
  white-space:nowrap;pointer-events:none;
  opacity:0;transition:all .2s
}
.help-fab:not(.dragging):hover + .help-fab-tooltip,.help-fab-tooltip.show{opacity:1}

</style>
</head>
<body>
<div class="bg-scene"></div>
<div class="grid-overlay"></div>

<!-- SIDEBAR -->
<aside class="sidebar" id="sidebar">
  <div class="sidebar-header">
    <img src="logo_saykyo.png" alt="Saykyo Club" style="height:44px;object-fit:contain;filter:drop-shadow(0 0 10px rgba(0,200,255,0.25))">
  </div>
  <div class="admin-info">
    <img class="admin-avatar" id="adminAvatar" src="" alt="admin"
         title="Cambiar avatar"
         style="cursor:pointer;transition:box-shadow 0.2s,transform 0.2s"
         onmouseover="this.style.boxShadow='0 0 0 3px var(--primary)';this.style.transform='scale(1.08)'"
         onmouseout="this.style.boxShadow='';this.style.transform=''"
         onclick="openOwnAvatarPicker()">
    <div>
      <div class="admin-name" id="adminName">Admin</div>
      <div class="admin-role" id="adminRoleLabel">ADMINISTRADOR</div>
    </div>
  </div>
  <nav class="nav-menu">
    <div class="nav-section">General</div>
    <div class="nav-item active" data-page="home">
      <span class="nav-icon">üè†</span> Inicio
    </div>
    <div class="nav-divider"></div>
    <div class="nav-section">Gesti√≥n</div>
    <div class="nav-item" data-page="usuarios">
      <span class="nav-icon">üë•</span> Usuarios
    </div>
    <div class="nav-item" data-page="categorias">
      <span class="nav-icon">üìÇ</span> Categor√≠as
    </div>
    <div class="nav-item" data-page="ejercicios">
      <span class="nav-icon">üí™</span> Ejercicios
    </div>
    <div class="nav-item" data-page="rutinas">
      <span class="nav-icon">üìã</span> Rutinas
    </div>
    <div class="nav-item" data-page="atletas">
      <span class="nav-icon">üèÉ</span> Seguimiento
    </div>
    <div class="nav-item" data-page="grupos">
      <span class="nav-icon">ü´Ç</span> Grupos
    </div>
    <div class="nav-divider"></div>
    <div class="nav-section">Reportes</div>
    <div class="nav-item" data-page="estadisticas">
      <span class="nav-icon">üìä</span> Estad√≠sticas
    </div>
    <div class="nav-item" data-page="anamnesis">
      <span class="nav-icon">üìù</span> Anamnesis
    </div>
    <div class="nav-item" data-page="revisiones">
      <span class="nav-icon">üîç</span> Revisiones
    </div>
    <div class="nav-item" data-page="valoraciones">
      <span class="nav-icon">‚öñÔ∏è</span> Valoraciones
    </div>
    <div class="nav-divider"></div>
    <div class="nav-section">Inteligencia</div>
    <div class="nav-item" data-page="alertas" id="navAlertas">
      <span class="nav-icon">üö®</span> Alertas <span id="alertasBadge" style="margin-left:auto;background:var(--error);color:#fff;border-radius:20px;padding:1px 8px;font-size:0.7rem;font-weight:700;display:none">0</span>
    </div>
  </nav>
  <div class="sidebar-footer">
    <button class="btn-logout" id="logoutBtn">üö™ Cerrar Sesi√≥n</button>
  </div>
</aside>

<!-- MAIN -->
<div class="main">
  <div class="topbar">
    <div style="display:flex;align-items:center;gap:10px;min-width:0">
      <button class="menu-toggle" id="menuToggle">‚ò∞</button>
      <button class="btn-back" id="backBtn" onclick="goBack()">‚Üê Atr√°s</button>
      <div style="flex:1;min-width:0;overflow:hidden">
        <div class="page-title" id="pageTitle">Dashboard</div>
        <div class="page-subtitle" id="pageSubtitle">Bienvenido al panel de administraci√≥n</div>
      </div>
    </div>
    <div class="topbar-actions">
      <button class="notif-btn" id="notifBtn" onclick="toggleNotifPanel()" title="Notificaciones">
        üîî
        <span class="notif-badge" id="notifBadge">0</span>
      </button>
      <button class="btn btn-primary btn-sm" id="topbarAction" style="display:none"></button>
    </div>
  </div>
  <div class="content" id="mainContent">
    <div class="page-loading"><div class="spinner-lg"></div><span>Cargando...</span></div>
  </div>
</div>

<!-- NOTIFICATION PANEL -->
<div id="notifPanel" style="display:none;position:fixed;top:70px;right:16px;z-index:400;width:360px;max-width:calc(100vw - 32px)">
  <div style="background:rgba(8,16,40,0.97);border:1px solid rgba(0,200,255,0.25);border-radius:20px;box-shadow:0 20px 60px rgba(0,0,0,0.7);overflow:hidden">
    <div style="display:flex;align-items:center;justify-content:space-between;padding:16px 18px;border-bottom:1px solid rgba(255,255,255,0.08)">
      <div style="font-weight:700;font-size:1rem">üîî Notificaciones</div>
      <div style="display:flex;gap:8px;align-items:center">
        <button onclick="markAllRead()" style="background:rgba(0,200,255,0.1);border:1px solid rgba(0,200,255,0.3);border-radius:8px;padding:4px 10px;color:var(--primary);font-size:0.72rem;cursor:pointer;font-family:'Exo 2',sans-serif">‚úì Todo le√≠do</button>
        <button onclick="deleteAllNotifs()" style="background:rgba(255,77,109,0.1);border:1px solid rgba(255,77,109,0.3);border-radius:8px;padding:4px 10px;color:#ff4d6d;font-size:0.72rem;cursor:pointer;font-family:'Exo 2',sans-serif">üóëÔ∏è Borrar todo</button>
        <button onclick="document.getElementById('notifPanel').style.display='none'" style="background:rgba(255,255,255,0.06);border:none;color:var(--text-muted);width:28px;height:28px;border-radius:8px;cursor:pointer;font-size:0.9rem">‚úï</button>
      </div>
    </div>
    <div id="notifList" style="max-height:400px;overflow-y:auto;padding:12px"></div>
    <div style="padding:12px 18px;border-top:1px solid rgba(255,255,255,0.06)">
      <button onclick="showSendNotifModal()" class="btn btn-primary btn-sm btn-full">üì£ Enviar notificaci√≥n a usuario</button>
    </div>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import { getDatabase, ref, get, set, push, update, remove, onValue, off, onChildAdded, onChildChanged, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";
import { getAuth, createUserWithEmailAndPassword, updateEmail, updatePassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
import { initializeApp as initializeSecondaryApp, deleteApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";

const firebaseConfig = {
  apiKey: "AIzaSyCDlQGoWTNtAna8unwVNgJZH8WNRsYF0MU",
  authDomain: "entrenamiento-6b069.firebaseapp.com",
  projectId: "entrenamiento-6b069",
  storageBucket: "entrenamiento-6b069.firebasestorage.app",
  messagingSenderId: "818051143570",
  appId: "1:818051143570:web:c17fa58f4f98ce67b9534b",
  databaseURL: "https://entrenamiento-6b069-default-rtdb.firebaseio.com"
};
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const auth = getAuth(app);

// Auth check
const session = sessionStorage.getItem('saykyo_user');
if (!session) { window.location.href='index.html'; }
const currentUser = JSON.parse(session||'{}');
if (!currentUser.id && currentUser.uid) { currentUser.id = currentUser.uid; }
if (currentUser.rol !== 'admin' && currentUser.rol !== 'superadmin') { window.location.href='entrenamiento.html'; }

// Helper: is superadmin?
const isSuperAdmin = () => currentUser.rol === 'superadmin';

// Init UI
document.getElementById('adminName').textContent = currentUser.nombres + ' ' + (currentUser.apellidos||'');
document.getElementById('adminAvatar').src = currentUser.avatar || `https://api.dicebear.com/7.x/adventurer/svg?seed=${currentUser.usuario}`;
// Show role badge
const roleLabel = document.getElementById('adminRoleLabel');
if(roleLabel) {
  if(isSuperAdmin()) {
    roleLabel.textContent = '‚≠ê SUPER ADMIN';
    roleLabel.style.color = '#ffd60a';
  } else {
    roleLabel.textContent = 'ADMINISTRADOR';
    roleLabel.style.color = 'var(--primary)';
  }
}

// Avatar seeds for picker
// Biblioteca de avatares (131 combinaciones √∫nicas)
const AVATAR_LIST = [
  "https://api.dicebear.com/7.x/adventurer/svg?seed=Felix&backgroundColor=059ff2",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=Luna&backgroundColor=7b2fff",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=Zoe&backgroundColor=ff6b35",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=Mia&backgroundColor=00e5a0",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=Max&backgroundColor=ffd60a",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=Sam&backgroundColor=ff4d6d",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=Alex&backgroundColor=00c8ff",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=Jordan&backgroundColor=a855f7",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=Taylor&backgroundColor=f59e0b",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=Morgan&backgroundColor=10b981",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=Casey&backgroundColor=e74c3c",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=Riley&backgroundColor=2ecc71",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=Avery&backgroundColor=3498db",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=Quinn&backgroundColor=9b59b6",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=Sage&backgroundColor=1abc9c",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=River&backgroundColor=e67e22",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=Blake&backgroundColor=34495e",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=Drew&backgroundColor=16a085",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=Reese&backgroundColor=8e44ad",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=Hayden&backgroundColor=c0392b",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=Peyton&backgroundColor=27ae60",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=Logan&backgroundColor=2980b9",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=Rowan&backgroundColor=d35400",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=Emery&backgroundColor=2c3e50",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=Finley&backgroundColor=059ff2",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=Harper&backgroundColor=7b2fff",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=Skylar&backgroundColor=ff6b35",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=Phoenix&backgroundColor=00e5a0",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=Dakota&backgroundColor=ffd60a",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=Kendall&backgroundColor=ff4d6d",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=Adrian&backgroundColor=00c8ff",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=Beatriz&backgroundColor=a855f7",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=Carlos&backgroundColor=f59e0b",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=Diana&backgroundColor=10b981",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=Eduardo&backgroundColor=e74c3c",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=Fernanda&backgroundColor=2ecc71",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=Gabriel&backgroundColor=3498db",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=Helena&backgroundColor=9b59b6",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=Ivan&backgroundColor=1abc9c",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=Julia&backgroundColor=e67e22",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=Kevin&backgroundColor=34495e",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=Laura&backgroundColor=16a085",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=Miguel&backgroundColor=8e44ad",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=Natalia&backgroundColor=c0392b",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=Oscar&backgroundColor=27ae60",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=Patricia&backgroundColor=2980b9",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=Rafael&backgroundColor=d35400",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=Sofia&backgroundColor=2c3e50",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=Thomas&backgroundColor=059ff2",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=Valentina&backgroundColor=7b2fff",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=William&backgroundColor=ff6b35",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=Ximena&backgroundColor=00e5a0",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=Yamil&backgroundColor=ffd60a",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=Zara&backgroundColor=ff4d6d",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=Andres&backgroundColor=00c8ff",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=Brenda&backgroundColor=a855f7",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=Camilo&backgroundColor=f59e0b",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=Daniela&backgroundColor=10b981",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=Esteban&backgroundColor=e74c3c",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=Fatima&backgroundColor=2ecc71",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=Shadow&backgroundColor=3498db",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=Storm&backgroundColor=9b59b6",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=Blaze&backgroundColor=1abc9c",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=Frost&backgroundColor=e67e22",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=Thunder&backgroundColor=34495e",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=Viper&backgroundColor=16a085",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=Raven&backgroundColor=8e44ad",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=Wolf&backgroundColor=c0392b",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=Eagle&backgroundColor=27ae60",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=Fox&backgroundColor=2980b9",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=Cobra&backgroundColor=d35400",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=Titan&backgroundColor=2c3e50",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=Nova&backgroundColor=059ff2",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=Orion&backgroundColor=7b2fff",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=Atlas&backgroundColor=ff6b35",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=Zenith&backgroundColor=00e5a0",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=Apex&backgroundColor=ffd60a",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=Nexus&backgroundColor=ff4d6d",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=Vortex&backgroundColor=00c8ff",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=Cipher&backgroundColor=a855f7",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=User001&backgroundColor=f59e0b",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=User002&backgroundColor=10b981",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=User003&backgroundColor=e74c3c",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=User004&backgroundColor=2ecc71",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=User005&backgroundColor=3498db",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=User006&backgroundColor=9b59b6",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=User007&backgroundColor=1abc9c",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=User008&backgroundColor=e67e22",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=User009&backgroundColor=34495e",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=User010&backgroundColor=16a085",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=Alpha01&backgroundColor=8e44ad",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=Beta02&backgroundColor=c0392b",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=Gamma03&backgroundColor=27ae60",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=Delta04&backgroundColor=2980b9",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=Sigma05&backgroundColor=d35400",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=Omega06&backgroundColor=2c3e50",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=Lambda07&backgroundColor=059ff2",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=Theta08&backgroundColor=7b2fff",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=Kappa09&backgroundColor=ff6b35",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=Psi10&backgroundColor=00e5a0",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=OldMike&backgroundColor=ffd60a",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=GrayWolf&backgroundColor=ff4d6d",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=DarkBear&backgroundColor=00c8ff",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=IronMan&backgroundColor=a855f7",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=SteelFox&backgroundColor=f59e0b",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=BlackHawk&backgroundColor=10b981",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=GoldRush&backgroundColor=e74c3c",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=SilverBack&backgroundColor=2ecc71",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=BronzeAge&backgroundColor=3498db",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=CopperKing&backgroundColor=9b59b6",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=NightOwl&backgroundColor=1abc9c",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=DawnRider&backgroundColor=e67e22",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=DuskHunter&backgroundColor=34495e",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=MidnightRun&backgroundColor=16a085",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=SunriseHero&backgroundColor=8e44ad",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=CoachPro&backgroundColor=c0392b",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=TrainHard&backgroundColor=27ae60",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=LiftBig&backgroundColor=2980b9",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=RunFast&backgroundColor=d35400",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=pro_player9&backgroundColor=e74c3c",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=gym_rat_10&backgroundColor=2ecc71",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=iron_will11&backgroundColor=3498db",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=steel_mind12&backgroundColor=9b59b6",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=fire_soul13&backgroundColor=1abc9c",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=ice_veins14&backgroundColor=e67e22",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=thunder_fist&backgroundColor=34495e",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=lightning_kick&backgroundColor=16a085",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=shadow_punch&backgroundColor=8e44ad",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=golden_hook&backgroundColor=c0392b",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=silver_jab&backgroundColor=27ae60",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=bronze_cross&backgroundColor=2980b9"
];
function getAvatarUrl(seed, bg) {
  // Compatibilidad con avatares de seed antiguo
  if(seed && seed.startsWith('http')) return seed;
  return AVATAR_LIST[0];
}

// Nav
let currentPage = 'home';
let prevPage = 'home';
window.goBack = () => { const t=(prevPage&&prevPage!==currentPage)?prevPage:'home'; navTo(t); };
document.querySelectorAll('.nav-item').forEach(item => {
  item.addEventListener('click', () => {
    document.querySelectorAll('.nav-item').forEach(n=>n.classList.remove('active'));
    item.classList.add('active');
    const page = item.dataset.page;
    prevPage = currentPage; currentPage = page;
    renderPage(page);
    if(window.innerWidth<=768) document.getElementById('sidebar').classList.remove('open');
  });
});

document.getElementById('menuToggle').addEventListener('click', () => {
  document.getElementById('sidebar').classList.toggle('open');
});
document.getElementById('logoutBtn').addEventListener('click', () => {
  signOut(auth).catch(()=>{});
  sessionStorage.removeItem('saykyo_user');
  window.location.href='index.html';
});

// ============ PAGE RENDERER ============
async function renderPage(page) {
  const content = document.getElementById('mainContent');
  const title = document.getElementById('pageTitle');
  const subtitle = document.getElementById('pageSubtitle');
  const action = document.getElementById('topbarAction');
  action.style.display='none';
  content.innerHTML='<div class="page-loading"><div class="spinner-lg"></div><span>Cargando...</span></div>';

  const pages = {
    home: renderHome, usuarios: renderUsuarios,
    categorias: renderCategorias, ejercicios: renderEjercicios,
    rutinas: renderRutinas, estadisticas: renderEstadisticas,
    anamnesis: renderAnamnesis, revisiones: renderRevisiones,
    atletas: renderAtletas, grupos: renderGrupos,
    alertas: renderAlertas, valoraciones: renderValoraciones
  };
  const titles = {
    home:'Dashboard', usuarios:'Gestionar Usuarios',
    categorias:'Categor√≠as', ejercicios:'Ejercicios',
    rutinas:'Rutinas', estadisticas:'Estad√≠sticas',
    anamnesis:'Anamnesis de Usuarios', revisiones:'Revisiones de Atletas',
    atletas:'Seguimiento de Atletas', grupos:'Gesti√≥n de Grupos',
    alertas:'üö® Alertas Inteligentes', valoraciones:'üìä Valoraciones & Progreso'
  };
  const subtitles = {
    home:'Panel principal', usuarios:'Crea y administra los perfiles de tus atletas',
    categorias:'Organiza los grupos musculares', ejercicios:'Biblioteca de movimientos',
    rutinas:'Dise√±a programas de entrenamiento', estadisticas:'An√°lisis y reportes',
    anamnesis:'Historial de cuestionarios', revisiones:'Revisiones semanales y mensuales',
    atletas:'Historial de sesiones y registro de entrenamientos en nombre del atleta',
    grupos:'Organiza atletas en grupos y gestiona co-entrenadores',
    alertas:'Detecci√≥n inteligente de situaciones que requieren atenci√≥n',
    valoraciones:'Valoraciones mensuales y tendencias de composici√≥n corporal'
  };
  title.textContent = titles[page]||page;
  subtitle.textContent = subtitles[page]||'';
  const backBtn = document.getElementById('backBtn');
  if(backBtn) backBtn.classList.toggle('visible', page!=='home');
  if (pages[page]) await pages[page](content, action);
}

// ============ TABLA PAGINADA ============
// Crea b√∫squeda + paginaci√≥n en cualquier tabla.
// Uso: initPagedTable(panelEl, rows, colsHtml, renderRow, opts)
function initPagedTable(panel, allRows, theadHtml, renderRow, opts={}) {
  const PAGE_SIZES = [10, 25, 50, 100];
  let perPage  = opts.perPage || 10;
  let page     = 1;
  let query    = '';
  let filtered = allRows;
  let _allRows = allRows;

  const toolbar   = panel.querySelector('.table-toolbar');
  const tbody     = panel.querySelector('tbody');
  const pagination= panel.querySelector('.pagination');

  function applyFilter() {
    const q = query.toLowerCase().trim();
    filtered = q ? _allRows.filter(r => opts.filterFn(r, q)) : _allRows;
    page = 1;
    render();
  }

  function render() {
    const total   = filtered.length;
    const pages   = Math.max(1, Math.ceil(total / perPage));
    page = Math.min(page, pages);
    const start   = (page-1)*perPage;
    const slice   = filtered.slice(start, start+perPage);

    tbody.innerHTML = slice.length
      ? slice.map(renderRow).join('')
      : `<tr><td colspan="99"><div class="empty-state"><div class="empty-icon">${opts.emptyIcon||'üîç'}</div><div class="empty-text">${query?'Sin resultados para "'+query+'"':(opts.emptyText||'Sin datos')}</div></div></td></tr>`;

    // Page info
    const info = panel.querySelector('.page-info');
    if(info) info.textContent = total===0 ? 'Sin resultados' : `Mostrando ${start+1}‚Äì${Math.min(start+perPage,total)} de ${total}`;

    // Page buttons
    const btnsWrap = panel.querySelector('.page-btns');
    if(!btnsWrap) return;
    btnsWrap.innerHTML = '';

    // Prev
    const prev = document.createElement('button');
    prev.className='page-btn'; prev.textContent='‚Äπ'; prev.disabled=page<=1;
    prev.onclick=()=>{page--;render();};
    btnsWrap.appendChild(prev);

    // Numbers (max 5 visible)
    const delta = 2;
    let lo = Math.max(1,page-delta), hi = Math.min(pages,page+delta);
    if(page<=delta) hi=Math.min(pages,1+delta*2);
    if(page>=pages-delta) lo=Math.max(1,pages-delta*2);
    if(lo>1){ const b=document.createElement('button');b.className='page-btn';b.textContent='1';b.onclick=()=>{page=1;render();};btnsWrap.appendChild(b); if(lo>2){const sp=document.createElement('span');sp.textContent='‚Ä¶';sp.style.cssText='color:var(--text-muted);font-size:0.8rem;padding:0 2px';btnsWrap.appendChild(sp);}}
    for(let i=lo;i<=hi;i++){const b=document.createElement('button');b.className='page-btn'+(i===page?' active':'');b.textContent=i;b.onclick=(()=>{const n=i;return()=>{page=n;render();};})();btnsWrap.appendChild(b);}
    if(hi<pages){if(hi<pages-1){const sp=document.createElement('span');sp.textContent='‚Ä¶';sp.style.cssText='color:var(--text-muted);font-size:0.8rem;padding:0 2px';btnsWrap.appendChild(sp);}const b=document.createElement('button');b.className='page-btn';b.textContent=pages;b.onclick=()=>{page=pages;render();};btnsWrap.appendChild(b);}

    // Next
    const next = document.createElement('button');
    next.className='page-btn'; next.textContent='‚Ä∫'; next.disabled=page>=pages;
    next.onclick=()=>{page++;render();};
    btnsWrap.appendChild(next);
  }

  // Search input
  const searchInput = toolbar.querySelector('input[type="search"]');
  if(searchInput) searchInput.addEventListener('input', e=>{query=e.target.value;applyFilter();});

  // Per-page select
  const perPageSel = toolbar.querySelector('.per-page-select');
  if(perPageSel) {
    perPageSel.value = perPage;
    perPageSel.addEventListener('change', e=>{perPage=+e.target.value;page=1;render();});
  }

  render();

  // Return API for external control (e.g. role filter)
  return {
    setRows(newRows) {
      _allRows = newRows;
      filtered = newRows;
      page = 1;
      applyFilter();
    }
  };
}

// ============ HOME ============
async function renderHome(container) {
  const [usSnap, catSnap, ejSnap, rutSnap, myUids] = await Promise.all([
    get(ref(db,'usuarios')), get(ref(db,'categorias')),
    get(ref(db,'ejercicios')), get(ref(db,'rutinas')), getMyGroupUserUids()
  ]);
  const users = usSnap.val()||{};
  const cats = catSnap.val()||{};
  const ejs = ejSnap.val()||{};
  const ruts = rutSnap.val()||{};
  // Scope to group members
  const myUsers = Object.entries(users).filter(([id,u])=>u.rol!=='admin' && u.rol!=='superadmin' && myUids.has(id));
  // "Activos" muestra todos los usuarios activos del sistema (no solo mis grupos)
  const activeUsers = Object.values(users).filter(u=>u.rol!=='admin' && u.rol!=='superadmin' && u.activo).length;
  const myRuts = Object.entries(ruts).filter(([,r])=>r.usuario && myUids.has(r.usuario));

  container.innerHTML = `
    <div class="dashboard-grid">
      <div class="stat-card" style="--card-accent:var(--primary)" onclick="navTo('grupos')">
        <div class="stat-icon">üë•</div>
        <div class="stat-value">${myUsers.length}</div>
        <div class="stat-label">Atletas en mis grupos</div>
      </div>
      <div class="stat-card" style="--card-accent:var(--success)" onclick="navTo('usuarios')">
        <div class="stat-icon">‚úÖ</div>
        <div class="stat-value">${activeUsers}</div>
        <div class="stat-label">Activos</div>
      </div>
      <div class="stat-card" style="--card-accent:var(--accent)" onclick="navTo('ejercicios')">
        <div class="stat-icon">üí™</div>
        <div class="stat-value">${Object.keys(ejs).length}</div>
        <div class="stat-label">Ejercicios</div>
      </div>
      <div class="stat-card" style="--card-accent:var(--accent2)" onclick="navTo('rutinas')">
        <div class="stat-icon">üìã</div>
        <div class="stat-value">${myRuts.length}</div>
        <div class="stat-label">Rutinas de mis atletas</div>
      </div>
    </div>
    <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:16px">
      <div class="glass-panel">
        <div class="panel-header"><span class="panel-title">üèÉ Acceso R√°pido</span></div>
        <div class="panel-body" style="display:flex;flex-direction:column;gap:10px">
          <button class="btn btn-primary btn-full" onclick="navTo('usuarios')">üë• Crear Usuario</button>
          <button class="btn btn-secondary btn-full" onclick="navTo('ejercicios')">üí™ A√±adir Ejercicio</button>
          <button class="btn btn-secondary btn-full" onclick="navTo('rutinas')">üìã Nueva Rutina</button>
          <button class="btn btn-secondary btn-full" onclick="navTo('estadisticas')">üìä Ver Estad√≠sticas</button>
        </div>
      </div>
      <div class="glass-panel">
        <div class="panel-header"><span class="panel-title">üë• Mis atletas recientes</span></div>
        <div class="panel-body">
          ${myUsers.slice(0,5).map(([id,u])=>`
            <div style="display:flex;align-items:center;gap:10px;padding:8px 0;border-bottom:1px solid rgba(255,255,255,0.05)">
              <img src="${u.avatar||getAvatarUrl(u.usuario)}" style="width:34px;height:34px;border-radius:50%;border:2px solid rgba(0,200,255,0.3)">
              <div style="flex:1">
                <div style="font-size:0.88rem;font-weight:600">${u.nombres} ${u.apellidos||''}</div>
                <div style="font-size:0.72rem;color:var(--text-muted)">@${u.usuario} ¬∑ ${u.metodo}</div>
              </div>
              <span class="badge ${u.activo?'badge-active':'badge-inactive'}">${u.activo?'Activo':'Inactivo'}</span>
            </div>
          `).join('')||'<div class="empty-state"><div class="empty-icon">üë§</div><div class="empty-text">No hay atletas en tus grupos</div></div>'}
        </div>
      </div>
    </div>
    <div id="homeAlertsPreview" style="margin-top:16px"></div>
  `;
  // Load alerts preview async
  renderHomeAlertsPreview(document.getElementById('homeAlertsPreview'), myUids, users, ruts);
}
window.navTo = (page) => {
  prevPage = currentPage;
  document.querySelector(`[data-page="${page}"]`).click();
};

// ============ USUARIOS ============
let selectedAvatar = '';
let editingUserId = null;

async function renderUsuarios(container, action) {
  action.textContent = '+ Nuevo Usuario';
  action.style.display = 'flex';
  action.onclick = () => showUserModal();

  const snap = await get(ref(db,'usuarios'));
  const users = snap.val()||{};

  // SuperAdmin sees everyone; regular admin only sees regular users
  const rows = isSuperAdmin()
    ? Object.entries(users)
    : Object.entries(users).filter(([,u])=>u.rol!=='admin' && u.rol!=='superadmin');

  container.innerHTML = `
    <div class="glass-panel" id="panelUsuarios">
      <div class="panel-header">
        <span class="panel-title">üë• Usuarios (${rows.length})</span>
        <button class="btn btn-primary btn-sm" onclick="showUserModal()">+ Nuevo</button>
      </div>
      <div class="table-toolbar">
        <div class="search-box"><span class="search-icon">üîç</span><input type="search" placeholder="Buscar por nombre, usuario..."></div>
        <select class="glass-input" id="filterRolUsuarios" style="width:auto;padding:8px 12px;font-size:0.82rem" onchange="applyUserRolFilter()">
          <option value="">Todos</option>
          <option value="usuario">Solo atletas</option>
          ${isSuperAdmin()?'<option value="admin">Solo admins</option><option value="superadmin">Solo superadmins</option>':''}
        </select>
        <select class="per-page-select">
          <option value="10">10 / p√°g</option>
          <option value="25">25 / p√°g</option>
          <option value="50">50 / p√°g</option>
        </select>
      </div>
      <div style="overflow-x:auto">
        <table class="data-table">
          <thead><tr>
            <th>Avatar</th><th>Usuario</th><th>Nombre</th><th>V√°lido hasta</th>
            <th>M√©todo</th>${isSuperAdmin()?'<th>Perfil</th>':''}
            <th>Estado</th><th>Acciones</th>
          </tr></thead>
          <tbody></tbody>
        </table>
      </div>
      <div class="pagination">
        <span class="page-info"></span>
        <div class="page-btns" style="display:flex;gap:4px;flex-wrap:wrap"></div>
      </div>
    </div>
  `;

  const pagedTable = initPagedTable(
    document.getElementById('panelUsuarios'),
    rows,
    '',
    ([id,u]) => `
      <tr>
        <td><img src="${u.avatar||getAvatarUrl(u.usuario)}" style="width:36px;height:36px;border-radius:50%;border:2px solid rgba(0,200,255,0.3)"></td>
        <td><code style="color:var(--primary)">@${u.usuario}</code></td>
        <td>${u.nombres} ${u.apellidos||''}</td>
        <td style="font-size:0.82rem;${u.validoHasta && new Date(u.validoHasta)<new Date(Date.now()+7*86400000)?'color:var(--warning);font-weight:700':''}">${u.validoHasta||'‚Äî'}</td>
        <td><span class="badge ${u.metodo==='RPE'?'badge-rpe':'badge-rir'}">${u.metodo||'‚Äî'}</span></td>
        ${isSuperAdmin()?`<td><span class="badge" style="${u.rol==='superadmin'?'background:rgba(255,214,0,0.15);color:#ffd60a;border:1px solid rgba(255,214,0,0.35)':u.rol==='admin'?'background:rgba(255,140,0,0.12);color:#ff9f43;border:1px solid rgba(255,140,0,0.3)':'background:rgba(0,200,255,0.1);color:var(--primary);border:1px solid rgba(0,200,255,0.3)'}">${u.rol==='superadmin'?'‚≠ê SuperAdmin':u.rol==='admin'?'üëÆ Admin':'üë§ Atleta'}</span></td>`:''}
        <td><div style="display:flex;align-items:center;gap:6px">
          <span class="badge ${u.activo?'badge-active':'badge-inactive'}" style="cursor:pointer" title="Click para cambiar estado" onclick="toggleUserActivo('${id}',${u.activo})">${u.activo?'Activo':'Inactivo'}</span>
        </div></td>
        <td><div style="display:flex;gap:6px">
          <button class="btn btn-secondary btn-sm" onclick="showUserModal('${id}')">‚úèÔ∏è</button>
          <button class="btn btn-danger btn-sm" onclick="deleteUser('${id}')">üóëÔ∏è</button>
        </div></td>
      </tr>`,
    {
      perPage: 10,
      emptyIcon: 'üë§',
      emptyText: 'No hay usuarios. ¬°Crea el primero!',
      filterFn: ([,u], q) =>
        u.usuario?.toLowerCase().includes(q) ||
        u.nombres?.toLowerCase().includes(q) ||
        u.apellidos?.toLowerCase().includes(q) ||
        u.metodo?.toLowerCase().includes(q)
    }
  );

  // Store reference for role filter
  window._usuariosPagedTable = { rows, pagedTable };
}

window.applyUserRolFilter = () => {
  const filterVal = document.getElementById('filterRolUsuarios')?.value;
  const { rows, pagedTable } = window._usuariosPagedTable || {};
  if(!pagedTable || !rows) return;
  const filtered = filterVal ? rows.filter(([,u])=>u.rol===filterVal) : rows;
  pagedTable.setRows(filtered);
};

// Toggle activo/inactivo inline desde la tabla
window.toggleUserActivo = async (id, currentActivo) => {
  const action = currentActivo ? 'desactivar' : 'activar';
  const res = await Swal.fire({
    icon: 'question',
    title: `¬ø${action.charAt(0).toUpperCase()+action.slice(1)} usuario?`,
    showCancelButton: true,
    confirmButtonText: `S√≠, ${action}`,
    cancelButtonText: 'Cancelar',
    confirmButtonColor: currentActivo ? '#ff4d6d' : '#00e5a0',
    background:'rgba(10,20,40,0.95)', color:'#e8f4ff'
  });
  if(!res.isConfirmed) return;
  await update(ref(db,`usuarios/${id}`), { activo: !currentActivo });
  Swal.fire({icon:'success',title:`Usuario ${!currentActivo?'activado':'desactivado'}`,timer:1200,showConfirmButton:false,background:'rgba(10,20,40,0.95)',color:'#e8f4ff'});
  document.querySelector('[data-page="usuarios"]').click();
};

window.showUserModal = async (userId=null) => {
  editingUserId = userId;
  let user = {};
  if (userId) {
    const snap = await get(ref(db,`usuarios/${userId}`));
    user = snap.val()||{};
  }
  selectedAvatar = user.avatar || AVATAR_LIST[0];

  const avatarGridHtml = AVATAR_LIST.map((url,i) => {
    return `<div class="avatar-option ${selectedAvatar===url?'selected':''}" onclick="selectAvatar('${url}', this)">
      <img src="${url}" loading="lazy">
    </div>`;
  }).join('');

  const html = `
    <div class="overlay-header">
      <span class="overlay-title">${userId?'‚úèÔ∏è Editar':'‚ûï Crear'} Usuario</span>
      <button class="btn-close" onclick="closeOverlay()">‚úï</button>
    </div>
    <div style="display:flex;align-items:center;gap:16px;margin-bottom:22px;padding:16px;background:rgba(0,200,255,0.05);border-radius:14px;border:1px solid rgba(0,200,255,0.1)">
      <div class="selected-avatar-preview" onclick="document.getElementById('avatarGridWrap').style.display=document.getElementById('avatarGridWrap').style.display==='none'?'block':'none'">
        <img id="previewAvatarImg" src="${selectedAvatar}" alt="avatar">
      </div>
      <div>
        <div style="font-weight:600;margin-bottom:4px">Avatar del usuario</div>
        <div style="font-size:0.8rem;color:var(--text-muted)">Toca la imagen para ver opciones</div>
        <button class="btn btn-secondary btn-sm" style="margin-top:8px" onclick="document.getElementById('avatarGridWrap').style.display=document.getElementById('avatarGridWrap').style.display==='none'?'block':'none'">üé® Cambiar avatar</button>
      </div>
    </div>
    <div id="avatarGridWrap" style="display:none;background:rgba(0,0,0,0.3);border-radius:14px;padding:12px;margin-bottom:16px;border:1px solid var(--glass-border)">
      <div style="font-size:0.8rem;color:var(--text-muted);margin-bottom:10px;text-align:center">Selecciona un avatar</div>
      <div class="avatar-grid">${avatarGridHtml}</div>
    </div>
    <div class="form-grid">
      <div class="form-group"><label>Usuario *</label><input class="glass-input" id="uUsuario" placeholder="nombre_usuario" value="${user.usuario||''}"></div>
	  <div class="form-group">
		  <label>Email *</label>
		  <input class="glass-input" id="uEmail" type="email" placeholder="correo@ejemplo.com" value="${user.email||''}">
	  </div>
      <div class="form-group"><label>Nombres *</label><input class="glass-input" id="uNombres" placeholder="Juan" value="${user.nombres||''}"></div>
      <div class="form-group"><label>Apellidos</label><input class="glass-input" id="uApellidos" placeholder="P√©rez" value="${user.apellidos||''}"></div>
      <div class="form-group"><label>Contrase√±a *</label><input class="glass-input" id="uContrasena" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" value="${user.contrasena||''}"></div>
      <div class="form-group"><label>V√°lido hasta *</label><input class="glass-input" id="uValidoHasta" type="date" value="${user.validoHasta||''}"></div>
      <div class="form-group"><label>M√©todo de intensidad</label>
        <select class="glass-input" id="uMetodo">
          <option value="RPE" ${user.metodo==='RPE'?'selected':''}>RPE (1-10)</option>
          <option value="RIR" ${user.metodo==='RIR'?'selected':''}>RIR (Reps en Reserva)</option>
        </select>
      </div>
      ${isSuperAdmin()?`
      <div class="form-group"><label>Perfil de acceso</label>
        <select class="glass-input" id="uRol">
          <option value="usuario" ${(user.rol||'usuario')==='usuario'?'selected':''}>üë§ Atleta (usuario)</option>
          <option value="admin" ${user.rol==='admin'?'selected':''}>üëÆ Admin (acceso al dashboard)</option>
          <option value="superadmin" ${user.rol==='superadmin'?'selected':''}>‚≠ê Super Admin (puede crear admins)</option>
        </select>
        <div style="margin-top:6px;font-size:0.72rem;color:var(--text-muted)">
          ‚ö†Ô∏è Los perfiles <strong>Admin</strong> tienen acceso al panel de administraci√≥n y pueden gestionar sus grupos de atletas.
          Solo el <strong>Super Admin</strong> puede crear otros admins.
        </div>
      </div>`:''}
    </div>
    <div style="margin-top:14px">
      <label class="toggle-wrap">
        <label class="toggle"><input type="checkbox" id="uActivo" ${user.activo!==false?'checked':''}><span class="toggle-slider"></span></label>
        <span class="toggle-label">Usuario activo</span>
      </label>
    </div>
    <div style="display:flex;gap:10px;margin-top:22px;justify-content:flex-end">
      <button class="btn btn-secondary" onclick="closeOverlay()">Cancelar</button>
      <button class="btn btn-primary" onclick="saveUser()">üíæ Guardar</button>
    </div>
  `;
  showOverlay(html);
};

// ‚îÄ‚îÄ Picker de avatar propio para admin/superadmin ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// Usa data-url en vez de onclick anidados para evitar conflictos de comillas.
// El t√≠tulo va dentro del HTML con overlay-header, igual que el resto del dashboard.
window.openOwnAvatarPicker = () => {
  window._ownAvatarTemp = currentUser.avatar || AVATAR_LIST[0];

  const gridHtml = AVATAR_LIST.map(url =>
    `<div class="avatar-option${window._ownAvatarTemp===url?' selected':''}"
          data-url="${url}"
          style="width:64px;height:64px;border-radius:50%;border:2px solid rgba(255,255,255,0.12);
                 overflow:hidden;cursor:pointer;transition:all 0.2s ease">
       <img src="${url}" style="width:100%;height:100%;object-fit:cover;border-radius:50%">
     </div>`
  ).join('');

  showOverlay(`
    <div class="overlay-header">
      <span class="overlay-title">üñºÔ∏è Cambiar mi avatar</span>
      <button class="btn-close" onclick="closeOverlay()">‚úï</button>
    </div>
    <div style="text-align:center;margin-bottom:20px">
      <img id="ownAvatarPreview" src="${window._ownAvatarTemp}"
           style="width:90px;height:90px;border-radius:50%;border:3px solid var(--primary);
                  object-fit:cover;box-shadow:0 0 20px rgba(0,200,255,0.3)">
      <div style="font-size:0.8rem;color:var(--text-muted);margin-top:8px">Vista previa</div>
    </div>
    <div id="ownAvatarGrid" class="avatar-grid" style="max-height:320px;overflow-y:auto;padding:4px">
      ${gridHtml}
    </div>
    <div style="display:flex;gap:10px;margin-top:22px;justify-content:flex-end">
      <button class="btn btn-secondary" onclick="closeOverlay()">Cancelar</button>
      <button class="btn btn-primary" onclick="saveOwnAvatar()">üíæ Guardar avatar</button>
    </div>
  `);

  // Event delegation: un solo listener en la grilla, sin onclick inline
  requestAnimationFrame(() => {
    const grid = document.getElementById('ownAvatarGrid');
    if (!grid) return;
    grid.addEventListener('click', e => {
      const opt = e.target.closest('[data-url]');
      if (!opt) return;
      const url = opt.dataset.url;
      grid.querySelectorAll('[data-url]').forEach(el => el.classList.remove('selected'));
      opt.classList.add('selected');
      document.getElementById('ownAvatarPreview').src = url;
      window._ownAvatarTemp = url;
    });
  });
};

window.saveOwnAvatar = async () => {
  const newAvatar = window._ownAvatarTemp;
  if (!newAvatar) return;
  try {
    await update(ref(db, `usuarios/${currentUser.id}`), { avatar: newAvatar });
    currentUser.avatar = newAvatar;
    sessionStorage.setItem('saykyo_user', JSON.stringify(currentUser));
    document.getElementById('adminAvatar').src = newAvatar;
    closeOverlay();
    Swal.fire({
      icon:'success', title:'¬°Avatar actualizado!',
      timer:1500, showConfirmButton:false,
      background:'rgba(10,20,40,0.95)', color:'#e8f4ff'
    });
  } catch(e) {
    Swal.fire({
      icon:'error', title:'Error al guardar', text:e.message,
      background:'rgba(10,20,40,0.95)', color:'#e8f4ff', confirmButtonColor:'#ff4d6d'
    });
  }
};
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

window.selectAvatar = (url, el) => {
  selectedAvatar = url;
  document.querySelectorAll('.avatar-option').forEach(a=>a.classList.remove('selected'));
  el.classList.add('selected');
  document.getElementById('previewAvatarImg').src = url;
};

window.saveUser = async () => {

  const usuario = document.getElementById('uUsuario').value.trim();
  const email = document.getElementById('uEmail').value.trim();
  const nombres = document.getElementById('uNombres').value.trim();
  const contrasena = document.getElementById('uContrasena').value;
  const validoHasta = document.getElementById('uValidoHasta').value;

  if (!usuario || !email || !nombres || !validoHasta || (!editingUserId && !contrasena)) {
    return Swal.fire({
      icon:'warning',
      title:'Campos requeridos',
      text:'Por favor completa todos los campos obligatorios',
      background:'rgba(10,20,40,0.95)',
      color:'#e8f4ff',
      confirmButtonColor:'#00c8ff'
    });
  }

  // Validar formato email simple
  const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
  if (!emailRegex.test(email)) {
    return Swal.fire({
      icon:'warning',
      title:'Email inv√°lido',
      text:'Ingresa un correo electr√≥nico v√°lido',
      background:'rgba(10,20,40,0.95)',
      color:'#e8f4ff',
      confirmButtonColor:'#00c8ff'
    });
  }

  try {

    let uid = editingUserId;

    // üî• CREAR EN AUTH SOLO SI ES NUEVO ‚Äî usar app secundaria para no desloguear al admin
    if (!editingUserId) {
      const secondaryApp = initializeSecondaryApp(firebaseConfig, `secondary_${Date.now()}`);
      try {
        const secondaryAuth = getAuth(secondaryApp);
        const cred = await createUserWithEmailAndPassword(secondaryAuth, email, contrasena);
        uid = cred.user.uid;
        await signOut(secondaryAuth);
      } finally {
        await deleteApp(secondaryApp).catch(()=>{});
      }
    }

    const dataToSave = {
      usuario,
      email,
      nombres,
      apellidos: document.getElementById('uApellidos').value.trim(),
      validoHasta,
      metodo: document.getElementById('uMetodo').value,
      activo: document.getElementById('uActivo').checked,
      avatar: selectedAvatar,
      rol: isSuperAdmin() ? (document.getElementById('uRol')?.value || 'usuario') : 'usuario',
      creadoEn: editingUserId ? undefined : Date.now()
    };

    if (editingUserId) delete dataToSave.creadoEn;

    await set(
      ref(db, `usuarios/${uid}`),
      editingUserId
        ? { ...(await get(ref(db, `usuarios/${uid}`))).val(), ...dataToSave }
        : dataToSave
    );

    // Si el admin edit√≥ su propio perfil: sync inmediato sin relogueo
    if (editingUserId && (editingUserId === currentUser.id || editingUserId === currentUser.uid)) {
      Object.assign(currentUser, dataToSave);
      sessionStorage.setItem('saykyo_user', JSON.stringify(currentUser));
      document.getElementById('adminAvatar').src = currentUser.avatar || '';
      document.getElementById('adminName').textContent = (currentUser.nombres||'') + ' ' + (currentUser.apellidos||'');
    }

    closeOverlay();

    Swal.fire({
      icon:'success',
      title:'¬°Guardado!',
      text:`Usuario ${usuario} ${editingUserId?'actualizado':'creado'} correctamente`,
      background:'rgba(10,20,40,0.95)',
      color:'#e8f4ff',
      confirmButtonColor:'#00c8ff',
      timer:1500,
      showConfirmButton:false
    });

    // Navegar y forzar recarga del listado con los datos m√°s recientes
    // Activar nav item visualmente
    document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
    const navUsuarios = document.querySelector('[data-page="usuarios"]');
    if(navUsuarios) navUsuarios.classList.add('active');

    // Llamar renderPage directamente para que haga un get() fresco sin depender del evento click
    prevPage = currentPage; currentPage = 'usuarios';
    renderPage('usuarios');

  } catch (e) {

    let mensaje = e.message;

    if (e.code === 'auth/email-already-in-use') {
      mensaje = 'Este correo ya est√° registrado';
    }

    Swal.fire({
      icon:'error',
      title:'Error',
      text:mensaje,
      background:'rgba(10,20,40,0.95)',
      color:'#e8f4ff',
      confirmButtonColor:'#ff4d6d'
    });
  }
};

window.deleteUser = async (id) => {
  const res = await Swal.fire({
    icon:'warning',title:'¬øEliminar usuario?',text:'Esta acci√≥n no se puede deshacer',
    showCancelButton:true,confirmButtonText:'S√≠, eliminar',cancelButtonText:'Cancelar',
    confirmButtonColor:'#ff4d6d',background:'rgba(10,20,40,0.95)',color:'#e8f4ff'
  });
  if(res.isConfirmed) {
    await remove(ref(db,`usuarios/${id}`));
    Swal.fire({icon:'success',title:'Eliminado',timer:1500,showConfirmButton:false,background:'rgba(10,20,40,0.95)',color:'#e8f4ff'});
    document.querySelector('[data-page="usuarios"]').click();
  }
};

// ============ CATEGORIAS ============
async function renderCategorias(container, action) {
  action.textContent = '+ Nueva Categor√≠a';
  action.style.display = 'flex';
  action.onclick = () => showCatModal();

  const snap = await get(ref(db,'categorias'));
  const cats = snap.val()||{};

  const rowsCat = Object.entries(cats);
  container.innerHTML = `
    <div class="glass-panel" id="panelCategorias">
      <div class="panel-header">
        <span class="panel-title">üìÇ Categor√≠as (${rowsCat.length})</span>
        <button class="btn btn-primary btn-sm" onclick="showCatModal()">+ Nueva</button>
      </div>
      <div class="table-toolbar">
        <div class="search-box"><span class="search-icon">üîç</span><input type="search" placeholder="Buscar categor√≠a..."></div>
        <select class="per-page-select">
          <option value="10">10 / p√°g</option>
          <option value="25">25 / p√°g</option>
          <option value="50">50 / p√°g</option>
        </select>
      </div>
      <div style="overflow-x:auto">
        <table class="data-table">
          <thead><tr><th>Nombre</th><th>Descripci√≥n</th><th>Estado</th><th>Acciones</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
      <div class="pagination">
        <span class="page-info"></span>
        <div class="page-btns" style="display:flex;gap:4px;flex-wrap:wrap"></div>
      </div>
    </div>
  `;
  initPagedTable(
    document.getElementById('panelCategorias'),
    rowsCat,
    '',
    ([id,c]) => `
      <tr>
        <td><strong>${c.nombre}</strong></td>
        <td style="color:var(--text-muted);font-size:0.85rem">${c.descripcion||'‚Äî'}</td>
        <td><span class="badge ${c.estado?'badge-active':'badge-inactive'}">${c.estado?'Activa':'Inactiva'}</span></td>
        <td><div style="display:flex;gap:6px">
          <button class="btn btn-secondary btn-sm" onclick="showCatModal('${id}')">‚úèÔ∏è</button>
          <button class="btn btn-danger btn-sm" onclick="deleteCat('${id}')">üóëÔ∏è</button>
        </div></td>
      </tr>`,
    {
      perPage: 10,
      emptyIcon: 'üìÇ',
      emptyText: 'No hay categor√≠as',
      filterFn: ([,c], q) =>
        c.nombre?.toLowerCase().includes(q) ||
        c.descripcion?.toLowerCase().includes(q)
    }
  );
}

window.showCatModal = async (catId=null) => {
  let cat = {};
  if(catId) { const s=await get(ref(db,`categorias/${catId}`)); cat=s.val()||{}; }
  showOverlay(`
    <div class="overlay-header">
      <span class="overlay-title">${catId?'‚úèÔ∏è Editar':'‚ûï Nueva'} Categor√≠a</span>
      <button class="btn-close" onclick="closeOverlay()">‚úï</button>
    </div>
    <div class="form-grid">
      <div class="form-group" style="grid-column:1/-1"><label>Nombre *</label><input class="glass-input" id="cNombre" placeholder="Ej: Pecho, Espalda..." value="${cat.nombre||''}"></div>
      <div class="form-group" style="grid-column:1/-1"><label>Descripci√≥n</label><textarea class="glass-input" id="cDesc" placeholder="Descripci√≥n de la categor√≠a...">${cat.descripcion||''}</textarea></div>
    </div>
    <div style="margin-top:14px">
      <label class="toggle-wrap">
        <label class="toggle"><input type="checkbox" id="cEstado" ${cat.estado!==false?'checked':''}><span class="toggle-slider"></span></label>
        <span class="toggle-label">Categor√≠a activa</span>
      </label>
    </div>
    <div style="display:flex;gap:10px;margin-top:22px;justify-content:flex-end">
      <button class="btn btn-secondary" onclick="closeOverlay()">Cancelar</button>
      <button class="btn btn-primary" onclick="saveCat('${catId||''}')">üíæ Guardar</button>
    </div>
  `);
};

window.saveCat = async (catId) => {
  const nombre = document.getElementById('cNombre').value.trim();
  if(!nombre) return Swal.fire({icon:'warning',title:'Nombre requerido',background:'rgba(10,20,40,0.95)',color:'#e8f4ff',confirmButtonColor:'#00c8ff'});
  const data = { nombre, descripcion:document.getElementById('cDesc').value.trim(), estado:document.getElementById('cEstado').checked };
  const path = catId || `cat_${Date.now()}`;
  await set(ref(db,`categorias/${path}`), data);
  closeOverlay();
  Swal.fire({icon:'success',title:'¬°Guardado!',timer:1500,showConfirmButton:false,background:'rgba(10,20,40,0.95)',color:'#e8f4ff'});
  document.querySelector('[data-page="categorias"]').click();
};

window.deleteCat = async (id) => {
  const r = await Swal.fire({icon:'warning',title:'¬øEliminar?',showCancelButton:true,confirmButtonColor:'#ff4d6d',background:'rgba(10,20,40,0.95)',color:'#e8f4ff'});
  if(r.isConfirmed) { await remove(ref(db,`categorias/${id}`)); document.querySelector('[data-page="categorias"]').click(); }
};

// ============ EJERCICIOS ============
async function renderEjercicios(container, action) {
  action.textContent = '+ Nuevo Ejercicio';
  action.style.display = 'flex';
  action.onclick = () => showEjModal();

  const [ejSnap, catSnap] = await Promise.all([get(ref(db,'ejercicios')),get(ref(db,'categorias'))]);
  const ejs = ejSnap.val()||{};
  const cats = catSnap.val()||{};

  const rowsEj = Object.entries(ejs);
  container.innerHTML = `
    <div class="glass-panel" id="panelEjercicios">
      <div class="panel-header">
        <span class="panel-title">üí™ Ejercicios (${rowsEj.length})</span>
        <button class="btn btn-primary btn-sm" onclick="showEjModal()">+ Nuevo</button>
      </div>
      <div class="table-toolbar">
        <div class="search-box"><span class="search-icon">üîç</span><input type="search" placeholder="Buscar por nombre, categor√≠a..."></div>
        <select class="per-page-select">
          <option value="10">10 / p√°g</option>
          <option value="25">25 / p√°g</option>
          <option value="50">50 / p√°g</option>
        </select>
      </div>
      <div style="overflow-x:auto">
        <table class="data-table">
          <thead><tr><th>Nombre</th><th>Categor√≠a</th><th>Biextremidad</th><th>Estado</th><th>Video</th><th>Acciones</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
      <div class="pagination">
        <span class="page-info"></span>
        <div class="page-btns" style="display:flex;gap:4px;flex-wrap:wrap"></div>
      </div>
    </div>
  `;
  initPagedTable(
    document.getElementById('panelEjercicios'),
    rowsEj,
    '',
    ([id,e]) => `
      <tr>
        <td><strong>${e.nombre}</strong><br><span style="font-size:0.78rem;color:var(--text-muted)">${e.descripcion||''}</span></td>
        <td>${cats[e.categoria]?.nombre||'‚Äî'}</td>
        <td>${e.biextremidad?'<span class="badge badge-active">S√≠</span>':'<span class="badge badge-inactive">No</span>'}</td>
        <td><span class="badge ${e.estado?'badge-active':'badge-inactive'}">${e.estado?'Activo':'Inactivo'}</span></td>
        <td>${e.urlVideo?`<button class="btn btn-secondary btn-sm" onclick="previewVideo('${e.urlVideo}')">‚ñ∂Ô∏è</button>`:'‚Äî'}</td>
        <td><div style="display:flex;gap:6px">
          <button class="btn btn-secondary btn-sm" onclick="showEjModal('${id}')">‚úèÔ∏è</button>
          <button class="btn btn-danger btn-sm" onclick="deleteEj('${id}')">üóëÔ∏è</button>
        </div></td>
      </tr>`,
    {
      perPage: 10,
      emptyIcon: 'üí™',
      emptyText: 'No hay ejercicios',
      filterFn: ([,e], q) =>
        e.nombre?.toLowerCase().includes(q) ||
        e.descripcion?.toLowerCase().includes(q) ||
        cats[e.categoria]?.nombre?.toLowerCase().includes(q)
    }
  );
}

function convertYoutubeUrl(url) {
  if (!url) return '';
  // Already embed
  if (url.includes('/embed/')) return url;
  // youtu.be
  const short = url.match(/youtu\.be\/([^?&]+)/);
  if (short) return `https://www.youtube.com/embed/${short[1]}`;
  // watch?v=
  const watch = url.match(/[?&]v=([^&]+)/);
  if (watch) return `https://www.youtube.com/embed/${watch[1]}`;
  return url;
}

window.showEjModal = async (ejId=null) => {
  let ej = {};
  if(ejId) { const s=await get(ref(db,`ejercicios/${ejId}`)); ej=s.val()||{}; }
  const catSnap = await get(ref(db,'categorias'));
  const cats = catSnap.val()||{};
  const catOptions = Object.entries(cats).filter(([,c])=>c.estado).map(([id,c])=>`<option value="${id}" ${ej.categoria===id?'selected':''}>${c.nombre}</option>`).join('');

  showOverlay(`
    <div class="overlay-header">
      <span class="overlay-title">${ejId?'‚úèÔ∏è Editar':'‚ûï Nuevo'} Ejercicio</span>
      <button class="btn-close" onclick="closeOverlay()">‚úï</button>
    </div>
    <div class="form-grid">
      <div class="form-group" style="grid-column:1/-1"><label>Nombre *</label><input class="glass-input" id="eNombre" placeholder="Press Banca..." value="${ej.nombre||''}"></div>
      <div class="form-group" style="grid-column:1/-1"><label>Descripci√≥n</label><textarea class="glass-input" id="eDesc">${ej.descripcion||''}</textarea></div>
      <div class="form-group" style="grid-column:1/-1">
        <label>URL Video YouTube</label>
        <input class="glass-input" id="eUrl" placeholder="https://www.youtube.com/watch?v=..." value="${ej.urlVideo?ej.urlVideo.replace('https://www.youtube.com/embed/','https://www.youtube.com/watch?v='):''}">
        <div style="font-size:0.75rem;color:var(--text-muted);margin-top:4px">Se convertir√° autom√°ticamente a URL de embebido</div>
      </div>
      <div class="form-group"><label>Categor√≠a</label><select class="glass-input" id="eCat"><option value="">Sin categor√≠a</option>${catOptions}</select></div>
    </div>
    <div style="display:flex;gap:20px;margin-top:14px;flex-wrap:wrap">
      <label class="toggle-wrap">
        <label class="toggle"><input type="checkbox" id="eEstado" ${ej.estado!==false?'checked':''}><span class="toggle-slider"></span></label>
        <span class="toggle-label">Activo</span>
      </label>
      <label class="toggle-wrap">
        <label class="toggle"><input type="checkbox" id="eBiext" ${ej.biextremidad?'checked':''}><span class="toggle-slider"></span></label>
        <span class="toggle-label">Biextremidad</span>
      </label>
    </div>
    <div style="display:flex;gap:10px;margin-top:22px;justify-content:flex-end">
      <button class="btn btn-secondary" onclick="closeOverlay()">Cancelar</button>
      <button class="btn btn-primary" onclick="saveEj('${ejId||''}')">üíæ Guardar</button>
    </div>
  `);
};

window.saveEj = async (ejId) => {
  const nombre = document.getElementById('eNombre').value.trim();
  if(!nombre) return Swal.fire({icon:'warning',title:'Nombre requerido',background:'rgba(10,20,40,0.95)',color:'#e8f4ff',confirmButtonColor:'#00c8ff'});
  const rawUrl = document.getElementById('eUrl').value.trim();
  const data = {
    nombre, descripcion:document.getElementById('eDesc').value.trim(),
    urlVideo: convertYoutubeUrl(rawUrl),
    categoria: document.getElementById('eCat').value,
    estado: document.getElementById('eEstado').checked,
    biextremidad: document.getElementById('eBiext').checked
  };
  const path = ejId || `ej_${Date.now()}`;
  await set(ref(db,`ejercicios/${path}`), data);
  closeOverlay();
  Swal.fire({icon:'success',title:'¬°Guardado!',timer:1500,showConfirmButton:false,background:'rgba(10,20,40,0.95)',color:'#e8f4ff'});
  document.querySelector('[data-page="ejercicios"]').click();
};

window.previewVideo = (url) => {
  showOverlay(`
    <div class="overlay-header">
      <span class="overlay-title">‚ñ∂Ô∏è Vista previa</span>
      <button class="btn-close" onclick="closeOverlay()">‚úï</button>
    </div>
    <div style="position:relative;padding-bottom:56.25%;height:0;border-radius:14px;overflow:hidden">
      <iframe src="${url}" style="position:absolute;inset:0;width:100%;height:100%;" frameborder="0" allowfullscreen></iframe>
    </div>
  `);
};

window.deleteEj = async (id) => {
  const r = await Swal.fire({icon:'warning',title:'¬øEliminar ejercicio?',showCancelButton:true,confirmButtonColor:'#ff4d6d',background:'rgba(10,20,40,0.95)',color:'#e8f4ff'});
  if(r.isConfirmed) { await remove(ref(db,`ejercicios/${id}`)); document.querySelector('[data-page="ejercicios"]').click(); }
};

// ============ RUTINAS ============
let rutinaState = { selectedUser:null, selectedRutina:null, selectedMes:null, selectedSemana:null, selectedDia:null };

async function renderRutinas(container, action) {
  action.textContent = '+ Nueva Rutina';
  action.style.display = 'flex';
  action.onclick = () => showRutinaModal();

  const [rutSnap, usSnap, myUids] = await Promise.all([get(ref(db,'rutinas')),get(ref(db,'usuarios')), getMyGroupUserUids()]);
  const ruts = rutSnap.val()||{};
  const users = usSnap.val()||{};
  // Filter to only show rutinas for athletes in admin's groups
  const myRuts = Object.entries(ruts).filter(([,r]) => !r.usuario || myUids.has(r.usuario));

  container.innerHTML = `
    <div class="rutinas-layout">
      <div class="glass-panel" style="overflow:hidden;display:flex;flex-direction:column">
        <div class="panel-header"><span class="panel-title">üìã Rutinas</span><button class="btn btn-primary btn-sm" onclick="showRutinaModal()">+</button></div>
        <div style="overflow-y:auto;flex:1;padding:12px">
          ${myRuts.map(([id,r])=>`
            <div class="rb-item ${rutinaState.selectedRutina===id?'active':''}" onclick="selectRutina('${id}')">
              <div>
                <div style="font-weight:600;font-size:0.88rem">${r.nombre}</div>
                <div style="font-size:0.75rem;color:var(--text-muted)">${users[r.usuario]?.nombres||r.usuario}</div>
              </div>
              <div style="display:flex;gap:6px;flex-direction:column;align-items:flex-end">
                <span class="badge ${r.activa?'badge-active':'badge-inactive'}" style="font-size:0.65rem">${r.activa?'Activa':'Inactiva'}</span>
                <div style="display:flex;gap:4px">
                  <button class="btn btn-danger btn-sm" style="padding:3px 7px;font-size:0.7rem" onclick="deleteRutina(event,'${id}')">üóëÔ∏è</button>
                </div>
              </div>
            </div>
          `).join('')||'<div class="empty-state"><div class="empty-icon">üìã</div><div class="empty-text">Sin rutinas</div></div>'}
        </div>
      </div>
      <div id="rutinaDetail" class="glass-panel" style="overflow-y:auto">
        <div style="display:flex;align-items:center;justify-content:center;height:100%;color:var(--text-muted)">
          <div style="text-align:center"><div style="font-size:3rem;margin-bottom:12px">üëà</div><div>Selecciona una rutina para editar</div></div>
        </div>
      </div>
    </div>
  `;
  if(rutinaState.selectedRutina) renderRutinaDetail(rutinaState.selectedRutina);
}

window.selectRutina = async (id) => {
  rutinaState.selectedRutina = id;
  rutinaState.selectedMes = null; rutinaState.selectedSemana = null; rutinaState.selectedDia = null;
  rutinaState._nextMes = null; rutinaState._nextSem = null; rutinaState._nextDia = null;

  // Auto-expandir al d√≠a siguiente del atleta asignado
  try {
    const rSnap = await get(ref(db,`rutinas/${id}`));
    const r = rSnap.val()||{};
    if(r.usuario) {
      const progSnap = await get(ref(db,`sesiones/${r.usuario}/progreso`));
      const prog = progSnap.val()||{mesActual:1,semanaActual:1,diaActual:1};
      rutinaState.selectedMes    = prog.mesActual;
      rutinaState.selectedSemana = prog.semanaActual;
      rutinaState.selectedDia    = prog.diaActual;
      rutinaState._nextMes       = prog.mesActual;
      rutinaState._nextSem       = prog.semanaActual;
      rutinaState._nextDia       = prog.diaActual;
    }
  } catch(e) {}

  await renderRutinaDetail(id);
  document.querySelectorAll('.rb-item').forEach(i=>i.classList.toggle('active',i.getAttribute('onclick')===`selectRutina('${id}')`));
};

async function renderRutinaDetail(rutinaId) {
  const detail = document.getElementById('rutinaDetail');
  if(!detail) return;
  const [rSnap, usSnap, ejSnap, catSnap] = await Promise.all([
    get(ref(db,`rutinas/${rutinaId}`)), get(ref(db,'usuarios')),
    get(ref(db,'ejercicios')), get(ref(db,'categorias'))
  ]);
  const r = rSnap.val(); if(!r) return;
  const users = usSnap.val()||{};
  const ejs = ejSnap.val()||{};
  const cats = catSnap.val()||{};
  const meses = r.meses||{};
  const numMeses = Math.max(...Object.keys(meses).map(Number), 0);

  const mesActual = rutinaState.selectedMes;
  const semActual = rutinaState.selectedSemana;
  const diaActual = rutinaState.selectedDia;
  const nextMes   = rutinaState._nextMes;
  const nextSem   = rutinaState._nextSem;
  const nextDia   = rutinaState._nextDia;
  const diasData = mesActual&&semActual ? (meses[mesActual]?.semanas?.[semActual]?.dias||{}) : {};
  const diaData = diaActual ? diasData[diaActual] : null;
  const ejsDia = diaData?.ejercicios||{};

  detail.innerHTML = `
    <div class="panel-header" style="flex-wrap:wrap;gap:8px">
      <div>
        <span class="panel-title">üìã ${r.nombre}</span>
        <div style="font-size:0.78rem;color:var(--text-muted);margin-top:2px">
          Atleta: ${users[r.usuario]?.nombres||r.usuario} ‚Ä¢ ${Object.keys(meses).length} mes(es)
        </div>
      </div>
      <div style="display:flex;gap:8px;flex-wrap:wrap">
        <button class="btn btn-secondary btn-sm" onclick="addMes('${rutinaId}',${numMeses+1})">+ Mes ${numMeses+1}</button>
        ${mesActual&&semActual&&diaActual?`<button class="btn btn-primary btn-sm" onclick="addEjercicioDia('${rutinaId}',${mesActual},${semActual},${diaActual})">+ Ejercicio</button>`:''}
      </div>
    </div>
    ${nextMes?`
    <div style="padding:10px 16px;background:linear-gradient(135deg,rgba(0,200,255,0.08),rgba(123,47,255,0.08));border-bottom:1px solid rgba(0,200,255,0.2);display:flex;align-items:center;gap:10px;flex-wrap:wrap">
      <span style="font-size:1.1rem">üìç</span>
      <span style="font-size:0.78rem;color:var(--text-muted)">D√≠a siguiente del atleta:</span>
      <span style="font-size:0.88rem;font-weight:800;color:var(--primary)">Mes ${nextMes} ¬∑ Semana ${nextSem} ¬∑ D√≠a ${nextDia}</span>
      <span style="font-size:0.72rem;background:rgba(0,200,255,0.15);border:1px solid rgba(0,200,255,0.3);border-radius:20px;padding:2px 10px;color:var(--primary)">‚û°Ô∏è Pr√≥xima sesi√≥n</span>
    </div>`:''}
    <div style="display:flex;gap:12px;padding:12px;flex-wrap:wrap;border-bottom:1px solid var(--glass-border)">
      <!-- MESES -->
      <div style="min-width:80px">
        <div style="font-size:0.7rem;color:var(--text-muted);text-transform:uppercase;letter-spacing:1px;margin-bottom:8px">Mes</div>
        ${Object.keys(meses).sort((a,b)=>a-b).map(m=>`
          <div class="rb-item ${mesActual==m?'active':''}" style="padding:6px 12px;margin-bottom:4px;position:relative" onclick="selMes('${rutinaId}',${m})">
            ${m}
            ${nextMes==m?'<span style="position:absolute;right:6px;top:50%;transform:translateY(-50%);font-size:0.6rem;background:rgba(0,200,255,0.2);color:var(--primary);border-radius:10px;padding:1px 6px">‚óè</span>':''}
          </div>
        `).join('')||'<div style="font-size:0.8rem;color:var(--text-muted)">Sin meses</div>'}
      </div>
      <!-- SEMANAS -->
      ${mesActual?`
        <div style="min-width:100px">
          <div style="font-size:0.7rem;color:var(--text-muted);text-transform:uppercase;letter-spacing:1px;margin-bottom:8px">Semana</div>
          ${[1,2,3,4].map(s=>{
            const hasDays = Object.values(meses[mesActual]?.semanas?.[s]?.dias||{}).some(d=>Object.keys(d?.ejercicios||{}).length>0);
            const nextWeek = s<4 ? s+1 : null;
            return `
            <div style="margin-bottom:4px">
              <div class="rb-item ${semActual==s?'active':''}" style="padding:6px 10px;position:relative;margin-bottom:0" onclick="selSemana('${rutinaId}',${mesActual},${s})">
                S${s}
                ${nextMes==mesActual&&nextSem==s?'<span style="position:absolute;right:6px;top:50%;transform:translateY(-50%);font-size:0.6rem;background:rgba(0,200,255,0.2);color:var(--primary);border-radius:10px;padding:1px 6px">‚óè</span>':''}
              </div>
              ${hasDays&&nextWeek?`<button title="Duplicar semana ${s} ‚Üí semana ${nextWeek}" onclick="duplicarSemana('${rutinaId}',${mesActual},${s},${nextWeek})" style="width:100%;padding:2px 4px;font-size:0.62rem;background:rgba(0,229,160,0.08);border:1px solid rgba(0,229,160,0.25);border-radius:0 0 6px 6px;color:rgba(0,229,160,0.8);cursor:pointer;font-family:'Exo 2',sans-serif">üìã S${nextWeek}</button>`:''} 
            </div>`;
          }).join('')}
        </div>
      `:''}
      <!-- DIAS -->
      ${mesActual&&semActual?`
        <div style="min-width:70px">
          <div style="font-size:0.7rem;color:var(--text-muted);text-transform:uppercase;letter-spacing:1px;margin-bottom:8px">D√≠a</div>
          ${[1,2,3,4,5].map(d=>`
            <div class="rb-item ${diaActual==d?'active':''}" style="padding:6px 12px;margin-bottom:4px;position:relative;${nextMes==mesActual&&nextSem==semActual&&nextDia==d&&diaActual!=d?'border-color:rgba(0,200,255,0.5);background:rgba(0,200,255,0.06);':''}" onclick="selDia('${rutinaId}',${mesActual},${semActual},${d})">
              D${d}
              ${nextMes==mesActual&&nextSem==semActual&&nextDia==d?'<span style="position:absolute;right:6px;top:50%;transform:translateY(-50%);font-size:0.6rem;background:rgba(0,229,160,0.25);color:var(--success);border-radius:10px;padding:1px 6px;font-weight:700">HOY</span>':''}
            </div>
          `).join('')}
        </div>
      `:''}
    </div>
    <!-- EJERCICIOS DEL D√çA -->
    <div style="padding:16px">
      ${diaActual?`
        <div style="font-weight:700;margin-bottom:16px;font-size:1rem">
          Mes ${mesActual} ¬∑ Semana ${semActual} ¬∑ D√≠a ${diaActual}
          <button class="btn btn-primary btn-sm" style="margin-left:12px" onclick="addEjercicioDia('${rutinaId}',${mesActual},${semActual},${diaActual})">+ Agregar ejercicio</button>
        </div>
        ${Object.entries(ejsDia).map(([i,ej])=>`
          <div class="exercise-slot">
            <div class="exercise-slot-header">
              <span class="exercise-slot-title">üí™ ${ejs[ej.ejercicioId]?.nombre||'Ejercicio'}</span>
              <div style="display:flex;gap:6px">
                <button class="btn btn-secondary btn-sm" onclick="editEjDia('${rutinaId}',${mesActual},${semActual},${diaActual},${i})">‚úèÔ∏è Editar</button>
                <button class="btn btn-danger btn-sm" onclick="removeEjDia('${rutinaId}',${mesActual},${semActual},${diaActual},${i})">üóëÔ∏è</button>
              </div>
            </div>
            <!-- Header pills -->
            <div style="display:flex;flex-wrap:wrap;gap:6px;margin-bottom:12px">
              <span style="background:rgba(0,200,255,0.1);border:1px solid rgba(0,200,255,0.25);border-radius:20px;padding:3px 10px;font-size:0.72rem;font-weight:700;color:var(--primary)">üì¶ ${ej.series} series</span>
              <span style="background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:20px;padding:3px 10px;font-size:0.72rem;color:var(--text-muted)">‚è± ${ej.tiempo||0}s/rep</span>
              ${ej.metodo?`<span style="background:rgba(123,47,255,0.15);border:1px solid rgba(123,47,255,0.35);border-radius:20px;padding:3px 10px;font-size:0.72rem;font-weight:700;color:#a78bfa">‚ö° ${ej.metodo}</span>`:''}
            </div>
            <!-- Per-series table -->
            ${(() => {
              const cfg = ej.seriesConfig;
              if(cfg && cfg.length) {
                const thS = 'padding:5px 8px;font-size:0.65rem;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.5px;font-weight:700;text-align:center;';
                const tdS = 'padding:5px 8px;font-size:0.8rem;font-weight:600;text-align:center;';
                const rows = cfg.map((s,si) => `
                  <tr style="border-bottom:1px solid rgba(255,255,255,0.04)">
                    <td style="${tdS};color:rgba(0,200,255,0.7);font-weight:800">${si+1}</td>
                    <td style="${tdS}">${s.repsMin}-${s.repsMax}</td>
                    <td style="${tdS}">${s.peso} kg</td>
                    <td style="${tdS};color:#a78bfa">${s.rirRpe}</td>
                    <td style="${tdS};color:#00e5a0">${s.descanso}s</td>
                  </tr>`).join('');
                return `<div style="overflow-x:auto"><table style="width:100%;border-collapse:collapse;min-width:280px">
                  <thead><tr style="border-bottom:1px solid rgba(255,255,255,0.08)">
                    <th style="${thS}">#</th><th style="${thS}">Reps</th><th style="${thS}">Peso</th><th style="${thS}">RIR/RPE</th><th style="${thS}">Descanso</th>
                  </tr></thead><tbody>${rows}</tbody></table></div>`;
              } else {
                // Legacy flat display
                return `<div class="slot-mini-grid">
                  <div><div style="font-size:0.7rem;color:var(--text-muted)">Reps</div><strong>${ej.repsMin}-${ej.repsMax}</strong></div>
                  <div><div style="font-size:0.7rem;color:var(--text-muted)">Peso</div><strong>${ej.peso} kg</strong></div>
                  <div><div style="font-size:0.7rem;color:var(--text-muted)">RIR/RPE</div><strong>${ej.rirRpe}</strong></div>
                  <div><div style="font-size:0.7rem;color:var(--text-muted)">Descanso</div><strong>${ej.descanso}s</strong></div>
                </div>`;
              }
            })()}
            ${ej.anotaciones?`<div style="margin-top:10px;font-size:0.8rem;color:var(--text-muted);font-style:italic;background:rgba(255,210,0,0.06);border:1px solid rgba(255,210,0,0.12);border-radius:10px;padding:8px 12px">üìù ${ej.anotaciones}</div>`:''}
          </div>
        `).join('')||'<div class="empty-state" style="padding:20px"><div class="empty-icon">üí™</div><div class="empty-text">Sin ejercicios. Agrega el primero.</div></div>'}
      `:'<div class="empty-state"><div class="empty-icon">üëÜ</div><div class="empty-text">Selecciona Mes ‚Üí Semana ‚Üí D√≠a para ver los ejercicios</div></div>'}
    </div>
  `;
}

window.selMes = (rid,m) => { rutinaState.selectedMes=m; rutinaState.selectedSemana=null; rutinaState.selectedDia=null; renderRutinaDetail(rid); };
window.selSemana = (rid,m,s) => { rutinaState.selectedSemana=s; rutinaState.selectedDia=null; renderRutinaDetail(rid); };
window.selDia = (rid,m,s,d) => { rutinaState.selectedDia=d; renderRutinaDetail(rid); };

// ‚îÄ‚îÄ Duplicar semana ‚Üí semana siguiente ‚îÄ‚îÄ
window.duplicarSemana = async (rutinaId, mes, semOrigen, semDestino) => {
  const semOriginPath = `rutinas/${rutinaId}/meses/${mes}/semanas/${semOrigen}`;
  const semDestPath   = `rutinas/${rutinaId}/meses/${mes}/semanas/${semDestino}`;

  // Check if destination already has data
  const destSnap = await get(ref(db, semDestPath));
  const destData = destSnap.val();
  const hasDest = destData && Object.values(destData.dias||{}).some(d=>Object.keys(d?.ejercicios||{}).length>0);

  if(hasDest) {
    const r = await Swal.fire({
      icon:'warning',
      title:`¬øSobreescribir semana ${semDestino}?`,
      text:`La semana ${semDestino} ya tiene datos. ¬øReemplazarla con la copia de la semana ${semOrigen}?`,
      showCancelButton:true,
      confirmButtonText:'S√≠, reemplazar',
      cancelButtonText:'Cancelar',
      confirmButtonColor:'#ff6b35',
      background:'rgba(10,20,40,0.95)',color:'#e8f4ff'
    });
    if(!r.isConfirmed) return;
  }

  // Deep-copy origin semana data
  const originSnap = await get(ref(db, semOriginPath));
  const originData = originSnap.val();
  if(!originData) return Swal.fire({icon:'info',title:'La semana origen no tiene datos',background:'rgba(10,20,40,0.95)',color:'#e8f4ff'});

  // Write to destination
  await set(ref(db, semDestPath), JSON.parse(JSON.stringify(originData)));

  Swal.fire({
    icon:'success',
    title:`‚úÖ Semana ${semOrigen} copiada a semana ${semDestino}`,
    text:'Puedes editarla ahora.',
    timer:1800,
    showConfirmButton:false,
    background:'rgba(10,20,40,0.95)',color:'#e8f4ff'
  });

  // Navigate to dest semana
  rutinaState.selectedSemana = semDestino;
  rutinaState.selectedDia = 1;
  renderRutinaDetail(rutinaId);
};


window.addMes = async (rutinaId, mes) => {
  const snap = await get(ref(db,`rutinas/${rutinaId}/meses/${mes}`));
  if(snap.exists()) return Swal.fire({icon:'info',title:`El mes ${mes} ya existe`,background:'rgba(10,20,40,0.95)',color:'#e8f4ff',confirmButtonColor:'#00c8ff'});
  await set(ref(db,`rutinas/${rutinaId}/meses/${mes}`), { semanas:{} });
  rutinaState.selectedMes = mes; rutinaState.selectedSemana = null; rutinaState.selectedDia = null;
  renderRutinaDetail(rutinaId);
};

window.addEjercicioDia = async (rutinaId, mes, semana, dia) => {
  const ejSnap = await get(ref(db,'ejercicios'));
  const ejs = ejSnap.val()||{};
  const ejOptions = Object.entries(ejs).filter(([,e])=>e.estado).map(([id,e])=>`<option value="${id}">${e.nombre}</option>`).join('');

  showOverlay(`
    <div class="overlay-header">
      <span class="overlay-title">‚ûï Agregar Ejercicio ‚Äî M${mes}¬∑S${semana}¬∑D${dia}</span>
      <button class="btn-close" onclick="closeOverlay()">‚úï</button>
    </div>

    <!-- Datos generales -->
    <div class="form-grid" style="margin-bottom:18px">
      <div class="form-group" style="grid-column:1/-1">
        <label>Ejercicio *</label>
        <select class="glass-input" id="ejSel"><option value="">Seleccionar...</option>${ejOptions}</select>
      </div>
      <div class="form-group">
        <label>N¬∞ de series</label>
        <input class="glass-input" type="number" id="ejSeries" value="4" min="1" max="20"
          oninput="rebuildSeriesTable()">
      </div>
      <div class="form-group">
        <label>Tiempo entre rep (seg)</label>
        <input class="glass-input" type="number" id="ejTiempo" value="45" min="0">
      </div>
      <div class="form-group" style="grid-column:1/-1">
        <label>M√©todo de entrenamiento</label>
        <input class="glass-input" id="ejMetodo" placeholder="Ej: Rest Pause, Drop Set, Cluster, Superset...">
      </div>
      <div class="form-group" style="grid-column:1/-1">
        <label>Anotaciones</label>
        <textarea class="glass-input" id="ejAnotaciones" rows="2" placeholder="Instrucciones especiales..."></textarea>
      </div>
    </div>

    <!-- Valores por defecto para rellenar la tabla r√°pido -->
    <div style="background:rgba(0,200,255,0.05);border:1px solid rgba(0,200,255,0.15);border-radius:14px;padding:14px;margin-bottom:16px">
      <div style="font-size:0.72rem;color:var(--primary);text-transform:uppercase;letter-spacing:1px;font-weight:700;margin-bottom:12px">
        ‚ö° Rellenar todas las series con estos valores
      </div>
      <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(110px,1fr));gap:10px;margin-bottom:10px">
        <div class="form-group" style="margin:0">
          <label>Reps M√≠n</label>
          <input class="glass-input" type="number" id="ejDefRepsMin" value="8" min="0" oninput="fillSeriesDefaults()">
        </div>
        <div class="form-group" style="margin:0">
          <label>Reps M√°x</label>
          <input class="glass-input" type="number" id="ejDefRepsMax" value="12" min="0" oninput="fillSeriesDefaults()">
        </div>
        <div class="form-group" style="margin:0">
          <label>Peso (kg)</label>
          <input class="glass-input" type="number" id="ejDefPeso" value="0" min="0" step="0.5" oninput="fillSeriesDefaults()">
        </div>
        <div class="form-group" style="margin:0">
          <label>RIR / RPE</label>
          <input class="glass-input" type="number" id="ejDefRirRpe" value="2" min="-1" max="10" oninput="fillSeriesDefaults()">
        </div>
        <div class="form-group" style="margin:0">
          <label>Descanso (seg)</label>
          <input class="glass-input" type="number" id="ejDefDescanso" value="90" min="0" oninput="fillSeriesDefaults()">
        </div>
      </div>
    </div>

    <!-- Tabla por series (se genera din√°micamente) -->
    <div style="font-size:0.78rem;font-weight:700;color:var(--text-muted);text-transform:uppercase;letter-spacing:1px;margin-bottom:10px">
      üìã Configuraci√≥n por serie
    </div>
    <div id="seriesTableWrap" style="overflow-x:auto;margin-bottom:20px">
      <!-- generado por rebuildSeriesTable() -->
    </div>

    <div style="display:flex;gap:10px;justify-content:flex-end">
      <button class="btn btn-secondary" onclick="closeOverlay()">Cancelar</button>
      <button class="btn btn-primary" onclick="saveEjDia('${rutinaId}',${mes},${semana},${dia})">üíæ Agregar</button>
    </div>
  `);

  // Build table right away
  rebuildSeriesTable();
};

// Build / rebuild the per-series table when the series count changes.
// Preserves any values already typed in existing rows.
window.rebuildSeriesTable = () => {
  const n = Math.max(1, Math.min(20, +document.getElementById('ejSeries')?.value || 4));

  // Snapshot current values from rows that already exist (so changing count doesn't wipe them)
  const saved = [];
  let existingIdx = 0;
  while(document.getElementById(`s_repsMin_${existingIdx}`) !== null) {
    saved.push({
      repsMin:  document.getElementById(`s_repsMin_${existingIdx}`)?.value,
      repsMax:  document.getElementById(`s_repsMax_${existingIdx}`)?.value,
      peso:     document.getElementById(`s_peso_${existingIdx}`)?.value,
      rirRpe:   document.getElementById(`s_rirRpe_${existingIdx}`)?.value,
      descanso: document.getElementById(`s_descanso_${existingIdx}`)?.value,
    });
    existingIdx++;
  }

  const defRepsMin  = document.getElementById('ejDefRepsMin')?.value  || '8';
  const defRepsMax  = document.getElementById('ejDefRepsMax')?.value  || '12';
  const defPeso     = document.getElementById('ejDefPeso')?.value     || '0';
  const defRirRpe   = document.getElementById('ejDefRirRpe')?.value   || '2';
  const defDescanso = document.getElementById('ejDefDescanso')?.value || '90';

  const wrap = document.getElementById('seriesTableWrap');
  if(!wrap) return;

  const thStyle = 'padding:8px 10px;font-size:0.68rem;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.5px;font-weight:700;white-space:nowrap;text-align:center;';
  const rows = Array.from({length:n}, (_,i) => {
    // Use saved value if row existed, else fall back to defaults
    const sv = saved[i];
    const repsMin  = sv ? sv.repsMin  : defRepsMin;
    const repsMax  = sv ? sv.repsMax  : defRepsMax;
    const peso     = sv ? sv.peso     : defPeso;
    const rirRpe   = sv ? sv.rirRpe   : defRirRpe;
    const descanso = sv ? sv.descanso : defDescanso;
    return `
      <tr>
        <td style="padding:6px 8px;text-align:center">
          <div style="width:28px;height:28px;border-radius:50%;background:rgba(0,200,255,0.12);border:1px solid rgba(0,200,255,0.3);display:flex;align-items:center;justify-content:center;font-size:0.78rem;font-weight:800;color:var(--primary);margin:0 auto">${i+1}</div>
        </td>
        <td style="padding:6px 5px"><input class="glass-input" type="number" id="s_repsMin_${i}" value="${repsMin}" min="0" style="padding:7px 8px;text-align:center;min-width:60px"></td>
        <td style="padding:6px 5px"><input class="glass-input" type="number" id="s_repsMax_${i}" value="${repsMax}" min="0" style="padding:7px 8px;text-align:center;min-width:60px"></td>
        <td style="padding:6px 5px"><input class="glass-input" type="number" id="s_peso_${i}"    value="${peso}"    min="0" step="0.5" style="padding:7px 8px;text-align:center;min-width:65px"></td>
        <td style="padding:6px 5px"><input class="glass-input" type="number" id="s_rirRpe_${i}" value="${rirRpe}"  min="-1" max="10" style="padding:7px 8px;text-align:center;min-width:60px"></td>
        <td style="padding:6px 5px"><input class="glass-input" type="number" id="s_descanso_${i}" value="${descanso}" min="0" style="padding:7px 8px;text-align:center;min-width:65px"></td>
      </tr>`;
  }).join('');

  wrap.innerHTML = `
    <table style="width:100%;border-collapse:collapse;min-width:420px">
      <thead>
        <tr style="border-bottom:1px solid rgba(255,255,255,0.08)">
          <th style="${thStyle}">#</th>
          <th style="${thStyle}">Rep M√≠n</th>
          <th style="${thStyle}">Rep M√°x</th>
          <th style="${thStyle}">Peso kg</th>
          <th style="${thStyle}">RIR/RPE</th>
          <th style="${thStyle}">Descanso s</th>
        </tr>
      </thead>
      <tbody>${rows}</tbody>
    </table>
  `;
};

// Fill all series rows with the current default values
window.fillSeriesDefaults = () => {
  const n = Math.max(1, +document.getElementById('ejSeries')?.value || 4);
  const defRepsMin  = document.getElementById('ejDefRepsMin')?.value  || '8';
  const defRepsMax  = document.getElementById('ejDefRepsMax')?.value  || '12';
  const defPeso     = document.getElementById('ejDefPeso')?.value     || '0';
  const defRirRpe   = document.getElementById('ejDefRirRpe')?.value   || '2';
  const defDescanso = document.getElementById('ejDefDescanso')?.value || '90';

  for(let i=0; i<n; i++) {
    const set = (id, val) => { const el = document.getElementById(id); if(el) el.value = val; };
    set(`s_repsMin_${i}`,  defRepsMin);
    set(`s_repsMax_${i}`,  defRepsMax);
    set(`s_peso_${i}`,     defPeso);
    set(`s_rirRpe_${i}`,   defRirRpe);
    set(`s_descanso_${i}`, defDescanso);
  }
};

window.saveEjDia = async (rutinaId, mes, semana, dia) => {
  const ejId = document.getElementById('ejSel').value;
  if(!ejId) return Swal.fire({icon:'warning',title:'Selecciona un ejercicio',background:'rgba(10,20,40,0.95)',color:'#e8f4ff',confirmButtonColor:'#00c8ff'});

  const n = Math.max(1, +document.getElementById('ejSeries').value || 4);

  // Read per-series config from the table
  const seriesConfig = Array.from({length: n}, (_, i) => ({
    repsMin:  +document.getElementById(`s_repsMin_${i}`)?.value  || 0,
    repsMax:  +document.getElementById(`s_repsMax_${i}`)?.value  || 0,
    peso:     +document.getElementById(`s_peso_${i}`)?.value     || 0,
    rirRpe:   +document.getElementById(`s_rirRpe_${i}`)?.value   || 0,
    descanso: +document.getElementById(`s_descanso_${i}`)?.value || 90,
  }));

  // Keep top-level defaults for backwards compatibility display
  const path = `rutinas/${rutinaId}/meses/${mes}/semanas/${semana}/dias/${dia}/ejercicios`;
  const snap = await get(ref(db, path));
  const idx = Object.keys(snap.val()||{}).length;

  await set(ref(db, `${path}/${idx}`), {
    ejercicioId:  ejId,
    series:       n,
    seriesConfig, // ‚Üê new: per-series array
    // top-level fallbacks (first series values, for legacy display)
    repsMin:  seriesConfig[0].repsMin,
    repsMax:  seriesConfig[0].repsMax,
    peso:     seriesConfig[0].peso,
    rirRpe:   seriesConfig[0].rirRpe,
    descanso: seriesConfig[0].descanso,
    tiempo:   +document.getElementById('ejTiempo').value || 0,
    metodo:   document.getElementById('ejMetodo').value.trim(),
    anotaciones: document.getElementById('ejAnotaciones').value.trim(),
  });

  closeOverlay();
  Swal.fire({icon:'success',title:'¬°Ejercicio agregado!',timer:1200,showConfirmButton:false,background:'rgba(10,20,40,0.95)',color:'#e8f4ff'});
  renderRutinaDetail(rutinaId);
};

window.removeEjDia = async (rutinaId, mes, semana, dia, idx) => {
  const r = await Swal.fire({icon:'warning',title:'¬øQuitar ejercicio?',showCancelButton:true,confirmButtonColor:'#ff4d6d',background:'rgba(10,20,40,0.95)',color:'#e8f4ff'});
  if(r.isConfirmed) {
    await remove(ref(db,`rutinas/${rutinaId}/meses/${mes}/semanas/${semana}/dias/${dia}/ejercicios/${idx}`));
    renderRutinaDetail(rutinaId);
  }
};

window.editEjDia = async (rutinaId, mes, semana, dia, idx) => {
  // Load current data
  const [ejSnap, slotSnap] = await Promise.all([
    get(ref(db, 'ejercicios')),
    get(ref(db, `rutinas/${rutinaId}/meses/${mes}/semanas/${semana}/dias/${dia}/ejercicios/${idx}`))
  ]);
  const ejs = ejSnap.val()||{};
  const ej  = slotSnap.val()||{};
  const ejOptions = Object.entries(ejs)
    .filter(([,e]) => e.estado)
    .map(([id,e]) => `<option value="${id}" ${id===ej.ejercicioId?'selected':''}>${e.nombre}</option>`)
    .join('');

  // Build per-series config from existing data (support legacy flat format)
  const existingCfg = ej.seriesConfig || Array.from({length: ej.series||4}, () => ({
    repsMin:  ej.repsMin  || 8,
    repsMax:  ej.repsMax  || 12,
    peso:     ej.peso     || 0,
    rirRpe:   ej.rirRpe   || 2,
    descanso: ej.descanso || 90,
  }));

  // Summary of first series for the defaults section
  const firstCfg = existingCfg[0] || {};

  showOverlay(`
    <div class="overlay-header">
      <span class="overlay-title">‚úèÔ∏è Editar Ejercicio ‚Äî M${mes}¬∑S${semana}¬∑D${dia}</span>
      <button class="btn-close" onclick="closeOverlay()">‚úï</button>
    </div>

    <div class="form-grid" style="margin-bottom:18px">
      <div class="form-group" style="grid-column:1/-1">
        <label>Ejercicio *</label>
        <select class="glass-input" id="ejSel"><option value="">Seleccionar...</option>${ejOptions}</select>
      </div>
      <div class="form-group">
        <label>N¬∞ de series</label>
        <input class="glass-input" type="number" id="ejSeries" value="${ej.series||4}" min="1" max="20"
          oninput="rebuildSeriesTable()">
      </div>
      <div class="form-group">
        <label>Tiempo por rep (seg)</label>
        <input class="glass-input" type="number" id="ejTiempo" value="${ej.tiempo||45}" min="0">
      </div>
      <div class="form-group" style="grid-column:1/-1">
        <label>M√©todo de entrenamiento</label>
        <input class="glass-input" id="ejMetodo" value="${ej.metodo||''}" placeholder="Ej: Rest Pause, Drop Set...">
      </div>
      <div class="form-group" style="grid-column:1/-1">
        <label>Anotaciones</label>
        <textarea class="glass-input" id="ejAnotaciones" rows="2">${ej.anotaciones||''}</textarea>
      </div>
    </div>

    <div style="background:rgba(0,200,255,0.05);border:1px solid rgba(0,200,255,0.15);border-radius:14px;padding:14px;margin-bottom:16px">
      <div style="font-size:0.72rem;color:var(--primary);text-transform:uppercase;letter-spacing:1px;font-weight:700;margin-bottom:12px">
        ‚ö° Rellenar todas las series con estos valores
      </div>
      <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(110px,1fr));gap:10px">
        <div class="form-group" style="margin:0"><label>Reps M√≠n</label><input class="glass-input" type="number" id="ejDefRepsMin" value="${firstCfg.repsMin||8}" min="0" oninput="fillSeriesDefaults()"></div>
        <div class="form-group" style="margin:0"><label>Reps M√°x</label><input class="glass-input" type="number" id="ejDefRepsMax" value="${firstCfg.repsMax||12}" min="0" oninput="fillSeriesDefaults()"></div>
        <div class="form-group" style="margin:0"><label>Peso (kg)</label><input class="glass-input" type="number" id="ejDefPeso" value="${firstCfg.peso||0}" min="0" step="0.5" oninput="fillSeriesDefaults()"></div>
        <div class="form-group" style="margin:0"><label>RIR / RPE</label><input class="glass-input" type="number" id="ejDefRirRpe" value="${firstCfg.rirRpe||2}" min="-1" max="10" oninput="fillSeriesDefaults()"></div>
        <div class="form-group" style="margin:0"><label>Descanso (seg)</label><input class="glass-input" type="number" id="ejDefDescanso" value="${firstCfg.descanso||90}" min="0" oninput="fillSeriesDefaults()"></div>
      </div>
    </div>

    <div style="font-size:0.78rem;font-weight:700;color:var(--text-muted);text-transform:uppercase;letter-spacing:1px;margin-bottom:10px">
      üìã Configuraci√≥n por serie
    </div>
    <div id="seriesTableWrap" style="overflow-x:auto;margin-bottom:20px"></div>

    <div style="display:flex;gap:10px;justify-content:flex-end">
      <button class="btn btn-secondary" onclick="closeOverlay()">Cancelar</button>
      <button class="btn btn-primary" onclick="updateEjDia('${rutinaId}',${mes},${semana},${dia},${idx})">üíæ Guardar cambios</button>
    </div>
  `);

  // Build table pre-populated with existing per-series values
  rebuildSeriesTableWithData(existingCfg);
};

// Rebuild table pre-filling rows with existing seriesConfig data
window.rebuildSeriesTableWithData = (existingCfg) => {
  const n = Math.max(1, Math.min(20, +document.getElementById('ejSeries')?.value || existingCfg.length));
  const wrap = document.getElementById('seriesTableWrap');
  if(!wrap) return;

  const thStyle = 'padding:8px 10px;font-size:0.68rem;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.5px;font-weight:700;white-space:nowrap;text-align:center;';
  const rows = Array.from({length:n}, (_,i) => {
    const s = existingCfg[i] || existingCfg[existingCfg.length-1] || {};
    return `
      <tr>
        <td style="padding:6px 8px;text-align:center">
          <div style="width:28px;height:28px;border-radius:50%;background:rgba(0,200,255,0.12);border:1px solid rgba(0,200,255,0.3);display:flex;align-items:center;justify-content:center;font-size:0.78rem;font-weight:800;color:var(--primary);margin:0 auto">${i+1}</div>
        </td>
        <td style="padding:6px 5px"><input class="glass-input" type="number" id="s_repsMin_${i}" value="${s.repsMin??8}" min="0" style="padding:7px 8px;text-align:center;min-width:60px"></td>
        <td style="padding:6px 5px"><input class="glass-input" type="number" id="s_repsMax_${i}" value="${s.repsMax??12}" min="0" style="padding:7px 8px;text-align:center;min-width:60px"></td>
        <td style="padding:6px 5px"><input class="glass-input" type="number" id="s_peso_${i}"    value="${s.peso??0}"   min="0" step="0.5" style="padding:7px 8px;text-align:center;min-width:65px"></td>
        <td style="padding:6px 5px"><input class="glass-input" type="number" id="s_rirRpe_${i}" value="${s.rirRpe??2}" min="-1" max="10" style="padding:7px 8px;text-align:center;min-width:60px"></td>
        <td style="padding:6px 5px"><input class="glass-input" type="number" id="s_descanso_${i}" value="${s.descanso??90}" min="0" style="padding:7px 8px;text-align:center;min-width:65px"></td>
      </tr>`;
  }).join('');

  wrap.innerHTML = `
    <table style="width:100%;border-collapse:collapse;min-width:420px">
      <thead>
        <tr style="border-bottom:1px solid rgba(255,255,255,0.08)">
          <th style="${thStyle}">#</th>
          <th style="${thStyle}">Rep M√≠n</th>
          <th style="${thStyle}">Rep M√°x</th>
          <th style="${thStyle}">Peso kg</th>
          <th style="${thStyle}">RIR/RPE</th>
          <th style="${thStyle}">Descanso s</th>
        </tr>
      </thead>
      <tbody>${rows}</tbody>
    </table>
  `;
};

window.updateEjDia = async (rutinaId, mes, semana, dia, idx) => {
  const ejId = document.getElementById('ejSel').value;
  if(!ejId) return Swal.fire({icon:'warning',title:'Selecciona un ejercicio',background:'rgba(10,20,40,0.95)',color:'#e8f4ff',confirmButtonColor:'#00c8ff'});

  const n = Math.max(1, +document.getElementById('ejSeries').value || 4);

  const seriesConfig = Array.from({length: n}, (_, i) => ({
    repsMin:  +document.getElementById(`s_repsMin_${i}`)?.value  || 0,
    repsMax:  +document.getElementById(`s_repsMax_${i}`)?.value  || 0,
    peso:     +document.getElementById(`s_peso_${i}`)?.value     || 0,
    rirRpe:   +document.getElementById(`s_rirRpe_${i}`)?.value   || 0,
    descanso: +document.getElementById(`s_descanso_${i}`)?.value || 90,
  }));

  const path = `rutinas/${rutinaId}/meses/${mes}/semanas/${semana}/dias/${dia}/ejercicios/${idx}`;
  await set(ref(db, path), {
    ejercicioId:  ejId,
    series:       n,
    seriesConfig,
    repsMin:  seriesConfig[0].repsMin,
    repsMax:  seriesConfig[0].repsMax,
    peso:     seriesConfig[0].peso,
    rirRpe:   seriesConfig[0].rirRpe,
    descanso: seriesConfig[0].descanso,
    tiempo:   +document.getElementById('ejTiempo').value || 0,
    metodo:   document.getElementById('ejMetodo').value.trim(),
    anotaciones: document.getElementById('ejAnotaciones').value.trim(),
  });

  closeOverlay();
  Swal.fire({icon:'success',title:'¬°Ejercicio actualizado!',timer:1200,showConfirmButton:false,background:'rgba(10,20,40,0.95)',color:'#e8f4ff'});
  renderRutinaDetail(rutinaId);
};

window.showRutinaModal = async () => {
  const [usSnap, myUids] = await Promise.all([get(ref(db,'usuarios')), getMyGroupUserUids()]);
  const users = usSnap.val()||{};
  const userOpts = Object.entries(users).filter(([id,u])=>u.rol!=='admin' && u.rol!=='superadmin' && myUids.has(id)).map(([id,u])=>`<option value="${id}">${u.nombres} ${u.apellidos||''} (@${u.usuario})</option>`).join('');
  showOverlay(`
    <div class="overlay-header">
      <span class="overlay-title">‚ûï Nueva Rutina</span>
      <button class="btn-close" onclick="closeOverlay()">‚úï</button>
    </div>
    <div class="form-grid">
      <div class="form-group"><label>Atleta *</label><select class="glass-input" id="rUser"><option value="">Seleccionar...</option>${userOpts}</select></div>
      <div class="form-group"><label>Nombre de la rutina *</label><input class="glass-input" id="rNombre" placeholder="Ej: Hipertrofia 3 meses"></div>
      <div class="form-group" style="grid-column:1/-1"><label>Descripci√≥n</label><textarea class="glass-input" id="rDesc" placeholder="Descripci√≥n..."></textarea></div>
    </div>
    <div style="margin-top:14px">
      <label class="toggle-wrap">
        <label class="toggle"><input type="checkbox" id="rActiva" checked><span class="toggle-slider"></span></label>
        <span class="toggle-label">Rutina activa</span>
      </label>
    </div>
    <div style="display:flex;gap:10px;margin-top:22px;justify-content:flex-end">
      <button class="btn btn-secondary" onclick="closeOverlay()">Cancelar</button>
      <button class="btn btn-primary" onclick="saveRutina()">üíæ Crear</button>
    </div>
  `);
};

window.saveRutina = async () => {
  const usuario = document.getElementById('rUser').value;
  const nombre = document.getElementById('rNombre').value.trim();
  if(!usuario||!nombre) return Swal.fire({icon:'warning',title:'Campos requeridos',background:'rgba(10,20,40,0.95)',color:'#e8f4ff',confirmButtonColor:'#00c8ff'});
  const id = `rutina_${Date.now()}`;
  await set(ref(db,`rutinas/${id}`), {
    usuario, nombre, descripcion: document.getElementById('rDesc').value.trim(),
    activa: document.getElementById('rActiva').checked, creadaEn: Date.now(), meses:{}
  });
  closeOverlay();
  rutinaState.selectedRutina = id;
  Swal.fire({icon:'success',title:'¬°Rutina creada!',timer:1500,showConfirmButton:false,background:'rgba(10,20,40,0.95)',color:'#e8f4ff'});
  document.querySelector('[data-page="rutinas"]').click();
};

window.deleteRutina = async (e, id) => {
  e.stopPropagation();
  const r = await Swal.fire({icon:'warning',title:'¬øEliminar rutina?',showCancelButton:true,confirmButtonColor:'#ff4d6d',background:'rgba(10,20,40,0.95)',color:'#e8f4ff'});
  if(r.isConfirmed) {
    await remove(ref(db,`rutinas/${id}`));
    if(rutinaState.selectedRutina===id) rutinaState = {selectedUser:null,selectedRutina:null,selectedMes:null,selectedSemana:null,selectedDia:null};
    document.querySelector('[data-page="rutinas"]').click();
  }
};

// ============ ATLETAS / SEGUIMIENTO ============
async function renderAtletas(container, action) {
  const [usSnap, rutSnap, ejSnap, myUids] = await Promise.all([
    get(ref(db,'usuarios')), get(ref(db,'rutinas')), get(ref(db,'ejercicios')), getMyGroupUserUids()
  ]);
  const users = usSnap.val()||{};
  const ruts  = rutSnap.val()||{};
  const ejs   = ejSnap.val()||{};
  const atletas = Object.entries(users).filter(([id,u])=>u.rol!=='admin' && u.rol!=='superadmin' && myUids.has(id));

  if(!atletas.length) {
    container.innerHTML = `<div class="empty-state"><div class="empty-icon">üèÉ</div><div class="empty-text">No hay atletas registrados</div></div>`;
    return;
  }

  // Estado local de la vista
  if(!window._atletaState) window._atletaState = { uid: atletas[0][0], sesId: null };
  const st = window._atletaState;

  const renderVista = async () => {
    const uid  = st.uid;
    const user = users[uid]||{};
    const rutina = Object.values(ruts).find(r=>r.usuario===uid && r.activa);
    const [sesSnap, progSnap] = await Promise.all([
      get(ref(db,`sesiones/${uid}/historial`)),
      get(ref(db,`sesiones/${uid}/progreso`))
    ]);
    const historial = sesSnap.val()||{};
    const progreso  = progSnap.val()||{};
    const sesiones  = Object.entries(historial)
      .map(([k,v])=>({...v, _key:k}))
      .sort((a,b)=>(b.fecha||b.fechaFin||0)-(a.fecha||a.fechaFin||0));

    const sesActual = st.sesId ? sesiones.find(s=>s._key===st.sesId) : sesiones[0];
    if(sesActual && !st.sesId) st.sesId = sesActual._key;

    // Selector de atleta
    const atletaOpts = atletas.map(([id,u])=>`
      <option value="${id}" ${id===uid?'selected':''}>${u.nombres} ${u.apellidos||''}</option>
    `).join('');

    // Card posici√≥n actual
    const posCard = progreso.mesActual ? `
      <div style="display:flex;gap:10px;flex-wrap:wrap;margin-bottom:16px">
        <div style="background:rgba(0,200,255,0.08);border:1px solid rgba(0,200,255,0.2);border-radius:14px;padding:12px 18px;flex:1;min-width:120px;text-align:center">
          <div style="font-size:0.7rem;color:var(--text-muted);text-transform:uppercase;letter-spacing:1px">Posici√≥n actual</div>
          <div style="font-size:1.4rem;font-weight:900;color:var(--primary)">M${progreso.mesActual}¬∑S${progreso.semanaActual}¬∑D${progreso.diaActual}</div>
          <div style="font-size:0.75rem;color:var(--text-muted)">${rutina?rutina.nombre:'Sin rutina activa'}</div>
        </div>
        <div style="background:rgba(0,229,160,0.08);border:1px solid rgba(0,229,160,0.2);border-radius:14px;padding:12px 18px;flex:1;min-width:120px;text-align:center">
          <div style="font-size:0.7rem;color:var(--text-muted);text-transform:uppercase;letter-spacing:1px">Sesiones totales</div>
          <div style="font-size:1.4rem;font-weight:900;color:#00e5a0">${sesiones.length}</div>
          <div style="font-size:0.75rem;color:var(--text-muted)">Completadas</div>
        </div>
      </div>` : `<div style="margin-bottom:16px;padding:12px;background:rgba(255,107,53,0.08);border:1px solid rgba(255,107,53,0.2);border-radius:12px;font-size:0.85rem;color:#ff6b35">‚ö†Ô∏è Sin progreso registrado a√∫n</div>`;

    // Timeline de sesiones paginada (10 por p√°gina)
    const SES_PER_PAGE = 10;
    const _sesPage = window._atletaSesPage || 0;
    window._atletaSesPage = _sesPage;
    const sesSlice = sesiones.slice(_sesPage * SES_PER_PAGE, (_sesPage + 1) * SES_PER_PAGE);
    const totalSesPages = Math.ceil(sesiones.length / SES_PER_PAGE);

    const timeline = sesiones.length ? `
      <div>
        <div style="display:flex;gap:6px;flex-wrap:wrap;margin-bottom:10px">
          ${sesSlice.map(s=>{
            const ts = s.fecha||s.fechaFin||s.fechaInicio||0;
            const fecha = ts ? new Date(ts).toLocaleDateString('es-CO',{day:'2-digit',month:'short'}) : '‚Äî';
            const isActive = s._key === st.sesId;
            return `<button onclick="window._atletaState.sesId='${s._key}';window._atletaRefresh()" style="
              padding:5px 10px;border-radius:20px;border:1px solid ${isActive?'var(--primary)':'rgba(255,255,255,0.12)'};
              background:${isActive?'rgba(0,200,255,0.15)':'rgba(255,255,255,0.04)'};
              color:${isActive?'var(--primary)':'var(--text-muted)'};
              font-size:0.72rem;font-family:'Exo 2',sans-serif;cursor:pointer;white-space:nowrap;
              font-weight:${isActive?'700':'400'}"
            >M${s.mes}¬∑S${s.semana}¬∑D${s.dia}<br><span style="font-size:0.62rem">${fecha}</span></button>`;
          }).join('')}
        </div>
        ${totalSesPages > 1 ? `
        <div style="display:flex;align-items:center;gap:6px;margin-top:8px;flex-wrap:wrap">
          <span style="font-size:0.72rem;color:var(--text-muted)">Sesiones ${_sesPage*SES_PER_PAGE+1}‚Äì${Math.min((_sesPage+1)*SES_PER_PAGE,sesiones.length)} de ${sesiones.length}</span>
          <div style="display:flex;gap:4px;margin-left:auto">
            ${_sesPage>0?`<button onclick="window._atletaSesPage=${_sesPage-1};window._atletaRefresh()" style="padding:4px 10px;border-radius:8px;border:1px solid rgba(255,255,255,0.12);background:rgba(255,255,255,0.06);color:var(--text-muted);font-family:'Exo 2',sans-serif;font-size:0.78rem;cursor:pointer">‚Äπ Ant</button>`:''}
            ${_sesPage<totalSesPages-1?`<button onclick="window._atletaSesPage=${_sesPage+1};window._atletaRefresh()" style="padding:4px 10px;border-radius:8px;border:1px solid rgba(0,200,255,0.3);background:rgba(0,200,255,0.1);color:var(--primary);font-family:'Exo 2',sans-serif;font-size:0.78rem;cursor:pointer">Sig ‚Ä∫</button>`:''}
          </div>
        </div>` : ''}
      </div>` : `<div style="color:var(--text-muted);font-size:0.85rem;margin-bottom:16px">Sin sesiones a√∫n</div>`;

    // Detalle sesi√≥n seleccionada
    let detalleSesion = '';
    if(sesActual) {
      const ts = sesActual.fecha||sesActual.fechaFin||sesActual.fechaInicio||0;
      const fechaStr = ts ? new Date(ts).toLocaleDateString('es-CO',{day:'2-digit',month:'long',year:'numeric',hour:'2-digit',minute:'2-digit'}) : '‚Äî';
      const ejercicios = Object.values(sesActual.ejerciciosCompletados||{});
      const ejRows = ejercicios.map(ec => {
        const ejInfo = ejs[ec.ejercicioId]||{};
        const esBiext = ec.series?.some(s=>s.rirRpeIzq!=null);
        const serieRows = (ec.series||[]).map((s,i)=>{
          const rpeCell = esBiext
            ? `<td style="text-align:center"><span style="color:#00e5a0">${s.rirRpeIzq??'‚Äî'}</span>/<span style="color:#ff6b35">${s.rirRpeDer??'‚Äî'}</span></td>`
            : `<td style="text-align:center;color:#a78bfa">${s.rirRpe??'‚Äî'}</td>`;
          const repsCell = esBiext
            ? `<td style="padding:5px 8px;text-align:center"><span style="color:#00e5a0">${s.repsIzq??s.reps??'‚Äî'}</span>/<span style="color:#ff6b35">${s.repsDer??s.reps??'‚Äî'}</span></td>`
            : `<td style="padding:5px 8px;text-align:center">${s.reps??'‚Äî'}</td>`;
          return `<tr style="border-bottom:1px solid rgba(255,255,255,0.04)">
            <td style="padding:5px 8px;text-align:center;color:var(--primary)">${i+1}</td>
            ${repsCell}
            <td style="padding:5px 8px;text-align:center">${s.peso?s.peso+' kg':'‚Äî'}</td>
            ${rpeCell}
            <td style="padding:5px 8px;font-size:0.72rem;color:var(--text-muted);font-style:italic">${s.comentario||''}</td>
          </tr>`;
        }).join('');
        const metodoH = esBiext ? `Izq/Der ${user.metodo||'RPE'}` : (user.metodo||'RPE');
        return `<div style="margin-bottom:14px">
          <div style="font-weight:700;font-size:0.9rem;margin-bottom:6px;color:#e8f4ff">${ejInfo.nombre||ec.ejercicioId}${ec.metodo?`<span style="margin-left:8px;font-size:0.68rem;background:rgba(123,47,255,0.2);color:#c084fc;border:1px solid rgba(123,47,255,0.4);border-radius:20px;padding:2px 8px;font-weight:700">‚ö° ${ec.metodo}</span>`:''}</div>
          <div style="overflow-x:auto">
            <table style="width:100%;border-collapse:collapse;font-size:0.83rem">
              <thead><tr style="border-bottom:1px solid rgba(255,255,255,0.1)">
                <th style="padding:4px 8px;color:var(--text-muted);font-weight:600;font-size:0.7rem">#</th>
                <th style="padding:4px 8px;color:var(--text-muted);font-weight:600;font-size:0.7rem">${esBiext?'REPS Izq/Der':'REPS'}</th>
                <th style="padding:4px 8px;color:var(--text-muted);font-weight:600;font-size:0.7rem">PESO</th>
                <th style="padding:4px 8px;color:#a78bfa;font-weight:600;font-size:0.7rem">${metodoH}</th>
                <th style="padding:4px 8px;color:var(--text-muted);font-weight:600;font-size:0.7rem">NOTA</th>
              </tr></thead>
              <tbody style="color:#e8f4ff">${serieRows}</tbody>
            </table>
          </div>
        </div>`;
      }).join('<hr style="border:none;border-top:1px solid rgba(255,255,255,0.06);margin:10px 0">');

      detalleSesion = `
        <div style="background:rgba(0,0,0,0.25);border:1px solid var(--glass-border);border-radius:16px;padding:16px">
          <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;flex-wrap:wrap;gap:8px">
            <div>
              <span style="font-weight:700;color:var(--primary)">M${sesActual.mes}¬∑S${sesActual.semana}¬∑D${sesActual.dia}</span>
              <span style="font-size:0.78rem;color:var(--text-muted);margin-left:8px">${fechaStr}</span>
            </div>
            <div style="display:flex;gap:6px;align-items:center;flex-wrap:wrap">
              <span style="font-size:0.75rem;background:rgba(255,107,53,0.15);border:1px solid rgba(255,107,53,0.3);border-radius:8px;padding:3px 8px;color:#ff6b35">
                üòì Fatiga fin: ${sesActual.nivelCansancioFin??'‚Äî'}/10
              </span>
              <button onclick="window._registrarComoAdmin('${uid}')" style="
                padding:6px 12px;background:rgba(123,47,255,0.2);border:1px solid rgba(123,47,255,0.4);
                border-radius:10px;color:#a78bfa;font-family:'Exo 2',sans-serif;font-size:0.78rem;
                font-weight:600;cursor:pointer">
                ‚úèÔ∏è Registrar sesi√≥n
              </button>
            </div>
          </div>
          ${ejercicios.length ? ejRows : '<div style="color:var(--text-muted);font-size:0.85rem;text-align:center;padding:20px">Sin ejercicios registrados</div>'}
        </div>`;
    }

    container.innerHTML = `
      <div style="margin-bottom:16px">
        <div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap">
          <div style="flex:1;min-width:200px">
            <label style="font-size:0.72rem;color:var(--text-muted);text-transform:uppercase;letter-spacing:1px;display:block;margin-bottom:6px">Atleta</label>
            <select class="glass-input" onchange="window._atletaState.uid=this.value;window._atletaState.sesId=null;window._atletaSesPage=0;window._atletaRefresh()">${atletaOpts}</select>
          </div>
          <button onclick="window._registrarComoAdmin('${uid}')" style="
            margin-top:18px;padding:10px 16px;background:linear-gradient(135deg,rgba(123,47,255,0.3),rgba(0,200,255,0.2));
            border:1px solid rgba(123,47,255,0.5);border-radius:12px;color:#e8f4ff;
            font-family:'Exo 2',sans-serif;font-size:0.85rem;font-weight:700;cursor:pointer;white-space:nowrap">
            ‚ûï Nueva sesi√≥n para este atleta
          </button>
        </div>
      </div>
      ${posCard}
      <div class="glass-panel" style="padding:16px;margin-bottom:16px">
        <div style="font-size:0.75rem;color:var(--text-muted);text-transform:uppercase;letter-spacing:1px;margin-bottom:10px">üìÖ Sesiones recientes (toca para ver detalle)</div>
        ${timeline}
      </div>
      ${detalleSesion ? `<div class="glass-panel" style="padding:16px"><div style="font-size:0.75rem;color:var(--text-muted);text-transform:uppercase;letter-spacing:1px;margin-bottom:12px">üìã Detalle de sesi√≥n</div>${detalleSesion}</div>` : ''}
    `;
  };

  window._atletaRefresh = () => { window._atletaSesPage = 0; renderVista(); };
  await renderVista();
}

// ‚îÄ‚îÄ Abrir modal de registro de sesi√≥n como admin ‚îÄ‚îÄ
window._registrarComoAdmin = async (targetUid) => {
  const [usSnap, rutSnap, ejSnap, histSnap] = await Promise.all([
    get(ref(db,`usuarios/${targetUid}`)),
    get(ref(db,'rutinas')),
    get(ref(db,'ejercicios')),
    get(ref(db,`sesiones/${targetUid}/historial`))
  ]);
  const user    = usSnap.val()||{};
  const ruts    = rutSnap.val()||{};
  const ejs     = ejSnap.val()||{};
  const hist    = histSnap.val()||{};
  const rutEntry = Object.entries(ruts).find(([,r])=>r.usuario===targetUid && r.activa);
  if(!rutEntry) return Swal.fire({icon:'warning',title:'Sin rutina activa',text:'Este atleta no tiene una rutina activa asignada.',background:'rgba(10,20,40,0.95)',color:'#e8f4ff',confirmButtonColor:'#00c8ff'});

  const [rutinaId, rutina] = rutEntry;
  const progSnap = await get(ref(db,`sesiones/${targetUid}/progreso`));
  const progreso = progSnap.val()||{mesActual:1,semanaActual:1,diaActual:1};
  const { mesActual=1, semanaActual=1, diaActual=1 } = progreso;

  // Construir lista de todos los d√≠as de la rutina con su estado
  const meses = rutina.meses||{};
  const sesionesHechas = new Set(
    Object.values(hist).map(s => `${s.mes}-${s.semana}-${s.dia}`)
  );

  const diasDisponibles = [];
  Object.keys(meses).sort((a,b)=>a-b).forEach(m => {
    const semanas = meses[m]?.semanas||{};
    Object.keys(semanas).sort((a,b)=>a-b).forEach(s => {
      const dias = semanas[s]?.dias||{};
      [1,2,3,4,5].forEach(d => {
        const ejsCount = Object.keys(dias[d]?.ejercicios||{}).length;
        if(ejsCount > 0) {
          const key = `${m}-${s}-${d}`;
          const hecho = sesionesHechas.has(key);
          const esSiguiente = +m===mesActual && +s===semanaActual && +d===diaActual;
          diasDisponibles.push({ m:+m, s:+s, d:+d, ejsCount, hecho, esSiguiente });
        }
      });
    });
  });

  if(!diasDisponibles.length) return Swal.fire({icon:'info',title:'Sin d√≠as configurados',text:'La rutina no tiene d√≠as con ejercicios.',background:'rgba(10,20,40,0.95)',color:'#e8f4ff',confirmButtonColor:'#00c8ff'});

  // Mostrar selector de d√≠a antes de abrir el formulario
  _mostrarSelectorDia(targetUid, rutinaId, rutina, ejs, user, progreso, diasDisponibles, hist);
};

// ‚îÄ‚îÄ Selector de d√≠a ‚îÄ‚îÄ
window._mostrarSelectorDia = (targetUid, rutinaId, rutina, ejs, user, progreso, diasDisponibles, hist) => {
  const { mesActual, semanaActual, diaActual } = progreso;

  // Guardar contexto ANTES de mostrar el overlay, para que _iniciarAdminSesionDia lo encuentre
  window._adminSesionCtx = { targetUid, rutinaId, rutina, ejs, user, progreso, hist };

  const filas = [...diasDisponibles].reverse().map(({m,s,d,ejsCount,hecho,esSiguiente}) => {
    let badge = '';
    let rowStyle = 'padding:10px 14px;border-radius:12px;margin-bottom:6px;cursor:pointer;display:flex;align-items:center;justify-content:space-between;border:1px solid;transition:all 0.2s ease;';
    if(hecho) {
      // Hecho siempre tiene prioridad visual, incluso si tambi√©n es el "siguiente"
      rowStyle += 'background:rgba(0,229,160,0.06);border-color:rgba(0,229,160,0.2);opacity:0.7;';
      badge = '<span style="font-size:0.7rem;background:rgba(0,229,160,0.15);color:var(--success);border:1px solid rgba(0,229,160,0.3);border-radius:20px;padding:2px 10px">‚úÖ Hecho</span>';
    } else if(esSiguiente) {
      rowStyle += 'background:rgba(0,200,255,0.12);border-color:rgba(0,200,255,0.5);';
      badge = '<span style="font-size:0.7rem;background:rgba(0,200,255,0.2);color:var(--primary);border:1px solid rgba(0,200,255,0.4);border-radius:20px;padding:2px 10px;font-weight:700">‚û°Ô∏è SIGUIENTE</span>';
    } else {
      rowStyle += 'background:rgba(255,255,255,0.04);border-color:rgba(255,255,255,0.08);';
      badge = '<span style="font-size:0.7rem;background:rgba(255,255,255,0.06);color:var(--text-muted);border:1px solid rgba(255,255,255,0.1);border-radius:20px;padding:2px 10px">‚è≥ Pendiente</span>';
    }
    return `
      <div style="${rowStyle}" onclick="window._iniciarAdminSesionDia('${targetUid}','${rutinaId}',${m},${s},${d})">
        <div style="display:flex;align-items:center;gap:12px">
          <span style="font-size:1rem;font-weight:800;color:${hecho?'var(--success)':esSiguiente?'var(--primary)':'var(--text-muted)'}">M${m}¬∑S${s}¬∑D${d}</span>
          <span style="font-size:0.75rem;color:var(--text-muted)">${ejsCount} ejercicio${ejsCount!==1?'s':''}</span>
        </div>
        ${badge}
      </div>`;
  }).join('');

  showOverlay(`
    <div class="overlay-header">
      <span class="overlay-title">üìÖ Selecciona el d√≠a a registrar ‚Äî ${user.nombres}</span>
      <button class="btn-close" onclick="closeOverlay()">‚úï</button>
    </div>
    <div style="font-size:0.8rem;color:var(--text-muted);margin-bottom:14px">
      El d√≠a marcado como <strong style="color:var(--primary)">‚û°Ô∏è SIGUIENTE</strong> es el que corresponde seg√∫n el progreso actual del atleta.
    </div>
    <div style="max-height:60vh;overflow-y:auto;padding-right:4px">
      ${filas}
    </div>
  `);

  // (contexto ya guardado al inicio de esta funci√≥n)
};

window._iniciarAdminSesionDia = (targetUid, rutinaId, m, s, d) => {
  closeOverlay();
  const { rutina, ejs, user, progreso, hist } = window._adminSesionCtx;
  const diaData = rutina.meses?.[m]?.semanas?.[s]?.dias?.[d];
  const ejsDia  = Object.values(diaData?.ejercicios||{});

  if(!ejsDia.length) return Swal.fire({icon:'info',title:'D√≠a sin ejercicios',text:`M${m}¬∑S${s}¬∑D${d} no tiene ejercicios configurados.`,background:'rgba(10,20,40,0.95)',color:'#e8f4ff',confirmButtonColor:'#00c8ff'});

  window._adminSesion = {
    targetUid, rutinaId,
    mesActual: m, semanaActual: s, diaActual: d,
    ejsDia, ejs, user, rutina, progreso, hist,
    ejercicioActual: 0, ejerciciosCompletados: {}, fechaInicio: Date.now()
  };
  _renderAdminEjercicio();
};

window._renderAdminEjercicio = function _renderAdminEjercicio() {
  const s = window._adminSesion;
  const { ejsDia, ejs, user, ejercicioActual, mesActual, semanaActual, diaActual, hist } = s;
  if(ejercicioActual >= ejsDia.length) { _finalizarAdminSesion(); return; }

  const ejConfig = ejsDia[ejercicioActual];
  const ejInfo   = ejs[ejConfig.ejercicioId]||{};
  const total    = ejsDia.length;
  const current  = ejercicioActual + 1;
  const metodo   = user.metodo||'RPE';
  const esBiext  = ejInfo.biextremidad === true;
  const metodoLabel = metodo==='RPE' ? 'RPE (1-10)' : 'RIR (-1‚Üí6)';
  const metodoMin   = metodo==='RPE' ? 1 : -1;
  const metodoMax   = metodo==='RPE' ? 10 : 6;

  // ‚îÄ‚îÄ Estilos compartidos para tablas ‚îÄ‚îÄ
  const thSt = 'padding:4px 6px;font-size:0.65rem;font-weight:600;text-align:left;text-transform:uppercase;letter-spacing:0.5px;color:rgba(167,139,250,0.6);';
  const tdSt = 'padding:5px 6px;font-size:0.82rem;font-weight:700;color:#e8f4ff;';

  // ‚îÄ‚îÄ Banner "√∫ltima vez" ‚îÄ‚îÄ
  let ultimoBanner = '';
  if(hist) {
    const sesiones = Object.values(hist).sort((a,b) => (b.fechaFin||b.fechaInicio||b.fecha||0) - (a.fechaFin||a.fechaInicio||a.fecha||0));
    const ultimoReg = sesiones.reduce((found, ses) => {
      if(found) return found;
      const completados = Object.values(ses.ejerciciosCompletados||{});
      const match = completados.find(ec => ec.ejercicioId === ejConfig.ejercicioId);
      const sesDate = ses.fechaFin||ses.fechaInicio||ses.fecha||0;
      return match ? { series: match.series||[], fecha: sesDate, mes: ses.mes, semana: ses.semana, dia: ses.dia } : null;
    }, null);

    if(ultimoReg) {
      const { series, fecha, mes, semana, dia } = ultimoReg;
      const esBiextUlt = series.some(s => s.rirRpeIzq != null);
      const fechaStr   = new Date(fecha).toLocaleDateString('es-CO',{day:'2-digit',month:'short'});
      const thRpe = esBiextUlt
        ? `<th style="${thSt}color:#00e5a0">Izq reps</th><th style="${thSt}color:#ff6b35">Der reps</th><th style="${thSt}color:#00e5a0">Izq ${metodo}</th><th style="${thSt}color:#ff6b35">Der ${metodo}</th>`
        : `<th style="${thSt}color:#a78bfa">${metodo}</th>`;

      const filas = series.map((s,i) => {
        const rpeCell = esBiextUlt
          ? `<td style="${tdSt}"><span style="color:#00e5a0">${s.repsIzq??s.reps??'‚Äî'}</span></td><td style="${tdSt}"><span style="color:#ff6b35">${s.repsDer??s.reps??'‚Äî'}</span></td><td style="${tdSt}"><span style="color:#00e5a0">${s.rirRpeIzq??'‚Äî'}</span></td><td style="${tdSt}"><span style="color:#ff6b35">${s.rirRpeDer??'‚Äî'}</span></td>`
          : `<td style="${tdSt};color:#a78bfa">${s.rirRpe??'‚Äî'}</td>`;
        return `
          <tr style="border-bottom:1px solid rgba(255,255,255,0.05)">
            <td style="${tdSt};color:#a78bfa">${i+1}</td>
            ${esBiextUlt ? '' : `<td style="${tdSt}">${s.reps??'‚Äî'}</td>`}
            <td style="${tdSt}">${s.peso ? s.peso+' kg' : '‚Äî'}</td>
            ${rpeCell}
            <td style="padding:5px 6px;font-size:0.7rem;font-style:italic;color:rgba(167,139,250,0.7)">${s.comentario ? 'üí¨ '+s.comentario : ''}</td>
          </tr>`;
      }).join('');

      ultimoBanner = `
        <div style="background:rgba(123,47,255,0.08);border:1px solid rgba(123,47,255,0.3);border-radius:12px;padding:10px 14px;margin-bottom:14px">
          <div style="font-size:0.65rem;color:#a78bfa;text-transform:uppercase;letter-spacing:1px;margin-bottom:8px;display:flex;align-items:center;gap:6px">
            <span>üìñ</span> √öltima vez ‚Äî M${mes}¬∑S${semana}¬∑D${dia} ¬∑ ${fechaStr}
          </div>
          <div style="overflow-x:auto">
            <table style="width:100%;border-collapse:collapse">
              <thead><tr style="border-bottom:1px solid rgba(123,47,255,0.3)">
                <th style="${thSt}">#</th>
                ${esBiextUlt ? '' : `<th style="${thSt}">Reps</th>`}
                <th style="${thSt}">Peso</th>
                ${thRpe}
                <th style="${thSt}">Nota</th>
              </tr></thead>
              <tbody>${filas}</tbody>
            </table>
          </div>
        </div>`;
    }
  }

  const seriesRows = Array.from({length:ejConfig.series||3},(_,i)=>`
    <div style="display:flex;gap:8px;align-items:flex-start;padding:8px 0;border-bottom:1px solid rgba(255,255,255,0.05);flex-wrap:wrap">
      <div style="width:24px;text-align:center;font-weight:700;color:var(--primary);padding-top:28px">${i+1}</div>
      <div style="display:flex;gap:6px;flex:1;flex-wrap:wrap">
        ${esBiext ? `
        <div style="display:flex;flex-direction:column;gap:3px;width:100%;background:rgba(0,229,160,0.05);border-radius:10px;padding:8px;border:1px solid rgba(0,229,160,0.15)">
          <div style="font-size:0.65rem;color:#00e5a0;font-weight:700;text-transform:uppercase;letter-spacing:0.5px;margin-bottom:4px">ü¶æ Reps por lado</div>
          <div style="display:flex;gap:8px">
            <div style="display:flex;flex-direction:column;gap:3px;flex:1">
              <label style="font-size:0.65rem;color:#00e5a0">Izq reps</label>
              <input type="number" id="adm_reps_izq_${i}" value="${ejConfig.repsMin||0}" min="0"
                style="background:rgba(0,229,160,0.08);border:1px solid rgba(0,229,160,0.3);border-radius:8px;padding:6px 8px;color:#e8f4ff;font-family:'Exo 2',sans-serif;width:100%">
            </div>
            <div style="display:flex;flex-direction:column;gap:3px;flex:1">
              <label style="font-size:0.65rem;color:#ff6b35">Der reps</label>
              <input type="number" id="adm_reps_der_${i}" value="${ejConfig.repsMin||0}" min="0"
                style="background:rgba(255,107,53,0.08);border:1px solid rgba(255,107,53,0.3);border-radius:8px;padding:6px 8px;color:#e8f4ff;font-family:'Exo 2',sans-serif;width:100%">
            </div>
          </div>
        </div>
        <div style="display:none"><input type="number" id="adm_reps_${i}" value="${ejConfig.repsMin||0}"></div>
        ` : `
        <div style="display:flex;flex-direction:column;gap:3px;flex:1;min-width:60px">
          <label style="font-size:0.68rem;color:var(--text-muted)">Reps</label>
          <input type="number" id="adm_reps_${i}" value="${ejConfig.repsMin||0}" min="0"
            style="background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:8px;padding:6px 8px;color:#e8f4ff;font-family:'Exo 2',sans-serif;width:100%">
        </div>`}
        <div style="display:flex;flex-direction:column;gap:3px;flex:1;min-width:60px">
          <label style="font-size:0.68rem;color:var(--text-muted)">Peso kg</label>
          <input type="number" id="adm_peso_${i}" value="${ejConfig.peso||0}" min="0" step="0.5"
            style="background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:8px;padding:6px 8px;color:#e8f4ff;font-family:'Exo 2',sans-serif;width:100%">
        </div>
        ${esBiext ? `
        <div style="display:flex;flex-direction:column;gap:3px;flex:1;min-width:60px">
          <label style="font-size:0.68rem;color:#00e5a0">Izq ${metodo}</label>
          <input type="number" id="adm_rpe_izq_${i}" value="${ejConfig.rirRpe||0}" min="${metodoMin}" max="${metodoMax}"
            style="background:rgba(0,229,160,0.06);border:1px solid rgba(0,229,160,0.3);border-radius:8px;padding:6px 8px;color:#e8f4ff;font-family:'Exo 2',sans-serif;width:100%">
        </div>
        <div style="display:flex;flex-direction:column;gap:3px;flex:1;min-width:60px">
          <label style="font-size:0.68rem;color:#ff6b35">Der ${metodo}</label>
          <input type="number" id="adm_rpe_der_${i}" value="${ejConfig.rirRpe||0}" min="${metodoMin}" max="${metodoMax}"
            style="background:rgba(255,107,53,0.06);border:1px solid rgba(255,107,53,0.3);border-radius:8px;padding:6px 8px;color:#e8f4ff;font-family:'Exo 2',sans-serif;width:100%">
        </div>` : `
        <div style="display:flex;flex-direction:column;gap:3px;flex:1;min-width:60px">
          <label style="font-size:0.68rem;color:#a78bfa">${metodoLabel}</label>
          <input type="number" id="adm_rpe_${i}" value="${ejConfig.rirRpe||0}" min="${metodoMin}" max="${metodoMax}"
            style="background:rgba(123,47,255,0.06);border:1px solid rgba(123,47,255,0.3);border-radius:8px;padding:6px 8px;color:#e8f4ff;font-family:'Exo 2',sans-serif;width:100%">
        </div>`}
      </div>
      <div style="width:100%;padding-left:32px;margin-top:4px">
        <input type="text" id="adm_comentario_${i}" placeholder="Comentario serie ${i+1} (opcional)..."
          style="width:100%;background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.07);border-radius:8px;padding:6px 10px;color:rgba(232,244,255,0.5);font-family:'Exo 2',sans-serif;font-size:0.78rem;outline:none;transition:all 0.2s"
          onfocus="this.style.borderColor='rgba(123,47,255,0.4)';this.style.color='#e8f4ff';this.style.background='rgba(123,47,255,0.05)'"
          onblur="this.style.borderColor='rgba(255,255,255,0.07)';this.style.color='rgba(232,244,255,0.5)';this.style.background='rgba(255,255,255,0.03)'">
      </div>
    </div>
  `).join('');

  showOverlay(`
    <div class="overlay-header">
      <span class="overlay-title">‚úèÔ∏è ${user.nombres} ‚Äî M${mesActual}¬∑S${semanaActual}¬∑D${diaActual}</span>
      <button class="btn-close" onclick="closeOverlay()">‚úï</button>
    </div>
    <div style="margin-bottom:14px">
      <div style="display:flex;justify-content:space-between;margin-bottom:6px">
        <span style="font-size:0.8rem;color:var(--text-muted)">Ejercicio ${current} de ${total}</span>
        <span style="font-size:0.8rem;color:var(--primary);font-weight:600">${Math.round(((current-1)/total)*100)}%</span>
      </div>
      <div style="height:4px;background:rgba(255,255,255,0.1);border-radius:2px">
        <div style="height:100%;background:var(--primary);border-radius:2px;width:${Math.round(((current-1)/total)*100)}%"></div>
      </div>
    </div>
    <div style="font-weight:700;font-size:1.05rem;margin-bottom:4px">${ejInfo.nombre||'Ejercicio'}</div>
    <div style="font-size:0.78rem;color:var(--text-muted);margin-bottom:14px">
      ${ejConfig.series} series ¬∑ ${ejConfig.repsMin}-${ejConfig.repsMax} reps ¬∑ ${ejConfig.peso}kg ¬∑ ${metodo} ${ejConfig.rirRpe} ¬∑ ‚è± ${ejConfig.descanso}s
    </div>
    ${ultimoBanner}
    <div>${seriesRows}</div>
    <div style="display:flex;gap:10px;margin-top:18px">
      ${ejercicioActual>0?`<button class="btn btn-secondary" onclick="window._adminSesion.ejercicioActual--;_renderAdminEjercicio()">‚Üê Anterior</button>`:''}
      <button class="btn btn-primary" style="flex:1" onclick="_completarAdminEj()">
        ${current<total?'Siguiente ejercicio ‚Üí':'‚úÖ Finalizar sesi√≥n'}
      </button>
    </div>
  `);
}

window._completarAdminEj = () => {
  const s = window._adminSesion;
  const ejConfig = s.ejsDia[s.ejercicioActual];
  const ejInfo   = s.ejs[ejConfig.ejercicioId]||{};
  const n        = ejConfig.series||3;
  const esBiext  = ejInfo.biextremidad === true;
  const series   = Array.from({length:n},(_,i)=>{
    const base = {
      reps: +document.getElementById(`adm_reps_${i}`)?.value||0,
      peso: +document.getElementById(`adm_peso_${i}`)?.value||0,
      completada: true,
      comentario: document.getElementById(`adm_comentario_${i}`)?.value?.trim()||''
    };
    if(esBiext) {
      base.rirRpeIzq = +document.getElementById(`adm_rpe_izq_${i}`)?.value||0;
      base.rirRpeDer = +document.getElementById(`adm_rpe_der_${i}`)?.value||0;
      base.rirRpe    = Math.round(((base.rirRpeIzq||0)+(base.rirRpeDer||0))/2);
      const repsIzqVal = +document.getElementById(`adm_reps_izq_${i}`)?.value;
      const repsDerVal = +document.getElementById(`adm_reps_der_${i}`)?.value;
      if(!isNaN(repsIzqVal)) base.repsIzq = repsIzqVal;
      if(!isNaN(repsDerVal)) base.repsDer = repsDerVal;
      if(base.repsIzq != null && base.repsDer != null) {
        base.reps = Math.round((base.repsIzq + base.repsDer) / 2);
      } else {
        base.reps = base.repsIzq ?? base.repsDer ?? 0;
      }
    } else {
      base.rirRpe = +document.getElementById(`adm_rpe_${i}`)?.value||0;
    }
    return base;
  });
  s.ejerciciosCompletados[s.ejercicioActual] = { ejercicioId: ejConfig.ejercicioId, series };
  s.ejercicioActual++;
  _renderAdminEjercicio();
};

async function _finalizarAdminSesion() {
  const s = window._adminSesion;

  // Pedir nivel de cansancio UNA sola vez al finalizar la sesi√≥n
  const nivelCansancio = await new Promise(resolve => {
    const colorsPost = ['#00c8ff','#00e5a0','#4ade80','#a3e635','#ffd60a','#ff6b35','#f97316','#ef4444','#dc2626','#b91c1c'];
    const emojisPost = ['üòä','üôÇ','üòê','üòë','üòî','üò∞','üòì','ü•µ','üòµ','üíÄ'];
    const labelsPost = ['1 - Nada cansado','2 - Muy poco cansado','3 - Poco cansado','4 - Algo cansado','5 - Moderadamente cansado','6 - Bastante cansado','7 - Muy cansado','8 - Agotado','9 - Muy agotado','10 - Totalmente destruido'];
    let selected = null;

    const dotsHtml = emojisPost.map((e,i) =>
      `<div class="fatigue-dot-adm" data-val="${i+1}" style="flex:1;height:50px;border-radius:10px;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:1.3rem;transition:all 0.15s ease;background:rgba(255,255,255,0.04);border:1px solid rgba(255,255,255,0.08)" onclick="admFatigaSelect(${i+1})">${e}</div>`
    ).join('');

    showOverlay(`
      <div class="overlay-header">
        <span class="overlay-title">üòì Cansancio al finalizar ‚Äî ${s.user.nombres}</span>
      </div>
      <div style="font-size:0.82rem;color:var(--text-muted);margin-bottom:16px;text-align:center">¬øQu√© tan cansado qued√≥ el atleta al terminar la sesi√≥n?</div>
      <div style="display:flex;justify-content:space-between;font-size:0.72rem;color:var(--text-muted);margin-bottom:8px">
        <span>üòä Nada cansado</span><span>Totalmente agotado üíÄ</span>
      </div>
      <div style="display:flex;gap:4px;margin-bottom:10px" id="adm_fatigue_final">${dotsHtml}</div>
      <div style="text-align:center;font-size:0.85rem;font-weight:600;color:var(--text-muted);margin-bottom:18px" id="adm_fatigue_final_label">Selecciona una opci√≥n</div>
      <button class="btn btn-success btn-full" id="adm_fatigue_confirm" onclick="admFatigaConfirm()" disabled style="opacity:0.5">‚úÖ Guardar sesi√≥n</button>
    `);

    window.admFatigaSelect = (val) => {
      selected = val;
      document.querySelectorAll('.fatigue-dot-adm').forEach((d,i) => {
        const isSelected = (i+1) === val;
        d.style.background  = isSelected ? colorsPost[i] : 'rgba(255,255,255,0.04)';
        d.style.border      = isSelected ? `2px solid ${colorsPost[i]}` : '1px solid rgba(255,255,255,0.08)';
        d.style.transform   = isSelected ? 'scale(1.12)' : 'scale(1)';
        d.style.boxShadow   = isSelected ? `0 0 12px ${colorsPost[i]}88` : 'none';
      });
      const lbl = document.getElementById('adm_fatigue_final_label');
      if(lbl) { lbl.textContent = labelsPost[val-1]; lbl.style.color = colorsPost[val-1]; }
      const btn = document.getElementById('adm_fatigue_confirm');
      if(btn) { btn.disabled = false; btn.style.opacity = '1'; }
    };
    window.admFatigaConfirm = () => {
      if(selected !== null) { closeOverlay(); resolve(selected); }
    };
  });

  closeOverlay();
  const { targetUid, rutinaId, mesActual, semanaActual, diaActual, ejerciciosCompletados, fechaInicio } = s;
  const now = Date.now();
  const sesId = `ses_${now}`;
  const sesData = {
    mes: mesActual, semana: semanaActual, dia: diaActual,
    rutinaActiva: rutinaId,
    fechaInicio, fechaFin: now, fecha: now,
    nivelCansancioInicio: 0, nivelCansancioFin: nivelCansancio,
    ejerciciosCompletados,
    registradoPorAdmin: true
  };
  await set(ref(db,`sesiones/${targetUid}/historial/${sesId}`), sesData);

  // Avanzar progreso: solo si el d√≠a registrado ES el d√≠a del progreso actual,
  // o si el d√≠a registrado est√° DESPU√âS del progreso actual (para no retroceder).
  const prog = s.progreso;
  const progKey  = prog.mesActual * 10000 + prog.semanaActual * 100 + prog.diaActual;
  const regKey   = mesActual     * 10000 + semanaActual     * 100 + diaActual;

  if(regKey >= progKey) {
    // Avanzar desde el d√≠a que se registr√≥, no desde el progreso guardado
    let m = mesActual, sem = semanaActual, dia = diaActual;
    dia++; if(dia>5){dia=1;sem++;} if(sem>4){sem=1;m++;}
    const maxMes = Math.max(...Object.keys(s.rutina.meses||{1:{}}).map(Number));
    if(m>maxMes){m=maxMes;sem=4;dia=5;}
    await set(ref(db,`sesiones/${targetUid}/progreso`), { rutinaActiva:rutinaId, mesActual:m, semanaActual:sem, diaActual:dia });
  }
  // Si registr√≥ un d√≠a ANTERIOR al progreso actual, no tocamos el progreso

  // Guardar estado para restaurar la vista de atletas tras el reload
  sessionStorage.setItem('saykyo_reload_page', 'atletas');
  sessionStorage.setItem('saykyo_reload_uid', targetUid);

  await Swal.fire({icon:'success',title:'‚úÖ Sesi√≥n registrada',
    text:`Sesi√≥n M${mesActual}¬∑S${semanaActual}¬∑D${diaActual} guardada para ${s.user.nombres}`,
    timer:2000,showConfirmButton:false,background:'rgba(10,20,40,0.95)',color:'#e8f4ff'});

  window.location.reload();
}

// ============ ESTAD√çSTICAS ============
async function renderEstadisticas(container) {
  const [usSnap, ejSnap, catSnap, myUids] = await Promise.all([get(ref(db,'usuarios')),get(ref(db,'ejercicios')),get(ref(db,'categorias')),getMyGroupUserUids()]);
  const users = usSnap.val()||{};
  const ejs = ejSnap.val()||{};
  const cats = catSnap.val()||{};
  const userOpts = Object.entries(users).filter(([id,u])=>u.rol!=='admin' && u.rol!=='superadmin' && myUids.has(id)).map(([id,u])=>`<option value="${id}">${u.nombres} ${u.apellidos||''}</option>`).join('');
  const ejOpts = Object.entries(ejs).map(([id,e])=>`<option value="${id}">${e.nombre}</option>`).join('');
  const catOpts = Object.entries(cats).map(([id,c])=>`<option value="${id}">${c.nombre}</option>`).join('');

  container.innerHTML = `
    <div class="glass-panel" style="margin-bottom:16px">
      <div class="panel-header"><span class="panel-title">üìä Filtros</span></div>
      <div class="panel-body">
        <div class="form-grid">
          <div class="form-group"><label>Usuario</label><select class="glass-input" id="statsUser"><option value="">Todos</option>${userOpts}</select></div>
          <div class="form-group"><label>Ejercicio</label><select class="glass-input" id="statsEj"><option value="">Todos</option>${ejOpts}</select></div>
          <div class="form-group"><label>Categor√≠a</label><select class="glass-input" id="statsCat"><option value="">Todas</option>${catOpts}</select></div>
          <div class="form-group"><label>Semana inicio</label><input class="glass-input" type="number" id="semIni" min="1" value="1"></div>
          <div class="form-group"><label>Semana fin</label><input class="glass-input" type="number" id="semFin" min="1" value="8"></div>
        </div>
        <div style="margin-top:14px">
          <button class="btn btn-primary" onclick="cargarEstadisticas()">üîç Generar Reportes</button>
        </div>
      </div>
    </div>
    <div id="chartsArea" class="stats-grid">
      <div class="stats-card"><div class="empty-state"><div class="empty-icon">üìä</div><div class="empty-text">Configura los filtros y presiona "Generar Reportes"</div></div></div>
    </div>
  `;
}

window.cargarEstadisticas = async () => {
  const userId = document.getElementById('statsUser').value;
  const ejId = document.getElementById('statsEj').value;
  const catId = document.getElementById('statsCat').value;
  const semIni = +document.getElementById('semIni').value;
  const semFin = +document.getElementById('semFin').value;

  const area = document.getElementById('chartsArea');
  area.innerHTML = '<div class="page-loading"><div class="spinner-lg"></div><span>Cargando datos...</span></div>';

  const [sesSnap, ejSnap, catSnap, usSnap, rutSnap] = await Promise.all([
    get(ref(db,'sesiones')), get(ref(db,'ejercicios')),
    get(ref(db,'categorias')), get(ref(db,'usuarios')),
    get(ref(db,'rutinas'))
  ]);
  const sesiones = sesSnap.val()||{};
  const ejs = ejSnap.val()||{};
  const cats = catSnap.val()||{};
  const users = usSnap.val()||{};

  // Build week-based data
  const buildWeekLabels = () => Array.from({length:semFin-semIni+1},(_,i)=>`Sem ${semIni+i}`);
  const labels = buildWeekLabels();

  // Collect all sessions in range
  const allSessions = [];
  Object.entries(sesiones).forEach(([uid, userData]) => {
    if(userId && uid!==userId) return;
    Object.entries(userData.historial||{}).forEach(([sid, ses]) => {
      const semAbs = (ses.mes-1)*4 + ses.semana;
      if(semAbs>=semIni && semAbs<=semFin) allSessions.push({...ses, userId:uid});
    });
  });

  // Chart 1: Carga (peso por ejercicio)
  const pesoData = {};
  allSessions.forEach(ses => {
    Object.values(ses.ejerciciosCompletados||{}).forEach(ec => {
      if(ejId && ec.ejercicioId!==ejId) return;
      const ejName = ejs[ec.ejercicioId]?.nombre||ec.ejercicioId;
      if(!pesoData[ejName]) pesoData[ejName] = Array(labels.length).fill(null).map(()=>[]);
      const semAbs = (ses.mes-1)*4+ses.semana;
      const idx = semAbs-semIni;
      if(idx>=0&&idx<labels.length) {
        (ec.series||[]).forEach(s=>pesoData[ejName][idx].push(s.peso));
      }
    });
  });
  const pesoDatasets = Object.entries(pesoData).map(([name,weeks],i) => ({
    label:name, data:weeks.map(w=>w.length?w.reduce((a,b)=>a+b,0)/w.length:null),
    borderColor:`hsl(${i*60},70%,60%)`, tension:0.4, fill:false, spanGaps:true
  }));

  // Chart 2: Intensidad RPE/RIR
  const intData = {};
  allSessions.forEach(ses => {
    Object.values(ses.ejerciciosCompletados||{}).forEach(ec => {
      if(ejId && ec.ejercicioId!==ejId) return;
      const ejName = ejs[ec.ejercicioId]?.nombre||ec.ejercicioId;
      if(!intData[ejName]) intData[ejName] = Array(labels.length).fill(null).map(()=>[]);
      const idx = (ses.mes-1)*4+ses.semana-semIni;
      if(idx>=0&&idx<labels.length) {
        (ec.series||[]).forEach(s=>{ if(s.rirRpe!=null) intData[ejName][idx].push(s.rirRpe); });
      }
    });
  });
  const intDatasets = Object.entries(intData).map(([name,weeks],i)=>({
    label:name, data:weeks.map(w=>w.length?w.reduce((a,b)=>a+b,0)/w.length:null),
    borderColor:`hsl(${i*60+120},70%,60%)`, tension:0.4, fill:false, spanGaps:true
  }));

  // Chart 3: Volumen (series por semana por categoria)
  const volData = {};
  allSessions.forEach(ses => {
    Object.values(ses.ejerciciosCompletados||{}).forEach(ec => {
      const ejCat = ejs[ec.ejercicioId]?.categoria;
      if(catId && ejCat!==catId) return;
      const catName = cats[ejCat]?.nombre||'Sin cat';
      if(!volData[catName]) volData[catName] = Array(labels.length).fill(0);
      const idx = (ses.mes-1)*4+ses.semana-semIni;
      if(idx>=0&&idx<labels.length) volData[catName][idx]+=(ec.series||[]).length;
    });
  });
  const volDatasets = Object.entries(volData).map(([name,data],i)=>({
    label:name, data, borderColor:`hsl(${i*60+240},70%,60%)`, tension:0.4, fill:false
  }));

  // Chart 4: Intensidad por sesi√≥n (dias de semana especifica)
  const sesIntData = {};
  const semAnalizar = semIni;
  allSessions.filter(s=>(s.mes-1)*4+s.semana===semAnalizar).forEach(ses => {
    const dayKey = `D√≠a ${ses.dia}`;
    if(!sesIntData[dayKey]) sesIntData[dayKey] = [];
    Object.values(ses.ejerciciosCompletados||{}).forEach(ec=>{
      (ec.series||[]).forEach(s=>{ if(s.rirRpe!=null) sesIntData[dayKey].push(s.rirRpe); });
    });
  });
  const sesIntLabels = Object.keys(sesIntData).sort();
  const sesIntVals = sesIntLabels.map(k=>sesIntData[k].length?sesIntData[k].reduce((a,b)=>a+b,0)/sesIntData[k].length:null);

  // Chart 5: Frecuencia (veces entrenado por grupo muscular por dia)
  const freqData = {};
  allSessions.forEach(ses => {
    Object.values(ses.ejerciciosCompletados||{}).forEach(ec => {
      const ejCat = ejs[ec.ejercicioId]?.categoria;
      if(catId && ejCat!==catId) return;
      const catName = cats[ejCat]?.nombre||'Sin cat';
      const dayKey = `M${ses.mes}S${ses.semana}D${ses.dia}`;
      if(!freqData[catName]) freqData[catName] = {};
      freqData[catName][dayKey] = (freqData[catName][dayKey]||0)+1;
    });
  });

  const chartOptions = {
    responsive:true, maintainAspectRatio:false,
    plugins:{legend:{labels:{color:'#e8f4ff',font:{family:'Exo 2',size:11}}}},
    scales:{x:{grid:{color:'rgba(255,255,255,0.05)'},ticks:{color:'rgba(232,244,255,0.6)'}},
            y:{grid:{color:'rgba(255,255,255,0.05)'},ticks:{color:'rgba(232,244,255,0.6)'}}}
  };

  area.innerHTML = `
    <div class="stats-card"><div style="font-weight:700;margin-bottom:12px">üìà Carga (Peso promedio por semana)</div><div class="chart-container"><canvas id="chartPeso"></canvas></div></div>
    <div class="stats-card"><div style="font-weight:700;margin-bottom:12px">üî• Intensidad RPE/RIR promedio</div><div class="chart-container"><canvas id="chartInt"></canvas></div></div>
    <div class="stats-card"><div style="font-weight:700;margin-bottom:12px">üì¶ Volumen (Series por categor√≠a)</div><div class="chart-container"><canvas id="chartVol"></canvas></div></div>
    <div class="stats-card"><div style="font-weight:700;margin-bottom:12px">‚ö° Intensidad por sesi√≥n (Sem ${semAnalizar})</div><div class="chart-container"><canvas id="chartSesInt"></canvas></div></div>
    <div class="stats-card" style="grid-column:1/-1"><div style="font-weight:700;margin-bottom:12px">üìä Resumen de sesiones</div>
      <div style="font-size:0.9rem;color:var(--text-muted)">Total sesiones analizadas: <strong style="color:var(--primary)">${allSessions.length}</strong></div>
    </div>
  `;

  // Render charts
  if(pesoDatasets.length) new Chart(document.getElementById('chartPeso'), {type:'line',data:{labels,datasets:pesoDatasets},options:chartOptions});
  else document.getElementById('chartPeso').parentElement.innerHTML += '<div class="empty-state"><div class="empty-icon">üìä</div><div class="empty-text">Sin datos</div></div>';

  if(intDatasets.length) new Chart(document.getElementById('chartInt'), {type:'line',data:{labels,datasets:intDatasets},options:chartOptions});
  else document.getElementById('chartInt').parentElement.innerHTML += '<div class="empty-state"><div class="empty-icon">üìä</div><div class="empty-text">Sin datos</div></div>';

  if(volDatasets.length) new Chart(document.getElementById('chartVol'), {type:'line',data:{labels,datasets:volDatasets},options:chartOptions});
  else document.getElementById('chartVol').parentElement.innerHTML += '<div class="empty-state"><div class="empty-icon">üìä</div><div class="empty-text">Sin datos</div></div>';

  if(sesIntVals.length) new Chart(document.getElementById('chartSesInt'), {type:'line',data:{labels:sesIntLabels,datasets:[{label:'Intensidad',data:sesIntVals,borderColor:'#00e5ff',backgroundColor:'#00e5ff',pointBackgroundColor:'#00e5ff',pointBorderColor:'#00e5ff',pointRadius:5,pointHoverRadius:7,tension:0.4,fill:false}]},options:chartOptions});
  else document.getElementById('chartSesInt').parentElement.innerHTML += '<div class="empty-state"><div class="empty-icon">üìä</div><div class="empty-text">Sin datos</div></div>';
};

// ============ ANAMNESIS ============
async function renderAnamnesis(container) {
  const [anaSnap, usSnap, myUids] = await Promise.all([get(ref(db,'anamnesis')),get(ref(db,'usuarios')), getMyGroupUserUids()]);
  const anamnesis = anaSnap.val()||{};
  const users = usSnap.val()||{};

  container.innerHTML = `
    <div class="dashboard-grid" style="margin-bottom:16px">
      ${Object.entries(users).filter(([id,u])=>u.rol!=='admin' && u.rol!=='superadmin' && myUids.has(id)).map(([uid,u])=>{
        const ana = anamnesis[uid];
        const completada = ana?.completada;
        return `
          <div class="stat-card ${completada?'':''}">
            <div style="display:flex;align-items:center;gap:10px;margin-bottom:12px">
              <img src="${u.avatar||getAvatarUrl(u.usuario)}" style="width:44px;height:44px;border-radius:50%;border:2px solid rgba(0,200,255,0.3)">
              <div>
                <div style="font-weight:700">${u.nombres} ${u.apellidos||''}</div>
                <div style="font-size:0.75rem;color:var(--text-muted)">@${u.usuario}</div>
              </div>
            </div>
            <span class="badge ${completada?'badge-active':'badge-inactive'}">${completada?'‚úÖ Completada':'‚è≥ Pendiente'}</span>
            ${completada?`<br><button class="btn btn-secondary btn-sm" style="margin-top:10px" onclick="verAnamnesis('${uid}')">üìã Ver respuestas</button>`:''}
          </div>
        `;
      }).join('')}
    </div>
  `;
}

window.verAnamnesis = async (uid) => {
  const [anaSnap, usSnap] = await Promise.all([get(ref(db,`anamnesis/${uid}`)),get(ref(db,`usuarios/${uid}`))]);
  const ana = anaSnap.val()||{};
  const user = usSnap.val()||{};
  const r = ana.respuestas||{};

  const preguntas = [
    'Edad','Peso (kg)','Talla (cm)','Objetivo principal',
    '¬øEnfermedad/lesi√≥n/condici√≥n m√©dica?','Descripci√≥n condici√≥n (si aplica)','Medicamentos (si aplica)',
    'Nivel de actividad f√≠sica actual','¬øCu√°ntos d√≠as entrenas por semana?',
    '¬øCu√°nto tiempo llevas entrenando?','¬øRealizas alg√∫n deporte adicional?',
    'Horario preferido de entrenamiento','¬øTomas alg√∫n suplemento?',
    'Horas de sue√±o promedio','¬øTienes alguna restricci√≥n alimentaria?',
    'Nivel de estr√©s (1-10)','¬øQu√© esperas lograr en los pr√≥ximos 3 meses?'
  ];

  showOverlay(`
    <div class="overlay-header">
      <span class="overlay-title">üìã Anamnesis ‚Äî ${user.nombres} ${user.apellidos||''}</span>
      <button class="btn-close" onclick="closeOverlay()">‚úï</button>
    </div>
    <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:12px">
      ${preguntas.map((p,i)=>`
        <div class="anamnesis-card">
          <div class="anamnesis-q">${p}</div>
          <div class="anamnesis-a">${r[`p${i}`]||'‚Äî'}</div>
        </div>
      `).join('')}
    </div>
    ${ana.completadaEn?`<div style="text-align:right;margin-top:16px;font-size:0.78rem;color:var(--text-muted)">Completada: ${new Date(ana.completadaEn).toLocaleDateString()}</div>`:''}
  `);
};

// ============ GRUPOS ============
const GROUP_COLORS = ['#00c8ff','#7b2fff','#00e5a0','#ff6b35','#ffd60a','#ff4d6d','#a855f7','#10b981','#f59e0b','#e74c3c'];

async function renderGrupos(container, action) {
  action.textContent = '+ Nuevo Grupo';
  action.style.display = 'flex';
  action.onclick = () => showGroupModal();

  const [gruposSnap, usSnap] = await Promise.all([
    get(ref(db,'grupos')), get(ref(db,'usuarios'))
  ]);
  const grupos = gruposSnap.val()||{};
  const users = usSnap.val()||{};

  // Only show groups where current admin is owner or invited
  const myGrupos = Object.entries(grupos).filter(([,g]) =>
    g.adminDueno === currentUser.id ||
    (g.adminsInvitados && g.adminsInvitados[currentUser.id])
  );

  if(myGrupos.length === 0) {
    container.innerHTML = `
      <div style="text-align:center;padding:60px 20px">
        <div style="font-size:4rem;margin-bottom:16px">ü´Ç</div>
        <div style="font-size:1.2rem;font-weight:700;margin-bottom:8px">No tienes grupos a√∫n</div>
        <div style="color:var(--text-muted);margin-bottom:24px">Crea tu primer grupo para organizar atletas</div>
        <button class="btn btn-primary" onclick="showGroupModal()">+ Crear primer grupo</button>
      </div>`;
    return;
  }

  const html = myGrupos.map(([gid,g]) => {
    const memberCount = g.miembros ? Object.keys(g.miembros).length : 0;
    const adminCount = 1 + (g.adminsInvitados ? Object.keys(g.adminsInvitados).length : 0);
    const isOwner = g.adminDueno === currentUser.id;
    const ownerData = users[g.adminDueno]||{};
    const invitedAdmins = Object.entries(g.adminsInvitados||{}).map(([aid]) => users[aid]).filter(Boolean);
    const members = Object.entries(g.miembros||{}).map(([uid]) => users[uid]).filter(Boolean).slice(0,8);

    return `
    <div class="group-card" style="--card-color:${g.color||'var(--primary)'}">
      <div class="group-header">
        <div>
          <div class="group-name">${g.nombre}</div>
          <div class="group-desc">${g.descripcion||'Sin descripci√≥n'}</div>
        </div>
        <div style="display:flex;gap:6px">
          ${isOwner?`<button class="btn btn-secondary btn-sm btn-icon" onclick="showGroupModal('${gid}')" title="Editar grupo">‚úèÔ∏è</button>`:''}
          ${isOwner?`<button class="btn btn-danger btn-sm btn-icon" onclick="deleteGroup('${gid}')" title="Eliminar grupo">üóëÔ∏è</button>`:''}
        </div>
      </div>
      <div class="group-stats">
        <div class="group-stat"><div class="group-stat-val" style="color:${g.color||'var(--primary)'};">${memberCount}</div><div class="group-stat-lbl">Atletas</div></div>
        <div class="group-stat"><div class="group-stat-val" style="color:${g.color||'var(--primary)'};">${adminCount}</div><div class="group-stat-lbl">Entrenadores</div></div>
      </div>
      <div style="margin-bottom:10px">
        <div style="font-size:0.72rem;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:6px">Entrenadores</div>
        <div class="group-admins">
          <div class="group-admin-chip owner" title="Due√±o del grupo">
            <img src="${ownerData.avatar||getAvatarUrl(ownerData.usuario)}" style="width:18px;height:18px;border-radius:50%">
            ${ownerData.nombres||'Due√±o'} üëë
          </div>
          ${invitedAdmins.map(a=>`
            <div class="group-admin-chip">
              <img src="${a.avatar||getAvatarUrl(a.usuario)}" style="width:18px;height:18px;border-radius:50%">
              ${a.nombres}
              ${isOwner?`<span onclick="removeAdminFromGroup('${gid}','${Object.entries(g.adminsInvitados||{}).find(([,v])=>v.uid===a.uid)?.[0]||''}',event)" style="cursor:pointer;color:var(--error);margin-left:2px" title="Quitar entrenador">‚úï</span>`:''}
            </div>
          `).join('')}
          ${isOwner?`<div class="group-admin-chip" style="cursor:pointer;border-style:dashed" onclick="showInviteAdminModal('${gid}')">+ Invitar</div>`:''}
        </div>
      </div>
      <div>
        <div style="font-size:0.72rem;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:6px">Atletas ${memberCount>8?`(${memberCount} total, mostrando 8)`:''}</div>
        <div style="display:flex;flex-wrap:wrap">
          ${members.map(m=>`
            <span class="member-chip">
              <img src="${m.avatar||getAvatarUrl(m.usuario)}">
              ${m.nombres}
            </span>
          `).join('')}
          ${memberCount===0?'<span style="color:var(--text-muted);font-size:0.82rem">Sin atletas</span>':''}
        </div>
      </div>
      <div style="display:flex;gap:8px;margin-top:14px;flex-wrap:wrap">
        <button class="btn btn-secondary btn-sm" onclick="showManageMembersModal('${gid}')">üë• Gestionar Atletas</button>
        <button class="btn btn-secondary btn-sm" onclick="showSendNotifModal('${gid}')">üì£ Notificar</button>
      </div>
    </div>`;
  }).join('');

  container.innerHTML = `<div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(340px,1fr));gap:16px">${html}</div>`;
}

window.showGroupModal = async (gid=null) => {
  let g = {};
  if(gid) { const s=await get(ref(db,`grupos/${gid}`)); g=s.val()||{}; }
  let selColor = g.color||GROUP_COLORS[0];

  const swatches = GROUP_COLORS.map(c=>`<div class="color-swatch ${selColor===c?'selected':''}" style="background:${c}" onclick="pickGroupColor('${c}',this)" data-color="${c}"></div>`).join('');

  showOverlay(`
    <div class="overlay-header">
      <span class="overlay-title">${gid?'‚úèÔ∏è Editar':'‚ûï Crear'} Grupo</span>
      <button class="btn-close" onclick="closeOverlay()">‚úï</button>
    </div>
    <div class="form-grid">
      <div class="form-group" style="grid-column:1/-1">
        <label>Nombre del grupo *</label>
        <input type="text" id="gNombre" class="glass-input" value="${g.nombre||''}" placeholder="Ej: Equipo Alpha">
      </div>
      <div class="form-group" style="grid-column:1/-1">
        <label>Descripci√≥n</label>
        <textarea id="gDesc" class="glass-input" placeholder="Descripci√≥n del grupo...">${g.descripcion||''}</textarea>
      </div>
      <div class="form-group" style="grid-column:1/-1">
        <label>Color del grupo</label>
        <div class="color-picker" id="colorPicker">${swatches}</div>
        <input type="hidden" id="gColor" value="${selColor}">
      </div>
    </div>
    <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:20px">
      <button class="btn btn-secondary" onclick="closeOverlay()">Cancelar</button>
      <button class="btn btn-primary" onclick="saveGroup('${gid||''}')">üíæ Guardar</button>
    </div>
  `);
};

window.pickGroupColor = (color, el) => {
  document.getElementById('gColor').value = color;
  document.querySelectorAll('.color-swatch').forEach(s=>s.classList.toggle('selected', s.dataset.color===color));
};

window.saveGroup = async (gid='') => {
  const nombre = document.getElementById('gNombre').value.trim();
  if(!nombre) return Swal.fire({icon:'warning',title:'Nombre requerido',background:'rgba(10,20,40,0.95)',color:'#e8f4ff',confirmButtonColor:'#00c8ff'});
  const data = { nombre, descripcion: document.getElementById('gDesc').value.trim(), color: document.getElementById('gColor').value };
  if(!gid) { data.adminDueno = currentUser.id; data.creadoEn = Date.now(); }
  const dbRef = gid ? ref(db,`grupos/${gid}`) : ref(db,'grupos');
  if(gid) await update(ref(db,`grupos/${gid}`), data);
  else await push(ref(db,'grupos'), data);
  closeOverlay();
  Swal.fire({icon:'success',title:'Grupo guardado',timer:1500,showConfirmButton:false,background:'rgba(10,20,40,0.95)',color:'#e8f4ff'});
  navTo('grupos');
};

window.deleteGroup = async (gid) => {
  const res = await Swal.fire({icon:'warning',title:'¬øEliminar grupo?',text:'Esto no elimina a los usuarios, solo el grupo.',showCancelButton:true,confirmButtonColor:'#ff4d6d',cancelButtonColor:'rgba(255,255,255,0.1)',background:'rgba(10,20,40,0.95)',color:'#e8f4ff',confirmButtonText:'S√≠, eliminar',cancelButtonText:'Cancelar'});
  if(!res.isConfirmed) return;
  // Remove group from all members
  const snap = await get(ref(db,`grupos/${gid}/miembros`));
  const miembros = snap.val()||{};
  for(const uid of Object.keys(miembros)) {
    await remove(ref(db,`usuarios/${uid}/grupoId`));
  }
  await remove(ref(db,`grupos/${gid}`));
  Swal.fire({icon:'success',title:'Grupo eliminado',timer:1500,showConfirmButton:false,background:'rgba(10,20,40,0.95)',color:'#e8f4ff'});
  navTo('grupos');
};

window.showInviteAdminModal = async (gid) => {
  const [usSnap, gSnap] = await Promise.all([get(ref(db,'usuarios')), get(ref(db,`grupos/${gid}`))]);
  const users = usSnap.val()||{};
  const g = gSnap.val()||{};
  const admins = Object.entries(users).filter(([uid,u]) =>
    (u.rol==='admin' || u.rol==='superadmin') && uid !== g.adminDueno && !(g.adminsInvitados && g.adminsInvitados[uid])
  );
  if(!admins.length) {
    return Swal.fire({icon:'info',title:'No hay m√°s entrenadores disponibles',background:'rgba(10,20,40,0.95)',color:'#e8f4ff',confirmButtonColor:'#00c8ff'});
  }
  showOverlay(`
    <div class="overlay-header"><span class="overlay-title">üë§ Invitar entrenador</span><button class="btn-close" onclick="closeOverlay()">‚úï</button></div>
    <div style="display:flex;flex-direction:column;gap:8px">
      ${admins.map(([uid,u])=>`
        <div style="display:flex;align-items:center;gap:12px;padding:12px;background:rgba(255,255,255,0.04);border-radius:12px;border:1px solid var(--glass-border);cursor:pointer;transition:all 0.2s" onclick="inviteAdmin('${gid}','${uid}')" onmouseover="this.style.background='rgba(0,200,255,0.08)'" onmouseout="this.style.background='rgba(255,255,255,0.04)'">
          <img src="${u.avatar||getAvatarUrl(u.usuario)}" style="width:38px;height:38px;border-radius:50%;border:2px solid rgba(0,200,255,0.3)">
          <div><div style="font-weight:600">${u.nombres} ${u.apellidos||''} ${u.rol==='superadmin'?'<span style="font-size:0.65rem;background:rgba(255,214,0,0.15);color:#ffd60a;border:1px solid rgba(255,214,0,0.3);border-radius:10px;padding:1px 7px;margin-left:4px">‚≠ê SuperAdmin</span>':`<span style="font-size:0.65rem;background:rgba(0,200,255,0.1);color:var(--primary);border:1px solid rgba(0,200,255,0.3);border-radius:10px;padding:1px 7px;margin-left:4px">üëÆ Admin</span>`}</div><div style="font-size:0.75rem;color:var(--text-muted)">@${u.usuario}</div></div>
          <button class="btn btn-primary btn-sm" style="margin-left:auto">+ Invitar</button>
        </div>
      `).join('')}
    </div>
  `);
};

window.inviteAdmin = async (gid, uid) => {
  await set(ref(db,`grupos/${gid}/adminsInvitados/${uid}`), {uid, addedAt:Date.now(), addedBy:currentUser.id});
  closeOverlay();
  Swal.fire({icon:'success',title:'Entrenador invitado',timer:1500,showConfirmButton:false,background:'rgba(10,20,40,0.95)',color:'#e8f4ff'});
  navTo('grupos');
};

window.removeAdminFromGroup = async (gid, uid, e) => {
  e.stopPropagation();
  if(!uid) return;
  const res = await Swal.fire({icon:'warning',title:'¬øQuitar entrenador?',showCancelButton:true,confirmButtonColor:'#ff4d6d',cancelButtonColor:'rgba(255,255,255,0.1)',background:'rgba(10,20,40,0.95)',color:'#e8f4ff',confirmButtonText:'S√≠, quitar'});
  if(!res.isConfirmed) return;
  await remove(ref(db,`grupos/${gid}/adminsInvitados/${uid}`));
  Swal.fire({icon:'success',title:'Entrenador eliminado del grupo',timer:1500,showConfirmButton:false,background:'rgba(10,20,40,0.95)',color:'#e8f4ff'});
  navTo('grupos');
};

window.showManageMembersModal = async (gid) => {
  const [gSnap, usSnap] = await Promise.all([get(ref(db,`grupos/${gid}`)), get(ref(db,'usuarios'))]);
  const g = gSnap.val()||{};
  const users = usSnap.val()||{};

  const currentMembers = Object.keys(g.miembros||{});
  const allAthletes = Object.entries(users).filter(([,u])=>u.rol!=='admin' && u.rol!=='superadmin');

  const membersHtml = allAthletes.map(([uid,u]) => {
    const isMember = currentMembers.includes(uid);
    const inOtherGroup = u.grupoId && u.grupoId !== gid;
    const otherGroupName = inOtherGroup ? (users[u.grupoId]?.nombre || 'otro grupo') : '';
    return `
      <div style="display:flex;align-items:center;gap:12px;padding:10px;background:rgba(255,255,255,0.04);border-radius:12px;border:1px solid rgba(255,255,255,0.07);margin-bottom:8px;${isMember?'border-color:rgba(0,200,255,0.3);background:rgba(0,200,255,0.06);':''}">
        <img src="${u.avatar||getAvatarUrl(u.usuario)}" style="width:34px;height:34px;border-radius:50%;border:2px solid ${isMember?'var(--primary)':'rgba(255,255,255,0.2)'}">
        <div style="flex:1">
          <div style="font-weight:600;font-size:0.88rem">${u.nombres} ${u.apellidos||''}</div>
          <div style="font-size:0.72rem;color:var(--text-muted)">@${u.usuario}${inOtherGroup?` ¬∑ <span style="color:var(--warning)">En: ${otherGroupName}</span>`:''}</div>
        </div>
        ${isMember
          ? `<button class="btn btn-danger btn-sm" onclick="removeMemberFromGroup('${gid}','${uid}')">Sacar</button>`
          : `<button class="btn btn-primary btn-sm" ${inOtherGroup?`onclick="confirmMoveMember('${gid}','${uid}','${u.grupoId}')"`:`onclick="addMemberToGroup('${gid}','${uid}')"`}>${inOtherGroup?'Mover':'A√±adir'}</button>`
        }
      </div>`;
  }).join('');

  showOverlay(`
    <div class="overlay-header"><span class="overlay-title">üë• Gestionar Atletas ‚Äî ${g.nombre}</span><button class="btn-close" onclick="closeOverlay()">‚úï</button></div>
    <div style="margin-bottom:12px">
      <input type="search" placeholder="üîç Buscar atleta..." class="glass-input" oninput="filterMembers(this.value)" style="margin-bottom:0">
    </div>
    <div id="membersList" style="max-height:450px;overflow-y:auto">${membersHtml}</div>
  `);
  document.getElementById('membersList').dataset.gid = gid;
};

window.filterMembers = (q) => {
  const items = document.querySelectorAll('#membersList > div');
  items.forEach(el => {
    const text = el.textContent.toLowerCase();
    el.style.display = text.includes(q.toLowerCase()) ? '' : 'none';
  });
};

window.addMemberToGroup = async (gid, uid) => {
  await Promise.all([
    set(ref(db,`grupos/${gid}/miembros/${uid}`), {uid, addedAt:Date.now(), addedBy:currentUser.id}),
    update(ref(db,`usuarios/${uid}`), {grupoId: gid})
  ]);
  showManageMembersModal(gid);
};

window.removeMemberFromGroup = async (gid, uid) => {
  await Promise.all([
    remove(ref(db,`grupos/${gid}/miembros/${uid}`)),
    remove(ref(db,`usuarios/${uid}/grupoId`))
  ]);
  showManageMembersModal(gid);
};

window.confirmMoveMember = async (newGid, uid, oldGid) => {
  const res = await Swal.fire({
    icon:'question', title:'¬øMover atleta?',
    text:'Este atleta est√° en otro grupo. ¬øDeseas moverlo a este grupo?',
    showCancelButton:true, confirmButtonColor:'#00c8ff',
    cancelButtonColor:'rgba(255,255,255,0.1)',
    background:'rgba(10,20,40,0.95)',color:'#e8f4ff',
    confirmButtonText:'S√≠, mover', cancelButtonText:'Cancelar'
  });
  if(!res.isConfirmed) return;
  await remove(ref(db,`grupos/${oldGid}/miembros/${uid}`));
  await addMemberToGroup(newGid, uid);
};

// ============ NOTIFICATIONS ============
let notifListener = null;

// ‚îÄ‚îÄ AUDIO ENGINE ‚Äî Web Audio API ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// Sonido elegante de notificaci√≥n (acorde mayor ascendente con reverb)
function playSaykyoNotifSound(type) {
  try {
    const ctx = new (window.AudioContext || window.webkitAudioContext)();
    const master = ctx.createGain();
    master.gain.setValueAtTime(0.18, ctx.currentTime);
    master.connect(ctx.destination);

    // Reverb impulse response
    const convolver = ctx.createConvolver();
    const irLen = ctx.sampleRate * 0.6;
    const ir = ctx.createBuffer(2, irLen, ctx.sampleRate);
    for (let c = 0; c < 2; c++) {
      const d = ir.getChannelData(c);
      for (let i = 0; i < irLen; i++) d[i] = (Math.random() * 2 - 1) * Math.pow(1 - i / irLen, 2.5);
    }
    convolver.buffer = ir;
    convolver.connect(master);

    function tone(freq, startT, dur, typ, vol, fi, fo) {
      const osc = ctx.createOscillator();
      const g   = ctx.createGain();
      osc.type = typ;
      osc.frequency.setValueAtTime(freq, ctx.currentTime + startT);
      g.gain.setValueAtTime(0, ctx.currentTime + startT);
      g.gain.linearRampToValueAtTime(vol, ctx.currentTime + startT + fi);
      g.gain.setValueAtTime(vol, ctx.currentTime + startT + dur - fo);
      g.gain.linearRampToValueAtTime(0, ctx.currentTime + startT + dur);
      osc.connect(g);
      g.connect(convolver);
      g.connect(master);
      osc.start(ctx.currentTime + startT);
      osc.stop(ctx.currentTime + startT + dur + 0.05);
    }

    if (type === 'training') {
      // Sonido de "inicio" ‚Äî en√©rgico, motivador
      tone(392.00, 0.00, 0.15, 'square',   0.12, 0.005, 0.08);
      tone(523.25, 0.12, 0.20, 'sine',     0.5,  0.005, 0.10);
      tone(659.25, 0.24, 0.20, 'sine',     0.45, 0.005, 0.10);
      tone(783.99, 0.36, 0.40, 'sine',     0.4,  0.005, 0.20);
      tone(261.63, 0.00, 0.50, 'triangle', 0.2,  0.01,  0.25);
      tone(1568.0, 0.36, 0.28, 'sine',     0.07, 0.02,  0.18);
    } else {
      // Sonido est√°ndar notificaci√≥n ‚Äî acorde do-mi-sol
      tone(523.25, 0.00, 0.22, 'sine',     0.5,  0.005, 0.12);
      tone(659.25, 0.13, 0.22, 'sine',     0.45, 0.005, 0.12);
      tone(783.99, 0.26, 0.35, 'sine',     0.4,  0.005, 0.18);
      tone(261.63, 0.00, 0.40, 'triangle', 0.2,  0.01,  0.20);
      tone(1046.5,  0.26, 0.30, 'sine',   0.08, 0.02,  0.20);
    }
    setTimeout(() => ctx.close(), 2000);
  } catch(e) { /* AudioContext no disponible */ }
}
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

// ‚îÄ‚îÄ TRAINING START TOASTS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// ‚îÄ‚îÄ TRAINING START LISTENER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// Estrategia: escucha onChildAdded (nodo nuevo) Y onChildChanged (nodo reescrito).
// El cliente borra+crea el nodo en cada sesi√≥n para garantizar child_added,
// pero child_changed act√∫a como red de seguridad si el borrado no llega primero.
// El deduplicador usa `inicioEn` (timestamp √∫nico por sesi√≥n).

let _trainingListenerAdded   = null;
let _trainingListenerChanged = null;
let _trainingBootTime        = 0; // ignorar eventos anteriores a cuando abrimos el dashboard

const _shownTrainingSessions = new Set(
  JSON.parse(sessionStorage.getItem('saykyo_shown_training') || '[]')
);

function setupTrainingStartListener() {
  const tRef = ref(db, 'sesiones_activas');

  // Limpiar listeners previos
  if (_trainingListenerAdded)   { off(tRef, 'child_added',   _trainingListenerAdded);   _trainingListenerAdded   = null; }
  if (_trainingListenerChanged) { off(tRef, 'child_changed', _trainingListenerChanged); _trainingListenerChanged = null; }

  // Tiempo de arranque con margen de 30s hacia atr√°s para absorber latencia de red.
  // Si el evento llega justo al mismo tiempo que abrimos el dashboard no lo perdemos.
  _trainingBootTime = Date.now() - 30_000;

  async function handleTrainingSnap(snap) {
    const uid  = snap.key;
    const data = snap.val();
    if (!uid || !data || !data.inicioEn) return;

    // Ignorar sesiones que empezaron antes de que abrimos el dashboard (con margen)
    if (data.inicioEn < _trainingBootTime) return;

    // Deduplicar: mismo uid+inicioEn no se muestra dos veces
    const sessionKey = `${uid}_${data.inicioEn}`;
    if (_shownTrainingSessions.has(sessionKey)) return;
    _shownTrainingSessions.add(sessionKey);
    sessionStorage.setItem('saykyo_shown_training', JSON.stringify([..._shownTrainingSessions]));

    // Verificar que el uid pertenece a alguno de mis grupos
    // getMyGroupUserUids() devuelve un Set ‚Äî usar .has() no .includes()
    try {
      const myUids = await getMyGroupUserUids();
      if (!myUids.has(uid)) return; // <-- .has() correcto para Set
      playSaykyoNotifSound('training');
      showTrainingStartToast(data);
    } catch(e) {
      console.warn('training toast error', e);
    }
  }

  _trainingListenerAdded   = onChildAdded(tRef,   handleTrainingSnap);
  _trainingListenerChanged = onChildChanged(tRef,  handleTrainingSnap);
}

function showTrainingStartToast(data) {
  // Soporta tanto el objeto de notificaci√≥n (deNombre, avatar, mensaje)
  // como el objeto legacy de sesiones_activas (nombre, avatar, dia/semana/mes)
  const nombre  = data.deNombre || data.nombre || 'Atleta';
  const avatar  = data.avatar || '';
  // Extraer d√≠a/semana/mes del campo mensaje si viene de notificaci√≥n
  // mensaje = "ha empezado a entrenar ‚Äî D√≠a X, Semana Y, Mes Z"
  let detalle = '';
  if (data.dia) {
    detalle = `D√≠a ${data.dia} ¬∑ Semana ${data.semana||'?'} ¬∑ Mes ${data.mes||'?'}`;
  } else if (data.mensaje) {
    const m = data.mensaje.match(/D√≠a (\d+), Semana (\d+), Mes (\d+)/);
    if (m) detalle = `D√≠a ${m[1]} ¬∑ Semana ${m[2]} ¬∑ Mes ${m[3]}`;
  }

  const toast = document.createElement('div');
  toast.className = 'training-toast';

  // Stacking: desplazar si ya hay toasts abiertos
  const existingToasts = document.querySelectorAll('.training-toast');
  const offset = existingToasts.length * 86;
  toast.style.top = (20 + offset) + 'px';

  const avatarHtml = avatar
    ? `<img class="tt-avatar" src="${avatar}" onerror="this.style.display='none'" alt="">`
    : `<div class="tt-pulse">üèãÔ∏è</div>`;

  // Detectar si es retomar o nueva sesi√≥n por el texto del mensaje
  const esRetoma = data.mensaje && data.mensaje.includes('retom√≥');
  const accionLabel = esRetoma ? 'üîÑ RETOMANDO SESI√ìN' : '‚ö° SESI√ìN INICIADA';
  const accionTexto = esRetoma ? 'retom√≥ su entrenamiento' : 'ha empezado a entrenar';

  toast.innerHTML = `
    ${avatarHtml}
    <div style="flex:1;min-width:0">
      <div class="tt-title">${accionLabel}</div>
      <div class="tt-body"><strong style="color:var(--text)">${nombre}</strong> ${accionTexto}</div>
      ${detalle ? `<div style="font-size:0.68rem;color:rgba(0,229,160,0.5);margin-top:3px;font-weight:600">${detalle}</div>` : ''}
    </div>
    <button class="tt-close" title="Descartar">‚úï</button>
    <div class="training-toast-bar"></div>
  `;

  function dismiss() {
    toast.classList.add('dismissing');
    setTimeout(() => toast.remove(), 310);
  }

  toast.querySelector('.tt-close').addEventListener('click', (e) => { e.stopPropagation(); dismiss(); });
  toast.addEventListener('click', dismiss);

  document.body.appendChild(toast);
  setTimeout(dismiss, 10000);
}
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

function setupNotifListener() {
  const notifRef = ref(db, `notificaciones/${currentUser.id}`);
  if(notifListener) off(notifRef, 'value', notifListener);
  notifListener = onValue(notifRef, (snap) => {
    const notifs = snap.val()||{};
    const unread = Object.values(notifs).filter(n=>!n.leida).length;
    const badge = document.getElementById('notifBadge');
    if(badge) {
      badge.textContent = unread > 99 ? '99+' : unread;
      badge.classList.toggle('visible', unread>0);
    }
    window._notifData = notifs;

    // Show push for newly arrived notifications
    const latest = Object.entries(notifs).filter(([,n])=>!n.leida&&!n._shown).sort((a,b)=>b[1].creadaEn-a[1].creadaEn)[0];
    if(latest) {
      const [nid, n] = latest;
      showPushToast(n);
      // Mark as shown locally
      window._notifData[nid]._shown = true;
    }
  });
}

function showPushToast(n) {
  // training_start usa el toast verde especial
  if (n.tipo === 'training_start') {
    playSaykyoNotifSound('training');
    showTrainingStartToast(n);
    return;
  }

  const existing = document.getElementById('pushToast');
  if(existing) existing.remove();
  playSaykyoNotifSound('notif');
  const toast = document.createElement('div');
  toast.id = 'pushToast';
  toast.className = 'push-toast';
  toast.innerHTML = `
    <div class="toast-icon">${n.tipo==='alerta'?'üö®':'üí¨'}</div>
    <div style="flex:1">
      <div class="toast-title">${n.tipo==='alerta'?'‚ö° Alerta de atleta':'üì£ Notificaci√≥n'}</div>
      <div class="toast-body"><strong>${n.deNombre||'Atleta'}:</strong> ${n.mensaje}</div>
    </div>
    <button class="toast-close" onclick="this.closest('.push-toast').remove()">‚úï</button>
  `;
  toast.onclick = (e) => { if(e.target.closest('.toast-close')) return; toggleNotifPanel(); toast.remove(); };
  document.body.appendChild(toast);
  setTimeout(()=>toast.remove(), 10000);
}

window.toggleNotifPanel = () => {
  const panel = document.getElementById('notifPanel');
  if(panel.style.display==='none') {
    panel.style.display='block';
    renderNotifList();
  } else {
    panel.style.display='none';
  }
  document.addEventListener('click', closeNotifOnOutsideClick, {once:true});
};

function closeNotifOnOutsideClick(e) {
  const panel = document.getElementById('notifPanel');
  const btn = document.getElementById('notifBtn');
  if(panel && !panel.contains(e.target) && !btn.contains(e.target)) {
    panel.style.display='none';
  }
}

function renderNotifList() {
  const list = document.getElementById('notifList');
  const notifs = window._notifData||{};
  const sorted = Object.entries(notifs).sort((a,b)=>b[1].creadaEn-a[1].creadaEn);

  if(!sorted.length) {
    list.innerHTML='<div class="empty-state" style="padding:24px"><div class="empty-icon">üîî</div><div class="empty-text">Sin notificaciones</div></div>';
    return;
  }

  list.innerHTML = sorted.map(([nid,n])=>{
    // Tipos que llegan al admin desde usuarios:
    //   'alerta'            ‚Üí usuario envi√≥ alerta/pregunta ‚Üí admin PUEDE responder una vez
    //   'respuesta_usuario' ‚Üí usuario respondi√≥ a algo del admin ‚Üí hilo cerrado
    // El admin NO ve mensajes tipo 'mensaje' ni 'respuesta_admin' (esos los env√≠a √©l)
    const isAlerta       = n.tipo === 'alerta';
    const isRespUsuario  = n.tipo === 'respuesta_usuario';
    const isTraining     = n.tipo === 'training_start';
    const canReply = isAlerta && !n.respondida && n.deId;
    const fromLabel = isAlerta    ? 'üö® Alerta de '
                    : isRespUsuario ? 'üí¨ Respuesta de '
                    : isTraining    ? 'üèãÔ∏è Sesi√≥n iniciada por '
                    :                 'üì© Mensaje de ';
    return `
    <div class="notif-item ${n.leida?'':'unread'}" id="notif_${nid}">
      <div style="display:flex;align-items:flex-start;gap:8px">
        <div style="flex:1;cursor:pointer;min-width:0" onclick="markNotifRead('${nid}')">
          <div class="notif-from">${fromLabel}<strong>${n.deNombre||'Atleta'}</strong></div>
          <div class="notif-msg">${n.mensaje}</div>
          ${n.respondida ? '<div style="font-size:0.7rem;color:var(--success);margin-top:3px">‚úÖ Respondida</div>' : ''}
          ${isRespUsuario ? '<div style="font-size:0.7rem;color:var(--text-muted);margin-top:2px;font-style:italic">üîí Hilo cerrado</div>' : ''}
          <div class="notif-time">${new Date(n.creadaEn).toLocaleString()}</div>
        </div>
        <div style="display:flex;flex-direction:column;gap:5px;flex-shrink:0;align-items:flex-end">
          ${canReply ? `<button onclick="replyToNotif('${nid}','${n.deId}')" style="background:rgba(0,200,255,0.1);border:1px solid rgba(0,200,255,0.3);border-radius:8px;padding:5px 8px;color:var(--primary);font-family:'Exo 2',sans-serif;font-size:0.7rem;font-weight:700;cursor:pointer;white-space:nowrap;transition:all 0.2s" onmouseover="this.style.background='rgba(0,200,255,0.2)'" onmouseout="this.style.background='rgba(0,200,255,0.1)'">üí¨ Responder</button>` : ''}
          <button onclick="deleteNotif('${nid}')" title="Eliminar" style="background:rgba(255,77,109,0.1);border:1px solid rgba(255,77,109,0.25);border-radius:8px;color:#ff4d6d;width:28px;height:28px;cursor:pointer;font-size:0.85rem;display:flex;align-items:center;justify-content:center;transition:all 0.2s" onmouseover="this.style.background='rgba(255,77,109,0.25)'" onmouseout="this.style.background='rgba(255,77,109,0.1)'">üóëÔ∏è</button>
        </div>
      </div>
    </div>`;
  }).join('');
}

window.markNotifRead = async (nid) => {
  await update(ref(db,`notificaciones/${currentUser.id}/${nid}`), {leida:true});
  renderNotifList();
};

window.markAllRead = async () => {
  const notifs = window._notifData||{};
  const unread = Object.entries(notifs).filter(([,n])=>!n.leida);
  await Promise.all(unread.map(([nid])=>update(ref(db,`notificaciones/${currentUser.id}/${nid}`), {leida:true})));
  renderNotifList();
};

window.deleteNotif = async (nid) => {
  await remove(ref(db,`notificaciones/${currentUser.id}/${nid}`));
  const el = document.getElementById(`notif_${nid}`);
  if(el) el.remove();
  // Refresh badge count
  const remaining = document.querySelectorAll('.notif-item.unread').length;
  const badge = document.getElementById('notifBadge');
  if(badge) { badge.textContent = remaining; badge.classList.toggle('visible', remaining>0); }
  if(!document.querySelector('.notif-item')) {
    document.getElementById('notifList').innerHTML='<div class="empty-state" style="padding:24px"><div class="empty-icon">üîî</div><div class="empty-text">Sin notificaciones</div></div>';
  }
};

window.deleteAllNotifs = async () => {
  const notifs = window._notifData||{};
  if(!Object.keys(notifs).length) return;
  const res = await Swal.fire({
    icon:'warning', title:'¬øBorrar todas las notificaciones?',
    text:'Esta acci√≥n no se puede deshacer.',
    showCancelButton:true, confirmButtonText:'S√≠, borrar todo',
    cancelButtonText:'Cancelar', confirmButtonColor:'#ff4d6d',
    background:'rgba(10,20,40,0.95)', color:'#e8f4ff'
  });
  if(!res.isConfirmed) return;
  await remove(ref(db,`notificaciones/${currentUser.id}`));
  renderNotifList();
};

// Admin replies to an athlete notification (one-time reply)
window.replyToNotif = async (nid, targetUid) => {
  // Marcar como le√≠da primero
  await update(ref(db,`notificaciones/${currentUser.id}/${nid}`), {leida:true});
  
  showOverlay(`
    <div class="overlay-header">
      <span class="overlay-title">üí¨ Responder al Atleta</span>
      <button class="btn-close" onclick="closeOverlay()">‚úï</button>
    </div>
    <div style="background:rgba(0,200,255,0.06);border:1px solid rgba(0,200,255,0.2);border-radius:12px;padding:12px;margin-bottom:16px;font-size:0.82rem;color:var(--text-muted)">
      ‚ÑπÔ∏è Esta respuesta llegar√° como notificaci√≥n al atleta. Solo puedes responder <strong>una vez</strong> a esta alerta.
    </div>
    <div class="form-group" style="margin-bottom:20px">
      <label>Tu respuesta</label>
      <textarea id="adminReplyMsg" class="glass-input" rows="4" placeholder="Escribe tu respuesta al atleta..."></textarea>
    </div>
    <div style="display:flex;gap:10px;justify-content:flex-end">
      <button class="btn btn-secondary" onclick="closeOverlay()">Cancelar</button>
      <button class="btn btn-primary" onclick="sendAdminReply('${nid}','${targetUid}')">üì§ Enviar respuesta</button>
    </div>
  `);
};

window.sendAdminReply = async (nid, targetUid) => {
  const msg = document.getElementById('adminReplyMsg')?.value?.trim();
  if(!msg) return Swal.fire({icon:'warning',title:'Escribe una respuesta',background:'rgba(10,20,40,0.95)',color:'#e8f4ff',confirmButtonColor:'#00c8ff'});

  // Send notification to the athlete as 'respuesta_alerta' type
  const notif = {
    mensaje: msg,
    deId: currentUser.id,
    deNombre: `${currentUser.nombres||'Entrenador'} ${currentUser.apellidos||''} (Entrenador)`.trim(),
    tipo: 'respuesta_admin',
    leida: false,
    creadaEn: Date.now()
  };
  await push(ref(db, `notificaciones/${targetUid}`), notif);

  // Mark original notif as responded so button disappears
  await update(ref(db, `notificaciones/${currentUser.id}/${nid}`), {respondida: true, leida: true});
  
  // Update local cache so UI reflects change immediately
  if(window._notifData && window._notifData[nid]) {
    window._notifData[nid].respondida = true;
    window._notifData[nid].leida = true;
  }

  closeOverlay();
  renderNotifList();
  Swal.fire({icon:'success',title:'Respuesta enviada',text:'El atleta recibir√° tu respuesta en sus notificaciones',timer:2000,showConfirmButton:false,background:'rgba(10,20,40,0.95)',color:'#e8f4ff'});
};

window.showSendNotifModal = async (gid=null) => {
  // Get users belonging to the group, or all group users for this admin
  const [gruposSnap, usSnap] = await Promise.all([get(ref(db,'grupos')), get(ref(db,'usuarios'))]);
  const grupos = gruposSnap.val()||{};
  const users = usSnap.val()||{};

  // Get all users in groups managed by this admin
  let targetUsers = [];
  if(gid) {
    const g = grupos[gid]||{};
    targetUsers = Object.keys(g.miembros||{}).map(uid=>({uid,u:users[uid]})).filter(x=>x.u);
  } else {
    // All groups this admin manages
    Object.entries(grupos).forEach(([,g])=>{
      if(g.adminDueno===currentUser.id || (g.adminsInvitados&&g.adminsInvitados[currentUser.id])) {
        Object.keys(g.miembros||{}).forEach(uid=>{ if(users[uid]&&!targetUsers.find(x=>x.uid===uid)) targetUsers.push({uid,u:users[uid]}); });
      }
    });
  }

  if(!targetUsers.length) {
    return Swal.fire({icon:'info',title:'No hay atletas en tus grupos',background:'rgba(10,20,40,0.95)',color:'#e8f4ff',confirmButtonColor:'#00c8ff'});
  }

  showOverlay(`
    <div class="overlay-header"><span class="overlay-title">üì£ Enviar Notificaci√≥n</span><button class="btn-close" onclick="closeOverlay()">‚úï</button></div>
    <div class="form-group" style="margin-bottom:16px">
      <label>Destinatario *</label>
      <select id="notifTarget" class="glass-input">
        <option value="">‚Äî Seleccionar atleta ‚Äî</option>
        ${targetUsers.map(({uid,u})=>`<option value="${uid}">${u.nombres} ${u.apellidos||''} (@${u.usuario})</option>`).join('')}
      </select>
    </div>
    <div class="form-group" style="margin-bottom:20px">
      <label>Mensaje *</label>
      <textarea id="notifMsg" class="glass-input" rows="4" placeholder="Escribe tu mensaje al atleta..."></textarea>
    </div>
    <div style="display:flex;gap:10px;justify-content:flex-end">
      <button class="btn btn-secondary" onclick="closeOverlay()">Cancelar</button>
      <button class="btn btn-primary" onclick="sendNotifToUser()">üì§ Enviar</button>
    </div>
  `);
};

window.sendNotifToUser = async () => {
  const target = document.getElementById('notifTarget').value;
  const msg = document.getElementById('notifMsg').value.trim();
  if(!target) return Swal.fire({icon:'warning',title:'Selecciona un atleta',background:'rgba(10,20,40,0.95)',color:'#e8f4ff',confirmButtonColor:'#00c8ff'});
  if(!msg) return Swal.fire({icon:'warning',title:'Escribe un mensaje',background:'rgba(10,20,40,0.95)',color:'#e8f4ff',confirmButtonColor:'#00c8ff'});

  await push(ref(db,`notificaciones/${target}`), {
    mensaje: msg,
    deId: currentUser.id,
    deNombre: `${currentUser.nombres} ${currentUser.apellidos||''} (Entrenador)`,
    tipo: 'mensaje',
    leida: false,
    creadaEn: Date.now()
  });
  closeOverlay();
  Swal.fire({icon:'success',title:'Notificaci√≥n enviada',timer:1500,showConfirmButton:false,background:'rgba(10,20,40,0.95)',color:'#e8f4ff'});
};

// ============ GROUP SCOPING for existing pages ============
// Helper: get UIDs that belong to groups this admin manages
// SuperAdmin sees ALL athletes; regular admin only sees their groups
async function getMyGroupUserUids() {
  // Both admin and superadmin see only users from THEIR groups
  const [gruposSnap] = await Promise.all([get(ref(db,'grupos'))]);
  const grupos = gruposSnap.val()||{};
  const uids = new Set();
  Object.values(grupos).forEach(g => {
    if(g.adminDueno===currentUser.id || (g.adminsInvitados&&g.adminsInvitados[currentUser.id])) {
      Object.keys(g.miembros||{}).forEach(uid => uids.add(uid));
    }
  });
  return uids;
}

// ============ OVERLAY ============
window.showOverlay = (html) => {
  // Eliminar TODOS los overlays existentes antes de crear uno nuevo
  document.querySelectorAll('#overlayBackdrop').forEach(el => el.remove());
  const backdrop = document.createElement('div');
  backdrop.className = 'overlay-backdrop'; backdrop.id = 'overlayBackdrop';
  backdrop.innerHTML = `<div class="overlay-panel">${html}</div>`;
  backdrop.addEventListener('click', e => { if(e.target===backdrop) closeOverlay(); });
  document.body.appendChild(backdrop);
};
window.closeOverlay = () => {
  // Eliminar TODOS los overlays (por si se apilaron)
  document.querySelectorAll('#overlayBackdrop').forEach(el => el.remove());
};

// ============ REVISIONES ============
async function renderRevisiones(container) {
  const [usSnap, revSemSnap, revMesSnap, myUids] = await Promise.all([
    get(ref(db,'usuarios')),
    get(ref(db,'revisiones_semana')),
    get(ref(db,'revisiones_mes')),
    getMyGroupUserUids()
  ]);
  const users = usSnap.val()||{};
  const revSem = revSemSnap.val()||{};
  const revMes = revMesSnap.val()||{};

  const atletasHtml = Object.entries(users)
    .filter(([id,u])=>u.rol!=='admin' && u.rol!=='superadmin' && myUids.has(id))
    .map(([uid,u]) => {
      const semanas = Object.values(revSem[uid]||{}).sort((a,b)=>b.fecha-a.fecha);
      const meses   = Object.values(revMes[uid]||{}).sort((a,b)=>b.fecha-a.fecha);
      const REV_PAGE_SIZE = 5;
      const safeName = uid.replace(/[^a-zA-Z0-9]/g,'_');

      const buildSemHtml = (items, page) => {
        const slice = items.slice(page * REV_PAGE_SIZE, (page+1)*REV_PAGE_SIZE);
        const totalPages = Math.ceil(items.length / REV_PAGE_SIZE);
        if(!slice.length) return '<div class="empty-state"><div class="empty-icon">üìã</div><div class="empty-text">Sin revisiones semanales a√∫n</div></div>';
        const cards = slice.map(r=>`
          <div style="background:rgba(0,0,0,0.25);border-radius:14px;padding:14px;margin-bottom:10px;border:1px solid rgba(255,255,255,0.06)">
            <div style="font-weight:700;margin-bottom:10px;color:var(--primary)">Mes ${r.mes} ¬∑ Semana ${r.semana} <span style="font-size:0.72rem;color:var(--text-muted);font-weight:400">${new Date(r.fecha).toLocaleDateString()}</span></div>
            <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:8px">
              <div class="rev-info-card"><div class="ric-label">üí¢ DOMS</div><div class="ric-val" style="color:${r.doms>=7?'var(--error)':r.doms>=4?'var(--warning)':'var(--success)'}">${r.doms}/10</div></div>
              <div class="rev-info-card"><div class="ric-label">üèãÔ∏è M√∫sculo DOMS</div><div class="ric-val">${r.musculoDoms||'‚Äî'}</div></div>
              <div class="rev-info-card"><div class="ric-label">üòä √Ånimo</div><div class="ric-val">${r.animo}/5</div></div>
              <div class="rev-info-card"><div class="ric-label">üò¥ Sue√±o</div><div class="ric-val">${r.sueno}</div></div>
              <div class="rev-info-card" style="grid-column:1/-1"><div class="ric-label">ü¶¥ Dolor articular/muscular</div><div class="ric-val">${r.dolor==='Si'?`‚ö†Ô∏è ${r.dolorDetalle}`:'‚úÖ Sin dolor'}</div></div>
            </div>
          </div>`).join('');
        const pager = totalPages > 1 ? ('<div style="display:flex;align-items:center;gap:6px;margin-top:8px"><span style="font-size:0.72rem;color:var(--text-muted)">'+(page*REV_PAGE_SIZE+1)+'‚Äì'+Math.min((page+1)*REV_PAGE_SIZE,items.length)+' de '+items.length+'</span><div style="margin-left:auto;display:flex;gap:4px">'+(page>0?'<button onclick="window._revSP_'+safeName+'('+(page-1)+')" style="padding:4px 10px;border-radius:8px;border:1px solid rgba(255,255,255,0.12);background:rgba(255,255,255,0.05);color:var(--text-muted);font-family:Exo 2,sans-serif;font-size:0.78rem;cursor:pointer">‚Äπ</button>':'')+' '+(page<totalPages-1?'<button onclick="window._revSP_'+safeName+'('+(page+1)+')" style="padding:4px 10px;border-radius:8px;border:1px solid rgba(0,200,255,0.3);background:rgba(0,200,255,0.1);color:var(--primary);font-family:Exo 2,sans-serif;font-size:0.78rem;cursor:pointer">‚Ä∫</button>':'')+' </div></div>') : '';
        return cards + pager;
      };

      const buildMesHtml = (items, page) => {
        const slice = items.slice(page * REV_PAGE_SIZE, (page+1)*REV_PAGE_SIZE);
        const totalPages = Math.ceil(items.length / REV_PAGE_SIZE);
        if(!slice.length) return '<div class="empty-state"><div class="empty-icon">üèÜ</div><div class="empty-text">Sin revisiones mensuales a√∫n</div></div>';
        const cards = slice.map(r=>`
          <div style="background:rgba(0,0,0,0.25);border-radius:14px;padding:14px;margin-bottom:10px;border:1px solid rgba(123,47,255,0.2)">
            <div style="font-weight:700;margin-bottom:10px;color:var(--accent)">Mes ${r.mes} <span style="font-size:0.72rem;color:var(--text-muted);font-weight:400">${new Date(r.fecha).toLocaleDateString()}</span></div>
            <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:8px">
              <div class="rev-info-card"><div class="ric-label">üìà ¬øSiente mejora?</div><div class="ric-val">${r.mejora}</div></div>
              <div class="rev-info-card"><div class="ric-label">üéØ Sin progreso en</div><div class="ric-val">${r.noProgresa||'‚Äî'}</div></div>
              <div class="rev-info-card"><div class="ric-label">üìÖ D√≠a m√°s fatigante</div><div class="ric-val">${r.diaMasFatiga}</div></div>
              <div class="rev-info-card"><div class="ric-label">‚ùì Motivo fatiga</div><div class="ric-val">${r.motivoFatiga}</div></div>
              <div class="rev-info-card"><div class="ric-label">üõå M√°s descanso</div><div class="ric-val">${r.masDescanso==='Si'?'‚ö†Ô∏è S√≠ lo necesita':'‚úÖ No necesita'}</div></div>
              ${r.motivoDetalle?`<div class="rev-info-card" style="grid-column:1/-1"><div class="ric-label">üí¨ Detalle</div><div class="ric-val">${r.motivoDetalle}</div></div>`:''}
              ${r.cambioEjercicios?`<div class="rev-info-card" style="grid-column:1/-1"><div class="ric-label">üîÑ Cambios</div><div class="ric-val">${r.cambioEjercicios}</div></div>`:''}
            </div>
          </div>`).join('');
        const pager = totalPages > 1 ? ('<div style="display:flex;align-items:center;gap:6px;margin-top:8px"><span style="font-size:0.72rem;color:var(--text-muted)">'+(page*REV_PAGE_SIZE+1)+'‚Äì'+Math.min((page+1)*REV_PAGE_SIZE,items.length)+' de '+items.length+'</span><div style="margin-left:auto;display:flex;gap:4px">'+(page>0?'<button onclick="window._revMP_'+safeName+'('+(page-1)+')" style="padding:4px 10px;border-radius:8px;border:1px solid rgba(255,255,255,0.12);background:rgba(255,255,255,0.05);color:var(--text-muted);font-family:Exo 2,sans-serif;font-size:0.78rem;cursor:pointer">‚Äπ</button>':'')+' '+(page<totalPages-1?'<button onclick="window._revMP_'+safeName+'('+(page+1)+')" style="padding:4px 10px;border-radius:8px;border:1px solid rgba(0,200,255,0.3);background:rgba(0,200,255,0.1);color:var(--primary);font-family:Exo 2,sans-serif;font-size:0.78rem;cursor:pointer">‚Ä∫</button>':'')+' </div></div>') : '';
        return cards + pager;
      };

      window[`_revSP_${safeName}`] = (p) => { const el=document.getElementById(`rev_sem_${uid}`); if(el) el.innerHTML=buildSemHtml(semanas,p); };
      window[`_revMP_${safeName}`] = (p) => { const el=document.getElementById(`rev_mes_${uid}`); if(el) el.innerHTML=buildMesHtml(meses,p); };

      return `
        <div class="glass-panel" style="margin-bottom:16px">
          <div class="panel-header">
            <div style="display:flex;align-items:center;gap:10px">
              <img src="${u.avatar||getAvatarUrl(u.usuario)}" style="width:38px;height:38px;border-radius:50%;border:2px solid rgba(0,200,255,0.3)">
              <div>
                <div style="font-weight:700">${u.nombres} ${u.apellidos||''}</div>
                <div style="font-size:0.75rem;color:var(--text-muted)">@${u.usuario} ¬∑ ${u.metodo}</div>
              </div>
            </div>
            <div style="font-size:0.8rem;color:var(--text-muted)">${semanas.length} sem ¬∑ ${meses.length} mes</div>
          </div>
          <div class="panel-body">
            <div class="tabs" style="margin-bottom:14px">
              <div class="tab active" id="tab_sem_${uid}" onclick="switchRevTab('${uid}','sem')">üìã Semanales (${semanas.length})</div>
              <div class="tab" id="tab_mes_${uid}" onclick="switchRevTab('${uid}','mes')">üèÜ Mensuales (${meses.length})</div>
            </div>
            <div id="rev_sem_${uid}">${buildSemHtml(semanas, 0)}</div>
            <div id="rev_mes_${uid}" style="display:none">${buildMesHtml(meses, 0)}</div>
          </div>
        </div>
      `;
    }).join('') || '<div class="empty-state"><div class="empty-icon">üë•</div><div class="empty-text">No hay atletas con revisiones</div></div>';


  container.innerHTML = atletasHtml;
}

window.switchRevTab = (uid, tab) => {
  document.getElementById(`tab_sem_${uid}`).classList.toggle('active', tab==='sem');
  document.getElementById(`tab_mes_${uid}`).classList.toggle('active', tab==='mes');
  document.getElementById(`rev_sem_${uid}`).style.display = tab==='sem' ? '' : 'none';
  document.getElementById(`rev_mes_${uid}`).style.display = tab==='mes' ? '' : 'none';
};

// ============ HOME ALERTS PREVIEW ============
async function renderHomeAlertsPreview(container, myUids, users, ruts) {
  const [sesSnap, revSnap] = await Promise.all([
    get(ref(db,'sesiones')), get(ref(db,'revisiones_semana'))
  ]);
  let alerts = await computeIntelligentAlerts(myUids, users, ruts, sesSnap.val()||{}, revSnap.val()||{});
  alerts = alerts.filter(a => !isAlertDismissed(a));
  window._currentAlerts = (window._currentAlerts||[]).concat(alerts.filter(a=>!window._currentAlerts?.find(x=>x.alertKey===a.alertKey)));
  if(!alerts.length) {
    container.innerHTML = `<div class="glass-panel"><div class="panel-header"><span class="panel-title">üö® Alertas Inteligentes</span></div><div class="panel-body"><div class="empty-state" style="padding:20px"><div class="empty-icon">‚úÖ</div><div class="empty-text">Todo en orden. Sin alertas activas.</div></div></div></div>`;
    return;
  }
  // Update badge
  const badge = document.getElementById('alertasBadge');
  if(badge && alerts.length>0) { badge.textContent = alerts.length; badge.style.display=''; }

  container.innerHTML = `
    <div class="glass-panel">
      <div class="panel-header" style="flex-wrap:wrap;gap:8px">
        <span class="panel-title">üö® Alertas Inteligentes <span style="background:var(--error);color:#fff;border-radius:20px;padding:2px 10px;font-size:0.72rem;font-weight:700;margin-left:6px">${alerts.length}</span></span>
        <button class="btn btn-secondary btn-sm" onclick="navTo('alertas')">Ver todas ‚Üí</button>
      </div>
      <div class="panel-body" style="display:flex;flex-direction:column;gap:8px">
        ${alerts.slice(0,5).map(a=>renderAlertCard(a)).join('')}
        ${alerts.length>5?`<div style="text-align:center;padding:8px 0"><button class="btn btn-secondary btn-sm" onclick="navTo('alertas')">Ver ${alerts.length-5} m√°s ‚Üí</button></div>`:''}
      </div>
    </div>`;
}

// Generate a stable ID for an alert
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SISTEMA DE DESCARTE DE ALERTAS ‚Äî persistido en Firebase
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//
// Cada alerta lleva dos campos clave:
//   alertKey      : ID estable del TIPO de alerta. No cambia con los datos.
//                   Formato: "<tipo>|<uid>"  ej: "memb_vence|abc123"
//   conditionValue: Huella del ESTADO ACTUAL de la condici√≥n.
//                   Cambia cuando los datos cambian (fecha, timestamp, valor).
//                   Ej: la fecha de expiraci√≥n "2026-03-15", o el timestamp de
//                   la √∫ltima revisi√≥n, o el valor de DOMS.
//
// Al descartar se guarda en Firebase:
//   alertas_descartadas/{adminId}/{alertKey} = { cv: conditionValue, ts: now }
//
// Al mostrar alertas:
//   - Si no hay entrada para alertKey ‚Üí mostrar (nueva alerta)
//   - Si hay entrada Y cv === conditionValue ‚Üí est√° descartada, ocultar
//   - Si hay entrada Y cv !== conditionValue ‚Üí condici√≥n cambi√≥, mostrar de nuevo
//
// Esto garantiza:
//   ‚Ä¢ Persiste entre recargas y dispositivos (Firebase)
//   ‚Ä¢ Reaparece si cambia la fecha de vencimiento, la √∫ltima sesi√≥n, etc.
//   ‚Ä¢ No requiere tocar reglas de seguridad de otros nodos

window._dismissedAlerts = {};  // mirror en memoria: { alertKey: { cv, ts } }

async function loadDismissedAlerts() {
  try {
    const snap = await get(ref(db, `alertas_descartadas/${currentUser.id}`));
    window._dismissedAlerts = snap.val() || {};
  } catch(e) {
    console.warn('No se pudieron cargar alertas descartadas:', e);
    window._dismissedAlerts = {};
  }
}

function isAlertDismissed(a) {
  const entry = window._dismissedAlerts?.[a.alertKey];
  if(!entry) return false;
  // Si el conditionValue actual difiere del guardado ‚Üí la condici√≥n cambi√≥ ‚Üí mostrar
  return String(entry.cv) === String(a.conditionValue);
}

function renderAlertCard(a, inAlertsPage=false) {
  const colors = {danger:'var(--error)',warning:'var(--warning)',info:'var(--primary)'};
  const bgs = {danger:'rgba(255,77,109,0.08)',warning:'rgba(255,214,10,0.08)',info:'rgba(0,200,255,0.08)'};
  const borders = {danger:'rgba(255,77,109,0.25)',warning:'rgba(255,214,10,0.2)',info:'rgba(0,200,255,0.2)'};
  const aId = a.alertKey;
  const actionsHtml = inAlertsPage ? `
    <div style="display:flex;flex-direction:column;gap:5px;flex-shrink:0">
      <button class="btn btn-danger btn-sm" onclick="dismissAlert('${aId}')" style="font-size:0.7rem;padding:5px 8px;white-space:nowrap">üóëÔ∏è Descartar</button>
    </div>` : '';
  return `
    <div id="alertcard_${aId}" style="background:${bgs[a.nivel]};border:1px solid ${borders[a.nivel]};border-radius:14px;padding:12px 14px;display:flex;align-items:flex-start;gap:12px">
      <div style="font-size:1.5rem;flex-shrink:0">${a.emoji}</div>
      <div style="flex:1;min-width:0">
        <div style="font-weight:700;font-size:0.9rem;color:${colors[a.nivel]}">${a.titulo}</div>
        <div style="font-size:0.82rem;color:var(--text-muted);margin-top:2px">${a.descripcion}</div>
      </div>
      ${actionsHtml}
    </div>`;
}

window.dismissAlert = async (aId) => {
  // Buscar la alerta activa por su alertKey para obtener conditionValue
  const alertData = window._currentAlerts?.find(a => a.alertKey === aId);
  const cv = alertData ? alertData.conditionValue : '__dismissed__';

  // Actualizar mirror en memoria
  if(!window._dismissedAlerts) window._dismissedAlerts = {};
  window._dismissedAlerts[aId] = { cv, ts: Date.now() };

  // Persistir en Firebase (requiere la regla alertas_descartadas en Firebase)
  try {
    await set(ref(db, `alertas_descartadas/${currentUser.id}/${aId}`), { cv, ts: Date.now() });
  } catch(e) {
    console.warn('No se pudo persistir descarte en Firebase:', e);
  }

  // Animar y quitar SOLO este card ‚Äî NO re-renderizar toda la p√°gina
  const el = document.getElementById(`alertcard_${aId}`);
  if(el) {
    el.style.transition = 'all 0.3s ease';
    el.style.opacity = '0';
    el.style.transform = 'translateX(40px)';
    setTimeout(() => {
      el.remove();
      refreshAlertBadge(true); // solo actualiza badge, no re-renderiza p√°gina
    }, 300);
  }
};



async function computeIntelligentAlerts(myUids, users, ruts, sesiones, revSem) {
  // Si no nos pasaron sesiones/revisiones, cargarlas (compatibilidad)
  if(sesiones === undefined || revSem === undefined) {
    const [sesSnap, revSemSnap] = await Promise.all([
      get(ref(db,'sesiones')), get(ref(db,'revisiones_semana'))
    ]);
    sesiones = sesSnap.val()||{};
    revSem = revSemSnap.val()||{};
  }

  // Parsear fecha como LOCAL para evitar bug UTC vs Colombia (UTC-5)
  function parseLocalDate(str) {
    if(!str) return null;
    return new Date(str.includes('T') ? str : str + 'T00:00:00');
  }
  const today = new Date(); today.setHours(0,0,0,0);
  const now = today.getTime();

  // Helper: sanitizar string para usar como clave de Firebase (sin /, ., #, $, [, ])
  function safeKey(s) { return String(s).replace(/[.#$[\]/]/g,'_'); }

  const alerts = [];

  for(const [uid, u] of Object.entries(users)) {
    if(u.rol==='admin' || !myUids.has(uid)) continue;

    // ‚îÄ‚îÄ 1. Membres√≠a vencida ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    // conditionValue = la fecha exacta de vencimiento.
    // Si el admin cambia validoHasta ‚Üí cv cambia ‚Üí alerta reaparece.
    if(u.validoHasta) {
      const exp = parseLocalDate(u.validoHasta);
      if(exp) {
        exp.setHours(0,0,0,0);
        const diffDays = Math.round((exp.getTime() - now) / (1000*60*60*24));
        if(diffDays < 0) {
          alerts.push({
            nivel: 'danger', emoji: 'üî¥',
            titulo: `${u.nombres} ‚Äî suscripcion vencida`,
            descripcion: `Vencio el ${exp.toLocaleDateString('es-CO')}${u.activo ? ' pero la cuenta sigue activa' : ''}`,
            alertKey: `memb_vencida__${safeKey(uid)}`,
            conditionValue: u.validoHasta,   // cambia si se modifica la fecha
            uid
          });
        } else if(diffDays <= 7) {
          // ‚îÄ‚îÄ 2. Pr√≥xima a vencer ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
          // conditionValue incluye TANTO la fecha como los d√≠as restantes.
          // As√≠, cuando pasan los d√≠as (7‚Üí6‚Üí5...) el cv cambia aunque no se toque la fecha,
          // y la alerta reaparece aunque haya sido descartada el d√≠a anterior.
          alerts.push({
            nivel: diffDays <= 3 ? 'danger' : 'warning', emoji: '‚è≥',
            titulo: `${u.nombres} vence ${diffDays === 0 ? 'hoy' : 'en ' + diffDays + ' dia' + (diffDays===1?'':'s')}`,
            descripcion: `Suscripcion expira el ${exp.toLocaleDateString('es-CO')}`,
            alertKey: `memb_vence__${safeKey(uid)}`,
            conditionValue: `${u.validoHasta}__d${diffDays}`,  // cambia cada d√≠a Y si se extiende la fecha
            uid
          });
        }
      }
    }

    // ‚îÄ‚îÄ 3. Sin entrenar ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    if(u.activo) {
      const rutina = Object.values(ruts).find(r=>r.usuario===uid && r.activa);
      if(rutina) {
        const historial = sesiones[uid]?.historial||{};
        const sesses = Object.values(historial);
        if(sesses.length === 0) {
          // conditionValue fijo = 'nunca'. Solo desaparece definitivamente si entrena (sesi√≥n crea historial)
          alerts.push({
            nivel: 'warning', emoji: 'üò¥',
            titulo: `${u.nombres} ‚Äî nunca ha entrenado`,
            descripcion: 'Tiene rutina activa pero no registra ninguna sesion',
            alertKey: `sin_entrenar_nunca__${safeKey(uid)}`,
            conditionValue: 'nunca',
            uid
          });
        } else {
          const lastSes = Math.max(...sesses.map(s=>s.fecha||s.fechaFin||0));
          const diasSin = (now - lastSes) / (1000*60*60*24);
          if(diasSin > 7) {
            // conditionValue = timestamp de la √∫ltima sesi√≥n + bucket de semanas.
            // Si el atleta entrena ‚Üí lastSes cambia ‚Üí cv cambia ‚Üí reaparece la pr√≥xima vez.
            // Si pasan 7 d√≠as m√°s sin entrenar ‚Üí el bucket cambia ‚Üí reaparece.
            const weekBucket = Math.floor(diasSin / 7); // 1 para 7-13 d√≠as, 2 para 14-20, etc.
            alerts.push({
              nivel: diasSin > 14 ? 'danger' : 'warning', emoji: 'üèÉ',
              titulo: `${u.nombres} ‚Äî ${Math.floor(diasSin)} dias sin entrenar`,
              descripcion: `Ultima sesion: ${new Date(lastSes).toLocaleDateString('es-CO')}. Tiene rutina activa.`,
              alertKey: `sin_entrenar__${safeKey(uid)}`,
              conditionValue: `${String(lastSes)}__w${weekBucket}`,  // cambia cuando entrena O cada 7 d√≠as adicionales
              uid
            });
          }
        }
      }
    }

    // ‚îÄ‚îÄ 4. Alertas de revisi√≥n reciente (DOMS, dolor, √°nimo) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    // Todas usan como conditionValue el timestamp de la revisi√≥n m√°s reciente.
    // Si el atleta env√≠a una nueva revisi√≥n ‚Üí lastRev.fecha cambia ‚Üí cv cambia ‚Üí reaparece.
    const revsSem = Object.values(revSem[uid]||{});
    if(revsSem.length) {
      const lastRev = revsSem.filter(r=>r && r.fecha).sort((a,b)=>b.fecha-a.fecha)[0];
      const esReciente = lastRev && (now - lastRev.fecha) <= 14 * 24 * 60 * 60 * 1000;
      if(lastRev && esReciente) {
        const doms = typeof lastRev.doms === 'number' ? lastRev.doms : parseFloat(lastRev.doms);
        if(!isNaN(doms) && doms > 0) {
          if(doms >= 8) {
            alerts.push({
              nivel: 'danger', emoji: 'üí¢',
              titulo: `${u.nombres} ‚Äî DOMS critico (${doms}/10)`,
              descripcion: `Dolor muscular severo en: ${lastRev.musculoDoms||'No especificado'}`,
              alertKey: `doms_critico__${safeKey(uid)}`,
              conditionValue: String(lastRev.fecha),  // nueva revisi√≥n ‚Üí cv nuevo
              uid
            });
          } else if(doms >= 6) {
            alerts.push({
              nivel: 'warning', emoji: '‚ö†Ô∏è',
              titulo: `${u.nombres} ‚Äî DOMS elevado (${doms}/10)`,
              descripcion: `Zona afectada: ${lastRev.musculoDoms||'No especificado'}`,
              alertKey: `doms_elevado__${safeKey(uid)}`,
              conditionValue: String(lastRev.fecha),
              uid
            });
          }
        }
        if(lastRev.dolor === 'Si') {
          alerts.push({
            nivel: 'danger', emoji: 'ü¶¥',
            titulo: `${u.nombres} ‚Äî Dolor articular reportado`,
            descripcion: lastRev.dolorDetalle || 'Sin detalle',
            alertKey: `dolor_articular__${safeKey(uid)}`,
            conditionValue: String(lastRev.fecha),
            uid
          });
        }
        const animo = typeof lastRev.animo === 'number' ? lastRev.animo : parseFloat(lastRev.animo);
        if(!isNaN(animo) && animo <= 2) {
          alerts.push({
            nivel: 'warning', emoji: 'üòî',
            titulo: `${u.nombres} ‚Äî Animo muy bajo (${animo}/5)`,
            descripcion: 'Requiere seguimiento emocional/motivacional',
            alertKey: `animo_bajo__${safeKey(uid)}`,
            conditionValue: String(lastRev.fecha),
            uid
          });
        }
      }
    }

    // ‚îÄ‚îÄ 5. Sin revisi√≥n semanal ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    if(u.activo) {
      const rutina = Object.values(ruts).find(r=>r.usuario===uid && r.activa);
      if(rutina) {
        const progreso = sesiones[uid]?.progreso || {};
        const mesActual = progreso.mesActual || 1;
        if(mesActual > 1) {
          const revsSemUser = Object.values(revSem[uid]||{});
          if(revsSemUser.length === 0) {
            alerts.push({
              nivel: 'info', emoji: 'üìã',
              titulo: `${u.nombres} ‚Äî Sin revisiones registradas`,
              descripcion: 'Ya complet√≥ el primer mes pero nunca ha enviado una revisi√≥n.',
              alertKey: `sin_rev_nunca__${safeKey(uid)}`,
              conditionValue: 'nunca',
              uid
            });
          } else {
            const lastRevDate = Math.max(...revsSemUser.map(r=>r.fecha||0));
            const diasSinRev = (now - lastRevDate) / (1000*60*60*24);
            if(diasSinRev > 30) {
              // conditionValue = timestamp de la √∫ltima revisi√≥n.
              // Si el atleta env√≠a una nueva ‚Üí cv cambia ‚Üí alerta reaparece cuando vuelva a faltar >30 d√≠as.
              alerts.push({
                nivel: 'info', emoji: 'üìã',
                titulo: `${u.nombres} ‚Äî Sin revision en ${Math.floor(diasSinRev)} dias`,
                descripcion: 'Ultima revision hace mas de 30 dias. Considera hacer un seguimiento.',
                alertKey: `sin_revision__${safeKey(uid)}`,
                conditionValue: String(lastRevDate),
                uid
              });
            }
          }
        }
      }
    }
  }

  const order = {danger:0, warning:1, info:2};
  alerts.sort((a,b)=>order[a.nivel]-order[b.nivel]);
  return alerts;
}


// ============ ALERTAS PAGE ============
async function renderAlertas(container) {
  container.innerHTML = '<div class="page-loading"><div class="spinner-lg"></div><span>Analizando datos...</span></div>';
  const [usSnap, rutSnap, sesSnap, revSnap, myUids] = await Promise.all([
    get(ref(db,'usuarios')), get(ref(db,'rutinas')),
    get(ref(db,'sesiones')), get(ref(db,'revisiones_semana')),
    getMyGroupUserUids()
  ]);
  const users = usSnap.val()||{};
  const ruts = rutSnap.val()||{};

  let alerts = await computeIntelligentAlerts(myUids, users, ruts, sesSnap.val()||{}, revSnap.val()||{});
  // Filtrar usando isAlertDismissed (respeta conditionValue ‚Äî reaparece si cambian los datos)
  alerts = alerts.filter(a => !isAlertDismissed(a));
  // Guardar lista activa para que dismissAlert pueda leer conditionValue
  window._currentAlerts = alerts;

  const danger = alerts.filter(a=>a.nivel==='danger');
  const warning = alerts.filter(a=>a.nivel==='warning');
  const info = alerts.filter(a=>a.nivel==='info');

  container.innerHTML = `
    <div style="margin-bottom:20px;display:flex;gap:12px;flex-wrap:wrap">
      <div class="stat-card" style="--card-accent:var(--error);flex:1;min-width:140px">
        <div class="stat-icon">üî¥</div>
        <div class="stat-value" style="color:var(--error)">${danger.length}</div>
        <div class="stat-label">Cr√≠ticas</div>
      </div>
      <div class="stat-card" style="--card-accent:var(--warning);flex:1;min-width:140px">
        <div class="stat-icon">‚ö†Ô∏è</div>
        <div class="stat-value" style="color:var(--warning)">${warning.length}</div>
        <div class="stat-label">Advertencias</div>
      </div>
      <div class="stat-card" style="--card-accent:var(--primary);flex:1;min-width:140px">
        <div class="stat-icon">‚ÑπÔ∏è</div>
        <div class="stat-value" style="color:var(--primary)">${info.length}</div>
        <div class="stat-label">Informativas</div>
      </div>
    </div>
    ${alerts.length===0?`
      <div class="glass-panel"><div class="panel-body" style="text-align:center;padding:60px 20px">
        <div style="font-size:4rem;margin-bottom:16px">‚úÖ</div>
        <div style="font-size:1.2rem;font-weight:700;margin-bottom:8px">¬°Todo en orden!</div>
        <div style="color:var(--text-muted)">No hay alertas activas para tus atletas.</div>
      </div></div>
    `:`
    ${danger.length?`
      <div class="glass-panel" style="margin-bottom:16px;border-color:rgba(255,77,109,0.3)">
        <div class="panel-header" style="border-bottom-color:rgba(255,77,109,0.2)">
          <span class="panel-title" style="color:var(--error)">üî¥ Alertas Cr√≠ticas (${danger.length})</span>
        </div>
        <div class="panel-body" style="display:flex;flex-direction:column;gap:8px">
          ${danger.map(a=>renderAlertCard(a,true)).join('')}
        </div>
      </div>`:''}
    ${warning.length?`
      <div class="glass-panel" style="margin-bottom:16px;border-color:rgba(255,214,10,0.3)">
        <div class="panel-header" style="border-bottom-color:rgba(255,214,10,0.15)">
          <span class="panel-title" style="color:var(--warning)">‚ö†Ô∏è Advertencias (${warning.length})</span>
        </div>
        <div class="panel-body" style="display:flex;flex-direction:column;gap:8px">
          ${warning.map(a=>renderAlertCard(a,true)).join('')}
        </div>
      </div>`:''}
    ${info.length?`
      <div class="glass-panel" style="margin-bottom:16px">
        <div class="panel-header">
          <span class="panel-title" style="color:var(--primary)">‚ÑπÔ∏è Informativas (${info.length})</span>
        </div>
        <div class="panel-body" style="display:flex;flex-direction:column;gap:8px">
          ${info.map(a=>renderAlertCard(a,true)).join('')}
        </div>
      </div>`:''}
    `}
    <div class="glass-panel" style="margin-top:8px">
      <div class="panel-header"><span class="panel-title">üìñ ¬øC√≥mo funcionan las alertas?</span></div>
      <div class="panel-body" style="font-size:0.85rem;color:var(--text-muted);line-height:1.7">
        Las alertas inteligentes analizan autom√°ticamente los datos de tus atletas y detectan:
        <ul style="margin-top:8px;padding-left:20px;display:flex;flex-direction:column;gap:4px">
          <li>‚è≥ <strong>Vencimientos pr√≥ximos</strong> ‚Äî suscripciones que expiran en ‚â§7 d√≠as</li>
          <li>üî¥ <strong>Cuentas vencidas activas</strong> ‚Äî membres√≠a expirada pero acceso habilitado</li>
          <li>üò¥ <strong>Inactividad prolongada</strong> ‚Äî activos con rutina pero sin entrenar >7 d√≠as</li>
          <li>üí¢ <strong>DOMS cr√≠tico</strong> ‚Äî dolor muscular reportado ‚â•6/10 en revisiones recientes</li>
          <li>ü¶¥ <strong>Dolor articular</strong> ‚Äî reporte de dolor articular en revisi√≥n semanal</li>
          <li>üòî <strong>√Ånimo bajo</strong> ‚Äî √°nimo ‚â§2/5 en revisi√≥n reciente</li>
          <li>üìã <strong>Sin revisi√≥n</strong> ‚Äî m√°s de 30 d√≠as sin revisi√≥n semanal</li>
        </ul>
        <div style="margin-top:10px;font-size:0.8rem;background:rgba(0,200,255,0.06);border:1px solid rgba(0,200,255,0.15);border-radius:10px;padding:10px">
          üí° Usa <strong>üóëÔ∏è Descartar</strong> para ocultar alertas que ya gestionaste. Las alertas descartadas no vuelven a aparecer hasta que la condici√≥n se actualice.
        </div>
      </div>
    </div>
  `;
}

// ============ BODY MAP HELPERS ============
// Zonas de medici√≥n con posici√≥n relativa en la silueta (mx=0..1, my=0..1)
const BODY_ZONES = [
  {key:'cuello',      label:'Cuello',        side:'front', mx:0.50,my:0.16, col:'#00c8ff', unit:'cm', cat:'medida'},
  {key:'torax',       label:'T√≥rax',         side:'back',  mx:0.50,my:0.28,  col:'#00b4d8', unit:'cm', cat:'medida'},
  {key:'bicepRelIzq', label:'B√≠c. Rel. Izq', side:'front', mx:0.14,my:0.31,  col:'#00e5a0', unit:'cm', cat:'medida'},
  {key:'bicepRelDer', label:'B√≠c. Rel. Der', side:'front', mx:0.86,my:0.31,  col:'#00e5a0', unit:'cm', cat:'medida'},
  {key:'bicepContIzq',label:'B√≠c. Con. Izq', side:'front', mx:0.14,my:0.31,  col:'#4ade80', unit:'cm', cat:'medida'},
  {key:'bicepContDer',label:'B√≠c. Con. Der', side:'front', mx:0.86,my:0.38,  col:'#4ade80', unit:'cm', cat:'medida'},
  {key:'cintura',     label:'Cintura',       side:'front', mx:0.50,my:0.47, col:'#ffd60a', unit:'cm', cat:'medida'},
  {key:'abdomen',     label:'Abdomen',       side:'front', mx:0.50,my:0.42, col:'#ff6b35', unit:'cm', cat:'medida'},
  {key:'cadera',      label:'Cadera',        side:'front', mx:0.64,my:0.47, col:'#ff4d6d', unit:'cm', cat:'medida'},
  {key:'musloIzq',    label:'Muslo Izq',     side:'front', mx:0.37,my:0.62, col:'#a78bfa', unit:'cm', cat:'medida'},
  {key:'musloDer',    label:'Muslo Der',     side:'front', mx:0.64,my:0.62, col:'#a78bfa', unit:'cm', cat:'medida'},
  {key:'pantorrilla', label:'Pantorrilla',   side:'back', mx:0.66,my:0.845, col:'#7b2fff', unit:'cm', cat:'medida'},
];
const PLIEGUES_ZONES = [
  {key:'Tr√≠ceps',      label:'Pl. Tr√≠ceps',       side:'back',  mx:0.85,my:0.29,  col:'#fb923c', unit:'mm', cat:'pliegue'},
  {key:'Subescapular', label:'Pl. Subescapular',  side:'back',  mx:0.62,my:0.245, col:'#f472b6', unit:'mm', cat:'pliegue'},
  {key:'Supraespinal', label:'Pl. Supraespinal',  side:'front', mx:0.38,my:0.43, col:'#e879f9', unit:'mm', cat:'pliegue'},
  {key:'Abdominal',    label:'Pl. Abdominal',     side:'front', mx:0.64,my:0.525, col:'#c084fc', unit:'mm', cat:'pliegue'},
  {key:'Muslo',        label:'Pl. Muslo',         side:'front', mx:0.37,my:0.65,  col:'#818cf8', unit:'mm', cat:'pliegue'},
  {key:'Pantorrilla',  label:'Pl. Pantorrilla',   side:'back',  mx:0.34,my:0.845, col:'#38bdf8', unit:'mm', cat:'pliegue'},
];



function buildBodyMapSVG(val) {
  const accentColor = '#00c8ff';
  const IMG_W = 130, IMG_H = 325;

  const makeDots = (zones) => zones.map(z => {
    const left = (z.mx * 100).toFixed(2);
    const top  = (z.my * 100).toFixed(2);
    return `
      <div title="${z.label}: ${z.displayVal}"
           style="position:absolute;left:${left}%;top:${top}%;transform:translate(-50%,-50%);cursor:pointer;z-index:2">
        <div style="position:absolute;width:22px;height:22px;border-radius:50%;
                    background:${z.col};opacity:0.2;top:50%;left:50%;
                    transform:translate(-50%,-50%);
                    animation:bodyPulse 2.5s ease-in-out infinite"></div>
        <div style="width:11px;height:11px;border-radius:50%;
                    background:${z.col};border:2px solid rgba(255,255,255,0.9);
                    box-shadow:0 0 8px ${z.col}99;position:relative;z-index:1">
          <div style="width:4px;height:4px;border-radius:50%;background:white;
                      position:absolute;top:50%;left:50%;transform:translate(-50%,-50%)"></div>
        </div>
      </div>`;
  }).join('');

  // Zonas frontales
  const frontZones = [
    ...BODY_ZONES.filter(z => z.side === 'front' && val[z.key] != null)
      .map(z => ({...z, displayVal: `${val[z.key]} cm`})),
    ...PLIEGUES_ZONES.filter(z => z.side === 'front' && val.pliegues?.[z.key] != null)
      .map(z => ({...z, displayVal: `${val.pliegues[z.key]} mm`}))
  ];

  // Zonas posteriores
  const backZones = [
    ...BODY_ZONES.filter(z => z.side === 'back' && val[z.key] != null)
      .map(z => ({...z, displayVal: `${val[z.key]} cm`})),
    ...PLIEGUES_ZONES.filter(z => z.side === 'back' && val.pliegues?.[z.key] != null)
      .map(z => ({...z, displayVal: `${val.pliegues[z.key]} mm`}))
  ];

  const frontDots = makeDots(frontZones);
  const backDots  = makeDots(backZones);

  const imgBlock = (src, label, dots, id) => `
    <div style="display:flex;flex-direction:column;align-items:center;gap:8px">
      <div style="font-size:0.65rem;letter-spacing:3px;color:${accentColor};font-weight:700;text-transform:uppercase">${label}</div>
      <div id="${id}" style="position:relative;width:${IMG_W}px;height:${IMG_H}px;border-radius:16px;overflow:hidden;
                  border:1px solid ${accentColor}33;
                  box-shadow:0 0 30px ${accentColor}18">
        <img src="${src}" style="width:100%;height:100%;object-fit:cover;display:block;" draggable="false">
        ${dots}
      </div>
    </div>`;

  return `
    <style>
      @keyframes bodyPulse {
        0%,100%{transform:translate(-50%,-50%) scale(1);opacity:0.2}
        50%{transform:translate(-50%,-50%) scale(1.6);opacity:0.05}
      }
    </style>
    <div style="display:flex;flex-direction:column;gap:16px;align-items:center">
      ${imgBlock('body.png',      'FRONTAL',   frontDots, 'bodyImgWrapper')}
      ${imgBlock('body_back.png', 'POSTERIOR', backDots,  'bodyImgWrapperBack')}
    </div>`;
}

function buildBodyMapLegend(val) {
  const allZones = [
    ...BODY_ZONES.filter(z => val[z.key] != null)
      .map(z => ({...z, displayVal: `${val[z.key]} cm`, cat:'medida'})),
    ...PLIEGUES_ZONES.filter(z => val.pliegues?.[z.key] != null)
      .map(z => ({...z, displayVal: `${val.pliegues[z.key]} mm`, cat:'pliegue'}))
  ];
  
  if (!allZones.length) return `<div style="color:rgba(255,255,255,0.3);font-size:0.82rem">Sin mediciones registradas</div>`;
  
  const frontMed = allZones.filter(z => z.side === 'front' && z.cat === 'medida');
  const backMed  = allZones.filter(z => z.side === 'back'  && z.cat === 'medida');
  const frontPli = allZones.filter(z => z.side === 'front' && z.cat === 'pliegue');
  const backPli  = allZones.filter(z => z.side === 'back'  && z.cat === 'pliegue');
  
  const section = (title, zones, accentCol) => {
    if (!zones.length) return '';
    return `
      <div style="margin-bottom:12px">
        <div style="font-size:0.62rem;letter-spacing:2px;color:${accentCol};text-transform:uppercase;font-weight:700;margin-bottom:7px;padding-bottom:4px;border-bottom:1px solid ${accentCol}30">${title}</div>
        ${zones.map(z => `
          <div style="display:flex;align-items:center;gap:8px;padding:5px 8px;border-radius:9px;margin-bottom:3px;
                      background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.05);
                      transition:all 0.2s" onmouseover="this.style.background='rgba(255,255,255,0.07)'" onmouseout="this.style.background='rgba(255,255,255,0.03)'">
            <div style="width:10px;height:10px;border-radius:50%;background:${z.col};flex-shrink:0;
                        box-shadow:0 0 6px ${z.col}88"></div>
            <div style="flex:1;font-size:0.78rem;color:rgba(232,244,255,0.7)">${z.label}</div>
            <div style="font-size:0.85rem;font-weight:700;color:${z.col}">${z.displayVal}</div>
          </div>`).join('')}
      </div>`;
  };
  
  return `
    <div style="padding:4px 0">
      <div style="font-size:0.72rem;color:rgba(255,255,255,0.4);margin-bottom:14px;font-style:italic">√öltima valoraci√≥n registrada</div>
      ${section('Medidas Frontales (cm)', frontMed, '#00c8ff')}
      ${section('Medidas Posteriores (cm)', backMed, '#00c8ff')}
      ${section('Pliegues Frontales (mm)', frontPli, '#a78bfa')}
      ${section('Pliegues Posteriores (mm)', backPli, '#a78bfa')}
    </div>`;
}

// ============ VALORACIONES ============
async function renderValoraciones(container, action) {
  action.textContent = '+ Nueva Valoraci√≥n';
  action.style.display = 'flex';
  action.onclick = () => showValoracionModal();

  const [usSnap, valSnap, myUids] = await Promise.all([
    get(ref(db,'usuarios')), get(ref(db,'valoraciones')), getMyGroupUserUids()
  ]);
  const users = usSnap.val()||{};
  const valoraciones = valSnap.val()||{};
  const myAtletas = Object.entries(users).filter(([id,u])=>u.rol!=='admin' && u.rol!=='superadmin' && myUids.has(id));

  if(!myAtletas.length) {
    container.innerHTML = `<div class="empty-state"><div class="empty-icon">‚öñÔ∏è</div><div class="empty-text">No tienes atletas en tus grupos</div></div>`;
    return;
  }

  // Render athlete selector + charts
  let selectedUid = window._valState?.uid || myAtletas[0][0];

  const renderAtletaVal = async (uid) => {
    window._valState = {uid};
    const u = users[uid]||{};
    const vals = Object.values(valoraciones[uid]||{}).sort((a,b)=>a.fecha-b.fecha);

    const atletaOpts = myAtletas.map(([id,u])=>`<option value="${id}" ${id===uid?'selected':''}>${u.nombres} ${u.apellidos||''}</option>`).join('');

    const lastVal = vals[vals.length-1];
    const firstVal = vals[0];

    // Trend calculations
    const deltaGrasa = lastVal && firstVal && vals.length>1 ? (lastVal.grasa - firstVal.grasa).toFixed(1) : null;
    const deltaMuscular = lastVal && firstVal && vals.length>1 ? (lastVal.muscular - firstVal.muscular).toFixed(1) : null;
    const deltaPeso = lastVal && firstVal && vals.length>1 ? (lastVal.peso - firstVal.peso).toFixed(1) : null;

    const trendIcon = (delta, invertido=false) => {
      if(delta===null) return '‚Äî';
      const neutro = Math.abs(delta) < 0.5;
      if(neutro) return `<span style="color:var(--text-muted)">‚Üí sin cambio</span>`;
      const subio = delta > 0;
      const esBueno = invertido ? !subio : subio;
      const arrow = subio ? '‚ñ≤' : '‚ñº';
      const sign = subio ? '+' : '';
      const color = esBueno ? 'var(--success)' : 'var(--error)';
      return `<span style="color:${color}">${arrow} ${sign}${Math.abs(delta)}</span>`;
    };

    const anyHasMes = vals.some(v => v.mes);
    const labels = vals.map((v, i) => anyHasMes ? `Mes ${v.mes || (i+1)}` : new Date(v.fecha).toLocaleDateString('es-CO',{month:'short',year:'2-digit'}));

    document.getElementById('valContent').innerHTML = `
      <div style="margin-bottom:16px;display:flex;align-items:center;gap:12px;flex-wrap:wrap">
        <img src="${u.avatar||getAvatarUrl(u.usuario)}" style="width:48px;height:48px;border-radius:50%;border:3px solid rgba(0,200,255,0.4)">
        <div style="flex:1">
          <div style="font-weight:700;font-size:1.1rem">${u.nombres} ${u.apellidos||''}</div>
          <div style="font-size:0.8rem;color:var(--text-muted)">${vals.length} valoraci√≥n(es) registrada(s)</div>
        </div>
        <button class="btn btn-primary btn-sm" onclick="showValoracionModal('${uid}')">+ Agregar valoraci√≥n</button>
      </div>

      ${lastVal ? `
      <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:12px;margin-bottom:20px">
        <div class="stat-card" style="--card-accent:#ff6b35;padding:16px">
          <div style="font-size:0.7rem;color:var(--text-muted);text-transform:uppercase;letter-spacing:1px">% Grasa actual</div>
          <div style="font-size:1.8rem;font-weight:900;color:#ff6b35">${lastVal.grasa}%</div>
          <div style="font-size:0.8rem;margin-top:2px">${trendIcon(deltaGrasa, true)}</div>
        </div>
        <div class="stat-card" style="--card-accent:var(--success);padding:16px">
          <div style="font-size:0.7rem;color:var(--text-muted);text-transform:uppercase;letter-spacing:1px">% Masa muscular</div>
          <div style="font-size:1.8rem;font-weight:900;color:var(--success)">${lastVal.muscular}%</div>
          <div style="font-size:0.8rem;margin-top:2px">${trendIcon(deltaMuscular)}</div>
        </div>
        <div class="stat-card" style="--card-accent:var(--primary);padding:16px">
          <div style="font-size:0.7rem;color:var(--text-muted);text-transform:uppercase;letter-spacing:1px">Peso actual</div>
          <div style="font-size:1.8rem;font-weight:900;color:var(--primary)">${lastVal.peso} kg</div>
          <div style="font-size:0.8rem;margin-top:2px">${trendIcon(deltaPeso, false)}</div>
        </div>
        ${lastVal.imc?`<div class="stat-card" style="--card-accent:var(--accent);padding:16px">
          <div style="font-size:0.7rem;color:var(--text-muted);text-transform:uppercase;letter-spacing:1px">IMC</div>
          <div style="font-size:1.8rem;font-weight:900;color:var(--accent)">${lastVal.imc}</div>
          <div style="font-size:0.8rem;margin-top:2px;color:var(--text-muted)">${lastVal.imc<18.5?'Bajo peso':lastVal.imc<25?'Normal':lastVal.imc<30?'Sobrepeso':'Obesidad'}</div>
        </div>`:''}
      </div>` : `<div style="padding:16px;background:rgba(255,107,53,0.08);border:1px solid rgba(255,107,53,0.2);border-radius:12px;margin-bottom:16px;font-size:0.85rem;color:#ff6b35">‚ö†Ô∏è Sin valoraciones registradas a√∫n</div>`}

      ${vals.length >= 2 ? `
      <!-- Charts composici√≥n corporal -->
      <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:16px;margin-bottom:20px">
        <div class="glass-panel"><div class="panel-header"><span class="panel-title">üî• % Grasa</span></div><div class="panel-body"><div class="chart-container" style="height:180px"><canvas id="chartGrasa"></canvas></div></div></div>
        <div class="glass-panel"><div class="panel-header"><span class="panel-title">üí™ % Muscular</span></div><div class="panel-body"><div class="chart-container" style="height:180px"><canvas id="chartMuscular"></canvas></div></div></div>
        <div class="glass-panel"><div class="panel-header"><span class="panel-title">‚öñÔ∏è Peso</span></div><div class="panel-body"><div class="chart-container" style="height:180px"><canvas id="chartPesoVal"></canvas></div></div></div>
        <div class="glass-panel"><div class="panel-header"><span class="panel-title">üìä Composici√≥n integral</span></div><div class="panel-body"><div class="chart-container" style="height:180px"><canvas id="chartComp"></canvas></div></div></div>
        ${vals.some(v=>v.metabolismo)?`<div class="glass-panel"><div class="panel-header"><span class="panel-title">üî• Metabolismo basal</span></div><div class="panel-body"><div class="chart-container" style="height:180px"><canvas id="chartMetab"></canvas></div></div></div>`:''}
        ${vals.some(v=>v.icc)?`<div class="glass-panel"><div class="panel-header"><span class="panel-title">üìê √çndice cintura-cadera</span></div><div class="panel-body"><div class="chart-container" style="height:180px"><canvas id="chartICC"></canvas></div></div></div>`:''}
        ${vals.some(v=>v.cintura)?`<div class="glass-panel"><div class="panel-header"><span class="panel-title">üìè Medidas (cintura/cadera)</span></div><div class="panel-body"><div class="chart-container" style="height:180px"><canvas id="chartMedidas"></canvas></div></div></div>`:''}
        ${vals.some(v=>v.bicepRelIzq||v.bicepContIzq)?`<div class="glass-panel"><div class="panel-header"><span class="panel-title">üí™ B√≠ceps</span></div><div class="panel-body"><div class="chart-container" style="height:180px"><canvas id="chartBicep"></canvas></div></div></div>`:''}
        ${vals.some(v=>v.musloIzq)?`<div class="glass-panel"><div class="panel-header"><span class="panel-title">ü¶µ Muslos y pantorrilla</span></div><div class="panel-body"><div class="chart-container" style="height:180px"><canvas id="chartPiernas"></canvas></div></div></div>`:''}
        ${vals.some(v=>v.pliegues)?`
          <div class="glass-panel" style="grid-column:1/-1">
            <div class="panel-header"><span class="panel-title">üìê Pliegues cut√°neos ‚Äî Evoluci√≥n por zona</span></div>
            <div class="panel-body">
              <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:12px">
                ${['Tr√≠ceps','Subescapular','Supraespinal','Abdominal','Muslo','Pantorrilla'].map((pk,pi)=>`
                  <div style="background:rgba(123,47,255,0.06);border:1px solid rgba(123,47,255,0.2);border-radius:14px;padding:12px">
                    <div style="font-size:0.72rem;color:#a78bfa;text-transform:uppercase;letter-spacing:1px;margin-bottom:6px;font-weight:600">üìç ${pk}</div>
                    <div class="chart-container" style="height:130px"><canvas id="chartPliegue_${pi}"></canvas></div>
                  </div>`).join('')}
              </div>
            </div>
          </div>`:''}
      </div>` : vals.length===1 ? `<div style="padding:12px;background:rgba(0,200,255,0.06);border:1px solid rgba(0,200,255,0.2);border-radius:12px;margin-bottom:16px;font-size:0.85rem;color:var(--primary)">üìä Agrega al menos 2 valoraciones para ver las gr√°ficas de tendencia</div>` : ''}

      ${lastVal ? `
      <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê MAPA CORPORAL PROFESIONAL ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
      <div class="glass-panel" style="margin-bottom:20px">
        <div class="panel-header" style="border-bottom:1px solid rgba(0,200,255,0.15)">
          <span class="panel-title">üß¨ Mapa de Mediciones Corporales</span>
          <span style="font-size:0.72rem;color:var(--text-muted);letter-spacing:1px">${lastVal.mes?`MES ${lastVal.mes} ¬∑ `:''} ${new Date(lastVal.fecha).toLocaleDateString('es-CO',{day:'2-digit',month:'long',year:'numeric'})}</span>
        </div>
        <div class="panel-body" style="padding:24px">
          <div id="bodyMapContainer" style="display:flex;gap:32px;align-items:flex-start;flex-wrap:wrap;justify-content:center">
            <!-- IMAGEN CORPORAL FRONTAL -->
            <div style="display:flex;gap:20px;justify-content:center;flex-shrink:0">
              ${buildBodyMapSVG(lastVal)}
            </div>
            <!-- LEYENDA -->
            <div style="flex:1;min-width:220px;display:flex;flex-direction:column;gap:6px">
              ${buildBodyMapLegend(lastVal)}
            </div>
          </div>
        </div>
      </div>` : ''}

      <div class="glass-panel">
        <div class="panel-header">
          <span class="panel-title">üìÖ Historial de valoraciones</span>
        </div>
        <div class="panel-body" style="display:flex;flex-direction:column;gap:10px">
          ${vals.length===0?'<div class="empty-state"><div class="empty-icon">üìä</div><div class="empty-text">Sin valoraciones a√∫n</div></div>':
            [...vals].reverse().map((v,i)=>{
              const vid = Object.entries(valoraciones[uid]||{}).find(([,val])=>val.fecha===v.fecha)?.[0];
              return `
              <div style="background:rgba(0,0,0,0.25);border:1px solid rgba(255,255,255,0.07);border-radius:14px;padding:14px">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;flex-wrap:wrap;gap:6px">
                  <div style="font-weight:700;color:var(--primary)">
                    ${v.mes?`Mes ${v.mes}`:''} 
                    <span style="font-size:0.75rem;color:var(--text-muted);font-weight:400">${new Date(v.fecha).toLocaleDateString('es-CO',{day:'2-digit',month:'long',year:'numeric'})}</span>
                  </div>
                  <div style="display:flex;gap:6px">
                    <button class="btn btn-secondary btn-sm" onclick="exportValoracionPDF('${uid}','${vid}')">üìÑ</button>
                    <button class="btn btn-danger btn-sm" onclick="deleteValoracion('${uid}','${vid}')">üóëÔ∏è</button>
                  </div>
                </div>
                <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(120px,1fr));gap:8px">
                  <div class="rev-info-card"><div class="ric-label">üî• % Grasa</div><div class="ric-val" style="color:#ff6b35">${v.grasa}%</div></div>
                  <div class="rev-info-card"><div class="ric-label">üí™ % Muscular</div><div class="ric-val" style="color:var(--success)">${v.muscular}%</div></div>
                  <div class="rev-info-card"><div class="ric-label">‚öñÔ∏è Peso</div><div class="ric-val">${v.peso} kg</div></div>
                  ${v.imc?`<div class="rev-info-card"><div class="ric-label">üìè IMC</div><div class="ric-val">${v.imc}</div></div>`:''}
                  ${v.metabolismo?`<div class="rev-info-card"><div class="ric-label">üî• Metab. basal</div><div class="ric-val">${v.metabolismo} kcal</div></div>`:''}
                  ${v.icc?`<div class="rev-info-card"><div class="ric-label">üìê ICC</div><div class="ric-val">${v.icc}</div></div>`:''}
                  ${v.cuello?`<div class="rev-info-card"><div class="ric-label">Cuello</div><div class="ric-val">${v.cuello} cm</div></div>`:''}
                  ${v.torax?`<div class="rev-info-card"><div class="ric-label">T√≥rax</div><div class="ric-val">${v.torax} cm</div></div>`:''}
                  ${v.cintura?`<div class="rev-info-card"><div class="ric-label">Cintura</div><div class="ric-val">${v.cintura} cm</div></div>`:''}
                  ${v.abdomen?`<div class="rev-info-card"><div class="ric-label">Abdomen</div><div class="ric-val">${v.abdomen} cm</div></div>`:''}
                  ${v.cadera?`<div class="rev-info-card"><div class="ric-label">Cadera</div><div class="ric-val">${v.cadera} cm</div></div>`:''}
                  ${v.bicepRelIzq?`<div class="rev-info-card"><div class="ric-label">üí™ B√≠c.Rel.Izq</div><div class="ric-val">${v.bicepRelIzq} cm</div></div>`:''}
                  ${v.bicepRelDer?`<div class="rev-info-card"><div class="ric-label">üí™ B√≠c.Rel.Der</div><div class="ric-val">${v.bicepRelDer} cm</div></div>`:''}
                  ${v.bicepContIzq?`<div class="rev-info-card"><div class="ric-label">üí™ B√≠c.Cont.Izq</div><div class="ric-val">${v.bicepContIzq} cm</div></div>`:''}
                  ${v.bicepContDer?`<div class="rev-info-card"><div class="ric-label">üí™ B√≠c.Cont.Der</div><div class="ric-val">${v.bicepContDer} cm</div></div>`:''}
                  ${v.musloIzq?`<div class="rev-info-card"><div class="ric-label">ü¶µ Muslo Izq</div><div class="ric-val">${v.musloIzq} cm</div></div>`:''}
                  ${v.musloDer?`<div class="rev-info-card"><div class="ric-label">ü¶µ Muslo Der</div><div class="ric-val">${v.musloDer} cm</div></div>`:''}
                  ${v.pantorrilla?`<div class="rev-info-card"><div class="ric-label">ü¶µ Pantorrilla</div><div class="ric-val">${v.pantorrilla} cm</div></div>`:''}
                  ${v.pesoGraso?`<div class="rev-info-card"><div class="ric-label">üèãÔ∏è Masa grasa</div><div class="ric-val">${v.pesoGraso} kg</div></div>`:''}
                  ${v.pesoMagro?`<div class="rev-info-card"><div class="ric-label">üéØ Masa magra</div><div class="ric-val">${v.pesoMagro} kg</div></div>`:''}
                  ${v.pesoOseo?`<div class="rev-info-card"><div class="ric-label">ü¶¥ Peso √≥seo</div><div class="ric-val">${v.pesoOseo} kg</div></div>`:''}
                </div>
                ${v.pliegues && Object.keys(v.pliegues).length ? `<div style="margin-top:8px"><div style="font-size:0.7rem;color:var(--text-muted);text-transform:uppercase;letter-spacing:1px;margin-bottom:4px">Pliegues cut√°neos (mm)</div><div style="display:flex;flex-wrap:wrap;gap:6px">${Object.entries(v.pliegues).map(([k,val])=>`<span style="background:rgba(123,47,255,0.12);border:1px solid rgba(123,47,255,0.25);border-radius:8px;padding:3px 8px;font-size:0.78rem">${k}: <strong>${val}</strong></span>`).join('')}</div></div>` : ''}
                ${v.notas?`<div style="margin-top:8px;font-size:0.82rem;color:var(--text-muted);padding:8px;background:rgba(255,255,255,0.03);border-radius:8px">üí¨ ${v.notas}</div>`:''}
              </div>`;
            }).join('')}
        </div>
      </div>
    `;

    // Render charts if enough data
    if(vals.length >= 2) {
      const chartOpts = {
        responsive:true, maintainAspectRatio:false,
        plugins:{
          legend:{display:false},
          // Plugin inline para fondo oscuro al exportar como imagen
          beforeDraw: (chart) => {
            const ctx = chart.ctx;
            ctx.save();
            ctx.globalCompositeOperation = 'destination-over';
            ctx.fillStyle = 'rgba(15,25,50,0.98)';
            ctx.fillRect(0, 0, chart.width, chart.height);
            ctx.restore();
          }
        },
        scales:{
          x:{grid:{color:'rgba(255,255,255,0.06)'},ticks:{color:'rgba(232,244,255,0.5)',font:{size:10}}},
          y:{grid:{color:'rgba(255,255,255,0.06)'},ticks:{color:'rgba(232,244,255,0.5)',font:{size:10}}}
        }
      };
      const chartOptsLegend = {...chartOpts, plugins:{...chartOpts.plugins, legend:{display:true,labels:{color:'rgba(232,244,255,0.7)',font:{size:10}}}}};
      const makeGradient = (ctx, c1, c2) => { const g=ctx.createLinearGradient(0,0,0,180); g.addColorStop(0,c1); g.addColorStop(1,c2); return g; };
      const mkLine = (el, label, data, color, fill=true) => {
        if(!el) return;
        const hasData = data.some(d=>d!=null);
        if(!hasData) return;
        new Chart(el, {type:'line',data:{labels,datasets:[{label,data,borderColor:color,backgroundColor:fill?(ctx)=>makeGradient(ctx.chart.ctx,color.replace(')',',0.3)').replace('rgb','rgba'),color.replace(')',',0)').replace('rgb','rgba')):'transparent',tension:0.4,fill,pointBackgroundColor:color,pointRadius:4,spanGaps:true}]},options:chartOpts});
      };

      mkLine(document.getElementById('chartGrasa'), '% Grasa', vals.map(v=>v.grasa), '#ff6b35');
      mkLine(document.getElementById('chartMuscular'), '% Muscular', vals.map(v=>v.muscular), '#00e5a0');
      mkLine(document.getElementById('chartPesoVal'), 'Peso kg', vals.map(v=>v.peso), '#00c8ff');
      // Composici√≥n integral (multi-line)
      const cc = document.getElementById('chartComp');
      if(cc) new Chart(cc,{type:'line',data:{labels,datasets:[
        {label:'% Grasa',data:vals.map(v=>v.grasa),borderColor:'#ff6b35',tension:0.4,fill:false,pointRadius:4,spanGaps:true},
        {label:'% Muscular',data:vals.map(v=>v.muscular),borderColor:'#00e5a0',tension:0.4,fill:false,pointRadius:4,spanGaps:true},
      ]},options:chartOptsLegend});
      mkLine(document.getElementById('chartMetab'), 'Kcal', vals.map(v=>v.metabolismo||null), '#ffd60a');
      mkLine(document.getElementById('chartICC'), 'ICC', vals.map(v=>v.icc||null), '#a78bfa');
      // Medidas cintura/cadera/torax
      const cm2 = document.getElementById('chartMedidas');
      if(cm2) new Chart(cm2,{type:'line',data:{labels,datasets:[
        {label:'Cintura',data:vals.map(v=>v.cintura||null),borderColor:'#ff6b35',tension:0.4,fill:false,pointRadius:4,spanGaps:true},
        {label:'Cadera',data:vals.map(v=>v.cadera||null),borderColor:'#00c8ff',tension:0.4,fill:false,pointRadius:4,spanGaps:true},
        {label:'Abdomen',data:vals.map(v=>v.abdomen||null),borderColor:'#ffd60a',tension:0.4,fill:false,pointRadius:4,spanGaps:true},
      ]},options:chartOptsLegend});
      // B√≠ceps
      const cb = document.getElementById('chartBicep');
      if(cb) new Chart(cb,{type:'line',data:{labels,datasets:[
        {label:'Rel.Izq',data:vals.map(v=>v.bicepRelIzq||null),borderColor:'#00e5a0',tension:0.4,fill:false,pointRadius:4,spanGaps:true},
        {label:'Rel.Der',data:vals.map(v=>v.bicepRelDer||null),borderColor:'#7b2fff',tension:0.4,fill:false,pointRadius:4,spanGaps:true},
        {label:'Cont.Izq',data:vals.map(v=>v.bicepContIzq||null),borderColor:'#ff6b35',tension:0.4,fill:false,pointRadius:4,spanGaps:true},
        {label:'Cont.Der',data:vals.map(v=>v.bicepContDer||null),borderColor:'#ffd60a',tension:0.4,fill:false,pointRadius:4,spanGaps:true},
      ]},options:chartOptsLegend});
      // Piernas
      const cpi = document.getElementById('chartPiernas');
      if(cpi) new Chart(cpi,{type:'line',data:{labels,datasets:[
        {label:'Muslo Izq',data:vals.map(v=>v.musloIzq||null),borderColor:'#00c8ff',tension:0.4,fill:false,pointRadius:4,spanGaps:true},
        {label:'Muslo Der',data:vals.map(v=>v.musloDer||null),borderColor:'#7b2fff',tension:0.4,fill:false,pointRadius:4,spanGaps:true},
        {label:'Pantorrilla',data:vals.map(v=>v.pantorrilla||null),borderColor:'#00e5a0',tension:0.4,fill:false,pointRadius:4,spanGaps:true},
      ]},options:chartOptsLegend});
      // Pliegues ‚Äî gr√°fica individual por zona
      {
        const pliegueKeys = ['Tr√≠ceps','Subescapular','Supraespinal','Abdominal','Muslo','Pantorrilla'];
        const plColors    = ['#ff6b35','#00c8ff','#00e5a0','#ffd60a','#a78bfa','#ff4d6d'];
        pliegueKeys.forEach((k, pi) => {
          const el = document.getElementById(`chartPliegue_${pi}`);
          if(!el) return;
          const data = vals.map(v => v.pliegues?.[k] ?? null);
          if(!data.some(x => x != null)) return;
          const col = plColors[pi];
          new Chart(el, {
            type:'line',
            data:{ labels, datasets:[{
              label: k, data,
              borderColor: col,
              backgroundColor: (ctx2) => {
                const g = ctx2.chart.ctx.createLinearGradient(0,0,0,130);
                g.addColorStop(0, col+'44'); g.addColorStop(1, col+'00'); return g;
              },
              tension:0.4, fill:true, pointBackgroundColor:col, pointRadius:4, spanGaps:true
            }]},
            options:{...chartOpts,
              plugins:{...chartOpts.plugins, legend:{display:false}},
              scales:{
                x:{grid:{color:'rgba(255,255,255,0.04)'},ticks:{color:'rgba(232,244,255,0.4)',font:{size:8}}},
                y:{grid:{color:'rgba(255,255,255,0.04)'},ticks:{color:'rgba(232,244,255,0.4)',font:{size:8}}}
              }
            }
          });
        });
      }
    }
  };

  container.innerHTML = `
    <div style="margin-bottom:16px;display:flex;align-items:center;gap:12px;flex-wrap:wrap">
      <label style="font-size:0.8rem;color:var(--text-muted);text-transform:uppercase;letter-spacing:1px;flex-shrink:0">Atleta:</label>
      <select class="glass-input" style="max-width:300px" onchange="window._valState={uid:this.value};renderValAtleta(this.value)">
        ${myAtletas.map(([id,u])=>`<option value="${id}" ${id===selectedUid?'selected':''}>${u.nombres} ${u.apellidos||''}</option>`).join('')}
      </select>
    </div>
    <div id="valContent"></div>
  `;

  window.renderValAtleta = renderAtletaVal;
  await renderAtletaVal(selectedUid);
}

window.showValoracionModal = async (uid=null) => {
  const [usSnap, myUids] = await Promise.all([get(ref(db,'usuarios')), getMyGroupUserUids()]);
  const users = usSnap.val()||{};
  const myAtletas = Object.entries(users).filter(([id,u])=>u.rol!=='admin' && u.rol!=='superadmin' && myUids.has(id));
  const userOpts = myAtletas.map(([id,u])=>`<option value="${id}" ${id===uid?'selected':''}>${u.nombres} ${u.apellidos||''}</option>`).join('');

  const PLIEGUES = ['Tr√≠ceps','Subescapular','Supraespinal','Abdominal','Muslo','Pantorrilla'];

  showOverlay(`
    <div class="overlay-header">
      <span class="overlay-title">‚öñÔ∏è Nueva Valoraci√≥n</span>
      <button class="btn-close" onclick="closeOverlay()">‚úï</button>
    </div>
    <div style="max-height:75vh;overflow-y:auto;padding-right:4px">
    <div class="form-grid">
      <div class="form-group" style="grid-column:1/-1"><label>Atleta *</label>
        <select class="glass-input" id="valUid"><option value="">Seleccionar...</option>${userOpts}</select>
      </div>
      <div class="form-group"><label>Mes (n√∫mero)</label>
        <input class="glass-input" type="number" id="valMes" placeholder="1" min="1">
      </div>
      <div class="form-group"><label>Fecha *</label>
        <input class="glass-input" type="date" id="valFecha" value="${new Date().toISOString().split('T')[0]}">
      </div>

      <!-- COMPOSICI√ìN CORPORAL -->
      <div style="grid-column:1/-1;font-size:0.72rem;color:var(--primary);text-transform:uppercase;letter-spacing:1px;font-weight:700;padding:8px 0 2px;border-top:1px solid rgba(255,255,255,0.07);margin-top:6px">üî¨ Composici√≥n corporal</div>
      <div class="form-group"><label>Peso (kg) *</label><input class="glass-input" type="number" id="valPeso" placeholder="70.5" step="0.1"></div>
      <div class="form-group"><label>% Grasa corporal *</label><input class="glass-input" type="number" id="valGrasa" placeholder="18.5" step="0.1" min="0" max="100"></div>
      <div class="form-group"><label>% Masa muscular *</label><input class="glass-input" type="number" id="valMuscular" placeholder="42.0" step="0.1" min="0" max="100"></div>
      <div class="form-group"><label>IMC</label><input class="glass-input" type="number" id="valIMC" placeholder="22.5" step="0.1"></div>
      <div class="form-group"><label>Masa grasa (kg)</label><input class="glass-input" type="number" id="valPesoGraso" placeholder="12.5" step="0.1"></div>
      <div class="form-group"><label>Masa magra (kg)</label><input class="glass-input" type="number" id="valPesoMagro" placeholder="55.0" step="0.1"></div>
      <div class="form-group"><label>Peso √≥seo (kg)</label><input class="glass-input" type="number" id="valPesoOseo" placeholder="3.2" step="0.1"></div>
      <div class="form-group"><label>Metabolismo basal (kcal)</label><input class="glass-input" type="number" id="valMetabolismo" placeholder="1650" step="1"></div>
      <div class="form-group"><label>√çndice cintura-cadera</label><input class="glass-input" type="number" id="valICC" placeholder="0.85" step="0.01"></div>

      <!-- MEDIDAS CORPORALES -->
      <div style="grid-column:1/-1;font-size:0.72rem;color:var(--primary);text-transform:uppercase;letter-spacing:1px;font-weight:700;padding:8px 0 2px;border-top:1px solid rgba(255,255,255,0.07);margin-top:6px">üìè Medidas corporales (cm)</div>
      <div class="form-group"><label>Cuello</label><input class="glass-input" type="number" id="valCuello" placeholder="38.0" step="0.1"></div>
      <div class="form-group"><label>T√≥rax</label><input class="glass-input" type="number" id="valTorax" placeholder="95.0" step="0.1"></div>
      <div class="form-group"><label>Cintura</label><input class="glass-input" type="number" id="valCintura" placeholder="80.0" step="0.1"></div>
      <div class="form-group"><label>Abdomen</label><input class="glass-input" type="number" id="valAbdomen" placeholder="85.0" step="0.1"></div>
      <div class="form-group"><label>Cadera</label><input class="glass-input" type="number" id="valCadera" placeholder="95.0" step="0.1"></div>
      <div class="form-group"><label>B√≠cep relajado Izq (cm)</label><input class="glass-input" type="number" id="valBicepRelIzq" placeholder="33.0" step="0.1"></div>
      <div class="form-group"><label>B√≠cep relajado Der (cm)</label><input class="glass-input" type="number" id="valBicepRelDer" placeholder="33.0" step="0.1"></div>
      <div class="form-group"><label>B√≠cep contra√≠do Izq (cm)</label><input class="glass-input" type="number" id="valBicepContIzq" placeholder="35.0" step="0.1"></div>
      <div class="form-group"><label>B√≠cep contra√≠do Der (cm)</label><input class="glass-input" type="number" id="valBicepContDer" placeholder="35.0" step="0.1"></div>
      <div class="form-group"><label>Muslo Izq (cm)</label><input class="glass-input" type="number" id="valMusloIzq" placeholder="55.0" step="0.1"></div>
      <div class="form-group"><label>Muslo Der (cm)</label><input class="glass-input" type="number" id="valMusloDer" placeholder="55.0" step="0.1"></div>
      <div class="form-group"><label>Pantorrilla (cm)</label><input class="glass-input" type="number" id="valPantorrilla" placeholder="37.0" step="0.1"></div>

      <!-- PLIEGUES CUT√ÅNEOS -->
      <div style="grid-column:1/-1;font-size:0.72rem;color:var(--primary);text-transform:uppercase;letter-spacing:1px;font-weight:700;padding:8px 0 2px;border-top:1px solid rgba(255,255,255,0.07);margin-top:6px">üìê Pliegues cut√°neos (mm)</div>
      <div style="grid-column:1/-1;display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:10px">
        ${PLIEGUES.map(p=>`<div class="form-group" style="margin:0"><label>${p}</label><input class="glass-input" type="number" id="valP_${p.replace(/[^a-z]/gi,'_')}" placeholder="mm" step="0.1" min="0"></div>`).join('')}
      </div>

      <div class="form-group" style="grid-column:1/-1"><label>Notas</label>
        <textarea class="glass-input" id="valNotas" placeholder="Observaciones de la valoraci√≥n..."></textarea>
      </div>
    </div>
    </div>
    <div style="display:flex;gap:10px;margin-top:22px;justify-content:flex-end">
      <button class="btn btn-secondary" onclick="closeOverlay()">Cancelar</button>
      <button class="btn btn-primary" onclick="saveValoracion()">üíæ Guardar</button>
    </div>
  `);
};

const PLIEGUES_KEYS = ['Tr√≠ceps','Subescapular','Supraespinal','Abdominal','Muslo','Pantorrilla'];

window.saveValoracion = async () => {
  const uid = document.getElementById('valUid').value;
  const fecha = document.getElementById('valFecha').value;
  const peso = parseFloat(document.getElementById('valPeso').value);
  const grasa = parseFloat(document.getElementById('valGrasa').value);
  const muscular = parseFloat(document.getElementById('valMuscular').value);
  if(!uid || !fecha || isNaN(peso) || isNaN(grasa) || isNaN(muscular)) {
    return Swal.fire({icon:'warning',title:'Campos requeridos',text:'Completa atleta, fecha, peso, % grasa y % muscular',background:'rgba(10,20,40,0.95)',color:'#e8f4ff',confirmButtonColor:'#00c8ff'});
  }
  const gv = id => { const el = document.getElementById(id); return el ? (parseFloat(el.value)||null) : null; };
  const pliegues = {};
  PLIEGUES_KEYS.forEach(p => {
    const v = gv(`valP_${p.replace(/[^a-z]/gi,'_')}`);
    if(v !== null) pliegues[p] = v;
  });
  const data = {
    fecha: new Date(fecha).getTime(),
    peso, grasa, muscular,
    mes: parseInt(document.getElementById('valMes').value)||null,
    imc: gv('valIMC'),
    pesoGraso: gv('valPesoGraso'),
    pesoMagro: gv('valPesoMagro'),
    pesoOseo: gv('valPesoOseo'),
    metabolismo: gv('valMetabolismo'),
    icc: gv('valICC'),
    cuello: gv('valCuello'),
    torax: gv('valTorax'),
    cintura: gv('valCintura'),
    abdomen: gv('valAbdomen'),
    cadera: gv('valCadera'),
    bicepRelIzq: gv('valBicepRelIzq'),
    bicepRelDer: gv('valBicepRelDer'),
    bicepContIzq: gv('valBicepContIzq'),
    bicepContDer: gv('valBicepContDer'),
    musloIzq: gv('valMusloIzq'),
    musloDer: gv('valMusloDer'),
    pantorrilla: gv('valPantorrilla'),
    pliegues: Object.keys(pliegues).length ? pliegues : null,
    notas: document.getElementById('valNotas').value.trim()||null,
    creadaEn: Date.now()
  };
  Object.keys(data).forEach(k => data[k]===null && delete data[k]);
  await push(ref(db,`valoraciones/${uid}`), data);
  closeOverlay();
  window._valState = {uid};
  Swal.fire({icon:'success',title:'¬°Valoraci√≥n guardada!',timer:1500,showConfirmButton:false,background:'rgba(10,20,40,0.95)',color:'#e8f4ff'});
  document.querySelector('[data-page="valoraciones"]').click();
};

window.deleteValoracion = async (uid, vid) => {
  if(!vid) return;
  const r = await Swal.fire({icon:'warning',title:'¬øEliminar valoraci√≥n?',showCancelButton:true,confirmButtonColor:'#ff4d6d',background:'rgba(10,20,40,0.95)',color:'#e8f4ff'});
  if(r.isConfirmed) {
    await remove(ref(db,`valoraciones/${uid}/${vid}`));
    window._valState = {uid};
    document.querySelector('[data-page="valoraciones"]').click();
  }
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚îÄ‚îÄ Exportar Valoraci√≥n PDF ‚Äî Versi√≥n Premium ‚îÄ‚îÄ
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚îÄ‚îÄ Exportar Valoraci√≥n PDF ‚Äî Versi√≥n Elite ‚îÄ‚îÄ
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
window.exportValoracionPDF = async (uid, specificVid) => {
  if (!specificVid) {
    return Swal.fire({icon:'warning', title:'Selecciona una valoraci√≥n', text:'Usa el bot√≥n üìÑ de cada registro.', background:'rgba(10,20,40,0.95)', color:'#e8f4ff'});
  }
  if (!window.jspdf?.jsPDF) {
    return Swal.fire({icon:'error', title:'jsPDF no disponible', background:'rgba(10,20,40,0.95)', color:'#e8f4ff'});
  }

  Swal.fire({title:'Generando PDF...', text:'Preparando informe elite', allowOutsideClick:false, didOpen:()=>Swal.showLoading(), background:'rgba(10,20,40,0.95)', color:'#e8f4ff'});

  const [usSnap, valSnap, allValsSnap] = await Promise.all([
    get(ref(db, `usuarios/${uid}`)),
    get(ref(db, `valoraciones/${uid}/${specificVid}`)),
    get(ref(db, `valoraciones/${uid}`))
  ]);
  const user = usSnap.val() || {};
  const v    = valSnap.val();
  if (!v) { Swal.close(); return Swal.fire({icon:'warning', title:'Valoraci√≥n no encontrada', background:'rgba(10,20,40,0.95)', color:'#e8f4ff'}); }

  const allValsEntries = Object.entries(allValsSnap.val() || {}).sort((a,b) => a[1].fecha - b[1].fecha);
  const allValsArr     = allValsEntries.map(([,vv]) => vv);
  const thisIdx        = allValsEntries.findIndex(([id]) => id === specificVid);
  const prevVal        = thisIdx > 0 ? allValsEntries[thisIdx - 1][1] : null;

  const PLIEGUES_KEYS = ['Tr√≠ceps','Subescapular','Supraespinal','Abdominal','Muslo','Pantorrilla'];
  const PLIEGUES_COLS = ['#ff6b35','#00c8ff','#00e5a0','#ffd60a','#a78bfa','#ff4d6d'];
  const hexToRgb = h => [parseInt(h.slice(1,3),16),parseInt(h.slice(3,5),16),parseInt(h.slice(5,7),16)];

  // ‚îÄ‚îÄ Generar gr√°ficas en canvas offscreen ‚îÄ‚îÄ
  const anyHasMes = allValsArr.some(vv => vv.mes);
  const labels    = allValsArr.map((vv,i) => anyHasMes ? `M${vv.mes||(i+1)}` : new Date(vv.fecha).toLocaleDateString('es-CO',{month:'short',year:'2-digit'}));

  // Canvas con exactamente la misma proporci√≥n que GW x GH en el PDF
  // GW ‚âà 88mm, GH = 52mm ‚Üí ratio = 88/52 ‚âà 1.692
  // Usamos 900x532 para alta resoluci√≥n manteniendo ese ratio exacto
  const CHART_W = 900, CHART_H = 532;
  const offscreenChartImg = (cfg) => new Promise(resolve => {
    const el = document.createElement('canvas');
    el.width = CHART_W; el.height = CHART_H;
    el.style.cssText = 'position:fixed;left:-9999px;top:-9999px;pointer-events:none';
    document.body.appendChild(el);
    const ctx2 = el.getContext('2d');
    ctx2.fillStyle = '#0a0f1e';
    ctx2.fillRect(0, 0, CHART_W, CHART_H);
    const baseOpts = {
      responsive: false, animation: false,
      plugins: {
        legend: {
          display: cfg.legend || false,
          labels: { color:'rgba(210,230,255,0.85)', font:{size:16, family:'Arial'}, padding:14 }
        }
      },
      scales: {
        x: {
          grid: { color:'rgba(255,255,255,0.08)', lineWidth:1 },
          ticks: { color:'rgba(180,210,255,0.75)', font:{size:14} }
        },
        y: {
          grid: { color:'rgba(255,255,255,0.08)', lineWidth:1 },
          ticks: { color:'rgba(180,210,255,0.75)', font:{size:14} }
        }
      },
      layout: { padding: { top:8, right:12, bottom:8, left:8 } }
    };
    try {
      const ch = new Chart(el, { type:'line', data:{ labels, datasets: cfg.datasets }, options: baseOpts });
      setTimeout(() => {
        const img = el.toDataURL('image/png');
        ch.destroy();
        document.body.removeChild(el);
        resolve(img);
      }, 150);
    } catch(e) { try { document.body.removeChild(el); } catch(_){} resolve(null); }
  });

  const mkDS = (label, data, color, fill=true) => ({
    label, data, borderColor:color, pointBackgroundColor:color, borderWidth:2.5,
    backgroundColor: fill ? color.replace(')',',0.15)').replace('rgb','rgba') : 'transparent',
    tension:0.4, fill, pointRadius:4, pointHoverRadius:6, spanGaps:true
  });

  // Render all charts
  const chartDefs = [
    { id:'chartGrasa',    label:'% Grasa corporal',     col:[255,107,53],  datasets:[mkDS('% Grasa',   allValsArr.map(v=>v.grasa),    'rgb(255,107,53)')] },
    { id:'chartMuscular', label:'% Masa muscular',      col:[0,229,160],   datasets:[mkDS('% Muscular',allValsArr.map(v=>v.muscular), 'rgb(0,229,160)')] },
    { id:'chartPesoVal',  label:'Peso corporal (kg)',   col:[0,200,255],   datasets:[mkDS('Peso kg',   allValsArr.map(v=>v.peso),     'rgb(0,200,255)')] },
    { id:'chartComp',     label:'Composici√≥n integral', col:[160,100,255], legend:true, datasets:[
      mkDS('% Grasa',   allValsArr.map(v=>v.grasa),    'rgb(255,107,53)',false),
      mkDS('% Muscular',allValsArr.map(v=>v.muscular), 'rgb(0,229,160)',false)
    ]},
    { id:'chartMetab',    label:'Metabolismo basal (kcal)', col:[255,214,10],  datasets:[mkDS('Kcal',    allValsArr.map(v=>v.metabolismo||null),'rgb(255,214,10)')] },
    { id:'chartICC',      label:'√çndice cintura-cadera',   col:[167,139,250], datasets:[mkDS('ICC',     allValsArr.map(v=>v.icc||null),       'rgb(167,139,250)')] },
    { id:'chartMedidas',  label:'Medidas corporales (cm)', col:[0,229,160],   legend:true, datasets:[
      mkDS('Cintura', allValsArr.map(v=>v.cintura||null),'rgb(255,107,53)',false),
      mkDS('Cadera',  allValsArr.map(v=>v.cadera||null), 'rgb(0,200,255)',false),
      mkDS('Abdomen', allValsArr.map(v=>v.abdomen||null),'rgb(255,214,10)',false)
    ]},
    { id:'chartBicep',    label:'B√≠ceps (cm)',           col:[0,200,255],   legend:true, datasets:[
      mkDS('Rel.Izq', allValsArr.map(v=>v.bicepRelIzq||null), 'rgb(0,229,160)',false),
      mkDS('Rel.Der', allValsArr.map(v=>v.bicepRelDer||null), 'rgb(123,47,255)',false),
      mkDS('Con.Izq', allValsArr.map(v=>v.bicepContIzq||null),'rgb(255,107,53)',false),
      mkDS('Con.Der', allValsArr.map(v=>v.bicepContDer||null),'rgb(255,214,10)',false)
    ]},
    { id:'chartPiernas',  label:'Muslos y pantorrilla (cm)', col:[123,47,255], legend:true, datasets:[
      mkDS('Muslo Izq',   allValsArr.map(v=>v.musloIzq||null),  'rgb(0,200,255)',false),
      mkDS('Muslo Der',   allValsArr.map(v=>v.musloDer||null),   'rgb(123,47,255)',false),
      mkDS('Pantorrilla', allValsArr.map(v=>v.pantorrilla||null),'rgb(0,229,160)',false)
    ]},
    ...PLIEGUES_KEYS.map((k,i) => ({
      id:`chartPliegue_${i}`, label:`Pliegue ${k}`,
      col: hexToRgb(PLIEGUES_COLS[i]),
      datasets:[mkDS(k, allValsArr.map(vv=>vv.pliegues?.[k]??null), PLIEGUES_COLS[i].replace('#','rgb(').replace(/(..)(..)(..)$/,(_,r,g,b)=>`${parseInt(r,16)},${parseInt(g,16)},${parseInt(b,16)})`).replace('rgb(rgb(','rgb('), false)]
    }))
  ];

  // Helper to check if chart has data
  const chartHasData = (def) => {
    return def.datasets.some(ds => ds.data.some(d => d != null));
  };

  // Siempre regenerar offscreen con el ratio exacto del PDF (nunca tomar del DOM)
  const chartImgs = {};
  await Promise.all(chartDefs.filter(d => chartHasData(d)).map(async d => {
    const img = await offscreenChartImg(d);
    if(img) chartImgs[d.id] = img;
  }));

  // ‚îÄ‚îÄ Setup jsPDF ‚îÄ‚îÄ
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({ orientation:'portrait', unit:'mm', format:'a4' });
  const W = doc.internal.pageSize.getWidth();
  const H = doc.internal.pageSize.getHeight();
  const M = 14;
  let y = M;

  // ‚îÄ‚îÄ Colores ‚îÄ‚îÄ
  const CP  = [0,200,255];      // cyan
  const CS  = [0,229,160];      // green
  const CA  = [160,100,255];    // purple
  const CW  = [255,214,10];     // yellow
  const CE  = [255,80,110];     // red
  const CO  = [255,107,53];     // orange
  const CMU = [110,145,185];    // muted
  const CTX = [210,232,255];    // text
  const CG1 = [14,22,42];       // header/card bg
  const CG2 = [18,28,52];       // card slightly lighter
  const CRW1= [20,32,58];       // row odd
  const CRW2= [24,38,65];       // row even

  const F = (...c) => doc.setFillColor(...c);
  const S = (...c) => doc.setDrawColor(...c);
  const T = (...c) => doc.setTextColor(...c);
  const LW = w => doc.setLineWidth(w);
  const FT = (sz, bold='normal') => { doc.setFontSize(sz); doc.setFont('helvetica', bold); };

  // ‚îÄ‚îÄ FONDO: negro puro, sin rejilla ‚îÄ‚îÄ
  const drawBg = () => {
    F(0,0,0);
    doc.rect(0,0,W,H,'F');
  };
  const newPage = () => { doc.addPage(); drawBg(); y = M; };
  // checkY con soporte de m√∫ltiples p√°ginas y correcci√≥n de rowY
  const checkY = (need, rowYRef) => {
    if(y + need > H - 14) {
      newPage();
      if(rowYRef) rowYRef.v = y;
    }
  };
  drawBg();

  const delta  = (a,b) => (a!=null && b!=null) ? a-b : null;
  const fmtD   = (d, inv=false) => {
    if(d===null) return {txt:'‚Äî',col:CMU};
    if(Math.abs(d)<0.05) return {txt:'sin cambio',col:CMU};
    const up=d>0, good=inv?!up:up;
    return {txt:`${up?'‚ñ≤':'‚ñº'} ${Math.abs(d).toFixed(1)}`, col:good?CS:CE};
  };



  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  // SILUETA HUMANA ‚Äî Render canvas offscreen para PDF (frontal y posterior)
  // Replica EXACTAMENTE el contenedor web 130x325 con object-fit:cover
  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const BODY_SCALE = 4;
  const CONT_W = 130, CONT_H = 325;
  const CW2 = CONT_W * BODY_SCALE;
  const CH2 = CONT_H * BODY_SCALE;

  const renderBodyCanvas = (imgSrc, zones) => new Promise(resolve => {
    const drawOnCanvas = (imgEl) => {
      const el = document.createElement('canvas');
      el.width = CW2; el.height = CH2;
      el.style.cssText = 'position:fixed;left:-9999px;top:-9999px;pointer-events:none';
      document.body.appendChild(el);
      const ctx2d = el.getContext('2d');

      // Fondo oscuro
      ctx2d.fillStyle = 'rgba(15,25,50,1)';
      ctx2d.fillRect(0, 0, CW2, CH2);

      // object-fit:cover ‚Äî escala para cubrir todo el canvas, centrada
      const natW = imgEl.naturalWidth || imgEl.width;
      const natH = imgEl.naturalHeight || imgEl.height;
      const coverScale = Math.max(CW2 / natW, CH2 / natH);
      const drawW = natW * coverScale;
      const drawH = natH * coverScale;
      ctx2d.drawImage(imgEl, (CW2 - drawW) / 2, (CH2 - drawH) / 2, drawW, drawH);

      // Dibujar puntos: mx/my % del contenedor, igual que en la web
      zones.forEach(z => {
        const px = z.mx * CW2;
        const py = z.my * CH2;
        const r2 = parseInt(z.col.slice(1,3),16);
        const g2 = parseInt(z.col.slice(3,5),16);
        const b2 = parseInt(z.col.slice(5,7),16);
        ctx2d.beginPath();
        ctx2d.arc(px, py, 6.5 * BODY_SCALE, 0, Math.PI*2);
        ctx2d.fillStyle = `rgba(${r2},${g2},${b2},0.25)`;
        ctx2d.fill();
        ctx2d.beginPath();
        ctx2d.arc(px, py, 3.5 * BODY_SCALE, 0, Math.PI*2);
        ctx2d.fillStyle = `rgba(${r2},${g2},${b2},1)`;
        ctx2d.fill();
        ctx2d.strokeStyle = 'rgba(255,255,255,0.95)';
        ctx2d.lineWidth = 2 * BODY_SCALE;
        ctx2d.stroke();
        ctx2d.beginPath();
        ctx2d.arc(px, py, 1.2 * BODY_SCALE, 0, Math.PI*2);
        ctx2d.fillStyle = 'white';
        ctx2d.fill();
      });

      const dataUrl = el.toDataURL('image/png');
      document.body.removeChild(el);
      resolve(dataUrl);
    };

    fetch(imgSrc)
      .then(r => r.blob())
      .then(blob => {
        const blobUrl = URL.createObjectURL(blob);
        const img2 = new Image();
        img2.onload = () => { drawOnCanvas(img2); URL.revokeObjectURL(blobUrl); };
        img2.onerror = () => { URL.revokeObjectURL(blobUrl); resolve(null); };
        img2.src = blobUrl;
      })
      .catch(() => {
        const img2 = new Image();
        img2.onload = () => drawOnCanvas(img2);
        img2.onerror = () => resolve(null);
        img2.src = imgSrc;
      });
  });

  const frontZonesPDF = [
    ...BODY_ZONES.filter(z=>z.side==='front'&&v[z.key]!=null),
    ...PLIEGUES_ZONES.filter(z=>z.side==='front'&&v.pliegues?.[z.key]!=null)
  ];
  const backZonesPDF = [
    ...BODY_ZONES.filter(z=>z.side==='back'&&v[z.key]!=null),
    ...PLIEGUES_ZONES.filter(z=>z.side==='back'&&v.pliegues?.[z.key]!=null)
  ];

  const [bodyFrontImg, bodyBackImg] = await Promise.all([
    renderBodyCanvas('body.png',      frontZonesPDF),
    renderBodyCanvas('body_back.png', backZonesPDF)
  ]);

  // ‚îÄ‚îÄ DATOS ‚îÄ‚îÄ
  const addC=(arr,label,key,unit,inv=false)=>{ if(v[key]!=null) arr.push({label,val:`${v[key]}${unit}`,d:delta(v[key],prevVal?.[key]),inv}); };
  const addM=(arr,label,key,inv=false)=>{ if(v[key]!=null) arr.push({label,val:`${v[key]} cm`,d:delta(v[key],prevVal?.[key]),inv}); };

  const fechaStr = new Date(v.fecha).toLocaleDateString('es-CO',{day:'2-digit',month:'long',year:'numeric'});
  const mesLabel = v.mes ? `Mes ${v.mes}  ¬∑  ` : '';

  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  // P√ÅGINA 1 ‚Äî PORTADA & DATOS
  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

  // Header elegante
  F(...CG1); doc.rect(0,0,W,46,'F');
  F(...CP); doc.rect(0,0,4,46,'F');
  T(...CP); FT(22,'bold'); doc.text('SAYKYO', M+3, 19);
  T(240,248,255); FT(22,'normal'); doc.text(' CLUB', M+40, 19);
  T(...CMU); FT(7); doc.text('INFORME DE VALORACI√ìN F√çSICA ‚Äî COMPOSICI√ìN CORPORAL', M+3, 28);
  T(...CMU); FT(6.5);
  doc.text(`${mesLabel}${fechaStr}`, M+3, 34);
  doc.text(`Generado: ${new Date().toLocaleDateString('es-CO')}`, W-M, 34, {align:'right'});
  // Atleta
  F(10,18,38); doc.roundedRect(M, 37, W-2*M, 10, 1.5,1.5,'F');
  T(...CTX); FT(10,'bold');
  doc.text(`${user.nombres||''} ${user.apellidos||''}`.trim(), M+3, 43.5);
  T(...CMU); FT(6.5);
  const infoArr=[user.usuario?`@${user.usuario}`:'',user.edad?`${user.edad} a√±os`:'',user.altura?`${user.altura} cm`:''].filter(Boolean);
  doc.text(infoArr.join('  ¬∑  '), W-M, 43.5, {align:'right'});
  y = 52;

  // KPIs
  const kpis=[
    {label:'Peso',      val:v.peso,     prev:prevVal?.peso,     unit:'kg',col:CP,  inv:false},
    {label:'% Grasa',   val:v.grasa,    prev:prevVal?.grasa,    unit:'%', col:CO,  inv:true},
    {label:'% M√∫sculo', val:v.muscular, prev:prevVal?.muscular, unit:'%', col:CS,  inv:false},
    {label:'IMC',       val:v.imc,      prev:prevVal?.imc,      unit:'',  col:CA,  inv:false},
  ].filter(k=>k.val!=null);

  if(kpis.length){
    const kW=(W-2*M-(kpis.length-1)*4)/kpis.length;
    kpis.forEach((k,i)=>{
      const kx=M+i*(kW+4);
      F(...CG2); doc.roundedRect(kx,y,kW,28,2,2,'F');
      F(...k.col); doc.roundedRect(kx,y,kW,1.5,0.5,0.5,'F');
      T(...CMU); FT(5.5); doc.text(k.label.toUpperCase(), kx+kW/2, y+7, {align:'center'});
      T(...k.col); FT(14,'bold'); doc.text(`${k.val}${k.unit}`, kx+kW/2, y+18, {align:'center'});
      if(k.prev!=null){
        const d=fmtD(k.val-k.prev,k.inv); T(...d.col); FT(5.5,'bold');
        doc.text(d.txt, kx+kW/2, y+25, {align:'center'});
      } else { T(...CMU); FT(5); doc.text('Primera', kx+kW/2, y+25, {align:'center'}); }
    });
    y+=33;
  }

  // Banner comparaci√≥n
  if(prevVal){
    const pf=new Date(prevVal.fecha).toLocaleDateString('es-CO',{day:'2-digit',month:'short',year:'2-digit'});
    F(8,26,52); doc.roundedRect(M,y,W-2*M,8,1.5,1.5,'F');
    T(...CP); FT(6,'italic');
    doc.text(`‚ñ∏ Comparando con valoraci√≥n anterior${prevVal.mes?` Mes ${prevVal.mes}`:''}: ${pf}`, M+3, y+5.5);
    y+=12;
  } else {
    F(8,32,14); doc.roundedRect(M,y,W-2*M,8,1.5,1.5,'F');
    T(...CS); FT(6,'italic');
    doc.text('‚ñ∏ Primera valoraci√≥n registrada ‚Äî sin datos anteriores para comparar', M+3, y+5.5);
    y+=12;
  }

  // ‚îÄ‚îÄ Funci√≥n para secci√≥n + tabla ‚îÄ‚îÄ
  const secTitle=(title,col)=>{
    checkY(14,null);
    T(...col); FT(7.5,'bold'); doc.text(title.toUpperCase(), M, y);
    S(...col); LW(0.3); doc.line(M,y+2,W-M,y+2);
    y+=7;
  };
  const dataRows=(rows)=>{
    const RH=8.5, cW=(W-2*M)/2;
    rows.forEach((r,i)=>{
      if(i%2===0){ F(...(Math.floor(i/2)%2===0?CRW1:CRW2)); doc.rect(M,y,W-2*M,RH,'F'); }
      const rx=M+(i%2)*cW+2;
      T(...CMU); FT(5.5); doc.text(r.label, rx, y+3.5);
      T(...CTX); FT(8.5,'bold'); doc.text(r.val, rx, y+8);
      if(r.d!=null){ const fd=fmtD(r.d,r.inv||false); T(...fd.col); FT(5.5,'bold'); doc.text(fd.txt, rx+cW-18, y+8); }
      if(i%2===1||i===rows.length-1) y+=RH;
    });
    y+=4;
  };

  const compR=[];
  addC(compR,'Peso corporal','peso',' kg');
  addC(compR,'% Grasa','grasa','%',true);
  addC(compR,'% Masa muscular','muscular','%');
  if(v.imc!=null) compR.push({label:'IMC',val:`${v.imc}  (${v.imc<18.5?'Bajo peso':v.imc<25?'Normal':v.imc<30?'Sobrepeso':'Obesidad'})`,d:null});
  addC(compR,'Masa grasa','pesoGraso',' kg',true);
  addC(compR,'Masa magra','pesoMagro',' kg');
  addC(compR,'Peso √≥seo','pesoOseo',' kg');
  addC(compR,'Metabolismo basal','metabolismo',' kcal');
  addC(compR,'√çndice cintura-cadera','icc','',true);
  if(compR.length){ secTitle('Composici√≥n Corporal',CP); dataRows(compR); }

  const medR=[];
  addM(medR,'Cuello','cuello'); addM(medR,'T√≥rax','torax');
  addM(medR,'Cintura','cintura',true); addM(medR,'Abdomen','abdomen',true);
  addM(medR,'Cadera','cadera'); addM(medR,'B√≠cep Rel. Izq','bicepRelIzq');
  addM(medR,'B√≠cep Rel. Der','bicepRelDer'); addM(medR,'B√≠cep Cont. Izq','bicepContIzq');
  addM(medR,'B√≠cep Cont. Der','bicepContDer'); addM(medR,'Muslo Izq','musloIzq');
  addM(medR,'Muslo Der','musloDer'); addM(medR,'Pantorrilla','pantorrilla');
  if(medR.length){ secTitle('Medidas Corporales (cm)',CS); dataRows(medR); }

  const plR=[];
  if(v.pliegues) PLIEGUES_KEYS.forEach(k=>{ if(v.pliegues[k]!=null) plR.push({label:`Pliegue ${k}`,val:`${v.pliegues[k]} mm`,d:delta(v.pliegues[k],prevVal?.pliegues?.[k]),inv:true}); });
  if(plR.length){ secTitle('Pliegues Cut√°neos (mm)',CA); dataRows(plR); }

  if(v.notas){
    const nL=doc.splitTextToSize(v.notas, W-2*M-12);
    const nH=Math.max(14,nL.length*4+8);
    checkY(nH+4,null);
    F(12,24,46); doc.roundedRect(M,y,W-2*M,nH,2,2,'F');
    S(...CW); LW(0.3); doc.roundedRect(M,y,W-2*M,nH,2,2,'S');
    T(...CW); FT(6,'bold'); doc.text('OBSERVACIONES:',M+3,y+5);
    T(200,220,245); FT(7,'italic'); doc.text(nL,M+3,y+11);
    y+=nH+6;
  }

  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  // P√ÅGINA 2 ‚Äî MAPA CORPORAL CON SILUETA SVG
  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  newPage();
  F(...CG1); doc.rect(0,0,W,16,'F');
  F(...CS); doc.rect(0,0,4,16,'F');
  T(...CS); FT(10,'bold'); doc.text('MAPA DE MEDICIONES CORPORALES', M, 11);
  T(...CMU); FT(6.5); doc.text(`${user.nombres||''} ‚Äî ${mesLabel}${fechaStr}`, W-M, 11, {align:'right'});
  y=20;

  // Lado a lado centradas ‚Äî BW ajustado para que quepan dos en A4
  const GAP_H = 6; // separaci√≥n horizontal entre las dos im√°genes
  const BW = (W - 2*M - GAP_H) / 2; // cada imagen ocupa la mitad del ancho √∫til
  const BH = Math.round(BW * 325 / 130); // proporci√≥n exacta del contenedor web
  const totalW = BW * 2 + GAP_H;
  const fX  = (W - totalW) / 2;       // X imagen frontal (izq)
  const bkX = fX + BW + GAP_H;        // X imagen posterior (der)
  const bY  = y + 5;

  const hex2rgb = h => { const r=parseInt(h.slice(1),16); return [r>>16&255,(r>>8)&255,r&255]; };

  // Etiquetas centradas sobre cada imagen
  T(...CP); FT(6,'bold');
  doc.text('FRONTAL',   fX  + BW/2, bY - 2, {align:'center'});
  doc.text('POSTERIOR', bkX + BW/2, bY - 2, {align:'center'});

  // Im√°genes lado a lado
  try { if(bodyFrontImg) doc.addImage(bodyFrontImg,'PNG', fX,  bY, BW, BH); } catch(e){}
  try { if(bodyBackImg)  doc.addImage(bodyBackImg, 'PNG', bkX, bY, BW, BH); } catch(e){}

  // ‚îÄ‚îÄ Leyenda debajo de las dos im√°genes ‚îÄ‚îÄ
  const legY = bY + BH + 6;

  const allFrontZ = [
    ...BODY_ZONES.filter(z=>z.side==='front'&&v[z.key]!=null).map(z=>({...z, val:`${v[z.key]} cm`, col:hex2rgb(z.col)})),
    ...PLIEGUES_ZONES.filter(z=>z.side==='front'&&v.pliegues?.[z.key]!=null).map(z=>({...z, val:`${v.pliegues[z.key]} mm`, label:`Pl.${z.key}`, col:hex2rgb(z.col)}))
  ];
  const allBackZ = [
    ...BODY_ZONES.filter(z=>z.side==='back'&&v[z.key]!=null).map(z=>({...z, val:`${v[z.key]} cm`, col:hex2rgb(z.col)})),
    ...PLIEGUES_ZONES.filter(z=>z.side==='back'&&v.pliegues?.[z.key]!=null).map(z=>({...z, val:`${v.pliegues[z.key]} mm`, label:`Pl.${z.key}`, col:hex2rgb(z.col)}))
  ];

  const drawLeg = (zones, sx, title) => {
    if (!zones.length) return 0;
    T(...CMU); FT(5,'bold'); doc.text(title, sx, legY);
    zones.forEach((z,i) => {
      const ly = legY + 5 + i * 6;
      const [r2,g2,b2] = z.col;
      doc.setFillColor(r2,g2,b2); doc.rect(sx, ly-2.2, 3, 3, 'F');
      T(...CTX); FT(5,'bold'); doc.text(z.label, sx+4.5, ly);
      doc.setTextColor(r2,g2,b2); FT(5.5,'bold'); doc.text(z.val, sx+35, ly);
    });
    return zones.length * 6 + 8;
  };

  const legHFront = drawLeg(allFrontZ, M, 'MEDICIONES FRONTALES');
  const legHBack  = drawLeg(allBackZ,  W/2+2, 'MEDICIONES POSTERIORES');
  y = legY + Math.max(legHFront, legHBack);



  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  // P√ÅGINA(S) 3+ ‚Äî GR√ÅFICAS, una por p√°gina si es necesario
  // Las gr√°ficas se paginan correctamente: 2 por fila,
  // nueva p√°gina autom√°tica cuando no cabe la siguiente fila
  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const chartsOk=chartDefs.filter(d=>chartImgs[d.id]);
  if(chartsOk.length>0){
    newPage();
    F(...CG1); doc.rect(0,0,W,16,'F');
    F(...CW); doc.rect(0,0,4,16,'F');
    T(...CW); FT(10,'bold'); doc.text('GR√ÅFICAS DE EVOLUCI√ìN', M, 11);
    T(...CMU); FT(6.5); doc.text(`${user.nombres||''} ‚Äî ${mesLabel}${fechaStr}`, W-M, 11, {align:'right'});
    y=22;

    const GW=(W-2*M-6)/2; // ancho de cada gr√°fica
    const GH=52;           // alto de cada gr√°fica
    const GLH=8;           // alto del label encima
    const GBOX=GH+GLH+4;   // alto total de la caja

    let col2=0;
    let rowStartY=y;

    chartsOk.forEach((cd,idx)=>{
      // Al inicio de cada fila izquierda, verificar si cabe la fila completa
      if(col2===0){
        if(rowStartY + GBOX > H - 14){
          newPage();
          rowStartY=y;
        }
      }
      const cx2=M+col2*(GW+6);

      // Card oscura sutil
      F(...CG2); doc.roundedRect(cx2, rowStartY, GW, GBOX, 2,2,'F');
      // Barra de color superior fina
      F(...cd.col); doc.roundedRect(cx2, rowStartY, GW, 1.5, 0.5,0.5,'F');
      // Label
      T(...cd.col); FT(6,'bold');
      doc.text(cd.label, cx2+3, rowStartY+GLH-1);
      // Imagen
      try {
        doc.addImage(chartImgs[cd.id],'PNG', cx2+1, rowStartY+GLH, GW-2, GH);
      } catch(e){
        T(...CMU); FT(6);
        doc.text('(sin datos)', cx2+GW/2, rowStartY+GLH+GH/2, {align:'center'});
      }

      col2++;
      if(col2===2){
        col2=0;
        rowStartY+=GBOX+6;
      }
    });
    y=rowStartY+(col2>0?GBOX+6:0);
  }

  // ‚îÄ‚îÄ Pie de p√°gina todas las p√°ginas ‚îÄ‚îÄ
  const totalPg=doc.getNumberOfPages();
  for(let p=1;p<=totalPg;p++){
    doc.setPage(p);
    F(...CG1); doc.rect(0,H-9,W,9,'F');
    F(...CP); doc.rect(0,H-9,2.5,9,'F');
    T(...CMU); FT(5.5);
    doc.text('SAYKYO CLUB  ¬∑  Informe de Composici√≥n Corporal  ¬∑  Confidencial', M, H-3.5);
    doc.text(`P√°g. ${p} / ${totalPg}`, W-M, H-3.5, {align:'right'});
  }

  // ‚îÄ‚îÄ Descarga ‚îÄ‚îÄ
  const blob=doc.output('blob');
  const url=URL.createObjectURL(blob);
  const fn=`${(user.nombres||'Atleta').replace(/\s+/g,'_')}_valoracion_${new Date(v.fecha).toLocaleDateString('es-CO').replace(/\//g,'-')}.pdf`;
  const a=document.createElement('a'); a.href=url; a.download=fn; a.style.display='none';
  document.body.appendChild(a); a.click();
  setTimeout(()=>{ document.body.removeChild(a); URL.revokeObjectURL(url); },2000);
  Swal.fire({icon:'success',title:'‚úÖ PDF generado',text:`Descargando ${fn}`,timer:2500,showConfirmButton:false,background:'rgba(10,20,40,0.95)',color:'#e8f4ff'});
};

// ‚îÄ‚îÄ Selector visual de fatiga (admin) ‚îÄ‚îÄ
window.admSelectFatiga = (val) => {
  const colors = ['#00c8ff','#00e5a0','#4ade80','#a3e635','#ffd60a','#ff6b35','#f97316','#ef4444','#dc2626','#b91c1c'];
  const labels = ['1 - Nada cansado','2 - Muy poco cansado','3 - Poco cansado','4 - Algo cansado','5 - Moderadamente cansado','6 - Bastante cansado','7 - Muy cansado','8 - Agotado','9 - Muy agotado','10 - Totalmente destruido'];
  document.querySelectorAll('#adm_fatigue_scale [data-fval]').forEach(d => {
    const isSelected = +d.dataset.fval === val;
    const c = colors[+d.dataset.fval - 1];
    d.style.background  = isSelected ? c : 'rgba(255,255,255,0.04)';
    d.style.border      = isSelected ? `2px solid ${c}` : '1px solid rgba(255,255,255,0.08)';
    d.style.transform   = isSelected ? 'scale(1.12)' : 'scale(1)';
    d.style.boxShadow   = isSelected ? `0 0 12px ${c}88` : 'none';
  });
  const lbl = document.getElementById('adm_fatigue_label');
  if(lbl) { lbl.textContent = labels[val-1]; lbl.style.color = colors[val-1]; }
  const inp = document.getElementById('adm_fatiga');
  if(inp) inp.value = val;
};

// Init
// ============ REAL-TIME ALERT BADGE ============
// Cache en memoria actualizado por onValue ‚Äî nunca usa get() que puede devolver cach√© viejo
const _liveCache = { usuarios: null, rutinas: null, sesiones: null, revisiones_semana: null };
let _alertDebounce = null;

async function refreshAlertBadge(skipPageRender=false) {
  try {
    if(!_liveCache.usuarios || !_liveCache.rutinas || !_liveCache.sesiones || !_liveCache.revisiones_semana) return;
    const myUids = await getMyGroupUserUids();
    let alerts = await computeIntelligentAlerts(
      myUids,
      _liveCache.usuarios,
      _liveCache.rutinas,
      _liveCache.sesiones,
      _liveCache.revisiones_semana
    );
    // Filtrar usando isAlertDismissed (compara conditionValue, no solo presencia)
    alerts = alerts.filter(a => !isAlertDismissed(a));
    const badge = document.getElementById('alertasBadge');
    if(badge) {
      badge.textContent = alerts.length;
      badge.style.display = alerts.length > 0 ? '' : 'none';
    }
    // Solo re-renderizar la p√°gina si fue disparado por cambio de datos en tiempo real,
    // NO si viene de dismissAlert (para no volver a mostrar cards ya eliminados visualmente)
    if(!skipPageRender) {
      const active = document.querySelector('.nav-item.active');
      if(active && active.dataset.page === 'alertas') {
        const mainContent = document.querySelector('.content');
        if(mainContent) renderAlertas(mainContent);
      }
    }
  } catch(e) { console.warn('refreshAlertBadge error:', e); }
}

function setupAlertBadgeListener() {
  ['usuarios','rutinas','sesiones','revisiones_semana'].forEach(path => {
    onValue(ref(db, path), (snap) => {
      _liveCache[path] = snap.val() || {};
      clearTimeout(_alertDebounce);
      _alertDebounce = setTimeout(refreshAlertBadge, 600);
    });
  });
}

onAuthStateChanged(auth, async (user) => {
  if (!user) { sessionStorage.removeItem('saykyo_user'); window.location.href='index.html'; return; }
  if (typeof window._appInited === 'undefined') {
    window._appInited = true;
    // Cargar alertas descartadas desde Firebase ANTES de setup del badge
    await loadDismissedAlerts();
    // Setup notification listener
    setupNotifListener();
    // Listener de sesiones activas (cuando un atleta empieza a entrenar)
    setupTrainingStartListener();
    // Alertas en tiempo real
    setupAlertBadgeListener();
    // Restaurar p√°gina tras reload post-sesi√≥n admin
    const reloadPage = sessionStorage.getItem('saykyo_reload_page');
    const reloadUid  = sessionStorage.getItem('saykyo_reload_uid');
    if (reloadPage) {
      sessionStorage.removeItem('saykyo_reload_page');
      sessionStorage.removeItem('saykyo_reload_uid');
      if (reloadUid) window._atletaState = { uid: reloadUid, sesId: null };
      // Activar el nav item correcto
      const navItem = document.querySelector(`[data-page="${reloadPage}"]`);
      if (navItem) { document.querySelectorAll('.nav-item').forEach(i=>i.classList.remove('active')); navItem.classList.add('active'); }
      renderPage(reloadPage);
    } else {
      renderPage('home');
    }
  }
});
</script>

<a class="help-fab" id="helpFab" href="manual.html" title="Abrir manual">?</a>
<div class="help-fab-tooltip" id="helpFabTooltip">üìñ Manual de uso</div>

<script>
(function(){
  const fab = document.getElementById('helpFab');
  const tip = document.getElementById('helpFabTooltip');
  const KEY = 'saykyo_fab_pos';

  function updateTooltip(){
    const r = fab.getBoundingClientRect();
    const tipW = 140;
    if(r.left > tipW + 10){
      tip.style.left = (r.left - tipW - 8)+'px';
    } else {
      tip.style.left = (r.right + 8)+'px';
    }
    tip.style.top = (r.top + r.height/2 - 16)+'px';
    tip.style.right = 'auto';
    tip.style.bottom = 'auto';
  }

  // Restaurar posici√≥n guardada
  try {
    const saved = JSON.parse(localStorage.getItem(KEY));
    if(saved) {
      fab.style.left=saved.l; fab.style.top=saved.t;
      fab.style.right='auto'; fab.style.bottom='auto';
      setTimeout(updateTooltip,0);
    }
  } catch(e){}

  let dragging=false, ox=0, oy=0, moved=false;

  fab.addEventListener('mousedown', e=>{
    dragging=true; moved=false;
    const r=fab.getBoundingClientRect();
    ox=e.clientX-r.left; oy=e.clientY-r.top;
    fab.classList.add('dragging');
    e.preventDefault();
  });

  document.addEventListener('mousemove', e=>{
    if(!dragging) return;
    moved=true;
    const x=Math.min(Math.max(e.clientX-ox,0),window.innerWidth-48);
    const y=Math.min(Math.max(e.clientY-oy,0),window.innerHeight-48);
    fab.style.left=x+'px'; fab.style.top=y+'px';
    fab.style.right='auto'; fab.style.bottom='auto';
    updateTooltip();
  });

  document.addEventListener('mouseup', e=>{
    if(!dragging) return;
    dragging=false;
    fab.classList.remove('dragging');
    if(moved){
      try{ localStorage.setItem(KEY, JSON.stringify({l:fab.style.left,t:fab.style.top})); }catch(e){}
    }
  });

  // Touch support
  fab.addEventListener('touchstart', e=>{
    const t=e.touches[0];
    dragging=true; moved=false;
    const r=fab.getBoundingClientRect();
    ox=t.clientX-r.left; oy=t.clientY-r.top;
    fab.classList.add('dragging');
  },{passive:true});

  document.addEventListener('touchmove', e=>{
    if(!dragging) return;
    moved=true;
    const t=e.touches[0];
    const x=Math.min(Math.max(t.clientX-ox,0),window.innerWidth-48);
    const y=Math.min(Math.max(t.clientY-oy,0),window.innerHeight-48);
    fab.style.left=x+'px'; fab.style.top=y+'px';
    fab.style.right='auto'; fab.style.bottom='auto';
    e.preventDefault();
  },{passive:false});

  document.addEventListener('touchend', ()=>{
    if(!dragging) return;
    dragging=false;
    fab.classList.remove('dragging');
    if(moved) try{ localStorage.setItem(KEY, JSON.stringify({l:fab.style.left,t:fab.style.top})); }catch(e){}
  });

  // Evitar navegaci√≥n si se arrastr√≥
  fab.addEventListener('click', e=>{ if(moved){ e.preventDefault(); moved=false; } });

  updateTooltip();
  window.addEventListener('resize', updateTooltip);
})();
</script>
</body>
</html>
