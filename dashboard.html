<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SAYKYO CLUB - Dashboard</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Exo+2:wght@300;400;600;700;900&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
:root {
  --primary: #00c8ff;
  --primary-dark: #0088cc;
  --accent: #7b2fff;
  --accent2: #ff6b35;
  --success: #00e5a0;
  --warning: #ffd60a;
  --error: #ff4d6d;
  --glass-bg: rgba(10,20,45,0.7);
  --glass-border: rgba(255,255,255,0.1);
  --text: #e8f4ff;
  --text-muted: rgba(232,244,255,0.5);
  --bg-dark: #060c18;
  --sidebar-w: 260px;
}
* { margin:0; padding:0; box-sizing:border-box; }
html,body { height:100%; overflow:hidden; }
body { font-family:'Exo 2',sans-serif; background:var(--bg-dark); color:var(--text); display:flex; }

/* BG */
.bg-scene { position:fixed;inset:0;z-index:0;
  background: radial-gradient(ellipse at 15% 40%, rgba(0,100,200,0.2) 0%,transparent 50%),
              radial-gradient(ellipse at 85% 70%, rgba(123,47,255,0.15) 0%,transparent 50%), #060c18;
}
.grid-overlay { position:fixed;inset:0;z-index:0;opacity:0.03;
  background-image:linear-gradient(rgba(0,200,255,1) 1px,transparent 1px),
                   linear-gradient(90deg,rgba(0,200,255,1) 1px,transparent 1px);
  background-size:40px 40px;
}

/* SIDEBAR */
.sidebar {
  position:fixed; left:0;top:0;bottom:0; width:var(--sidebar-w);
  background: rgba(6,12,28,0.9);
  backdrop-filter:blur(30px);
  border-right: 1px solid var(--glass-border);
  z-index:100; display:flex; flex-direction:column;
  transition: transform 0.3s ease;
}
.sidebar-header {
  padding: 24px 20px 20px;
  border-bottom: 1px solid var(--glass-border);
}
.logo-text { font-family:'Space Mono',monospace; font-size:1.4rem; font-weight:700; letter-spacing:4px;
  background:linear-gradient(135deg,#fff,var(--primary),var(--accent));
  -webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;
}
.logo-sub { font-size:0.6rem;letter-spacing:6px;color:var(--primary);opacity:0.7; }

.admin-info {
  display:flex;align-items:center;gap:10px;
  padding:16px 20px; border-bottom:1px solid var(--glass-border);
}
.admin-avatar { width:38px;height:38px;border-radius:50%;border:2px solid var(--primary);object-fit:cover; }
.admin-name { font-size:0.85rem;font-weight:600; }
.admin-role { font-size:0.7rem;color:var(--primary);letter-spacing:1px; }

.nav-menu { flex:1;overflow-y:auto;padding:12px 0; }
.nav-item {
  display:flex;align-items:center;gap:12px;
  padding:12px 20px; cursor:pointer;
  font-size:0.9rem; font-weight:500;
  transition:all 0.2s ease; position:relative;
  color:var(--text-muted); border-left:3px solid transparent;
}
.nav-item:hover { background:rgba(0,200,255,0.06); color:var(--text); border-left-color:rgba(0,200,255,0.3); }
.nav-item.active { background:rgba(0,200,255,0.1); color:var(--primary); border-left-color:var(--primary); }
.nav-item .nav-icon { font-size:1.1rem;width:22px;text-align:center; }
.nav-divider { height:1px;background:var(--glass-border);margin:8px 20px; }
.nav-section { padding:6px 20px;font-size:0.65rem;letter-spacing:2px;color:var(--text-muted);text-transform:uppercase;margin-top:6px; }

.sidebar-footer { padding:16px 20px;border-top:1px solid var(--glass-border); }
.btn-logout {
  width:100%;padding:10px;background:rgba(255,77,109,0.1);border:1px solid rgba(255,77,109,0.3);
  border-radius:10px;color:#ff4d6d;font-family:'Exo 2',sans-serif;font-size:0.85rem;
  cursor:pointer;transition:all 0.2s ease;display:flex;align-items:center;justify-content:center;gap:8px;
}
.btn-logout:hover { background:rgba(255,77,109,0.2); }

/* MAIN */
.main {
  flex:1; margin-left:var(--sidebar-w);
  display:flex;flex-direction:column;
  height:100vh; overflow:hidden;
  position:relative;z-index:1;
}

/* TOPBAR */
.topbar {
  display:flex;align-items:center;justify-content:space-between;
  padding:16px 24px;
  background:rgba(6,12,28,0.8);
  backdrop-filter:blur(20px);
  border-bottom:1px solid var(--glass-border);
  flex-shrink:0;
}
.page-title { font-size:1.3rem;font-weight:700; }
.page-subtitle { font-size:0.8rem;color:var(--text-muted); }
.topbar-actions { display:flex;gap:10px;align-items:center; }
.menu-toggle { display:none;background:none;border:none;color:var(--text);font-size:1.3rem;cursor:pointer;padding:6px;flex-shrink:0; }
.btn-back { display:none;align-items:center;gap:6px;flex-shrink:0;background:rgba(255,255,255,0.06);border:1px solid rgba(255,255,255,0.12);border-radius:10px;padding:7px 14px;color:var(--text-muted);font-family:'Exo 2',sans-serif;font-size:0.85rem;font-weight:600;cursor:pointer;transition:all 0.2s ease;white-space:nowrap; }
.btn-back:hover { background:rgba(0,200,255,0.1);border-color:rgba(0,200,255,0.3);color:var(--primary); }
.btn-back.visible { display:inline-flex; }

/* CONTENT */
.content {
  flex:1; overflow-y:auto; padding:24px;
}

/* CARDS */
.dashboard-grid {
  display:grid; grid-template-columns:repeat(auto-fill,minmax(240px,1fr)); gap:16px; margin-bottom:24px;
}
.stat-card {
  background:var(--glass-bg); backdrop-filter:blur(20px);
  border:1px solid var(--glass-border); border-radius:20px;
  padding:22px; cursor:pointer; transition:all 0.3s ease;
  position:relative; overflow:hidden;
}
.stat-card::before {
  content:''; position:absolute;top:0;left:0;right:0;height:2px;
  background:var(--card-accent,var(--primary));
}
.stat-card:hover { transform:translateY(-3px); box-shadow:0 12px 30px rgba(0,0,0,0.3); border-color:rgba(255,255,255,0.2); }
.stat-icon { font-size:2rem;margin-bottom:12px; }
.stat-value { font-size:2rem;font-weight:900;color:var(--card-accent,var(--primary)); }
.stat-label { font-size:0.8rem;color:var(--text-muted);text-transform:uppercase;letter-spacing:1px;margin-top:4px; }

/* GLASS PANELS */
.glass-panel {
  background:var(--glass-bg); backdrop-filter:blur(20px);
  border:1px solid var(--glass-border); border-radius:20px;
  overflow:hidden;
}
.panel-header {
  display:flex;align-items:center;justify-content:space-between;
  padding:18px 22px; border-bottom:1px solid var(--glass-border);
}
.panel-title { font-size:1rem;font-weight:700; }
.panel-body { padding:20px; }

/* FORMS */
.form-grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(220px,1fr)); gap:14px; }
.form-group { display:flex;flex-direction:column;gap:6px; }
.form-group label { font-size:0.75rem;color:var(--text-muted);letter-spacing:1px;text-transform:uppercase; }
.glass-input {
  background:rgba(255,255,255,0.05); border:1px solid rgba(255,255,255,0.1);
  border-radius:12px; padding:12px 14px; color:var(--text);
  font-family:'Exo 2',sans-serif; font-size:0.9rem; outline:none; width:100%;
  transition:all 0.3s ease;
}
.glass-input:focus { border-color:var(--primary); background:rgba(0,200,255,0.08); box-shadow:0 0 0 3px rgba(0,200,255,0.1); }
.glass-input::placeholder { color:rgba(232,244,255,0.25); }
select.glass-input option { background:#0d1a35; }
textarea.glass-input { resize:vertical; min-height:80px; }

/* TOGGLE */
.toggle-wrap { display:flex;align-items:center;gap:10px; }
.toggle { position:relative;display:inline-block;width:44px;height:24px; }
.toggle input { opacity:0;width:0;height:0; }
.toggle-slider {
  position:absolute;inset:0; background:rgba(255,255,255,0.1);
  border-radius:24px; cursor:pointer; transition:0.3s;
  border:1px solid rgba(255,255,255,0.15);
}
.toggle-slider:before {
  content:''; position:absolute;height:18px;width:18px;
  left:2px;bottom:2px; background:#fff; border-radius:50%; transition:0.3s;
}
.toggle input:checked + .toggle-slider { background:var(--primary); }
.toggle input:checked + .toggle-slider:before { transform:translateX(20px); }
.toggle-label { font-size:0.85rem;color:var(--text-muted); }

/* BUTTONS */
.btn { padding:10px 18px; border-radius:12px; font-family:'Exo 2',sans-serif; font-size:0.85rem; font-weight:600; cursor:pointer; border:none; transition:all 0.2s ease; letter-spacing:0.5px; display:inline-flex;align-items:center;gap:8px; }
.btn-primary { background:linear-gradient(135deg,var(--primary-dark),var(--primary)); color:#fff; box-shadow:0 4px 15px rgba(0,200,255,0.3); }
.btn-primary:hover { transform:translateY(-1px); box-shadow:0 6px 20px rgba(0,200,255,0.5); }
.btn-secondary { background:rgba(255,255,255,0.08); border:1px solid var(--glass-border); color:var(--text); }
.btn-secondary:hover { background:rgba(255,255,255,0.12); }
.btn-danger { background:rgba(255,77,109,0.15); border:1px solid rgba(255,77,109,0.3); color:var(--error); }
.btn-danger:hover { background:rgba(255,77,109,0.25); }
.btn-success { background:linear-gradient(135deg,#00a86b,var(--success)); color:#000; }
.btn-accent { background:linear-gradient(135deg,var(--accent),#a855f7); color:#fff; }
.btn-sm { padding:7px 12px; font-size:0.8rem; border-radius:9px; }
.btn-icon { padding:8px; border-radius:9px; }
.btn-full { width:100%; justify-content:center; }

/* TABLE */
.data-table { width:100%; border-collapse:collapse; }
.data-table th { padding:10px 14px; text-align:left; font-size:0.75rem; letter-spacing:1px; text-transform:uppercase; color:var(--text-muted); border-bottom:1px solid var(--glass-border); }
.data-table td { padding:12px 14px; font-size:0.88rem; border-bottom:1px solid rgba(255,255,255,0.04); vertical-align:middle; }
.data-table tr:hover td { background:rgba(0,200,255,0.04); }
.badge { padding:3px 10px; border-radius:20px; font-size:0.72rem; font-weight:600; letter-spacing:0.5px; }
.badge-active { background:rgba(0,229,160,0.15); color:var(--success); border:1px solid rgba(0,229,160,0.3); }
.badge-inactive { background:rgba(255,77,109,0.15); color:var(--error); border:1px solid rgba(255,77,109,0.3); }
.badge-rpe { background:rgba(0,200,255,0.15); color:var(--primary); border:1px solid rgba(0,200,255,0.3); }
.badge-rir { background:rgba(123,47,255,0.15); color:#a78bfa; border:1px solid rgba(123,47,255,0.3); }

/* AVATAR SELECTOR */
.avatar-grid {
  display:grid; grid-template-columns:repeat(3,1fr); gap:50px;
  max-height:360px; overflow-y:auto; padding:8px 4px;
}
@media (min-width:600px) {
  .avatar-grid { grid-template-columns:repeat(auto-fill,minmax(72px,1fr)); gap:12px; }
}
.avatar-option {
  cursor:pointer; border-radius:50%; border:3px solid transparent;
  transition:all 0.2s ease; overflow:hidden;
  aspect-ratio:1; display:flex;align-items:center;justify-content:center;
}
.avatar-option img { width:100%;height:100%;object-fit:cover;border-radius:50%; }
.avatar-option:hover { border-color:rgba(0,200,255,0.5); transform:scale(1.08); }
.avatar-option.selected { border-color:var(--primary); box-shadow:0 0 15px rgba(0,200,255,0.4); transform:scale(1.05); }
.selected-avatar-preview {
  width:60px;height:60px;border-radius:50%;border:3px solid var(--primary);
  overflow:hidden;cursor:pointer;transition:all 0.2s ease;
  box-shadow:0 0 20px rgba(0,200,255,0.3);
}
.selected-avatar-preview img { width:100%;height:100%;object-fit:cover; }
.selected-avatar-preview:hover { transform:scale(1.05); }

/* TABS */
.tabs { display:flex; gap:4px; background:rgba(0,0,0,0.3); border-radius:14px; padding:4px; }
.tab { padding:8px 16px; border-radius:10px; cursor:pointer; font-size:0.85rem; font-weight:600; color:var(--text-muted); transition:all 0.2s ease; }
.tab.active { background:rgba(0,200,255,0.15); color:var(--primary); box-shadow:0 0 10px rgba(0,200,255,0.1); }

/* MONTH/WEEK/DAY builder */
.routine-builder { display:flex;gap:16px;height:100%; }
.rb-col { flex:1;display:flex;flex-direction:column;gap:10px; }
.rb-col-title { font-size:0.75rem;text-transform:uppercase;letter-spacing:1px;color:var(--text-muted);padding-bottom:8px;border-bottom:1px solid var(--glass-border); }
.rb-item {
  padding:10px 14px; background:rgba(255,255,255,0.04);
  border:1px solid var(--glass-border); border-radius:12px;
  cursor:pointer; font-size:0.88rem; transition:all 0.2s ease;
  display:flex;justify-content:space-between;align-items:center;
}
.rb-item:hover { background:rgba(0,200,255,0.06); border-color:rgba(0,200,255,0.2); }
.rb-item.active { background:rgba(0,200,255,0.1); border-color:var(--primary); color:var(--primary); }
.rb-item .rb-count { font-size:0.7rem;color:var(--text-muted);background:rgba(255,255,255,0.08);padding:2px 8px;border-radius:10px; }

/* EXERCISE SLOT */
.exercise-slot {
  background:rgba(255,255,255,0.04); border:1px solid var(--glass-border);
  border-radius:14px; padding:14px; margin-bottom:10px;
  position:relative;
}
.exercise-slot-header { display:flex;justify-content:space-between;align-items:center;margin-bottom:12px; }
.exercise-slot-title { font-weight:600;font-size:0.9rem; }
.slot-mini-grid { display:grid;grid-template-columns:repeat(auto-fill,minmax(120px,1fr));gap:8px; }

/* STATS/CHARTS */
.chart-container { position:relative; height:280px; }
.stats-filters { display:flex;gap:10px;flex-wrap:wrap;margin-bottom:16px; }
.stats-grid { display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:16px; }
.stats-card { background:var(--glass-bg);backdrop-filter:blur(20px);border:1px solid var(--glass-border);border-radius:16px;padding:18px; }

/* ANAMNESIS */
.anamnesis-card { background:rgba(0,200,255,0.05);border:1px solid rgba(0,200,255,0.15);border-radius:12px;padding:14px;margin-bottom:10px; }
.anamnesis-q { font-size:0.8rem;color:var(--text-muted);margin-bottom:4px; }
.anamnesis-a { font-size:0.92rem;font-weight:600; }

/* SEARCH + PAGINATION */
.table-toolbar { display:flex;align-items:center;gap:10px;padding:14px 16px;border-bottom:1px solid var(--glass-border);flex-wrap:wrap; }
.search-box { position:relative;flex:1;min-width:180px; }
.search-box input { width:100%;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:10px;padding:8px 12px 8px 34px;color:var(--text);font-family:'Exo 2',sans-serif;font-size:0.85rem;outline:none;transition:all 0.2s ease; }
.search-box input:focus { border-color:var(--primary);background:rgba(0,200,255,0.07);box-shadow:0 0 0 2px rgba(0,200,255,0.1); }
.search-box input::placeholder { color:rgba(232,244,255,0.3); }
.search-box .search-icon { position:absolute;left:10px;top:50%;transform:translateY(-50%);font-size:0.9rem;pointer-events:none; }
.pagination { display:flex;align-items:center;gap:6px;padding:12px 16px;border-top:1px solid var(--glass-border);justify-content:flex-end;flex-wrap:wrap; }
.page-info { font-size:0.78rem;color:var(--text-muted);margin-right:auto; }
.page-btn { width:32px;height:32px;border-radius:8px;border:1px solid rgba(255,255,255,0.1);background:rgba(255,255,255,0.05);color:var(--text);font-family:'Exo 2',sans-serif;font-size:0.82rem;font-weight:600;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all 0.2s ease; }
.page-btn:hover:not(:disabled) { background:rgba(0,200,255,0.1);border-color:rgba(0,200,255,0.3);color:var(--primary); }
.page-btn.active { background:rgba(0,200,255,0.15);border-color:var(--primary);color:var(--primary); }
.page-btn:disabled { opacity:0.3;cursor:not-allowed; }
.per-page-select { background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:8px;padding:5px 8px;color:var(--text);font-family:'Exo 2',sans-serif;font-size:0.8rem;outline:none;cursor:pointer; }
.per-page-select option { background:#0d1a35; }

/* SCROLLBAR */
.rev-info-card { background:rgba(255,255,255,0.04);border:1px solid rgba(255,255,255,0.07);border-radius:10px;padding:10px; }
.ric-label { font-size:0.68rem;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:4px; }
.ric-val { font-size:0.88rem;font-weight:700; }
::-webkit-scrollbar { width:5px; }
::-webkit-scrollbar-track { background:transparent; }
::-webkit-scrollbar-thumb { background:rgba(0,200,255,0.2);border-radius:3px; }
::-webkit-scrollbar-thumb:hover { background:rgba(0,200,255,0.4); }

/* OVERLAY */
.overlay-backdrop {
  position:fixed;inset:0;background:rgba(0,0,0,0.7);backdrop-filter:blur(10px);
  z-index:500;display:flex;align-items:center;justify-content:center;
  animation:fadeIn 0.2s ease;
}
@keyframes fadeIn { from{opacity:0} to{opacity:1} }
.overlay-panel {
  background:rgba(8,16,36,0.95);border:1px solid var(--glass-border);
  border-radius:24px;padding:28px;width:95%;max-width:800px;
  max-height:90vh;overflow-y:auto;
  animation:slideUp 0.3s cubic-bezier(0.16,1,0.3,1);
}
@keyframes slideUp { from{opacity:0;transform:translateY(30px)} to{opacity:1;transform:translateY(0)} }
.overlay-header { display:flex;justify-content:space-between;align-items:center;margin-bottom:22px; }
.overlay-title { font-size:1.2rem;font-weight:700; }
.btn-close { background:rgba(255,255,255,0.08);border:none;color:var(--text);width:32px;height:32px;border-radius:8px;cursor:pointer;font-size:1.1rem;display:flex;align-items:center;justify-content:center; }
.btn-close:hover { background:rgba(255,77,109,0.2);color:var(--error); }

/* MOBILE */
@media (max-width: 768px) {
  .sidebar { transform:translateX(-100%); }
  .sidebar.open { transform:translateX(0); }
  .main { margin-left:0; }
  .menu-toggle { display:block; }
  .dashboard-grid { grid-template-columns:repeat(2,1fr); }
  .form-grid { grid-template-columns:1fr; }
  .stats-grid { grid-template-columns:1fr; }
  .routine-builder { flex-direction:column; }
  .rutinas-layout { grid-template-columns:1fr !important; height:auto !important; }
  .rutinas-layout > .glass-panel:first-child { max-height:220px; }
}
.rutinas-layout {
  display:grid; grid-template-columns:280px 1fr; gap:16px; height:calc(100vh - 160px);
}

/* LOADING */
.page-loading { display:flex;flex-direction:column;align-items:center;justify-content:center;height:200px;gap:12px;color:var(--text-muted); }
.spinner-lg { width:40px;height:40px;border:3px solid rgba(0,200,255,0.2);border-top-color:var(--primary);border-radius:50%;animation:spin 0.8s linear infinite; }
@keyframes spin { to{transform:rotate(360deg)} }

.empty-state { text-align:center;padding:40px;color:var(--text-muted); }
.empty-icon { font-size:3rem;margin-bottom:12px; }
.empty-text { font-size:0.9rem; }
</style>
</head>
<body>
<div class="bg-scene"></div>
<div class="grid-overlay"></div>

<!-- SIDEBAR -->
<aside class="sidebar" id="sidebar">
  <div class="sidebar-header">
    <img src="logo_saykyo.png" alt="Saykyo Club" style="height:44px;object-fit:contain;filter:drop-shadow(0 0 10px rgba(0,200,255,0.25))">
  </div>
  <div class="admin-info">
    <img class="admin-avatar" id="adminAvatar" src="" alt="admin">
    <div>
      <div class="admin-name" id="adminName">Admin</div>
      <div class="admin-role">ADMINISTRADOR</div>
    </div>
  </div>
  <nav class="nav-menu">
    <div class="nav-section">General</div>
    <div class="nav-item active" data-page="home">
      <span class="nav-icon">ğŸ </span> Inicio
    </div>
    <div class="nav-divider"></div>
    <div class="nav-section">GestiÃ³n</div>
    <div class="nav-item" data-page="usuarios">
      <span class="nav-icon">ğŸ‘¥</span> Usuarios
    </div>
    <div class="nav-item" data-page="categorias">
      <span class="nav-icon">ğŸ“‚</span> CategorÃ­as
    </div>
    <div class="nav-item" data-page="ejercicios">
      <span class="nav-icon">ğŸ’ª</span> Ejercicios
    </div>
    <div class="nav-item" data-page="rutinas">
      <span class="nav-icon">ğŸ“‹</span> Rutinas
    </div>
    <div class="nav-item" data-page="atletas">
      <span class="nav-icon">ğŸƒ</span> Seguimiento
    </div>
    <div class="nav-divider"></div>
    <div class="nav-section">Reportes</div>
    <div class="nav-item" data-page="estadisticas">
      <span class="nav-icon">ğŸ“Š</span> EstadÃ­sticas
    </div>
    <div class="nav-item" data-page="anamnesis">
      <span class="nav-icon">ğŸ“</span> Anamnesis
    </div>
    <div class="nav-item" data-page="revisiones">
      <span class="nav-icon">ğŸ”</span> Revisiones
    </div>
  </nav>
  <div class="sidebar-footer">
    <button class="btn-logout" id="logoutBtn">ğŸšª Cerrar SesiÃ³n</button>
  </div>
</aside>

<!-- MAIN -->
<div class="main">
  <div class="topbar">
    <div style="display:flex;align-items:center;gap:10px;min-width:0">
      <button class="menu-toggle" id="menuToggle">â˜°</button>
      <button class="btn-back" id="backBtn" onclick="goBack()">â† AtrÃ¡s</button>
      <div style="min-width:0">
        <div class="page-title" id="pageTitle">Dashboard</div>
        <div class="page-subtitle" id="pageSubtitle">Bienvenido al panel de administraciÃ³n</div>
      </div>
    </div>
    <div class="topbar-actions">
      <button class="btn btn-primary btn-sm" id="topbarAction" style="display:none"></button>
    </div>
  </div>
  <div class="content" id="mainContent">
    <div class="page-loading"><div class="spinner-lg"></div><span>Cargando...</span></div>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import { getDatabase, ref, get, set, push, update, remove, onValue } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";
import { getAuth, createUserWithEmailAndPassword, updateEmail, updatePassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyCDlQGoWTNtAna8unwVNgJZH8WNRsYF0MU",
  authDomain: "entrenamiento-6b069.firebaseapp.com",
  projectId: "entrenamiento-6b069",
  storageBucket: "entrenamiento-6b069.firebasestorage.app",
  messagingSenderId: "818051143570",
  appId: "1:818051143570:web:c17fa58f4f98ce67b9534b",
  databaseURL: "https://entrenamiento-6b069-default-rtdb.firebaseio.com"
};
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const auth = getAuth(app);

// Auth check
const session = sessionStorage.getItem('saykyo_user');
if (!session) { window.location.href='index.html'; }
const currentUser = JSON.parse(session||'{}');
if (!currentUser.id && currentUser.uid) { currentUser.id = currentUser.uid; }
if (currentUser.rol !== 'admin') { window.location.href='entrenamiento.html'; }

// Init UI
document.getElementById('adminName').textContent = currentUser.nombres + ' ' + (currentUser.apellidos||'');
document.getElementById('adminAvatar').src = currentUser.avatar || `https://api.dicebear.com/7.x/adventurer/svg?seed=${currentUser.usuario}`;

// Avatar seeds for picker
// Biblioteca de avatares (131 combinaciones Ãºnicas)
const AVATAR_LIST = [
  "https://api.dicebear.com/7.x/adventurer/svg?seed=Felix&backgroundColor=059ff2",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=Luna&backgroundColor=7b2fff",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=Zoe&backgroundColor=ff6b35",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=Mia&backgroundColor=00e5a0",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=Max&backgroundColor=ffd60a",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=Sam&backgroundColor=ff4d6d",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=Alex&backgroundColor=00c8ff",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=Jordan&backgroundColor=a855f7",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=Taylor&backgroundColor=f59e0b",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=Morgan&backgroundColor=10b981",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=Casey&backgroundColor=e74c3c",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=Riley&backgroundColor=2ecc71",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=Avery&backgroundColor=3498db",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=Quinn&backgroundColor=9b59b6",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=Sage&backgroundColor=1abc9c",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=River&backgroundColor=e67e22",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=Blake&backgroundColor=34495e",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=Drew&backgroundColor=16a085",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=Reese&backgroundColor=8e44ad",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=Hayden&backgroundColor=c0392b",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=Peyton&backgroundColor=27ae60",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=Logan&backgroundColor=2980b9",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=Rowan&backgroundColor=d35400",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=Emery&backgroundColor=2c3e50",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=Finley&backgroundColor=059ff2",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=Harper&backgroundColor=7b2fff",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=Skylar&backgroundColor=ff6b35",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=Phoenix&backgroundColor=00e5a0",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=Dakota&backgroundColor=ffd60a",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=Kendall&backgroundColor=ff4d6d",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=Adrian&backgroundColor=00c8ff",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=Beatriz&backgroundColor=a855f7",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=Carlos&backgroundColor=f59e0b",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=Diana&backgroundColor=10b981",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=Eduardo&backgroundColor=e74c3c",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=Fernanda&backgroundColor=2ecc71",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=Gabriel&backgroundColor=3498db",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=Helena&backgroundColor=9b59b6",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=Ivan&backgroundColor=1abc9c",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=Julia&backgroundColor=e67e22",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=Kevin&backgroundColor=34495e",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=Laura&backgroundColor=16a085",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=Miguel&backgroundColor=8e44ad",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=Natalia&backgroundColor=c0392b",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=Oscar&backgroundColor=27ae60",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=Patricia&backgroundColor=2980b9",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=Rafael&backgroundColor=d35400",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=Sofia&backgroundColor=2c3e50",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=Thomas&backgroundColor=059ff2",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=Valentina&backgroundColor=7b2fff",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=William&backgroundColor=ff6b35",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=Ximena&backgroundColor=00e5a0",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=Yamil&backgroundColor=ffd60a",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=Zara&backgroundColor=ff4d6d",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=Andres&backgroundColor=00c8ff",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=Brenda&backgroundColor=a855f7",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=Camilo&backgroundColor=f59e0b",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=Daniela&backgroundColor=10b981",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=Esteban&backgroundColor=e74c3c",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=Fatima&backgroundColor=2ecc71",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=Shadow&backgroundColor=3498db",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=Storm&backgroundColor=9b59b6",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=Blaze&backgroundColor=1abc9c",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=Frost&backgroundColor=e67e22",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=Thunder&backgroundColor=34495e",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=Viper&backgroundColor=16a085",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=Raven&backgroundColor=8e44ad",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=Wolf&backgroundColor=c0392b",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=Eagle&backgroundColor=27ae60",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=Fox&backgroundColor=2980b9",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=Cobra&backgroundColor=d35400",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=Titan&backgroundColor=2c3e50",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=Nova&backgroundColor=059ff2",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=Orion&backgroundColor=7b2fff",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=Atlas&backgroundColor=ff6b35",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=Zenith&backgroundColor=00e5a0",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=Apex&backgroundColor=ffd60a",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=Nexus&backgroundColor=ff4d6d",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=Vortex&backgroundColor=00c8ff",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=Cipher&backgroundColor=a855f7",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=User001&backgroundColor=f59e0b",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=User002&backgroundColor=10b981",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=User003&backgroundColor=e74c3c",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=User004&backgroundColor=2ecc71",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=User005&backgroundColor=3498db",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=User006&backgroundColor=9b59b6",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=User007&backgroundColor=1abc9c",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=User008&backgroundColor=e67e22",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=User009&backgroundColor=34495e",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=User010&backgroundColor=16a085",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=Alpha01&backgroundColor=8e44ad",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=Beta02&backgroundColor=c0392b",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=Gamma03&backgroundColor=27ae60",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=Delta04&backgroundColor=2980b9",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=Sigma05&backgroundColor=d35400",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=Omega06&backgroundColor=2c3e50",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=Lambda07&backgroundColor=059ff2",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=Theta08&backgroundColor=7b2fff",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=Kappa09&backgroundColor=ff6b35",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=Psi10&backgroundColor=00e5a0",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=OldMike&backgroundColor=ffd60a",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=GrayWolf&backgroundColor=ff4d6d",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=DarkBear&backgroundColor=00c8ff",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=IronMan&backgroundColor=a855f7",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=SteelFox&backgroundColor=f59e0b",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=BlackHawk&backgroundColor=10b981",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=GoldRush&backgroundColor=e74c3c",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=SilverBack&backgroundColor=2ecc71",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=BronzeAge&backgroundColor=3498db",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=CopperKing&backgroundColor=9b59b6",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=NightOwl&backgroundColor=1abc9c",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=DawnRider&backgroundColor=e67e22",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=DuskHunter&backgroundColor=34495e",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=MidnightRun&backgroundColor=16a085",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=SunriseHero&backgroundColor=8e44ad",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=CoachPro&backgroundColor=c0392b",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=TrainHard&backgroundColor=27ae60",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=LiftBig&backgroundColor=2980b9",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=RunFast&backgroundColor=d35400",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=pro_player9&backgroundColor=e74c3c",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=gym_rat_10&backgroundColor=2ecc71",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=iron_will11&backgroundColor=3498db",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=steel_mind12&backgroundColor=9b59b6",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=fire_soul13&backgroundColor=1abc9c",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=ice_veins14&backgroundColor=e67e22",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=thunder_fist&backgroundColor=34495e",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=lightning_kick&backgroundColor=16a085",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=shadow_punch&backgroundColor=8e44ad",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=golden_hook&backgroundColor=c0392b",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=silver_jab&backgroundColor=27ae60",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=bronze_cross&backgroundColor=2980b9"
];
function getAvatarUrl(seed, bg) {
  // Compatibilidad con avatares de seed antiguo
  if(seed && seed.startsWith('http')) return seed;
  return AVATAR_LIST[0];
}

// Nav
let currentPage = 'home';
let prevPage = 'home';
window.goBack = () => { const t=(prevPage&&prevPage!==currentPage)?prevPage:'home'; navTo(t); };
document.querySelectorAll('.nav-item').forEach(item => {
  item.addEventListener('click', () => {
    document.querySelectorAll('.nav-item').forEach(n=>n.classList.remove('active'));
    item.classList.add('active');
    const page = item.dataset.page;
    prevPage = currentPage; currentPage = page;
    renderPage(page);
    if(window.innerWidth<=768) document.getElementById('sidebar').classList.remove('open');
  });
});

document.getElementById('menuToggle').addEventListener('click', () => {
  document.getElementById('sidebar').classList.toggle('open');
});
document.getElementById('logoutBtn').addEventListener('click', () => {
  signOut(auth).catch(()=>{});
  sessionStorage.removeItem('saykyo_user');
  window.location.href='index.html';
});

// ============ PAGE RENDERER ============
async function renderPage(page) {
  const content = document.getElementById('mainContent');
  const title = document.getElementById('pageTitle');
  const subtitle = document.getElementById('pageSubtitle');
  const action = document.getElementById('topbarAction');
  action.style.display='none';
  content.innerHTML='<div class="page-loading"><div class="spinner-lg"></div><span>Cargando...</span></div>';

  const pages = {
    home: renderHome, usuarios: renderUsuarios,
    categorias: renderCategorias, ejercicios: renderEjercicios,
    rutinas: renderRutinas, estadisticas: renderEstadisticas,
    anamnesis: renderAnamnesis, revisiones: renderRevisiones,
    atletas: renderAtletas
  };
  const titles = {
    home:'Dashboard', usuarios:'Gestionar Usuarios',
    categorias:'CategorÃ­as', ejercicios:'Ejercicios',
    rutinas:'Rutinas', estadisticas:'EstadÃ­sticas',
    anamnesis:'Anamnesis de Usuarios', revisiones:'Revisiones de Atletas',
    atletas:'Seguimiento de Atletas'
  };
  const subtitles = {
    home:'Panel principal', usuarios:'Crea y administra los perfiles de tus atletas',
    categorias:'Organiza los grupos musculares', ejercicios:'Biblioteca de movimientos',
    rutinas:'DiseÃ±a programas de entrenamiento', estadisticas:'AnÃ¡lisis y reportes',
    anamnesis:'Historial de cuestionarios', revisiones:'Revisiones semanales y mensuales',
    atletas:'Historial de sesiones y registro de entrenamientos en nombre del atleta'
  };
  title.textContent = titles[page]||page;
  subtitle.textContent = subtitles[page]||'';
  const backBtn = document.getElementById('backBtn');
  if(backBtn) backBtn.classList.toggle('visible', page!=='home');
  if (pages[page]) await pages[page](content, action);
}

// ============ TABLA PAGINADA ============
// Crea bÃºsqueda + paginaciÃ³n en cualquier tabla.
// Uso: initPagedTable(panelEl, rows, colsHtml, renderRow, opts)
function initPagedTable(panel, allRows, theadHtml, renderRow, opts={}) {
  const PAGE_SIZES = [10, 25, 50, 100];
  let perPage  = opts.perPage || 10;
  let page     = 1;
  let query    = '';
  let filtered = allRows;

  const toolbar   = panel.querySelector('.table-toolbar');
  const tbody     = panel.querySelector('tbody');
  const pagination= panel.querySelector('.pagination');

  function applyFilter() {
    const q = query.toLowerCase().trim();
    filtered = q ? allRows.filter(r => opts.filterFn(r, q)) : allRows;
    page = 1;
    render();
  }

  function render() {
    const total   = filtered.length;
    const pages   = Math.max(1, Math.ceil(total / perPage));
    page = Math.min(page, pages);
    const start   = (page-1)*perPage;
    const slice   = filtered.slice(start, start+perPage);

    tbody.innerHTML = slice.length
      ? slice.map(renderRow).join('')
      : `<tr><td colspan="99"><div class="empty-state"><div class="empty-icon">${opts.emptyIcon||'ğŸ”'}</div><div class="empty-text">${query?'Sin resultados para "'+query+'"':(opts.emptyText||'Sin datos')}</div></div></td></tr>`;

    // Page info
    const info = panel.querySelector('.page-info');
    if(info) info.textContent = total===0 ? 'Sin resultados' : `Mostrando ${start+1}â€“${Math.min(start+perPage,total)} de ${total}`;

    // Page buttons
    const btnsWrap = panel.querySelector('.page-btns');
    if(!btnsWrap) return;
    btnsWrap.innerHTML = '';

    // Prev
    const prev = document.createElement('button');
    prev.className='page-btn'; prev.textContent='â€¹'; prev.disabled=page<=1;
    prev.onclick=()=>{page--;render();};
    btnsWrap.appendChild(prev);

    // Numbers (max 5 visible)
    const delta = 2;
    let lo = Math.max(1,page-delta), hi = Math.min(pages,page+delta);
    if(page<=delta) hi=Math.min(pages,1+delta*2);
    if(page>=pages-delta) lo=Math.max(1,pages-delta*2);
    if(lo>1){ const b=document.createElement('button');b.className='page-btn';b.textContent='1';b.onclick=()=>{page=1;render();};btnsWrap.appendChild(b); if(lo>2){const sp=document.createElement('span');sp.textContent='â€¦';sp.style.cssText='color:var(--text-muted);font-size:0.8rem;padding:0 2px';btnsWrap.appendChild(sp);}}
    for(let i=lo;i<=hi;i++){const b=document.createElement('button');b.className='page-btn'+(i===page?' active':'');b.textContent=i;b.onclick=(()=>{const n=i;return()=>{page=n;render();};})();btnsWrap.appendChild(b);}
    if(hi<pages){if(hi<pages-1){const sp=document.createElement('span');sp.textContent='â€¦';sp.style.cssText='color:var(--text-muted);font-size:0.8rem;padding:0 2px';btnsWrap.appendChild(sp);}const b=document.createElement('button');b.className='page-btn';b.textContent=pages;b.onclick=()=>{page=pages;render();};btnsWrap.appendChild(b);}

    // Next
    const next = document.createElement('button');
    next.className='page-btn'; next.textContent='â€º'; next.disabled=page>=pages;
    next.onclick=()=>{page++;render();};
    btnsWrap.appendChild(next);
  }

  // Search input
  const searchInput = toolbar.querySelector('input[type="search"]');
  if(searchInput) searchInput.addEventListener('input', e=>{query=e.target.value;applyFilter();});

  // Per-page select
  const perPageSel = toolbar.querySelector('.per-page-select');
  if(perPageSel) {
    perPageSel.value = perPage;
    perPageSel.addEventListener('change', e=>{perPage=+e.target.value;page=1;render();});
  }

  render();
}

// ============ HOME ============
async function renderHome(container) {
  const [usSnap, catSnap, ejSnap, rutSnap] = await Promise.all([
    get(ref(db,'usuarios')), get(ref(db,'categorias')),
    get(ref(db,'ejercicios')), get(ref(db,'rutinas'))
  ]);
  const users = usSnap.val()||{};
  const cats = catSnap.val()||{};
  const ejs = ejSnap.val()||{};
  const ruts = rutSnap.val()||{};
  const activeUsers = Object.values(users).filter(u=>u.activo&&u.rol!=='admin').length;

  container.innerHTML = `
    <div class="dashboard-grid">
      <div class="stat-card" style="--card-accent:var(--primary)" onclick="navTo('usuarios')">
        <div class="stat-icon">ğŸ‘¥</div>
        <div class="stat-value">${Object.keys(users).length-1}</div>
        <div class="stat-label">Usuarios totales</div>
      </div>
      <div class="stat-card" style="--card-accent:var(--success)" onclick="navTo('usuarios')">
        <div class="stat-icon">âœ…</div>
        <div class="stat-value">${activeUsers}</div>
        <div class="stat-label">Activos</div>
      </div>
      <div class="stat-card" style="--card-accent:var(--accent)" onclick="navTo('ejercicios')">
        <div class="stat-icon">ğŸ’ª</div>
        <div class="stat-value">${Object.keys(ejs).length}</div>
        <div class="stat-label">Ejercicios</div>
      </div>
      <div class="stat-card" style="--card-accent:var(--accent2)" onclick="navTo('rutinas')">
        <div class="stat-icon">ğŸ“‹</div>
        <div class="stat-value">${Object.keys(ruts).length}</div>
        <div class="stat-label">Rutinas</div>
      </div>
    </div>
    <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:16px">
      <div class="glass-panel">
        <div class="panel-header"><span class="panel-title">ğŸƒ Acceso RÃ¡pido</span></div>
        <div class="panel-body" style="display:flex;flex-direction:column;gap:10px">
          <button class="btn btn-primary btn-full" onclick="navTo('usuarios')">ğŸ‘¥ Crear Usuario</button>
          <button class="btn btn-secondary btn-full" onclick="navTo('ejercicios')">ğŸ’ª AÃ±adir Ejercicio</button>
          <button class="btn btn-secondary btn-full" onclick="navTo('rutinas')">ğŸ“‹ Nueva Rutina</button>
          <button class="btn btn-secondary btn-full" onclick="navTo('estadisticas')">ğŸ“Š Ver EstadÃ­sticas</button>
        </div>
      </div>
      <div class="glass-panel">
        <div class="panel-header"><span class="panel-title">ğŸ‘¥ Usuarios recientes</span></div>
        <div class="panel-body">
          ${Object.entries(users).filter(([,u])=>u.rol!=='admin').slice(0,5).map(([id,u])=>`
            <div style="display:flex;align-items:center;gap:10px;padding:8px 0;border-bottom:1px solid rgba(255,255,255,0.05)">
              <img src="${u.avatar||getAvatarUrl(u.usuario)}" style="width:34px;height:34px;border-radius:50%;border:2px solid rgba(0,200,255,0.3)">
              <div style="flex:1">
                <div style="font-size:0.88rem;font-weight:600">${u.nombres} ${u.apellidos||''}</div>
                <div style="font-size:0.72rem;color:var(--text-muted)">@${u.usuario} Â· ${u.metodo}</div>
              </div>
              <span class="badge ${u.activo?'badge-active':'badge-inactive'}">${u.activo?'Activo':'Inactivo'}</span>
            </div>
          `).join('')||'<div class="empty-state"><div class="empty-icon">ğŸ‘¤</div><div class="empty-text">No hay usuarios aÃºn</div></div>'}
        </div>
      </div>
    </div>
  `;
}
window.navTo = (page) => {
  prevPage = currentPage;
  document.querySelector(`[data-page="${page}"]`).click();
};

// ============ USUARIOS ============
let selectedAvatar = '';
let editingUserId = null;

async function renderUsuarios(container, action) {
  action.textContent = '+ Nuevo Usuario';
  action.style.display = 'flex';
  action.onclick = () => showUserModal();

  const snap = await get(ref(db,'usuarios'));
  const users = snap.val()||{};

  const rows = Object.entries(users).filter(([,u])=>u.rol!=='admin');
  container.innerHTML = `
    <div class="glass-panel" id="panelUsuarios">
      <div class="panel-header">
        <span class="panel-title">ğŸ‘¥ Usuarios (${rows.length})</span>
        <button class="btn btn-primary btn-sm" onclick="showUserModal()">+ Nuevo</button>
      </div>
      <div class="table-toolbar">
        <div class="search-box"><span class="search-icon">ğŸ”</span><input type="search" placeholder="Buscar por nombre, usuario..."></div>
        <select class="per-page-select">
          <option value="10">10 / pÃ¡g</option>
          <option value="25">25 / pÃ¡g</option>
          <option value="50">50 / pÃ¡g</option>
        </select>
      </div>
      <div style="overflow-x:auto">
        <table class="data-table">
          <thead><tr>
            <th>Avatar</th><th>Usuario</th><th>Nombre</th><th>VÃ¡lido hasta</th>
            <th>MÃ©todo</th><th>Estado</th><th>Acciones</th>
          </tr></thead>
          <tbody></tbody>
        </table>
      </div>
      <div class="pagination">
        <span class="page-info"></span>
        <div class="page-btns" style="display:flex;gap:4px;flex-wrap:wrap"></div>
      </div>
    </div>
  `;
  initPagedTable(
    document.getElementById('panelUsuarios'),
    rows,
    '', // thead ya estÃ¡ en el HTML
    ([id,u]) => `
      <tr>
        <td><img src="${u.avatar||getAvatarUrl(u.usuario)}" style="width:36px;height:36px;border-radius:50%;border:2px solid rgba(0,200,255,0.3)"></td>
        <td><code style="color:var(--primary)">@${u.usuario}</code></td>
        <td>${u.nombres} ${u.apellidos||''}</td>
        <td style="font-size:0.82rem">${u.validoHasta||'â€”'}</td>
        <td><span class="badge ${u.metodo==='RPE'?'badge-rpe':'badge-rir'}">${u.metodo}</span></td>
        <td><span class="badge ${u.activo?'badge-active':'badge-inactive'}">${u.activo?'Activo':'Inactivo'}</span></td>
        <td><div style="display:flex;gap:6px">
          <button class="btn btn-secondary btn-sm" onclick="showUserModal('${id}')">âœï¸</button>
          <button class="btn btn-danger btn-sm" onclick="deleteUser('${id}')">ğŸ—‘ï¸</button>
        </div></td>
      </tr>`,
    {
      perPage: 10,
      emptyIcon: 'ğŸ‘¤',
      emptyText: 'No hay usuarios. Â¡Crea el primero!',
      filterFn: ([,u], q) =>
        u.usuario?.toLowerCase().includes(q) ||
        u.nombres?.toLowerCase().includes(q) ||
        u.apellidos?.toLowerCase().includes(q) ||
        u.metodo?.toLowerCase().includes(q)
    }
  );
}

window.showUserModal = async (userId=null) => {
  editingUserId = userId;
  let user = {};
  if (userId) {
    const snap = await get(ref(db,`usuarios/${userId}`));
    user = snap.val()||{};
  }
  selectedAvatar = user.avatar || AVATAR_LIST[0];

  const avatarGridHtml = AVATAR_LIST.map((url,i) => {
    return `<div class="avatar-option ${selectedAvatar===url?'selected':''}" onclick="selectAvatar('${url}', this)">
      <img src="${url}" loading="lazy">
    </div>`;
  }).join('');

  const html = `
    <div class="overlay-header">
      <span class="overlay-title">${userId?'âœï¸ Editar':'â• Crear'} Usuario</span>
      <button class="btn-close" onclick="closeOverlay()">âœ•</button>
    </div>
    <div style="display:flex;align-items:center;gap:16px;margin-bottom:22px;padding:16px;background:rgba(0,200,255,0.05);border-radius:14px;border:1px solid rgba(0,200,255,0.1)">
      <div class="selected-avatar-preview" onclick="document.getElementById('avatarGridWrap').style.display=document.getElementById('avatarGridWrap').style.display==='none'?'block':'none'">
        <img id="previewAvatarImg" src="${selectedAvatar}" alt="avatar">
      </div>
      <div>
        <div style="font-weight:600;margin-bottom:4px">Avatar del usuario</div>
        <div style="font-size:0.8rem;color:var(--text-muted)">Toca la imagen para ver opciones</div>
        <button class="btn btn-secondary btn-sm" style="margin-top:8px" onclick="document.getElementById('avatarGridWrap').style.display=document.getElementById('avatarGridWrap').style.display==='none'?'block':'none'">ğŸ¨ Cambiar avatar</button>
      </div>
    </div>
    <div id="avatarGridWrap" style="display:none;background:rgba(0,0,0,0.3);border-radius:14px;padding:12px;margin-bottom:16px;border:1px solid var(--glass-border)">
      <div style="font-size:0.8rem;color:var(--text-muted);margin-bottom:10px;text-align:center">Selecciona un avatar</div>
      <div class="avatar-grid">${avatarGridHtml}</div>
    </div>
    <div class="form-grid">
      <div class="form-group"><label>Usuario *</label><input class="glass-input" id="uUsuario" placeholder="nombre_usuario" value="${user.usuario||''}"></div>
	  <div class="form-group">
		  <label>Email *</label>
		  <input class="glass-input" id="uEmail" type="email" placeholder="correo@ejemplo.com" value="${user.email||''}">
	  </div>
      <div class="form-group"><label>Nombres *</label><input class="glass-input" id="uNombres" placeholder="Juan" value="${user.nombres||''}"></div>
      <div class="form-group"><label>Apellidos</label><input class="glass-input" id="uApellidos" placeholder="PÃ©rez" value="${user.apellidos||''}"></div>
      <div class="form-group"><label>ContraseÃ±a *</label><input class="glass-input" id="uContrasena" type="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢" value="${user.contrasena||''}"></div>
      <div class="form-group"><label>VÃ¡lido hasta *</label><input class="glass-input" id="uValidoHasta" type="date" value="${user.validoHasta||''}"></div>
      <div class="form-group"><label>MÃ©todo de intensidad</label>
        <select class="glass-input" id="uMetodo">
          <option value="RPE" ${user.metodo==='RPE'?'selected':''}>RPE (1-10)</option>
          <option value="RIR" ${user.metodo==='RIR'?'selected':''}>RIR (Reps en Reserva)</option>
        </select>
      </div>
    </div>
    <div style="margin-top:14px">
      <label class="toggle-wrap">
        <label class="toggle"><input type="checkbox" id="uActivo" ${user.activo!==false?'checked':''}><span class="toggle-slider"></span></label>
        <span class="toggle-label">Usuario activo</span>
      </label>
    </div>
    <div style="display:flex;gap:10px;margin-top:22px;justify-content:flex-end">
      <button class="btn btn-secondary" onclick="closeOverlay()">Cancelar</button>
      <button class="btn btn-primary" onclick="saveUser()">ğŸ’¾ Guardar</button>
    </div>
  `;
  showOverlay(html);
};

window.selectAvatar = (url, el) => {
  selectedAvatar = url;
  document.querySelectorAll('.avatar-option').forEach(a=>a.classList.remove('selected'));
  el.classList.add('selected');
  document.getElementById('previewAvatarImg').src = url;
};

window.saveUser = async () => {

  const usuario = document.getElementById('uUsuario').value.trim();
  const email = document.getElementById('uEmail').value.trim();
  const nombres = document.getElementById('uNombres').value.trim();
  const contrasena = document.getElementById('uContrasena').value;
  const validoHasta = document.getElementById('uValidoHasta').value;

  if (!usuario || !email || !nombres || !validoHasta || (!editingUserId && !contrasena)) {
    return Swal.fire({
      icon:'warning',
      title:'Campos requeridos',
      text:'Por favor completa todos los campos obligatorios',
      background:'rgba(10,20,40,0.95)',
      color:'#e8f4ff',
      confirmButtonColor:'#00c8ff'
    });
  }

  // Validar formato email simple
  const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
  if (!emailRegex.test(email)) {
    return Swal.fire({
      icon:'warning',
      title:'Email invÃ¡lido',
      text:'Ingresa un correo electrÃ³nico vÃ¡lido',
      background:'rgba(10,20,40,0.95)',
      color:'#e8f4ff',
      confirmButtonColor:'#00c8ff'
    });
  }

  try {

    let uid = editingUserId;

    // ğŸ”¥ CREAR EN AUTH SOLO SI ES NUEVO
    if (!editingUserId) {
      const cred = await createUserWithEmailAndPassword(auth, email, contrasena);
      uid = cred.user.uid;
    }

    const dataToSave = {
      usuario,
      email,
      nombres,
      apellidos: document.getElementById('uApellidos').value.trim(),
      validoHasta,
      metodo: document.getElementById('uMetodo').value,
      activo: document.getElementById('uActivo').checked,
      avatar: selectedAvatar,
      rol: 'usuario',
      creadoEn: editingUserId ? undefined : Date.now()
    };

    if (editingUserId) delete dataToSave.creadoEn;

    await set(
      ref(db, `usuarios/${uid}`),
      editingUserId
        ? { ...(await get(ref(db, `usuarios/${uid}`))).val(), ...dataToSave }
        : dataToSave
    );

    closeOverlay();

    Swal.fire({
      icon:'success',
      title:'Â¡Guardado!',
      text:`Usuario ${usuario} ${editingUserId?'actualizado':'creado'} correctamente`,
      background:'rgba(10,20,40,0.95)',
      color:'#e8f4ff',
      confirmButtonColor:'#00c8ff',
      timer:2000,
      showConfirmButton:false
    });

    document.querySelector('[data-page="usuarios"]').click();

  } catch (e) {

    let mensaje = e.message;

    if (e.code === 'auth/email-already-in-use') {
      mensaje = 'Este correo ya estÃ¡ registrado';
    }

    Swal.fire({
      icon:'error',
      title:'Error',
      text:mensaje,
      background:'rgba(10,20,40,0.95)',
      color:'#e8f4ff',
      confirmButtonColor:'#ff4d6d'
    });
  }
};

window.deleteUser = async (id) => {
  const res = await Swal.fire({
    icon:'warning',title:'Â¿Eliminar usuario?',text:'Esta acciÃ³n no se puede deshacer',
    showCancelButton:true,confirmButtonText:'SÃ­, eliminar',cancelButtonText:'Cancelar',
    confirmButtonColor:'#ff4d6d',background:'rgba(10,20,40,0.95)',color:'#e8f4ff'
  });
  if(res.isConfirmed) {
    await remove(ref(db,`usuarios/${id}`));
    Swal.fire({icon:'success',title:'Eliminado',timer:1500,showConfirmButton:false,background:'rgba(10,20,40,0.95)',color:'#e8f4ff'});
    document.querySelector('[data-page="usuarios"]').click();
  }
};

// ============ CATEGORIAS ============
async function renderCategorias(container, action) {
  action.textContent = '+ Nueva CategorÃ­a';
  action.style.display = 'flex';
  action.onclick = () => showCatModal();

  const snap = await get(ref(db,'categorias'));
  const cats = snap.val()||{};

  const rowsCat = Object.entries(cats);
  container.innerHTML = `
    <div class="glass-panel" id="panelCategorias">
      <div class="panel-header">
        <span class="panel-title">ğŸ“‚ CategorÃ­as (${rowsCat.length})</span>
        <button class="btn btn-primary btn-sm" onclick="showCatModal()">+ Nueva</button>
      </div>
      <div class="table-toolbar">
        <div class="search-box"><span class="search-icon">ğŸ”</span><input type="search" placeholder="Buscar categorÃ­a..."></div>
        <select class="per-page-select">
          <option value="10">10 / pÃ¡g</option>
          <option value="25">25 / pÃ¡g</option>
          <option value="50">50 / pÃ¡g</option>
        </select>
      </div>
      <div style="overflow-x:auto">
        <table class="data-table">
          <thead><tr><th>Nombre</th><th>DescripciÃ³n</th><th>Estado</th><th>Acciones</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
      <div class="pagination">
        <span class="page-info"></span>
        <div class="page-btns" style="display:flex;gap:4px;flex-wrap:wrap"></div>
      </div>
    </div>
  `;
  initPagedTable(
    document.getElementById('panelCategorias'),
    rowsCat,
    '',
    ([id,c]) => `
      <tr>
        <td><strong>${c.nombre}</strong></td>
        <td style="color:var(--text-muted);font-size:0.85rem">${c.descripcion||'â€”'}</td>
        <td><span class="badge ${c.estado?'badge-active':'badge-inactive'}">${c.estado?'Activa':'Inactiva'}</span></td>
        <td><div style="display:flex;gap:6px">
          <button class="btn btn-secondary btn-sm" onclick="showCatModal('${id}')">âœï¸</button>
          <button class="btn btn-danger btn-sm" onclick="deleteCat('${id}')">ğŸ—‘ï¸</button>
        </div></td>
      </tr>`,
    {
      perPage: 10,
      emptyIcon: 'ğŸ“‚',
      emptyText: 'No hay categorÃ­as',
      filterFn: ([,c], q) =>
        c.nombre?.toLowerCase().includes(q) ||
        c.descripcion?.toLowerCase().includes(q)
    }
  );
}

window.showCatModal = async (catId=null) => {
  let cat = {};
  if(catId) { const s=await get(ref(db,`categorias/${catId}`)); cat=s.val()||{}; }
  showOverlay(`
    <div class="overlay-header">
      <span class="overlay-title">${catId?'âœï¸ Editar':'â• Nueva'} CategorÃ­a</span>
      <button class="btn-close" onclick="closeOverlay()">âœ•</button>
    </div>
    <div class="form-grid">
      <div class="form-group" style="grid-column:1/-1"><label>Nombre *</label><input class="glass-input" id="cNombre" placeholder="Ej: Pecho, Espalda..." value="${cat.nombre||''}"></div>
      <div class="form-group" style="grid-column:1/-1"><label>DescripciÃ³n</label><textarea class="glass-input" id="cDesc" placeholder="DescripciÃ³n de la categorÃ­a...">${cat.descripcion||''}</textarea></div>
    </div>
    <div style="margin-top:14px">
      <label class="toggle-wrap">
        <label class="toggle"><input type="checkbox" id="cEstado" ${cat.estado!==false?'checked':''}><span class="toggle-slider"></span></label>
        <span class="toggle-label">CategorÃ­a activa</span>
      </label>
    </div>
    <div style="display:flex;gap:10px;margin-top:22px;justify-content:flex-end">
      <button class="btn btn-secondary" onclick="closeOverlay()">Cancelar</button>
      <button class="btn btn-primary" onclick="saveCat('${catId||''}')">ğŸ’¾ Guardar</button>
    </div>
  `);
};

window.saveCat = async (catId) => {
  const nombre = document.getElementById('cNombre').value.trim();
  if(!nombre) return Swal.fire({icon:'warning',title:'Nombre requerido',background:'rgba(10,20,40,0.95)',color:'#e8f4ff',confirmButtonColor:'#00c8ff'});
  const data = { nombre, descripcion:document.getElementById('cDesc').value.trim(), estado:document.getElementById('cEstado').checked };
  const path = catId || `cat_${Date.now()}`;
  await set(ref(db,`categorias/${path}`), data);
  closeOverlay();
  Swal.fire({icon:'success',title:'Â¡Guardado!',timer:1500,showConfirmButton:false,background:'rgba(10,20,40,0.95)',color:'#e8f4ff'});
  document.querySelector('[data-page="categorias"]').click();
};

window.deleteCat = async (id) => {
  const r = await Swal.fire({icon:'warning',title:'Â¿Eliminar?',showCancelButton:true,confirmButtonColor:'#ff4d6d',background:'rgba(10,20,40,0.95)',color:'#e8f4ff'});
  if(r.isConfirmed) { await remove(ref(db,`categorias/${id}`)); document.querySelector('[data-page="categorias"]').click(); }
};

// ============ EJERCICIOS ============
async function renderEjercicios(container, action) {
  action.textContent = '+ Nuevo Ejercicio';
  action.style.display = 'flex';
  action.onclick = () => showEjModal();

  const [ejSnap, catSnap] = await Promise.all([get(ref(db,'ejercicios')),get(ref(db,'categorias'))]);
  const ejs = ejSnap.val()||{};
  const cats = catSnap.val()||{};

  const rowsEj = Object.entries(ejs);
  container.innerHTML = `
    <div class="glass-panel" id="panelEjercicios">
      <div class="panel-header">
        <span class="panel-title">ğŸ’ª Ejercicios (${rowsEj.length})</span>
        <button class="btn btn-primary btn-sm" onclick="showEjModal()">+ Nuevo</button>
      </div>
      <div class="table-toolbar">
        <div class="search-box"><span class="search-icon">ğŸ”</span><input type="search" placeholder="Buscar por nombre, categorÃ­a..."></div>
        <select class="per-page-select">
          <option value="10">10 / pÃ¡g</option>
          <option value="25">25 / pÃ¡g</option>
          <option value="50">50 / pÃ¡g</option>
        </select>
      </div>
      <div style="overflow-x:auto">
        <table class="data-table">
          <thead><tr><th>Nombre</th><th>CategorÃ­a</th><th>Biextremidad</th><th>Estado</th><th>Video</th><th>Acciones</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
      <div class="pagination">
        <span class="page-info"></span>
        <div class="page-btns" style="display:flex;gap:4px;flex-wrap:wrap"></div>
      </div>
    </div>
  `;
  initPagedTable(
    document.getElementById('panelEjercicios'),
    rowsEj,
    '',
    ([id,e]) => `
      <tr>
        <td><strong>${e.nombre}</strong><br><span style="font-size:0.78rem;color:var(--text-muted)">${e.descripcion||''}</span></td>
        <td>${cats[e.categoria]?.nombre||'â€”'}</td>
        <td>${e.biextremidad?'<span class="badge badge-active">SÃ­</span>':'<span class="badge badge-inactive">No</span>'}</td>
        <td><span class="badge ${e.estado?'badge-active':'badge-inactive'}">${e.estado?'Activo':'Inactivo'}</span></td>
        <td>${e.urlVideo?`<button class="btn btn-secondary btn-sm" onclick="previewVideo('${e.urlVideo}')">â–¶ï¸</button>`:'â€”'}</td>
        <td><div style="display:flex;gap:6px">
          <button class="btn btn-secondary btn-sm" onclick="showEjModal('${id}')">âœï¸</button>
          <button class="btn btn-danger btn-sm" onclick="deleteEj('${id}')">ğŸ—‘ï¸</button>
        </div></td>
      </tr>`,
    {
      perPage: 10,
      emptyIcon: 'ğŸ’ª',
      emptyText: 'No hay ejercicios',
      filterFn: ([,e], q) =>
        e.nombre?.toLowerCase().includes(q) ||
        e.descripcion?.toLowerCase().includes(q) ||
        cats[e.categoria]?.nombre?.toLowerCase().includes(q)
    }
  );
}

function convertYoutubeUrl(url) {
  if (!url) return '';
  // Already embed
  if (url.includes('/embed/')) return url;
  // youtu.be
  const short = url.match(/youtu\.be\/([^?&]+)/);
  if (short) return `https://www.youtube.com/embed/${short[1]}`;
  // watch?v=
  const watch = url.match(/[?&]v=([^&]+)/);
  if (watch) return `https://www.youtube.com/embed/${watch[1]}`;
  return url;
}

window.showEjModal = async (ejId=null) => {
  let ej = {};
  if(ejId) { const s=await get(ref(db,`ejercicios/${ejId}`)); ej=s.val()||{}; }
  const catSnap = await get(ref(db,'categorias'));
  const cats = catSnap.val()||{};
  const catOptions = Object.entries(cats).filter(([,c])=>c.estado).map(([id,c])=>`<option value="${id}" ${ej.categoria===id?'selected':''}>${c.nombre}</option>`).join('');

  showOverlay(`
    <div class="overlay-header">
      <span class="overlay-title">${ejId?'âœï¸ Editar':'â• Nuevo'} Ejercicio</span>
      <button class="btn-close" onclick="closeOverlay()">âœ•</button>
    </div>
    <div class="form-grid">
      <div class="form-group" style="grid-column:1/-1"><label>Nombre *</label><input class="glass-input" id="eNombre" placeholder="Press Banca..." value="${ej.nombre||''}"></div>
      <div class="form-group" style="grid-column:1/-1"><label>DescripciÃ³n</label><textarea class="glass-input" id="eDesc">${ej.descripcion||''}</textarea></div>
      <div class="form-group" style="grid-column:1/-1">
        <label>URL Video YouTube</label>
        <input class="glass-input" id="eUrl" placeholder="https://www.youtube.com/watch?v=..." value="${ej.urlVideo?ej.urlVideo.replace('https://www.youtube.com/embed/','https://www.youtube.com/watch?v='):''}">
        <div style="font-size:0.75rem;color:var(--text-muted);margin-top:4px">Se convertirÃ¡ automÃ¡ticamente a URL de embebido</div>
      </div>
      <div class="form-group"><label>CategorÃ­a</label><select class="glass-input" id="eCat"><option value="">Sin categorÃ­a</option>${catOptions}</select></div>
    </div>
    <div style="display:flex;gap:20px;margin-top:14px;flex-wrap:wrap">
      <label class="toggle-wrap">
        <label class="toggle"><input type="checkbox" id="eEstado" ${ej.estado!==false?'checked':''}><span class="toggle-slider"></span></label>
        <span class="toggle-label">Activo</span>
      </label>
      <label class="toggle-wrap">
        <label class="toggle"><input type="checkbox" id="eBiext" ${ej.biextremidad?'checked':''}><span class="toggle-slider"></span></label>
        <span class="toggle-label">Biextremidad</span>
      </label>
    </div>
    <div style="display:flex;gap:10px;margin-top:22px;justify-content:flex-end">
      <button class="btn btn-secondary" onclick="closeOverlay()">Cancelar</button>
      <button class="btn btn-primary" onclick="saveEj('${ejId||''}')">ğŸ’¾ Guardar</button>
    </div>
  `);
};

window.saveEj = async (ejId) => {
  const nombre = document.getElementById('eNombre').value.trim();
  if(!nombre) return Swal.fire({icon:'warning',title:'Nombre requerido',background:'rgba(10,20,40,0.95)',color:'#e8f4ff',confirmButtonColor:'#00c8ff'});
  const rawUrl = document.getElementById('eUrl').value.trim();
  const data = {
    nombre, descripcion:document.getElementById('eDesc').value.trim(),
    urlVideo: convertYoutubeUrl(rawUrl),
    categoria: document.getElementById('eCat').value,
    estado: document.getElementById('eEstado').checked,
    biextremidad: document.getElementById('eBiext').checked
  };
  const path = ejId || `ej_${Date.now()}`;
  await set(ref(db,`ejercicios/${path}`), data);
  closeOverlay();
  Swal.fire({icon:'success',title:'Â¡Guardado!',timer:1500,showConfirmButton:false,background:'rgba(10,20,40,0.95)',color:'#e8f4ff'});
  document.querySelector('[data-page="ejercicios"]').click();
};

window.previewVideo = (url) => {
  showOverlay(`
    <div class="overlay-header">
      <span class="overlay-title">â–¶ï¸ Vista previa</span>
      <button class="btn-close" onclick="closeOverlay()">âœ•</button>
    </div>
    <div style="position:relative;padding-bottom:56.25%;height:0;border-radius:14px;overflow:hidden">
      <iframe src="${url}" style="position:absolute;inset:0;width:100%;height:100%;" frameborder="0" allowfullscreen></iframe>
    </div>
  `);
};

window.deleteEj = async (id) => {
  const r = await Swal.fire({icon:'warning',title:'Â¿Eliminar ejercicio?',showCancelButton:true,confirmButtonColor:'#ff4d6d',background:'rgba(10,20,40,0.95)',color:'#e8f4ff'});
  if(r.isConfirmed) { await remove(ref(db,`ejercicios/${id}`)); document.querySelector('[data-page="ejercicios"]').click(); }
};

// ============ RUTINAS ============
let rutinaState = { selectedUser:null, selectedRutina:null, selectedMes:null, selectedSemana:null, selectedDia:null };

async function renderRutinas(container, action) {
  action.textContent = '+ Nueva Rutina';
  action.style.display = 'flex';
  action.onclick = () => showRutinaModal();

  const [rutSnap, usSnap] = await Promise.all([get(ref(db,'rutinas')),get(ref(db,'usuarios'))]);
  const ruts = rutSnap.val()||{};
  const users = usSnap.val()||{};

  container.innerHTML = `
    <div class="rutinas-layout">
      <div class="glass-panel" style="overflow:hidden;display:flex;flex-direction:column">
        <div class="panel-header"><span class="panel-title">ğŸ“‹ Rutinas</span><button class="btn btn-primary btn-sm" onclick="showRutinaModal()">+</button></div>
        <div style="overflow-y:auto;flex:1;padding:12px">
          ${Object.entries(ruts).map(([id,r])=>`
            <div class="rb-item ${rutinaState.selectedRutina===id?'active':''}" onclick="selectRutina('${id}')">
              <div>
                <div style="font-weight:600;font-size:0.88rem">${r.nombre}</div>
                <div style="font-size:0.75rem;color:var(--text-muted)">${users[r.usuario]?.nombres||r.usuario}</div>
              </div>
              <div style="display:flex;gap:6px;flex-direction:column;align-items:flex-end">
                <span class="badge ${r.activa?'badge-active':'badge-inactive'}" style="font-size:0.65rem">${r.activa?'Activa':'Inactiva'}</span>
                <div style="display:flex;gap:4px">
                  <button class="btn btn-danger btn-sm" style="padding:3px 7px;font-size:0.7rem" onclick="deleteRutina(event,'${id}')">ğŸ—‘ï¸</button>
                </div>
              </div>
            </div>
          `).join('')||'<div class="empty-state"><div class="empty-icon">ğŸ“‹</div><div class="empty-text">Sin rutinas</div></div>'}
        </div>
      </div>
      <div id="rutinaDetail" class="glass-panel" style="overflow-y:auto">
        <div style="display:flex;align-items:center;justify-content:center;height:100%;color:var(--text-muted)">
          <div style="text-align:center"><div style="font-size:3rem;margin-bottom:12px">ğŸ‘ˆ</div><div>Selecciona una rutina para editar</div></div>
        </div>
      </div>
    </div>
  `;
  if(rutinaState.selectedRutina) renderRutinaDetail(rutinaState.selectedRutina);
}

window.selectRutina = async (id) => {
  rutinaState.selectedRutina = id;
  rutinaState.selectedMes = null; rutinaState.selectedSemana = null; rutinaState.selectedDia = null;
  rutinaState._nextMes = null; rutinaState._nextSem = null; rutinaState._nextDia = null;

  // Auto-expandir al dÃ­a siguiente del atleta asignado
  try {
    const rSnap = await get(ref(db,`rutinas/${id}`));
    const r = rSnap.val()||{};
    if(r.usuario) {
      const progSnap = await get(ref(db,`sesiones/${r.usuario}/progreso`));
      const prog = progSnap.val()||{mesActual:1,semanaActual:1,diaActual:1};
      rutinaState.selectedMes    = prog.mesActual;
      rutinaState.selectedSemana = prog.semanaActual;
      rutinaState.selectedDia    = prog.diaActual;
      rutinaState._nextMes       = prog.mesActual;
      rutinaState._nextSem       = prog.semanaActual;
      rutinaState._nextDia       = prog.diaActual;
    }
  } catch(e) {}

  await renderRutinaDetail(id);
  document.querySelectorAll('.rb-item').forEach(i=>i.classList.toggle('active',i.getAttribute('onclick')===`selectRutina('${id}')`));
};

async function renderRutinaDetail(rutinaId) {
  const detail = document.getElementById('rutinaDetail');
  if(!detail) return;
  const [rSnap, usSnap, ejSnap, catSnap] = await Promise.all([
    get(ref(db,`rutinas/${rutinaId}`)), get(ref(db,'usuarios')),
    get(ref(db,'ejercicios')), get(ref(db,'categorias'))
  ]);
  const r = rSnap.val(); if(!r) return;
  const users = usSnap.val()||{};
  const ejs = ejSnap.val()||{};
  const cats = catSnap.val()||{};
  const meses = r.meses||{};
  const numMeses = Math.max(...Object.keys(meses).map(Number), 0);

  const mesActual = rutinaState.selectedMes;
  const semActual = rutinaState.selectedSemana;
  const diaActual = rutinaState.selectedDia;
  const nextMes   = rutinaState._nextMes;
  const nextSem   = rutinaState._nextSem;
  const nextDia   = rutinaState._nextDia;
  const diasData = mesActual&&semActual ? (meses[mesActual]?.semanas?.[semActual]?.dias||{}) : {};
  const diaData = diaActual ? diasData[diaActual] : null;
  const ejsDia = diaData?.ejercicios||{};

  detail.innerHTML = `
    <div class="panel-header" style="flex-wrap:wrap;gap:8px">
      <div>
        <span class="panel-title">ğŸ“‹ ${r.nombre}</span>
        <div style="font-size:0.78rem;color:var(--text-muted);margin-top:2px">
          Atleta: ${users[r.usuario]?.nombres||r.usuario} â€¢ ${Object.keys(meses).length} mes(es)
        </div>
      </div>
      <div style="display:flex;gap:8px;flex-wrap:wrap">
        <button class="btn btn-secondary btn-sm" onclick="addMes('${rutinaId}',${numMeses+1})">+ Mes ${numMeses+1}</button>
        ${mesActual&&semActual&&diaActual?`<button class="btn btn-primary btn-sm" onclick="addEjercicioDia('${rutinaId}',${mesActual},${semActual},${diaActual})">+ Ejercicio</button>`:''}
      </div>
    </div>
    ${nextMes?`
    <div style="padding:10px 16px;background:linear-gradient(135deg,rgba(0,200,255,0.08),rgba(123,47,255,0.08));border-bottom:1px solid rgba(0,200,255,0.2);display:flex;align-items:center;gap:10px;flex-wrap:wrap">
      <span style="font-size:1.1rem">ğŸ“</span>
      <span style="font-size:0.78rem;color:var(--text-muted)">DÃ­a siguiente del atleta:</span>
      <span style="font-size:0.88rem;font-weight:800;color:var(--primary)">Mes ${nextMes} Â· Semana ${nextSem} Â· DÃ­a ${nextDia}</span>
      <span style="font-size:0.72rem;background:rgba(0,200,255,0.15);border:1px solid rgba(0,200,255,0.3);border-radius:20px;padding:2px 10px;color:var(--primary)">â¡ï¸ PrÃ³xima sesiÃ³n</span>
    </div>`:''}
    <div style="display:flex;gap:12px;padding:12px;flex-wrap:wrap;border-bottom:1px solid var(--glass-border)">
      <!-- MESES -->
      <div style="min-width:80px">
        <div style="font-size:0.7rem;color:var(--text-muted);text-transform:uppercase;letter-spacing:1px;margin-bottom:8px">Mes</div>
        ${Object.keys(meses).sort((a,b)=>a-b).map(m=>`
          <div class="rb-item ${mesActual==m?'active':''}" style="padding:6px 12px;margin-bottom:4px;position:relative" onclick="selMes('${rutinaId}',${m})">
            ${m}
            ${nextMes==m?'<span style="position:absolute;right:6px;top:50%;transform:translateY(-50%);font-size:0.6rem;background:rgba(0,200,255,0.2);color:var(--primary);border-radius:10px;padding:1px 6px">â—</span>':''}
          </div>
        `).join('')||'<div style="font-size:0.8rem;color:var(--text-muted)">Sin meses</div>'}
      </div>
      <!-- SEMANAS -->
      ${mesActual?`
        <div style="min-width:90px">
          <div style="font-size:0.7rem;color:var(--text-muted);text-transform:uppercase;letter-spacing:1px;margin-bottom:8px">Semana</div>
          ${[1,2,3,4].map(s=>`
            <div class="rb-item ${semActual==s?'active':''}" style="padding:6px 12px;margin-bottom:4px;position:relative" onclick="selSemana('${rutinaId}',${mesActual},${s})">
              S${s}
              ${nextMes==mesActual&&nextSem==s?'<span style="position:absolute;right:6px;top:50%;transform:translateY(-50%);font-size:0.6rem;background:rgba(0,200,255,0.2);color:var(--primary);border-radius:10px;padding:1px 6px">â—</span>':''}
            </div>
          `).join('')}
        </div>
      `:''}
      <!-- DIAS -->
      ${mesActual&&semActual?`
        <div style="min-width:70px">
          <div style="font-size:0.7rem;color:var(--text-muted);text-transform:uppercase;letter-spacing:1px;margin-bottom:8px">DÃ­a</div>
          ${[1,2,3,4,5].map(d=>`
            <div class="rb-item ${diaActual==d?'active':''}" style="padding:6px 12px;margin-bottom:4px;position:relative;${nextMes==mesActual&&nextSem==semActual&&nextDia==d&&diaActual!=d?'border-color:rgba(0,200,255,0.5);background:rgba(0,200,255,0.06);':''}" onclick="selDia('${rutinaId}',${mesActual},${semActual},${d})">
              D${d}
              ${nextMes==mesActual&&nextSem==semActual&&nextDia==d?'<span style="position:absolute;right:6px;top:50%;transform:translateY(-50%);font-size:0.6rem;background:rgba(0,229,160,0.25);color:var(--success);border-radius:10px;padding:1px 6px;font-weight:700">HOY</span>':''}
            </div>
          `).join('')}
        </div>
      `:''}
    </div>
    <!-- EJERCICIOS DEL DÃA -->
    <div style="padding:16px">
      ${diaActual?`
        <div style="font-weight:700;margin-bottom:16px;font-size:1rem">
          Mes ${mesActual} Â· Semana ${semActual} Â· DÃ­a ${diaActual}
          <button class="btn btn-primary btn-sm" style="margin-left:12px" onclick="addEjercicioDia('${rutinaId}',${mesActual},${semActual},${diaActual})">+ Agregar ejercicio</button>
        </div>
        ${Object.entries(ejsDia).map(([i,ej])=>`
          <div class="exercise-slot">
            <div class="exercise-slot-header">
              <span class="exercise-slot-title">ğŸ’ª ${ejs[ej.ejercicioId]?.nombre||'Ejercicio'}</span>
              <button class="btn btn-danger btn-sm" onclick="removeEjDia('${rutinaId}',${mesActual},${semActual},${diaActual},${i})">ğŸ—‘ï¸</button>
            </div>
            <div class="slot-mini-grid">
              <div><div style="font-size:0.7rem;color:var(--text-muted)">Series</div><strong>${ej.series}</strong></div>
              <div><div style="font-size:0.7rem;color:var(--text-muted)">Reps</div><strong>${ej.repsMin}-${ej.repsMax}</strong></div>
              <div><div style="font-size:0.7rem;color:var(--text-muted)">Peso</div><strong>${ej.peso} kg</strong></div>
              <div><div style="font-size:0.7rem;color:var(--text-muted)">RIR/RPE</div><strong>${ej.rirRpe}</strong></div>
              <div><div style="font-size:0.7rem;color:var(--text-muted)">Tiempo</div><strong>${ej.tiempo}s</strong></div>
              <div><div style="font-size:0.7rem;color:var(--text-muted)">Descanso</div><strong>${ej.descanso}s</strong></div>
            </div>
            ${ej.anotaciones?`<div style="margin-top:8px;font-size:0.8rem;color:var(--text-muted);font-style:italic">ğŸ“ ${ej.anotaciones}</div>`:''}
          </div>
        `).join('')||'<div class="empty-state" style="padding:20px"><div class="empty-icon">ğŸ’ª</div><div class="empty-text">Sin ejercicios. Agrega el primero.</div></div>'}
      `:'<div class="empty-state"><div class="empty-icon">ğŸ‘†</div><div class="empty-text">Selecciona Mes â†’ Semana â†’ DÃ­a para ver los ejercicios</div></div>'}
    </div>
  `;
}

window.selMes = (rid,m) => { rutinaState.selectedMes=m; rutinaState.selectedSemana=null; rutinaState.selectedDia=null; renderRutinaDetail(rid); };
window.selSemana = (rid,m,s) => { rutinaState.selectedSemana=s; rutinaState.selectedDia=null; renderRutinaDetail(rid); };
window.selDia = (rid,m,s,d) => { rutinaState.selectedDia=d; renderRutinaDetail(rid); };

window.addMes = async (rutinaId, mes) => {
  const snap = await get(ref(db,`rutinas/${rutinaId}/meses/${mes}`));
  if(snap.exists()) return Swal.fire({icon:'info',title:`El mes ${mes} ya existe`,background:'rgba(10,20,40,0.95)',color:'#e8f4ff',confirmButtonColor:'#00c8ff'});
  await set(ref(db,`rutinas/${rutinaId}/meses/${mes}`), { semanas:{} });
  rutinaState.selectedMes = mes; rutinaState.selectedSemana = null; rutinaState.selectedDia = null;
  renderRutinaDetail(rutinaId);
};

window.addEjercicioDia = async (rutinaId, mes, semana, dia) => {
  const ejSnap = await get(ref(db,'ejercicios'));
  const ejs = ejSnap.val()||{};
  const ejOptions = Object.entries(ejs).filter(([,e])=>e.estado).map(([id,e])=>`<option value="${id}">${e.nombre}</option>`).join('');

  showOverlay(`
    <div class="overlay-header">
      <span class="overlay-title">â• Agregar Ejercicio â€” M${mes}Â·S${semana}Â·D${dia}</span>
      <button class="btn-close" onclick="closeOverlay()">âœ•</button>
    </div>
    <div class="form-grid">
      <div class="form-group" style="grid-column:1/-1"><label>Ejercicio *</label><select class="glass-input" id="ejSel"><option value="">Seleccionar...</option>${ejOptions}</select></div>
      <div class="form-group"><label>Series</label><input class="glass-input" type="number" id="ejSeries" value="4" min="1"></div>
      <div class="form-group"><label>Reps MÃ­n</label><input class="glass-input" type="number" id="ejRepsMin" value="8" min="1"></div>
      <div class="form-group"><label>Reps MÃ¡x</label><input class="glass-input" type="number" id="ejRepsMax" value="12" min="1"></div>
      <div class="form-group"><label>Peso (kg)</label><input class="glass-input" type="number" id="ejPeso" value="0" min="0" step="0.5"></div>
      <div class="form-group"><label>RIR / RPE</label><input class="glass-input" type="number" id="ejRirRpe" value="2" min="-1" max="10"></div>
      <div class="form-group"><label>Tiempo (seg)</label><input class="glass-input" type="number" id="ejTiempo" value="45" min="0"></div>
      <div class="form-group"><label>Descanso (seg)</label><input class="glass-input" type="number" id="ejDescanso" value="90" min="0"></div>
      <div class="form-group" style="grid-column:1/-1"><label>Anotaciones</label><textarea class="glass-input" id="ejAnotaciones" placeholder="Instrucciones especiales..."></textarea></div>
    </div>
    <div style="display:flex;gap:10px;margin-top:22px;justify-content:flex-end">
      <button class="btn btn-secondary" onclick="closeOverlay()">Cancelar</button>
      <button class="btn btn-primary" onclick="saveEjDia('${rutinaId}',${mes},${semana},${dia})">ğŸ’¾ Agregar</button>
    </div>
  `);
};

window.saveEjDia = async (rutinaId, mes, semana, dia) => {
  const ejId = document.getElementById('ejSel').value;
  if(!ejId) return Swal.fire({icon:'warning',title:'Selecciona un ejercicio',background:'rgba(10,20,40,0.95)',color:'#e8f4ff',confirmButtonColor:'#00c8ff'});
  const path = `rutinas/${rutinaId}/meses/${mes}/semanas/${semana}/dias/${dia}/ejercicios`;
  const snap = await get(ref(db,path));
  const current = snap.val()||{};
  const idx = Object.keys(current).length;
  await set(ref(db,`${path}/${idx}`), {
    ejercicioId: ejId,
    series: +document.getElementById('ejSeries').value,
    repsMin: +document.getElementById('ejRepsMin').value,
    repsMax: +document.getElementById('ejRepsMax').value,
    peso: +document.getElementById('ejPeso').value,
    rirRpe: +document.getElementById('ejRirRpe').value,
    tiempo: +document.getElementById('ejTiempo').value,
    descanso: +document.getElementById('ejDescanso').value,
    anotaciones: document.getElementById('ejAnotaciones').value.trim()
  });
  closeOverlay();
  Swal.fire({icon:'success',title:'Â¡Ejercicio agregado!',timer:1200,showConfirmButton:false,background:'rgba(10,20,40,0.95)',color:'#e8f4ff'});
  renderRutinaDetail(rutinaId);
};

window.removeEjDia = async (rutinaId, mes, semana, dia, idx) => {
  const r = await Swal.fire({icon:'warning',title:'Â¿Quitar ejercicio?',showCancelButton:true,confirmButtonColor:'#ff4d6d',background:'rgba(10,20,40,0.95)',color:'#e8f4ff'});
  if(r.isConfirmed) {
    await remove(ref(db,`rutinas/${rutinaId}/meses/${mes}/semanas/${semana}/dias/${dia}/ejercicios/${idx}`));
    renderRutinaDetail(rutinaId);
  }
};

window.showRutinaModal = async () => {
  const usSnap = await get(ref(db,'usuarios'));
  const users = usSnap.val()||{};
  const userOpts = Object.entries(users).filter(([,u])=>u.rol!=='admin').map(([id,u])=>`<option value="${id}">${u.nombres} ${u.apellidos||''} (@${u.usuario})</option>`).join('');
  showOverlay(`
    <div class="overlay-header">
      <span class="overlay-title">â• Nueva Rutina</span>
      <button class="btn-close" onclick="closeOverlay()">âœ•</button>
    </div>
    <div class="form-grid">
      <div class="form-group"><label>Atleta *</label><select class="glass-input" id="rUser"><option value="">Seleccionar...</option>${userOpts}</select></div>
      <div class="form-group"><label>Nombre de la rutina *</label><input class="glass-input" id="rNombre" placeholder="Ej: Hipertrofia 3 meses"></div>
      <div class="form-group" style="grid-column:1/-1"><label>DescripciÃ³n</label><textarea class="glass-input" id="rDesc" placeholder="DescripciÃ³n..."></textarea></div>
    </div>
    <div style="margin-top:14px">
      <label class="toggle-wrap">
        <label class="toggle"><input type="checkbox" id="rActiva" checked><span class="toggle-slider"></span></label>
        <span class="toggle-label">Rutina activa</span>
      </label>
    </div>
    <div style="display:flex;gap:10px;margin-top:22px;justify-content:flex-end">
      <button class="btn btn-secondary" onclick="closeOverlay()">Cancelar</button>
      <button class="btn btn-primary" onclick="saveRutina()">ğŸ’¾ Crear</button>
    </div>
  `);
};

window.saveRutina = async () => {
  const usuario = document.getElementById('rUser').value;
  const nombre = document.getElementById('rNombre').value.trim();
  if(!usuario||!nombre) return Swal.fire({icon:'warning',title:'Campos requeridos',background:'rgba(10,20,40,0.95)',color:'#e8f4ff',confirmButtonColor:'#00c8ff'});
  const id = `rutina_${Date.now()}`;
  await set(ref(db,`rutinas/${id}`), {
    usuario, nombre, descripcion: document.getElementById('rDesc').value.trim(),
    activa: document.getElementById('rActiva').checked, creadaEn: Date.now(), meses:{}
  });
  closeOverlay();
  rutinaState.selectedRutina = id;
  Swal.fire({icon:'success',title:'Â¡Rutina creada!',timer:1500,showConfirmButton:false,background:'rgba(10,20,40,0.95)',color:'#e8f4ff'});
  document.querySelector('[data-page="rutinas"]').click();
};

window.deleteRutina = async (e, id) => {
  e.stopPropagation();
  const r = await Swal.fire({icon:'warning',title:'Â¿Eliminar rutina?',showCancelButton:true,confirmButtonColor:'#ff4d6d',background:'rgba(10,20,40,0.95)',color:'#e8f4ff'});
  if(r.isConfirmed) {
    await remove(ref(db,`rutinas/${id}`));
    if(rutinaState.selectedRutina===id) rutinaState = {selectedUser:null,selectedRutina:null,selectedMes:null,selectedSemana:null,selectedDia:null};
    document.querySelector('[data-page="rutinas"]').click();
  }
};

// ============ ATLETAS / SEGUIMIENTO ============
async function renderAtletas(container, action) {
  const [usSnap, rutSnap, ejSnap] = await Promise.all([
    get(ref(db,'usuarios')), get(ref(db,'rutinas')), get(ref(db,'ejercicios'))
  ]);
  const users = usSnap.val()||{};
  const ruts  = rutSnap.val()||{};
  const ejs   = ejSnap.val()||{};
  const atletas = Object.entries(users).filter(([,u])=>u.rol!=='admin');

  if(!atletas.length) {
    container.innerHTML = `<div class="empty-state"><div class="empty-icon">ğŸƒ</div><div class="empty-text">No hay atletas registrados</div></div>`;
    return;
  }

  // Estado local de la vista
  if(!window._atletaState) window._atletaState = { uid: atletas[0][0], sesId: null };
  const st = window._atletaState;

  const renderVista = async () => {
    const uid  = st.uid;
    const user = users[uid]||{};
    const rutina = Object.values(ruts).find(r=>r.usuario===uid && r.activa);
    const [sesSnap, progSnap] = await Promise.all([
      get(ref(db,`sesiones/${uid}/historial`)),
      get(ref(db,`sesiones/${uid}/progreso`))
    ]);
    const historial = sesSnap.val()||{};
    const progreso  = progSnap.val()||{};
    const sesiones  = Object.entries(historial)
      .map(([k,v])=>({...v, _key:k}))
      .sort((a,b)=>(b.fecha||b.fechaFin||0)-(a.fecha||a.fechaFin||0));

    const sesActual = st.sesId ? sesiones.find(s=>s._key===st.sesId) : sesiones[0];
    if(sesActual && !st.sesId) st.sesId = sesActual._key;

    // Selector de atleta
    const atletaOpts = atletas.map(([id,u])=>`
      <option value="${id}" ${id===uid?'selected':''}>${u.nombres} ${u.apellidos||''}</option>
    `).join('');

    // Card posiciÃ³n actual
    const posCard = progreso.mesActual ? `
      <div style="display:flex;gap:10px;flex-wrap:wrap;margin-bottom:16px">
        <div style="background:rgba(0,200,255,0.08);border:1px solid rgba(0,200,255,0.2);border-radius:14px;padding:12px 18px;flex:1;min-width:120px;text-align:center">
          <div style="font-size:0.7rem;color:var(--text-muted);text-transform:uppercase;letter-spacing:1px">PosiciÃ³n actual</div>
          <div style="font-size:1.4rem;font-weight:900;color:var(--primary)">M${progreso.mesActual}Â·S${progreso.semanaActual}Â·D${progreso.diaActual}</div>
          <div style="font-size:0.75rem;color:var(--text-muted)">${rutina?rutina.nombre:'Sin rutina activa'}</div>
        </div>
        <div style="background:rgba(0,229,160,0.08);border:1px solid rgba(0,229,160,0.2);border-radius:14px;padding:12px 18px;flex:1;min-width:120px;text-align:center">
          <div style="font-size:0.7rem;color:var(--text-muted);text-transform:uppercase;letter-spacing:1px">Sesiones totales</div>
          <div style="font-size:1.4rem;font-weight:900;color:#00e5a0">${sesiones.length}</div>
          <div style="font-size:0.75rem;color:var(--text-muted)">Completadas</div>
        </div>
      </div>` : `<div style="margin-bottom:16px;padding:12px;background:rgba(255,107,53,0.08);border:1px solid rgba(255,107,53,0.2);border-radius:12px;font-size:0.85rem;color:#ff6b35">âš ï¸ Sin progreso registrado aÃºn</div>`;

    // Timeline de sesiones (pills)
    const timeline = sesiones.length ? `
      <div style="display:flex;gap:6px;flex-wrap:wrap;margin-bottom:16px">
        ${sesiones.slice(0,20).map(s=>{
          const ts = s.fecha||s.fechaFin||s.fechaInicio||0;
          const fecha = ts ? new Date(ts).toLocaleDateString('es-CO',{day:'2-digit',month:'short'}) : 'â€”';
          const isActive = s._key === st.sesId;
          return `<button onclick="window._atletaState.sesId='${s._key}';window._atletaRefresh()" style="
            padding:5px 10px;border-radius:20px;border:1px solid ${isActive?'var(--primary)':'rgba(255,255,255,0.12)'};
            background:${isActive?'rgba(0,200,255,0.15)':'rgba(255,255,255,0.04)'};
            color:${isActive?'var(--primary)':'var(--text-muted)'};
            font-size:0.72rem;font-family:'Exo 2',sans-serif;cursor:pointer;white-space:nowrap;
            font-weight:${isActive?'700':'400'}"
          >M${s.mes}Â·S${s.semana}Â·D${s.dia}<br><span style="font-size:0.62rem">${fecha}</span></button>`;
        }).join('')}
      </div>` : `<div style="color:var(--text-muted);font-size:0.85rem;margin-bottom:16px">Sin sesiones aÃºn</div>`;

    // Detalle sesiÃ³n seleccionada
    let detalleSesion = '';
    if(sesActual) {
      const ts = sesActual.fecha||sesActual.fechaFin||sesActual.fechaInicio||0;
      const fechaStr = ts ? new Date(ts).toLocaleDateString('es-CO',{day:'2-digit',month:'long',year:'numeric',hour:'2-digit',minute:'2-digit'}) : 'â€”';
      const ejercicios = Object.values(sesActual.ejerciciosCompletados||{});
      const ejRows = ejercicios.map(ec => {
        const ejInfo = ejs[ec.ejercicioId]||{};
        const esBiext = ec.series?.some(s=>s.rirRpeIzq!=null);
        const serieRows = (ec.series||[]).map((s,i)=>{
          const rpeCell = esBiext
            ? `<td style="text-align:center"><span style="color:#00e5a0">${s.rirRpeIzq??'â€”'}</span>/<span style="color:#ff6b35">${s.rirRpeDer??'â€”'}</span></td>`
            : `<td style="text-align:center;color:#a78bfa">${s.rirRpe??'â€”'}</td>`;
          return `<tr style="border-bottom:1px solid rgba(255,255,255,0.04)">
            <td style="padding:5px 8px;text-align:center;color:var(--primary)">${i+1}</td>
            <td style="padding:5px 8px;text-align:center">${s.reps??'â€”'}</td>
            <td style="padding:5px 8px;text-align:center">${s.peso?s.peso+' kg':'â€”'}</td>
            ${rpeCell}
          </tr>`;
        }).join('');
        const metodoH = esBiext ? 'Izq/Der' : (user.metodo||'RPE');
        return `<div style="margin-bottom:14px">
          <div style="font-weight:700;font-size:0.9rem;margin-bottom:6px;color:#e8f4ff">${ejInfo.nombre||ec.ejercicioId}</div>
          <div style="overflow-x:auto">
            <table style="width:100%;border-collapse:collapse;font-size:0.83rem">
              <thead><tr style="border-bottom:1px solid rgba(255,255,255,0.1)">
                <th style="padding:4px 8px;color:var(--text-muted);font-weight:600;font-size:0.7rem">#</th>
                <th style="padding:4px 8px;color:var(--text-muted);font-weight:600;font-size:0.7rem">REPS</th>
                <th style="padding:4px 8px;color:var(--text-muted);font-weight:600;font-size:0.7rem">PESO</th>
                <th style="padding:4px 8px;color:#a78bfa;font-weight:600;font-size:0.7rem">${metodoH}</th>
              </tr></thead>
              <tbody style="color:#e8f4ff">${serieRows}</tbody>
            </table>
          </div>
        </div>`;
      }).join('<hr style="border:none;border-top:1px solid rgba(255,255,255,0.06);margin:10px 0">');

      detalleSesion = `
        <div style="background:rgba(0,0,0,0.25);border:1px solid var(--glass-border);border-radius:16px;padding:16px">
          <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;flex-wrap:wrap;gap:8px">
            <div>
              <span style="font-weight:700;color:var(--primary)">M${sesActual.mes}Â·S${sesActual.semana}Â·D${sesActual.dia}</span>
              <span style="font-size:0.78rem;color:var(--text-muted);margin-left:8px">${fechaStr}</span>
            </div>
            <div style="display:flex;gap:6px;align-items:center;flex-wrap:wrap">
              <span style="font-size:0.75rem;background:rgba(255,107,53,0.15);border:1px solid rgba(255,107,53,0.3);border-radius:8px;padding:3px 8px;color:#ff6b35">
                ğŸ˜“ Fatiga fin: ${sesActual.nivelCansancioFin??'â€”'}/10
              </span>
              <button onclick="window._registrarComoAdmin('${uid}')" style="
                padding:6px 12px;background:rgba(123,47,255,0.2);border:1px solid rgba(123,47,255,0.4);
                border-radius:10px;color:#a78bfa;font-family:'Exo 2',sans-serif;font-size:0.78rem;
                font-weight:600;cursor:pointer">
                âœï¸ Registrar sesiÃ³n
              </button>
            </div>
          </div>
          ${ejercicios.length ? ejRows : '<div style="color:var(--text-muted);font-size:0.85rem;text-align:center;padding:20px">Sin ejercicios registrados</div>'}
        </div>`;
    }

    container.innerHTML = `
      <div style="margin-bottom:16px">
        <div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap">
          <div style="flex:1;min-width:200px">
            <label style="font-size:0.72rem;color:var(--text-muted);text-transform:uppercase;letter-spacing:1px;display:block;margin-bottom:6px">Atleta</label>
            <select class="glass-input" onchange="window._atletaState.uid=this.value;window._atletaState.sesId=null;window._atletaRefresh()">${atletaOpts}</select>
          </div>
          <button onclick="window._registrarComoAdmin('${uid}')" style="
            margin-top:18px;padding:10px 16px;background:linear-gradient(135deg,rgba(123,47,255,0.3),rgba(0,200,255,0.2));
            border:1px solid rgba(123,47,255,0.5);border-radius:12px;color:#e8f4ff;
            font-family:'Exo 2',sans-serif;font-size:0.85rem;font-weight:700;cursor:pointer;white-space:nowrap">
            â• Nueva sesiÃ³n para este atleta
          </button>
        </div>
      </div>
      ${posCard}
      <div class="glass-panel" style="padding:16px;margin-bottom:16px">
        <div style="font-size:0.75rem;color:var(--text-muted);text-transform:uppercase;letter-spacing:1px;margin-bottom:10px">ğŸ“… Sesiones recientes (toca para ver detalle)</div>
        ${timeline}
      </div>
      ${detalleSesion ? `<div class="glass-panel" style="padding:16px"><div style="font-size:0.75rem;color:var(--text-muted);text-transform:uppercase;letter-spacing:1px;margin-bottom:12px">ğŸ“‹ Detalle de sesiÃ³n</div>${detalleSesion}</div>` : ''}
    `;
  };

  window._atletaRefresh = () => renderVista();
  await renderVista();
}

// â”€â”€ Abrir modal de registro de sesiÃ³n como admin â”€â”€
window._registrarComoAdmin = async (targetUid) => {
  const [usSnap, rutSnap, ejSnap, histSnap] = await Promise.all([
    get(ref(db,`usuarios/${targetUid}`)),
    get(ref(db,'rutinas')),
    get(ref(db,'ejercicios')),
    get(ref(db,`sesiones/${targetUid}/historial`))
  ]);
  const user    = usSnap.val()||{};
  const ruts    = rutSnap.val()||{};
  const ejs     = ejSnap.val()||{};
  const hist    = histSnap.val()||{};
  const rutEntry = Object.entries(ruts).find(([,r])=>r.usuario===targetUid && r.activa);
  if(!rutEntry) return Swal.fire({icon:'warning',title:'Sin rutina activa',text:'Este atleta no tiene una rutina activa asignada.',background:'rgba(10,20,40,0.95)',color:'#e8f4ff',confirmButtonColor:'#00c8ff'});

  const [rutinaId, rutina] = rutEntry;
  const progSnap = await get(ref(db,`sesiones/${targetUid}/progreso`));
  const progreso = progSnap.val()||{mesActual:1,semanaActual:1,diaActual:1};
  const { mesActual=1, semanaActual=1, diaActual=1 } = progreso;

  // Construir lista de todos los dÃ­as de la rutina con su estado
  const meses = rutina.meses||{};
  const sesionesHechas = new Set(
    Object.values(hist).map(s => `${s.mes}-${s.semana}-${s.dia}`)
  );

  const diasDisponibles = [];
  Object.keys(meses).sort((a,b)=>a-b).forEach(m => {
    const semanas = meses[m]?.semanas||{};
    Object.keys(semanas).sort((a,b)=>a-b).forEach(s => {
      const dias = semanas[s]?.dias||{};
      [1,2,3,4,5].forEach(d => {
        const ejsCount = Object.keys(dias[d]?.ejercicios||{}).length;
        if(ejsCount > 0) {
          const key = `${m}-${s}-${d}`;
          const hecho = sesionesHechas.has(key);
          const esSiguiente = +m===mesActual && +s===semanaActual && +d===diaActual;
          diasDisponibles.push({ m:+m, s:+s, d:+d, ejsCount, hecho, esSiguiente });
        }
      });
    });
  });

  if(!diasDisponibles.length) return Swal.fire({icon:'info',title:'Sin dÃ­as configurados',text:'La rutina no tiene dÃ­as con ejercicios.',background:'rgba(10,20,40,0.95)',color:'#e8f4ff',confirmButtonColor:'#00c8ff'});

  // Mostrar selector de dÃ­a antes de abrir el formulario
  _mostrarSelectorDia(targetUid, rutinaId, rutina, ejs, user, progreso, diasDisponibles);
};

// â”€â”€ Selector de dÃ­a â”€â”€
window._mostrarSelectorDia = (targetUid, rutinaId, rutina, ejs, user, progreso, diasDisponibles) => {
  const { mesActual, semanaActual, diaActual } = progreso;

  const filas = [...diasDisponibles].reverse().map(({m,s,d,ejsCount,hecho,esSiguiente}) => {
    let badge = '';
    let rowStyle = 'padding:10px 14px;border-radius:12px;margin-bottom:6px;cursor:pointer;display:flex;align-items:center;justify-content:space-between;border:1px solid;transition:all 0.2s ease;';
    if(hecho) {
      // Hecho siempre tiene prioridad visual, incluso si tambiÃ©n es el "siguiente"
      rowStyle += 'background:rgba(0,229,160,0.06);border-color:rgba(0,229,160,0.2);opacity:0.7;';
      badge = '<span style="font-size:0.7rem;background:rgba(0,229,160,0.15);color:var(--success);border:1px solid rgba(0,229,160,0.3);border-radius:20px;padding:2px 10px">âœ… Hecho</span>';
    } else if(esSiguiente) {
      rowStyle += 'background:rgba(0,200,255,0.12);border-color:rgba(0,200,255,0.5);';
      badge = '<span style="font-size:0.7rem;background:rgba(0,200,255,0.2);color:var(--primary);border:1px solid rgba(0,200,255,0.4);border-radius:20px;padding:2px 10px;font-weight:700">â¡ï¸ SIGUIENTE</span>';
    } else {
      rowStyle += 'background:rgba(255,255,255,0.04);border-color:rgba(255,255,255,0.08);';
      badge = '<span style="font-size:0.7rem;background:rgba(255,255,255,0.06);color:var(--text-muted);border:1px solid rgba(255,255,255,0.1);border-radius:20px;padding:2px 10px">â³ Pendiente</span>';
    }
    return `
      <div style="${rowStyle}" onclick="window._iniciarAdminSesionDia('${targetUid}','${rutinaId}',${m},${s},${d})">
        <div style="display:flex;align-items:center;gap:12px">
          <span style="font-size:1rem;font-weight:800;color:${hecho?'var(--success)':esSiguiente?'var(--primary)':'var(--text-muted)'}">M${m}Â·S${s}Â·D${d}</span>
          <span style="font-size:0.75rem;color:var(--text-muted)">${ejsCount} ejercicio${ejsCount!==1?'s':''}</span>
        </div>
        ${badge}
      </div>`;
  }).join('');

  showOverlay(`
    <div class="overlay-header">
      <span class="overlay-title">ğŸ“… Selecciona el dÃ­a a registrar â€” ${user.nombres}</span>
      <button class="btn-close" onclick="closeOverlay()">âœ•</button>
    </div>
    <div style="font-size:0.8rem;color:var(--text-muted);margin-bottom:14px">
      El dÃ­a marcado como <strong style="color:var(--primary)">â¡ï¸ SIGUIENTE</strong> es el que corresponde segÃºn el progreso actual del atleta.
    </div>
    <div style="max-height:60vh;overflow-y:auto;padding-right:4px">
      ${filas}
    </div>
  `);

  // Guardar contexto para cuando se elija el dÃ­a
  window._adminSesionCtx = { targetUid, rutinaId, rutina, ejs, user, progreso };
};

window._iniciarAdminSesionDia = (targetUid, rutinaId, m, s, d) => {
  closeOverlay();
  const { rutina, ejs, user, progreso } = window._adminSesionCtx;
  const diaData = rutina.meses?.[m]?.semanas?.[s]?.dias?.[d];
  const ejsDia  = Object.values(diaData?.ejercicios||{});

  if(!ejsDia.length) return Swal.fire({icon:'info',title:'DÃ­a sin ejercicios',text:`M${m}Â·S${s}Â·D${d} no tiene ejercicios configurados.`,background:'rgba(10,20,40,0.95)',color:'#e8f4ff',confirmButtonColor:'#00c8ff'});

  window._adminSesion = {
    targetUid, rutinaId,
    mesActual: m, semanaActual: s, diaActual: d,
    ejsDia, ejs, user, rutina, progreso,
    ejercicioActual: 0, ejerciciosCompletados: {}, fechaInicio: Date.now()
  };
  _renderAdminEjercicio();
};

function _renderAdminEjercicio() {
  const s = window._adminSesion;
  const { ejsDia, ejs, user, ejercicioActual, mesActual, semanaActual, diaActual } = s;
  if(ejercicioActual >= ejsDia.length) { _finalizarAdminSesion(); return; }

  const ejConfig = ejsDia[ejercicioActual];
  const ejInfo   = ejs[ejConfig.ejercicioId]||{};
  const total    = ejsDia.length;
  const current  = ejercicioActual + 1;
  const metodo   = user.metodo||'RPE';
  const esBiext  = ejInfo.biextremidad === true;
  const metodoLabel = metodo==='RPE' ? 'RPE (1-10)' : 'RIR (-1â†’6)';
  const metodoMin   = metodo==='RPE' ? 1 : -1;
  const metodoMax   = metodo==='RPE' ? 10 : 6;

  const seriesRows = Array.from({length:ejConfig.series||3},(_,i)=>`
    <div style="display:flex;gap:8px;align-items:center;padding:8px 0;border-bottom:1px solid rgba(255,255,255,0.05);flex-wrap:wrap">
      <div style="width:24px;text-align:center;font-weight:700;color:var(--primary)">${i+1}</div>
      <div style="display:flex;gap:6px;flex:1;flex-wrap:wrap">
        <div style="display:flex;flex-direction:column;gap:3px;flex:1;min-width:60px">
          <label style="font-size:0.68rem;color:var(--text-muted)">Reps</label>
          <input type="number" id="adm_reps_${i}" value="${ejConfig.repsMin||0}" min="0"
            style="background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:8px;padding:6px 8px;color:#e8f4ff;font-family:'Exo 2',sans-serif;width:100%">
        </div>
        <div style="display:flex;flex-direction:column;gap:3px;flex:1;min-width:60px">
          <label style="font-size:0.68rem;color:var(--text-muted)">Peso kg</label>
          <input type="number" id="adm_peso_${i}" value="${ejConfig.peso||0}" min="0" step="0.5"
            style="background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:8px;padding:6px 8px;color:#e8f4ff;font-family:'Exo 2',sans-serif;width:100%">
        </div>
        ${esBiext ? `
        <div style="display:flex;flex-direction:column;gap:3px;flex:1;min-width:60px">
          <label style="font-size:0.68rem;color:#00e5a0">Izq ${metodo}</label>
          <input type="number" id="adm_rpe_izq_${i}" value="${ejConfig.rirRpe||0}" min="${metodoMin}" max="${metodoMax}"
            style="background:rgba(0,229,160,0.06);border:1px solid rgba(0,229,160,0.3);border-radius:8px;padding:6px 8px;color:#e8f4ff;font-family:'Exo 2',sans-serif;width:100%">
        </div>
        <div style="display:flex;flex-direction:column;gap:3px;flex:1;min-width:60px">
          <label style="font-size:0.68rem;color:#ff6b35">Der ${metodo}</label>
          <input type="number" id="adm_rpe_der_${i}" value="${ejConfig.rirRpe||0}" min="${metodoMin}" max="${metodoMax}"
            style="background:rgba(255,107,53,0.06);border:1px solid rgba(255,107,53,0.3);border-radius:8px;padding:6px 8px;color:#e8f4ff;font-family:'Exo 2',sans-serif;width:100%">
        </div>` : `
        <div style="display:flex;flex-direction:column;gap:3px;flex:1;min-width:60px">
          <label style="font-size:0.68rem;color:#a78bfa">${metodoLabel}</label>
          <input type="number" id="adm_rpe_${i}" value="${ejConfig.rirRpe||0}" min="${metodoMin}" max="${metodoMax}"
            style="background:rgba(123,47,255,0.06);border:1px solid rgba(123,47,255,0.3);border-radius:8px;padding:6px 8px;color:#e8f4ff;font-family:'Exo 2',sans-serif;width:100%">
        </div>`}
      </div>
    </div>
  `).join('');

  showOverlay(`
    <div class="overlay-header">
      <span class="overlay-title">âœï¸ ${user.nombres} â€” M${mesActual}Â·S${semanaActual}Â·D${diaActual}</span>
      <button class="btn-close" onclick="closeOverlay()">âœ•</button>
    </div>
    <div style="margin-bottom:14px">
      <div style="display:flex;justify-content:space-between;margin-bottom:6px">
        <span style="font-size:0.8rem;color:var(--text-muted)">Ejercicio ${current} de ${total}</span>
        <span style="font-size:0.8rem;color:var(--primary);font-weight:600">${Math.round(((current-1)/total)*100)}%</span>
      </div>
      <div style="height:4px;background:rgba(255,255,255,0.1);border-radius:2px">
        <div style="height:100%;background:var(--primary);border-radius:2px;width:${Math.round(((current-1)/total)*100)}%"></div>
      </div>
    </div>
    <div style="font-weight:700;font-size:1.05rem;margin-bottom:4px">${ejInfo.nombre||'Ejercicio'}</div>
    <div style="font-size:0.78rem;color:var(--text-muted);margin-bottom:14px">
      ${ejConfig.series} series Â· ${ejConfig.repsMin}-${ejConfig.repsMax} reps Â· ${ejConfig.peso}kg Â· ${metodo} ${ejConfig.rirRpe} Â· â± ${ejConfig.descanso}s
    </div>
    <div>${seriesRows}</div>
    <div style="margin-top:4px">
      <label style="font-size:0.72rem;color:var(--text-muted);text-transform:uppercase;letter-spacing:1px;display:block;margin-bottom:6px;margin-top:14px">Nivel de fatiga al terminar este ejercicio (0-10)</label>
      <input type="number" id="adm_fatiga" value="5" min="0" max="10"
        style="background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:8px;padding:8px 12px;color:#e8f4ff;font-family:'Exo 2',sans-serif;width:100%">
    </div>
    <div style="display:flex;gap:10px;margin-top:18px">
      ${ejercicioActual>0?`<button class="btn btn-secondary" onclick="window._adminSesion.ejercicioActual--;_renderAdminEjercicio()">â† Anterior</button>`:''}
      <button class="btn btn-primary" style="flex:1" onclick="_completarAdminEj()">
        ${current<total?'Siguiente ejercicio â†’':'âœ… Finalizar sesiÃ³n'}
      </button>
    </div>
  `);
}

window._completarAdminEj = () => {
  const s = window._adminSesion;
  const ejConfig = s.ejsDia[s.ejercicioActual];
  const ejInfo   = s.ejs[ejConfig.ejercicioId]||{};
  const n        = ejConfig.series||3;
  const esBiext  = ejInfo.biextremidad === true;
  const series   = Array.from({length:n},(_,i)=>{
    const base = {
      reps: +document.getElementById(`adm_reps_${i}`)?.value||0,
      peso: +document.getElementById(`adm_peso_${i}`)?.value||0,
      completada: true
    };
    if(esBiext) {
      base.rirRpeIzq = +document.getElementById(`adm_rpe_izq_${i}`)?.value||0;
      base.rirRpeDer = +document.getElementById(`adm_rpe_der_${i}`)?.value||0;
      base.rirRpe    = Math.round(((base.rirRpeIzq||0)+(base.rirRpeDer||0))/2);
    } else {
      base.rirRpe = +document.getElementById(`adm_rpe_${i}`)?.value||0;
    }
    return base;
  });
  s.ejerciciosCompletados[s.ejercicioActual] = { ejercicioId: ejConfig.ejercicioId, series };
  s.nivelCansancioFin = +document.getElementById('adm_fatiga')?.value||5;
  s.ejercicioActual++;
  _renderAdminEjercicio();
};

async function _finalizarAdminSesion() {
  const s = window._adminSesion;
  closeOverlay();
  const { targetUid, rutinaId, mesActual, semanaActual, diaActual, ejerciciosCompletados, fechaInicio, nivelCansancioFin } = s;
  const now = Date.now();
  const sesId = `ses_${now}`;
  const sesData = {
    mes: mesActual, semana: semanaActual, dia: diaActual,
    rutinaActiva: rutinaId,
    fechaInicio, fechaFin: now, fecha: now,
    nivelCansancioInicio: 0, nivelCansancioFin: nivelCansancioFin||5,
    ejerciciosCompletados,
    registradoPorAdmin: true
  };
  await set(ref(db,`sesiones/${targetUid}/historial/${sesId}`), sesData);

  // Avanzar progreso: solo si el dÃ­a registrado ES el dÃ­a del progreso actual,
  // o si el dÃ­a registrado estÃ¡ DESPUÃ‰S del progreso actual (para no retroceder).
  const prog = s.progreso;
  const progKey  = prog.mesActual * 10000 + prog.semanaActual * 100 + prog.diaActual;
  const regKey   = mesActual     * 10000 + semanaActual     * 100 + diaActual;

  if(regKey >= progKey) {
    // Avanzar desde el dÃ­a que se registrÃ³, no desde el progreso guardado
    let m = mesActual, sem = semanaActual, dia = diaActual;
    dia++; if(dia>5){dia=1;sem++;} if(sem>4){sem=1;m++;}
    const maxMes = Math.max(...Object.keys(s.rutina.meses||{1:{}}).map(Number));
    if(m>maxMes){m=maxMes;sem=4;dia=5;}
    await set(ref(db,`sesiones/${targetUid}/progreso`), { rutinaActiva:rutinaId, mesActual:m, semanaActual:sem, diaActual:dia });
  }
  // Si registrÃ³ un dÃ­a ANTERIOR al progreso actual, no tocamos el progreso

  // Guardar estado para restaurar la vista de atletas tras el reload
  sessionStorage.setItem('saykyo_reload_page', 'atletas');
  sessionStorage.setItem('saykyo_reload_uid', targetUid);

  await Swal.fire({icon:'success',title:'âœ… SesiÃ³n registrada',
    text:`SesiÃ³n M${mesActual}Â·S${semanaActual}Â·D${diaActual} guardada para ${s.user.nombres}`,
    timer:2000,showConfirmButton:false,background:'rgba(10,20,40,0.95)',color:'#e8f4ff'});

  window.location.reload();
}

// ============ ESTADÃSTICAS ============
async function renderEstadisticas(container) {
  const [usSnap, ejSnap, catSnap] = await Promise.all([get(ref(db,'usuarios')),get(ref(db,'ejercicios')),get(ref(db,'categorias'))]);
  const users = usSnap.val()||{};
  const ejs = ejSnap.val()||{};
  const cats = catSnap.val()||{};
  const userOpts = Object.entries(users).filter(([,u])=>u.rol!=='admin').map(([id,u])=>`<option value="${id}">${u.nombres} ${u.apellidos||''}</option>`).join('');
  const ejOpts = Object.entries(ejs).map(([id,e])=>`<option value="${id}">${e.nombre}</option>`).join('');
  const catOpts = Object.entries(cats).map(([id,c])=>`<option value="${id}">${c.nombre}</option>`).join('');

  container.innerHTML = `
    <div class="glass-panel" style="margin-bottom:16px">
      <div class="panel-header"><span class="panel-title">ğŸ“Š Filtros</span></div>
      <div class="panel-body">
        <div class="form-grid">
          <div class="form-group"><label>Usuario</label><select class="glass-input" id="statsUser"><option value="">Todos</option>${userOpts}</select></div>
          <div class="form-group"><label>Ejercicio</label><select class="glass-input" id="statsEj"><option value="">Todos</option>${ejOpts}</select></div>
          <div class="form-group"><label>CategorÃ­a</label><select class="glass-input" id="statsCat"><option value="">Todas</option>${catOpts}</select></div>
          <div class="form-group"><label>Semana inicio</label><input class="glass-input" type="number" id="semIni" min="1" value="1"></div>
          <div class="form-group"><label>Semana fin</label><input class="glass-input" type="number" id="semFin" min="1" value="8"></div>
        </div>
        <div style="margin-top:14px">
          <button class="btn btn-primary" onclick="cargarEstadisticas()">ğŸ” Generar Reportes</button>
        </div>
      </div>
    </div>
    <div id="chartsArea" class="stats-grid">
      <div class="stats-card"><div class="empty-state"><div class="empty-icon">ğŸ“Š</div><div class="empty-text">Configura los filtros y presiona "Generar Reportes"</div></div></div>
    </div>
  `;
}

window.cargarEstadisticas = async () => {
  const userId = document.getElementById('statsUser').value;
  const ejId = document.getElementById('statsEj').value;
  const catId = document.getElementById('statsCat').value;
  const semIni = +document.getElementById('semIni').value;
  const semFin = +document.getElementById('semFin').value;

  const area = document.getElementById('chartsArea');
  area.innerHTML = '<div class="page-loading"><div class="spinner-lg"></div><span>Cargando datos...</span></div>';

  const [sesSnap, ejSnap, catSnap, usSnap, rutSnap] = await Promise.all([
    get(ref(db,'sesiones')), get(ref(db,'ejercicios')),
    get(ref(db,'categorias')), get(ref(db,'usuarios')),
    get(ref(db,'rutinas'))
  ]);
  const sesiones = sesSnap.val()||{};
  const ejs = ejSnap.val()||{};
  const cats = catSnap.val()||{};
  const users = usSnap.val()||{};

  // Build week-based data
  const buildWeekLabels = () => Array.from({length:semFin-semIni+1},(_,i)=>`Sem ${semIni+i}`);
  const labels = buildWeekLabels();

  // Collect all sessions in range
  const allSessions = [];
  Object.entries(sesiones).forEach(([uid, userData]) => {
    if(userId && uid!==userId) return;
    Object.entries(userData.historial||{}).forEach(([sid, ses]) => {
      const semAbs = (ses.mes-1)*4 + ses.semana;
      if(semAbs>=semIni && semAbs<=semFin) allSessions.push({...ses, userId:uid});
    });
  });

  // Chart 1: Carga (peso por ejercicio)
  const pesoData = {};
  allSessions.forEach(ses => {
    Object.values(ses.ejerciciosCompletados||{}).forEach(ec => {
      if(ejId && ec.ejercicioId!==ejId) return;
      const ejName = ejs[ec.ejercicioId]?.nombre||ec.ejercicioId;
      if(!pesoData[ejName]) pesoData[ejName] = Array(labels.length).fill(null).map(()=>[]);
      const semAbs = (ses.mes-1)*4+ses.semana;
      const idx = semAbs-semIni;
      if(idx>=0&&idx<labels.length) {
        (ec.series||[]).forEach(s=>pesoData[ejName][idx].push(s.peso));
      }
    });
  });
  const pesoDatasets = Object.entries(pesoData).map(([name,weeks],i) => ({
    label:name, data:weeks.map(w=>w.length?w.reduce((a,b)=>a+b,0)/w.length:null),
    borderColor:`hsl(${i*60},70%,60%)`, tension:0.4, fill:false, spanGaps:true
  }));

  // Chart 2: Intensidad RPE/RIR
  const intData = {};
  allSessions.forEach(ses => {
    Object.values(ses.ejerciciosCompletados||{}).forEach(ec => {
      if(ejId && ec.ejercicioId!==ejId) return;
      const ejName = ejs[ec.ejercicioId]?.nombre||ec.ejercicioId;
      if(!intData[ejName]) intData[ejName] = Array(labels.length).fill(null).map(()=>[]);
      const idx = (ses.mes-1)*4+ses.semana-semIni;
      if(idx>=0&&idx<labels.length) {
        (ec.series||[]).forEach(s=>{ if(s.rirRpe!=null) intData[ejName][idx].push(s.rirRpe); });
      }
    });
  });
  const intDatasets = Object.entries(intData).map(([name,weeks],i)=>({
    label:name, data:weeks.map(w=>w.length?w.reduce((a,b)=>a+b,0)/w.length:null),
    borderColor:`hsl(${i*60+120},70%,60%)`, tension:0.4, fill:false, spanGaps:true
  }));

  // Chart 3: Volumen (series por semana por categoria)
  const volData = {};
  allSessions.forEach(ses => {
    Object.values(ses.ejerciciosCompletados||{}).forEach(ec => {
      const ejCat = ejs[ec.ejercicioId]?.categoria;
      if(catId && ejCat!==catId) return;
      const catName = cats[ejCat]?.nombre||'Sin cat';
      if(!volData[catName]) volData[catName] = Array(labels.length).fill(0);
      const idx = (ses.mes-1)*4+ses.semana-semIni;
      if(idx>=0&&idx<labels.length) volData[catName][idx]+=(ec.series||[]).length;
    });
  });
  const volDatasets = Object.entries(volData).map(([name,data],i)=>({
    label:name, data, borderColor:`hsl(${i*60+240},70%,60%)`, tension:0.4, fill:false
  }));

  // Chart 4: Intensidad por sesiÃ³n (dias de semana especifica)
  const sesIntData = {};
  const semAnalizar = semIni;
  allSessions.filter(s=>(s.mes-1)*4+s.semana===semAnalizar).forEach(ses => {
    const dayKey = `DÃ­a ${ses.dia}`;
    if(!sesIntData[dayKey]) sesIntData[dayKey] = [];
    Object.values(ses.ejerciciosCompletados||{}).forEach(ec=>{
      (ec.series||[]).forEach(s=>{ if(s.rirRpe!=null) sesIntData[dayKey].push(s.rirRpe); });
    });
  });
  const sesIntLabels = Object.keys(sesIntData).sort();
  const sesIntVals = sesIntLabels.map(k=>sesIntData[k].length?sesIntData[k].reduce((a,b)=>a+b,0)/sesIntData[k].length:null);

  // Chart 5: Frecuencia (veces entrenado por grupo muscular por dia)
  const freqData = {};
  allSessions.forEach(ses => {
    Object.values(ses.ejerciciosCompletados||{}).forEach(ec => {
      const ejCat = ejs[ec.ejercicioId]?.categoria;
      if(catId && ejCat!==catId) return;
      const catName = cats[ejCat]?.nombre||'Sin cat';
      const dayKey = `M${ses.mes}S${ses.semana}D${ses.dia}`;
      if(!freqData[catName]) freqData[catName] = {};
      freqData[catName][dayKey] = (freqData[catName][dayKey]||0)+1;
    });
  });

  const chartOptions = {
    responsive:true, maintainAspectRatio:false,
    plugins:{legend:{labels:{color:'#e8f4ff',font:{family:'Exo 2',size:11}}}},
    scales:{x:{grid:{color:'rgba(255,255,255,0.05)'},ticks:{color:'rgba(232,244,255,0.6)'}},
            y:{grid:{color:'rgba(255,255,255,0.05)'},ticks:{color:'rgba(232,244,255,0.6)'}}}
  };

  area.innerHTML = `
    <div class="stats-card"><div style="font-weight:700;margin-bottom:12px">ğŸ“ˆ Carga (Peso promedio por semana)</div><div class="chart-container"><canvas id="chartPeso"></canvas></div></div>
    <div class="stats-card"><div style="font-weight:700;margin-bottom:12px">ğŸ”¥ Intensidad RPE/RIR promedio</div><div class="chart-container"><canvas id="chartInt"></canvas></div></div>
    <div class="stats-card"><div style="font-weight:700;margin-bottom:12px">ğŸ“¦ Volumen (Series por categorÃ­a)</div><div class="chart-container"><canvas id="chartVol"></canvas></div></div>
    <div class="stats-card"><div style="font-weight:700;margin-bottom:12px">âš¡ Intensidad por sesiÃ³n (Sem ${semAnalizar})</div><div class="chart-container"><canvas id="chartSesInt"></canvas></div></div>
    <div class="stats-card" style="grid-column:1/-1"><div style="font-weight:700;margin-bottom:12px">ğŸ“Š Resumen de sesiones</div>
      <div style="font-size:0.9rem;color:var(--text-muted)">Total sesiones analizadas: <strong style="color:var(--primary)">${allSessions.length}</strong></div>
    </div>
  `;

  // Render charts
  if(pesoDatasets.length) new Chart(document.getElementById('chartPeso'), {type:'line',data:{labels,datasets:pesoDatasets},options:chartOptions});
  else document.getElementById('chartPeso').parentElement.innerHTML += '<div class="empty-state"><div class="empty-icon">ğŸ“Š</div><div class="empty-text">Sin datos</div></div>';

  if(intDatasets.length) new Chart(document.getElementById('chartInt'), {type:'line',data:{labels,datasets:intDatasets},options:chartOptions});
  else document.getElementById('chartInt').parentElement.innerHTML += '<div class="empty-state"><div class="empty-icon">ğŸ“Š</div><div class="empty-text">Sin datos</div></div>';

  if(volDatasets.length) new Chart(document.getElementById('chartVol'), {type:'line',data:{labels,datasets:volDatasets},options:chartOptions});
  else document.getElementById('chartVol').parentElement.innerHTML += '<div class="empty-state"><div class="empty-icon">ğŸ“Š</div><div class="empty-text">Sin datos</div></div>';

  if(sesIntVals.length) new Chart(document.getElementById('chartSesInt'), {type:'line',data:{labels:sesIntLabels,datasets:[{label:'Intensidad',data:sesIntVals,borderColor:'var(--primary)',tension:0.4,fill:false}]},options:chartOptions});
  else document.getElementById('chartSesInt').parentElement.innerHTML += '<div class="empty-state"><div class="empty-icon">ğŸ“Š</div><div class="empty-text">Sin datos</div></div>';
};

// ============ ANAMNESIS ============
async function renderAnamnesis(container) {
  const [anaSnap, usSnap] = await Promise.all([get(ref(db,'anamnesis')),get(ref(db,'usuarios'))]);
  const anamnesis = anaSnap.val()||{};
  const users = usSnap.val()||{};

  container.innerHTML = `
    <div class="dashboard-grid" style="margin-bottom:16px">
      ${Object.entries(users).filter(([,u])=>u.rol!=='admin').map(([uid,u])=>{
        const ana = anamnesis[uid];
        const completada = ana?.completada;
        return `
          <div class="stat-card ${completada?'':''}">
            <div style="display:flex;align-items:center;gap:10px;margin-bottom:12px">
              <img src="${u.avatar||getAvatarUrl(u.usuario)}" style="width:44px;height:44px;border-radius:50%;border:2px solid rgba(0,200,255,0.3)">
              <div>
                <div style="font-weight:700">${u.nombres} ${u.apellidos||''}</div>
                <div style="font-size:0.75rem;color:var(--text-muted)">@${u.usuario}</div>
              </div>
            </div>
            <span class="badge ${completada?'badge-active':'badge-inactive'}">${completada?'âœ… Completada':'â³ Pendiente'}</span>
            ${completada?`<br><button class="btn btn-secondary btn-sm" style="margin-top:10px" onclick="verAnamnesis('${uid}')">ğŸ“‹ Ver respuestas</button>`:''}
          </div>
        `;
      }).join('')}
    </div>
  `;
}

window.verAnamnesis = async (uid) => {
  const [anaSnap, usSnap] = await Promise.all([get(ref(db,`anamnesis/${uid}`)),get(ref(db,`usuarios/${uid}`))]);
  const ana = anaSnap.val()||{};
  const user = usSnap.val()||{};
  const r = ana.respuestas||{};

  const preguntas = [
    'Edad','Peso (kg)','Talla (cm)','Objetivo principal',
    'Â¿Lesiones o condiciones mÃ©dicas?','Nivel de actividad fÃ­sica actual',
    'Â¿CuÃ¡ntos dÃ­as entrenas por semana?','Â¿CuÃ¡nto tiempo llevas entrenando?',
    'Â¿Realizas algÃºn deporte adicional?','Horario preferido de entrenamiento',
    'Â¿Tomas algÃºn suplemento?','Horas de sueÃ±o promedio',
    'Â¿Tienes alguna restricciÃ³n alimentaria?','Nivel de estrÃ©s (1-10)',
    'Â¿QuÃ© esperas lograr en los prÃ³ximos 3 meses?'
  ];

  showOverlay(`
    <div class="overlay-header">
      <span class="overlay-title">ğŸ“‹ Anamnesis â€” ${user.nombres} ${user.apellidos||''}</span>
      <button class="btn-close" onclick="closeOverlay()">âœ•</button>
    </div>
    <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:12px">
      ${preguntas.map((p,i)=>`
        <div class="anamnesis-card">
          <div class="anamnesis-q">${p}</div>
          <div class="anamnesis-a">${r[`p${i}`]||'â€”'}</div>
        </div>
      `).join('')}
    </div>
    ${ana.completadaEn?`<div style="text-align:right;margin-top:16px;font-size:0.78rem;color:var(--text-muted)">Completada: ${new Date(ana.completadaEn).toLocaleDateString()}</div>`:''}
  `);
};

// ============ OVERLAY ============
window.showOverlay = (html) => {
  const backdrop = document.createElement('div');
  backdrop.className = 'overlay-backdrop'; backdrop.id = 'overlayBackdrop';
  backdrop.innerHTML = `<div class="overlay-panel">${html}</div>`;
  backdrop.addEventListener('click', e => { if(e.target===backdrop) closeOverlay(); });
  document.body.appendChild(backdrop);
};
window.closeOverlay = () => {
  const el = document.getElementById('overlayBackdrop');
  if(el) el.remove();
};

// ============ REVISIONES ============
async function renderRevisiones(container) {
  const [usSnap, revSemSnap, revMesSnap] = await Promise.all([
    get(ref(db,'usuarios')),
    get(ref(db,'revisiones_semana')),
    get(ref(db,'revisiones_mes'))
  ]);
  const users = usSnap.val()||{};
  const revSem = revSemSnap.val()||{};
  const revMes = revMesSnap.val()||{};

  const atletasHtml = Object.entries(users)
    .filter(([,u])=>u.rol!=='admin')
    .map(([uid,u]) => {
      const semanas = Object.values(revSem[uid]||{}).sort((a,b)=>a.fecha-b.fecha);
      const meses   = Object.values(revMes[uid]||{}).sort((a,b)=>a.fecha-b.fecha);
      return `
        <div class="glass-panel" style="margin-bottom:16px">
          <div class="panel-header">
            <div style="display:flex;align-items:center;gap:10px">
              <img src="${u.avatar||getAvatarUrl(u.usuario)}" style="width:38px;height:38px;border-radius:50%;border:2px solid rgba(0,200,255,0.3)">
              <div>
                <div style="font-weight:700">${u.nombres} ${u.apellidos||''}</div>
                <div style="font-size:0.75rem;color:var(--text-muted)">@${u.usuario} Â· ${u.metodo}</div>
              </div>
            </div>
            <div style="font-size:0.8rem;color:var(--text-muted)">${semanas.length} sem Â· ${meses.length} mes</div>
          </div>
          <div class="panel-body">
            <!-- TABS -->
            <div class="tabs" style="margin-bottom:14px">
              <div class="tab active" id="tab_sem_${uid}" onclick="switchRevTab('${uid}','sem')">ğŸ“‹ Semanales (${semanas.length})</div>
              <div class="tab" id="tab_mes_${uid}" onclick="switchRevTab('${uid}','mes')">ğŸ† Mensuales (${meses.length})</div>
            </div>

            <!-- SEMANALES -->
            <div id="rev_sem_${uid}">
              ${semanas.length===0?'<div class="empty-state"><div class="empty-icon">ğŸ“‹</div><div class="empty-text">Sin revisiones semanales aÃºn</div></div>':
                semanas.map(r=>`
                  <div style="background:rgba(0,0,0,0.25);border-radius:14px;padding:14px;margin-bottom:10px;border:1px solid rgba(255,255,255,0.06)">
                    <div style="font-weight:700;margin-bottom:10px;color:var(--primary)">Mes ${r.mes} Â· Semana ${r.semana} <span style="font-size:0.72rem;color:var(--text-muted);font-weight:400">${new Date(r.fecha).toLocaleDateString()}</span></div>
                    <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:8px">
                      <div class="rev-info-card"><div class="ric-label">ğŸ’¢ DOMS</div><div class="ric-val" style="color:${r.doms>=7?'var(--error)':r.doms>=4?'var(--warning)':'var(--success)'}">${r.doms}/10</div></div>
                      <div class="rev-info-card"><div class="ric-label">ğŸ‹ï¸ MÃºsculo DOMS</div><div class="ric-val">${r.musculoDoms||'â€”'}</div></div>
                      <div class="rev-info-card"><div class="ric-label">ğŸ˜Š Ãnimo</div><div class="ric-val">${r.animo}/5</div></div>
                      <div class="rev-info-card"><div class="ric-label">ğŸ˜´ SueÃ±o</div><div class="ric-val">${r.sueno}</div></div>
                      <div class="rev-info-card" style="grid-column:1/-1"><div class="ric-label">ğŸ¦´ Dolor articular/muscular</div><div class="ric-val">${r.dolor==='Si'?`âš ï¸ ${r.dolorDetalle}`:'âœ… Sin dolor'}</div></div>
                    </div>
                  </div>
                `).join('')}
            </div>

            <!-- MENSUALES -->
            <div id="rev_mes_${uid}" style="display:none">
              ${meses.length===0?'<div class="empty-state"><div class="empty-icon">ğŸ†</div><div class="empty-text">Sin revisiones mensuales aÃºn</div></div>':
                meses.map(r=>`
                  <div style="background:rgba(0,0,0,0.25);border-radius:14px;padding:14px;margin-bottom:10px;border:1px solid rgba(123,47,255,0.2)">
                    <div style="font-weight:700;margin-bottom:10px;color:var(--accent)">Mes ${r.mes} <span style="font-size:0.72rem;color:var(--text-muted);font-weight:400">${new Date(r.fecha).toLocaleDateString()}</span></div>
                    <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:8px">
                      <div class="rev-info-card"><div class="ric-label">ğŸ“ˆ Â¿Siente mejora?</div><div class="ric-val">${r.mejora}</div></div>
                      <div class="rev-info-card"><div class="ric-label">ğŸ¯ Sin progreso en</div><div class="ric-val">${r.noProgresa||'â€”'}</div></div>
                      <div class="rev-info-card"><div class="ric-label">ğŸ“… DÃ­a mÃ¡s fatigante</div><div class="ric-val">${r.diaMasFatiga}</div></div>
                      <div class="rev-info-card"><div class="ric-label">â“ Motivo fatiga</div><div class="ric-val">${r.motivoFatiga}</div></div>
                      <div class="rev-info-card"><div class="ric-label">ğŸ›Œ MÃ¡s descanso</div><div class="ric-val">${r.masDescanso==='Si'?'âš ï¸ SÃ­ lo necesita':'âœ… No necesita'}</div></div>
                      ${r.motivoDetalle?`<div class="rev-info-card" style="grid-column:1/-1"><div class="ric-label">ğŸ’¬ Detalle motivo</div><div class="ric-val">${r.motivoDetalle}</div></div>`:''}
                      ${r.cambioEjercicios?`<div class="rev-info-card" style="grid-column:1/-1"><div class="ric-label">ğŸ”„ Cambios solicitados</div><div class="ric-val">${r.cambioEjercicios}</div></div>`:''}
                    </div>
                  </div>
                `).join('')}
            </div>
          </div>
        </div>
      `;
    }).join('') || '<div class="empty-state"><div class="empty-icon">ğŸ‘¥</div><div class="empty-text">No hay atletas con revisiones</div></div>';

  container.innerHTML = atletasHtml;
}

window.switchRevTab = (uid, tab) => {
  document.getElementById(`tab_sem_${uid}`).classList.toggle('active', tab==='sem');
  document.getElementById(`tab_mes_${uid}`).classList.toggle('active', tab==='mes');
  document.getElementById(`rev_sem_${uid}`).style.display = tab==='sem' ? '' : 'none';
  document.getElementById(`rev_mes_${uid}`).style.display = tab==='mes' ? '' : 'none';
};

// Init
onAuthStateChanged(auth, (user) => {
  if (!user) { sessionStorage.removeItem('saykyo_user'); window.location.href='index.html'; return; }
  if (typeof window._appInited === 'undefined') {
    window._appInited = true;
    // Restaurar pÃ¡gina tras reload post-sesiÃ³n admin
    const reloadPage = sessionStorage.getItem('saykyo_reload_page');
    const reloadUid  = sessionStorage.getItem('saykyo_reload_uid');
    if (reloadPage) {
      sessionStorage.removeItem('saykyo_reload_page');
      sessionStorage.removeItem('saykyo_reload_uid');
      if (reloadUid) window._atletaState = { uid: reloadUid, sesId: null };
      // Activar el nav item correcto
      const navItem = document.querySelector(`[data-page="${reloadPage}"]`);
      if (navItem) { document.querySelectorAll('.nav-item').forEach(i=>i.classList.remove('active')); navItem.classList.add('active'); }
      renderPage(reloadPage);
    } else {
      renderPage('home');
    }
  }
});
</script>
</body>
</html>
