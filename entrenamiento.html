<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SAYKYO CLUB - Entrenamiento</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Exo+2:wght@300;400;600;700;900&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
:root {
  --primary: #00c8ff;
  --primary-dark: #0088cc;
  --accent: #7b2fff;
  --success: #00e5a0;
  --warning: #ffd60a;
  --error: #ff4d6d;
  --glass-bg: rgba(10,20,45,0.7);
  --glass-border: rgba(255,255,255,0.1);
  --text: #e8f4ff;
  --text-muted: rgba(232,244,255,0.5);
  --bg-dark: #060c18;
}
* { margin:0; padding:0; box-sizing:border-box; }
body { font-family:'Exo 2',sans-serif; background:var(--bg-dark); color:var(--text); min-height:100vh; }

.bg-scene { position:fixed;inset:0;z-index:0;
  background:radial-gradient(ellipse at 20% 30%,rgba(0,100,200,0.2) 0%,transparent 50%),
             radial-gradient(ellipse at 80% 70%,rgba(123,47,255,0.15) 0%,transparent 50%), #060c18;
}
.grid-overlay { position:fixed;inset:0;z-index:0;opacity:0.02;
  background-image:linear-gradient(rgba(0,200,255,1) 1px,transparent 1px),linear-gradient(90deg,rgba(0,200,255,1) 1px,transparent 1px);
  background-size:40px 40px;
}

/* HEADER */
.header {
  position:sticky;top:0;z-index:100;
  background:rgba(6,12,28,0.9);backdrop-filter:blur(20px);
  border-bottom:1px solid var(--glass-border);
  display:flex;align-items:center;justify-content:space-between;
  padding:14px 20px;
}
.header-logo { font-family:'Space Mono',monospace;font-size:1.1rem;font-weight:700;letter-spacing:4px;
  background:linear-gradient(135deg,#fff,var(--primary),var(--accent));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;
}
.header-user { display:flex;align-items:center;gap:10px; }
.header-avatar { width:36px;height:36px;border-radius:50%;border:2px solid var(--primary);object-fit:cover; }
.header-name { font-size:0.85rem;font-weight:600; }
.header-method { font-size:0.7rem;color:var(--primary);letter-spacing:1px; }

/* MAIN */
.page { position:relative;z-index:1;max-width:620px;margin:0 auto;padding:20px 16px 40px; }

/* GLASS CARD */
.glass-card {
  background:rgba(15,25,50,0.65);backdrop-filter:blur(20px);
  border:1px solid var(--glass-border);border-radius:20px;padding:22px;
  margin-bottom:16px;
}
.card-title { font-size:1.1rem;font-weight:700;margin-bottom:16px;display:flex;align-items:center;gap:8px; }

/* PROGRESS WIDGET */
.progress-widget {
  background:linear-gradient(135deg,rgba(0,100,200,0.15),rgba(123,47,255,0.1));
  border:1px solid rgba(0,200,255,0.2);border-radius:20px;padding:20px;margin-bottom:16px;
  position:relative;overflow:hidden;
}
.progress-widget::before {
  content:'';position:absolute;top:0;left:0;right:0;height:2px;
  background:linear-gradient(90deg,var(--primary),var(--accent));
}
.progress-crumbs { display:flex;gap:8px;flex-wrap:wrap;margin-bottom:12px; }
.crumb {
  background:rgba(0,200,255,0.1);border:1px solid rgba(0,200,255,0.2);
  border-radius:20px;padding:4px 12px;font-size:0.78rem;color:var(--primary);font-weight:600;
}
.progress-bar-wrap { margin-top:12px; }
.progress-label { display:flex;justify-content:space-between;font-size:0.78rem;color:var(--text-muted);margin-bottom:6px; }
.progress-bar { height:6px;background:rgba(255,255,255,0.08);border-radius:3px;overflow:hidden; }
.progress-fill { height:100%;background:linear-gradient(90deg,var(--primary),var(--accent));border-radius:3px;transition:width 1s ease; }

/* BUTTONS */
.btn { padding:12px 20px;border-radius:14px;font-family:'Exo 2',sans-serif;font-size:0.9rem;font-weight:700;cursor:pointer;border:none;transition:all 0.2s ease;letter-spacing:0.5px;display:inline-flex;align-items:center;justify-content:center;gap:8px; }
.btn-primary { background:linear-gradient(135deg,var(--primary-dark),var(--primary));color:#fff;box-shadow:0 4px 20px rgba(0,200,255,0.3); }
.btn-primary:hover { transform:translateY(-2px);box-shadow:0 8px 30px rgba(0,200,255,0.5); }
.btn-secondary { background:rgba(255,255,255,0.08);border:1px solid var(--glass-border);color:var(--text); }
.btn-success { background:linear-gradient(135deg,#00a86b,var(--success));color:#000;font-weight:800; }
.btn-full { width:100%; }
.btn-sm { padding:8px 14px;font-size:0.82rem;border-radius:10px; }

/* EXERCISE CARD - Training Mode */
.training-card {
  background:rgba(10,20,45,0.8);backdrop-filter:blur(30px);
  border:1px solid rgba(0,200,255,0.2);border-radius:22px;overflow:hidden;
  margin-bottom:16px;
}
.training-video { position:relative;padding-bottom:56.25%;background:#000;border-radius:0; }
.training-video iframe { position:absolute;inset:0;width:100%;height:100%; }
.training-video .no-video { position:absolute;inset:0;display:flex;align-items:center;justify-content:center;flex-direction:column;gap:8px;color:var(--text-muted); }
.training-info { padding:20px; }
.training-title { font-size:1.3rem;font-weight:900;margin-bottom:6px; }
.training-meta { display:flex;gap:8px;flex-wrap:wrap;margin-bottom:16px; }
.meta-pill { background:rgba(0,200,255,0.1);border:1px solid rgba(0,200,255,0.2);border-radius:20px;padding:4px 12px;font-size:0.78rem;color:var(--primary); }

/* SERIES TRACKER */
.series-list { display:flex;flex-direction:column;gap:12px;margin-bottom:16px; }
.serie-row {
  background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.08);
  border-radius:14px;padding:14px;display:flex;flex-direction:column;gap:10px;
}
.serie-header {
  display:flex;align-items:center;gap:10px;padding-bottom:10px;
  border-bottom:1px solid rgba(255,255,255,0.06);
}
.serie-num { 
  width:32px;height:32px;border-radius:50%;
  background:rgba(0,200,255,0.12);border:1px solid rgba(0,200,255,0.3);
  display:flex;align-items:center;justify-content:center;
  font-size:0.85rem;font-weight:700;color:var(--primary);flex-shrink:0;
}
.serie-inputs { 
  display:grid;grid-template-columns:repeat(auto-fit,minmax(85px,1fr));
  gap:10px;
}
.serie-field { display:flex;flex-direction:column;gap:4px; }
.serie-field label { 
  font-size:0.68rem;color:var(--text-muted);
  text-transform:uppercase;letter-spacing:0.8px;font-weight:600;
  white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
}
.serie-field input { 
  background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.12);
  border-radius:10px;padding:9px 12px;color:var(--text);
  font-family:'Exo 2',sans-serif;font-size:0.92rem;font-weight:600;
  outline:none;width:100%;transition:all 0.2s ease;
}
.serie-field input:focus { 
  border-color:var(--primary);
  background:rgba(0,200,255,0.08);
  box-shadow:0 0 0 2px rgba(0,200,255,0.12);
}
.serie-done { 
  width:40px;height:40px;border-radius:50%;
  background:rgba(0,229,160,0.08);border:2px solid rgba(0,229,160,0.25);
  cursor:pointer;font-size:1.1rem;transition:all 0.2s ease;
  flex-shrink:0;display:flex;align-items:center;justify-content:center;
  color:rgba(0,229,160,0.5);
}
.serie-done:hover { 
  background:rgba(0,229,160,0.15);
  border-color:rgba(0,229,160,0.4);
  transform:scale(1.05);
}
.serie-done.checked { 
  background:var(--success);border-color:var(--success);
  color:#000;font-weight:900;
}

/* EFFORT SCALE */
.effort-scale { display:grid;grid-template-columns:repeat(5,1fr);gap:8px;margin:16px 0; }
.effort-option {
  aspect-ratio:1;border-radius:14px;background:rgba(255,255,255,0.05);
  border:2px solid transparent;cursor:pointer;
  display:flex;flex-direction:column;align-items:center;justify-content:center;gap:2px;
  transition:all 0.2s ease;
}
.effort-option .effort-emoji { font-size:1.6rem;transition:transform 0.2s ease; }
.effort-option .effort-label { font-size:0.6rem;color:var(--text-muted);text-align:center;line-height:1.1; }
.effort-option:hover { background:rgba(0,200,255,0.1);border-color:rgba(0,200,255,0.3); }
.effort-option:hover .effort-emoji { transform:scale(1.15); }
.effort-option.selected { border-color:var(--primary);background:rgba(0,200,255,0.15);box-shadow:0 0 20px rgba(0,200,255,0.2); }
.effort-option.selected .effort-emoji { transform:scale(1.2); }
.effort-option.selected .effort-label { color:var(--primary); }

/* FATIGUE SCALE */
.fatigue-scale { display:flex;gap:6px;justify-content:space-between;margin:12px 0; }
.fatigue-dot {
  flex:1;height:40px;border-radius:10px;cursor:pointer;
  display:flex;align-items:center;justify-content:center;
  font-size:0.8rem;font-weight:700;transition:all 0.2s ease;
  background:rgba(255,255,255,0.04);border:1px solid rgba(255,255,255,0.08);
}
.fatigue-dot:hover { transform:scale(1.08); }
.fatigue-dot.active { box-shadow:0 0 12px rgba(0,200,255,0.3); }

/* AVATAR SELECTOR */
.avatar-grid-user {
  display:grid;
  grid-template-columns:repeat(auto-fill,minmax(62px,1fr));
  gap:64px;
  max-height:320px;
  overflow-y:auto;
  padding:4px 2px;
}
.av-opt { cursor:pointer;border-radius:50%;border:3px solid transparent;transition:all 0.2s ease;overflow:hidden;aspect-ratio:1;display:flex;align-items:center;justify-content:center;background:rgba(255,255,255,0.04); }
.av-opt img { width:100%;height:100%;object-fit:cover;border-radius:50%;display:block; }
.av-opt:hover { border-color:rgba(0,200,255,0.5);transform:scale(1.08); }
.av-opt.selected { border-color:var(--primary);box-shadow:0 0 15px rgba(0,200,255,0.4);transform:scale(1.05); }
/* Placeholder mientras carga */
.av-opt img[data-src] { opacity:0; transition:opacity 0.3s ease; }
.av-opt img.loaded { opacity:1; }

/* FORMS */
.glass-input { background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:12px;padding:12px 14px;color:var(--text);font-family:'Exo 2',sans-serif;font-size:0.9rem;outline:none;width:100%;transition:all 0.3s ease; }
.glass-input:focus { border-color:var(--primary);background:rgba(0,200,255,0.08);box-shadow:0 0 0 3px rgba(0,200,255,0.1); }
.glass-input::placeholder { color:rgba(232,244,255,0.25); }
select.glass-input option { background:#0d1a35; }
.form-group { margin-bottom:14px; }
.form-label { display:block;font-size:0.75rem;color:var(--text-muted);letter-spacing:1px;text-transform:uppercase;margin-bottom:6px; }

/* TABS BOTTOM NAV */
.bottom-nav {
  position:fixed;bottom:0;left:0;right:0;z-index:100;
  background:rgba(6,12,28,0.95);backdrop-filter:blur(20px);
  border-top:1px solid var(--glass-border);
  display:flex;padding:8px 0 max(8px,env(safe-area-inset-bottom));
}
.nav-tab { flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:3px;cursor:pointer;padding:6px;transition:all 0.2s ease; }
.nav-tab .tab-icon { font-size:1.3rem; }
.nav-tab .tab-label { font-size:0.65rem;color:var(--text-muted);letter-spacing:0.5px; }
.nav-tab.active .tab-label { color:var(--primary); }
.nav-tab.active .tab-icon { transform:translateY(-2px); }

/* ANAMNESIS */
.question-step { animation:fadeIn 0.3s ease; }
@keyframes fadeIn { from{opacity:0;transform:translateX(20px)} to{opacity:1;transform:translateX(0)} }
.q-number { font-size:0.75rem;color:var(--primary);letter-spacing:2px;text-transform:uppercase;margin-bottom:8px; }
.q-text { font-size:1.1rem;font-weight:700;margin-bottom:20px;line-height:1.4; }
.step-progress { display:flex;gap:4px;margin-bottom:24px; }
.step-dot { flex:1;height:3px;background:rgba(255,255,255,0.1);border-radius:2px; }
.step-dot.done { background:var(--primary); }
.step-dot.current { background:rgba(0,200,255,0.5); }

.option-grid { display:grid;grid-template-columns:repeat(2,1fr);gap:8px; }
.option-btn {
  padding:12px;background:rgba(255,255,255,0.04);border:1px solid var(--glass-border);
  border-radius:12px;color:var(--text);font-family:'Exo 2',sans-serif;font-size:0.85rem;
  cursor:pointer;transition:all 0.2s ease;text-align:center;
}
.option-btn:hover,.option-btn.selected { background:rgba(0,200,255,0.12);border-color:var(--primary);color:var(--primary); }

/* OVERLAY */
.overlay-backdrop { position:fixed;inset:0;background:rgba(0,0,0,0.8);backdrop-filter:blur(12px);z-index:500;display:flex;align-items:flex-end;justify-content:center;padding:0; }
.overlay-sheet { background:rgba(8,16,36,0.98);border:1px solid var(--glass-border);border-radius:28px 28px 0 0;padding:28px 20px max(28px,env(safe-area-inset-bottom));width:100%;max-width:600px;max-height:90vh;overflow-y:auto;animation:slideUp 0.3s cubic-bezier(0.16,1,0.3,1); }
.sheet-handle { width:36px;height:4px;background:rgba(255,255,255,0.15);border-radius:2px;margin:0 auto 20px; }

/* SCROLL */
::-webkit-scrollbar { width:4px; }
::-webkit-scrollbar-thumb { background:rgba(0,200,255,0.2);border-radius:2px; }

/* SESIÃ“N EN CURSO â€” dot indicator on Entrenar tab */
.nav-tab .session-dot {
  display:none;
  position:absolute;
  top:4px; right:calc(50% - 18px);
  width:8px; height:8px;
  border-radius:50%;
  background:var(--success);
  box-shadow:0 0 8px var(--success);
  animation:pulse-dot 1.4s ease-in-out infinite;
}
.nav-tab { position:relative; }
.nav-tab.has-session .session-dot { display:block; }
@keyframes pulse-dot {
  0%,100% { transform:scale(1); opacity:1; }
  50% { transform:scale(1.4); opacity:0.7; }
}
@keyframes pulse-session {
  0%,100% { box-shadow: 0 0 0 0 rgba(0,200,255,0.15); }
  50% { box-shadow: 0 0 0 4px rgba(0,200,255,0.05); }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   REST TIMER â€” Full overlay modal
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#restTimerOverlay {
  position:fixed; inset:0; z-index:800;
  background:rgba(3,7,18,0.88);
  backdrop-filter:blur(18px) saturate(160%);
  -webkit-backdrop-filter:blur(18px) saturate(160%);
  display:flex; flex-direction:column;
  align-items:center; justify-content:center;
  gap:0;
  animation:rtFadeIn 0.35s cubic-bezier(0.16,1,0.3,1);
}
@keyframes rtFadeIn { from{opacity:0} to{opacity:1} }
#restTimerOverlay.rt-exit {
  animation:rtFadeOut 0.3s ease forwards;
}
@keyframes rtFadeOut { from{opacity:1} to{opacity:0} }

/* Label superior */
.rt-label {
  font-family:'Space Mono',monospace;
  font-size:0.72rem; letter-spacing:5px;
  text-transform:uppercase;
  color:rgba(232,244,255,0.35);
  margin-bottom:32px;
}

/* Serie completada badge */
.rt-series-badge {
  background:rgba(0,229,160,0.1);
  border:1px solid rgba(0,229,160,0.3);
  border-radius:30px; padding:6px 18px;
  font-size:0.78rem; font-weight:700;
  color:var(--success); letter-spacing:1px;
  margin-bottom:36px;
  animation:rtBadgePop 0.4s cubic-bezier(0.34,1.56,0.64,1);
}
@keyframes rtBadgePop { from{opacity:0;transform:scale(0.7)} to{opacity:1;transform:scale(1)} }

/* Ring container */
.rt-ring-wrap {
  position:relative;
  width:220px; height:220px;
  margin-bottom:36px;
}
.rt-ring-wrap svg {
  transform:rotate(-90deg);
  filter:drop-shadow(0 0 18px var(--rt-glow, rgba(0,200,255,0.5)));
  transition:filter 0.6s ease;
}
.rt-ring-bg {
  fill:none;
  stroke:rgba(255,255,255,0.06);
  stroke-width:10;
}
.rt-ring-track {
  fill:none;
  stroke:rgba(255,255,255,0.04);
  stroke-width:10;
}
.rt-ring-fill {
  fill:none;
  stroke:var(--rt-color, var(--primary));
  stroke-width:10;
  stroke-linecap:round;
  transition:stroke-dashoffset 1s linear, stroke 0.5s ease;
}
/* Inner glow ring (decorative) */
.rt-ring-inner {
  fill:none;
  stroke:var(--rt-color, var(--primary));
  stroke-width:1;
  opacity:0.25;
  transition:stroke 0.5s ease;
}

/* Number in center */
.rt-number {
  position:absolute; inset:0;
  display:flex; flex-direction:column;
  align-items:center; justify-content:center;
  gap:2px;
}
.rt-count {
  font-family:'Space Mono',monospace;
  font-size:5.5rem; font-weight:700; line-height:1;
  color:var(--rt-color, var(--primary));
  transition:color 0.5s ease;
  text-shadow:0 0 40px var(--rt-glow, rgba(0,200,255,0.4));
  animation:rtCountPop 0.25s cubic-bezier(0.34,1.56,0.64,1);
}
@keyframes rtCountPop { from{transform:scale(1.15)} to{transform:scale(1)} }
.rt-secs-label {
  font-size:0.7rem; letter-spacing:3px;
  color:rgba(232,244,255,0.3);
  text-transform:uppercase;
}

/* Status message */
.rt-msg {
  font-size:1.15rem; font-weight:700;
  color:rgba(232,244,255,0.75);
  letter-spacing:0.5px;
  margin-bottom:10px;
  min-height:1.6em;
  text-align:center;
  transition:color 0.4s ease;
}

/* Progress bar (thin, below ring) */
.rt-progress-bar {
  width:200px; height:3px;
  background:rgba(255,255,255,0.06);
  border-radius:2px; overflow:hidden;
  margin-bottom:44px;
}
.rt-progress-fill {
  height:100%;
  background:var(--rt-color, var(--primary));
  border-radius:2px;
  transition:width 1s linear, background 0.5s ease;
  box-shadow:0 0 8px var(--rt-glow, rgba(0,200,255,0.6));
}

/* Skip button */
.rt-skip {
  background:rgba(255,255,255,0.05);
  border:1px solid rgba(255,255,255,0.12);
  border-radius:50px; padding:12px 36px;
  color:rgba(232,244,255,0.5);
  font-family:'Exo 2',sans-serif;
  font-size:0.88rem; font-weight:600; letter-spacing:1px;
  cursor:pointer;
  transition:all 0.25s ease;
}
.rt-skip:hover {
  background:rgba(255,255,255,0.1);
  border-color:rgba(255,255,255,0.25);
  color:rgba(232,244,255,0.9);
  transform:scale(1.03);
}
.rt-skip:active { transform:scale(0.97); }

/* URGENCY PULSE â€” when <= 10s */
.rt-ring-wrap.rt-urgent svg {
  animation:rtUrgentPulse 0.8s ease-in-out infinite;
}
@keyframes rtUrgentPulse {
  0%,100% { filter:drop-shadow(0 0 18px var(--rt-glow)); }
  50%      { filter:drop-shadow(0 0 36px var(--rt-glow)) drop-shadow(0 0 60px var(--rt-glow)); }
}

/* DONE state */
#restTimerOverlay.rt-done .rt-count {
  animation:rtDonePop 0.5s cubic-bezier(0.34,1.56,0.64,1);
}
@keyframes rtDonePop { 0%{transform:scale(0.5);opacity:0} 60%{transform:scale(1.15)} 100%{transform:scale(1);opacity:1} }

/* AUTOSAVE MICRO-FEEDBACK */
.autosave-badge {
  display:inline-flex; align-items:center; gap:4px;
  background:rgba(0,229,160,0.12); border:1px solid rgba(0,229,160,0.3);
  border-radius:8px; padding:3px 8px;
  font-size:0.68rem; color:var(--success); font-weight:700;
  animation:fadeInOut 1.5s ease forwards;
  pointer-events:none;
}
@keyframes fadeInOut { 0%{opacity:0;transform:translateY(4px)} 15%{opacity:1;transform:translateY(0)} 75%{opacity:1} 100%{opacity:0} }

/* LANDSCAPE VIDEO EXPAND BUTTON */
.video-expand-btn {
  position:absolute; bottom:10px; right:10px;
  background:rgba(0,0,0,0.65); border:1px solid rgba(255,255,255,0.2);
  border-radius:8px; padding:6px 10px;
  color:#fff; font-size:0.75rem; font-weight:700;
  cursor:pointer; z-index:10; backdrop-filter:blur(6px);
  display:flex; align-items:center; gap:5px;
  transition:all 0.2s ease;
}
.video-expand-btn:hover { background:rgba(0,200,255,0.3); border-color:rgba(0,200,255,0.5); }

/* SUBSCRIPTION EXPIRY BANNER â€” sticky under header, always visible */
#expiryBanner {
  position:sticky; top:0; z-index:99;
  background:linear-gradient(90deg, rgba(20,8,4,0.97) 0%, rgba(30,10,4,0.97) 100%);
  border-bottom:2px solid rgba(255,107,53,0.7);
  padding:10px 16px;
  display:flex; align-items:center; gap:10px;
  box-shadow:0 4px 20px rgba(255,107,53,0.2);
  animation:expirySlideIn 0.5s cubic-bezier(0.16,1,0.3,1);
}
@keyframes expirySlideIn { from{opacity:0;transform:translateY(-100%)} to{opacity:1;transform:translateY(0)} }
.expiry-banner-pulse {
  width:10px; height:10px; border-radius:50%; flex-shrink:0;
  background:#ff6b35;
  box-shadow:0 0 0 0 rgba(255,107,53,0.7);
  animation:expiryPulse 1.6s ease-in-out infinite;
}
@keyframes expiryPulse {
  0%   { box-shadow:0 0 0 0 rgba(255,107,53,0.7); }
  70%  { box-shadow:0 0 0 8px rgba(255,107,53,0); }
  100% { box-shadow:0 0 0 0 rgba(255,107,53,0); }
}
.expiry-banner-text { flex:1; min-width:0; }
.expiry-banner-title { font-size:0.82rem; font-weight:800; color:#ff6b35; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
.expiry-banner-sub { font-size:0.72rem; color:rgba(255,180,140,0.8); margin-top:1px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
.expiry-banner-close {
  background:rgba(255,107,53,0.15); border:1px solid rgba(255,107,53,0.35);
  border-radius:8px; padding:5px 10px;
  color:#ff6b35; font-family:'Exo 2',sans-serif; font-size:0.72rem; font-weight:700;
  cursor:pointer; white-space:nowrap; flex-shrink:0;
  transition:all 0.2s ease;
}
.expiry-banner-close:hover { background:rgba(255,107,53,0.28); }

/* STAT MINI */
.mini-stats { display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-bottom:16px; }
.mini-stat { background:rgba(0,0,0,0.3);border-radius:14px;padding:14px;text-align:center;border:1px solid var(--glass-border); }
.mini-stat .val { font-size:1.6rem;font-weight:900;color:var(--primary); }
.mini-stat .lbl { font-size:0.68rem;color:var(--text-muted);text-transform:uppercase;letter-spacing:1px; }

@keyframes slideUp { from{opacity:0;transform:translateY(50px)} to{opacity:1;transform:translateY(0)} }

.page-wrap { padding-bottom: 80px; }
@keyframes spin { to { transform: rotate(360deg); } }
.spinner { width:40px;height:40px;border:3px solid rgba(0,200,255,0.15);border-top-color:var(--primary);border-radius:50%;animation:spin 0.8s linear infinite;margin:0 auto; }
.spinner-sm { width:28px;height:28px;border:3px solid rgba(0,200,255,0.15);border-top-color:var(--primary);border-radius:50%;animation:spin 0.8s linear infinite; }
.loading-box { display:flex;flex-direction:column;align-items:center;justify-content:center;padding:60px 20px;gap:14px;color:var(--text-muted);font-size:0.9rem; }

/* REVISION BLOCKS */
.rev-block {
  background:rgba(255,255,255,0.03);
  border:1px solid rgba(255,255,255,0.07);
  border-radius:14px; padding:14px; margin-bottom:12px;
}
.rev-q {
  font-size:0.9rem; font-weight:700; margin-bottom:8px;
  line-height:1.4;
}
.mini-scale {
  display:flex; gap:5px; flex-wrap:wrap;
}
.mini-dot {
  flex:1; min-width:28px; height:36px;
  border-radius:8px; cursor:pointer;
  display:flex; align-items:center; justify-content:center;
  font-size:0.82rem; font-weight:600;
  background:rgba(255,255,255,0.05);
  border:1px solid rgba(255,255,255,0.1);
  transition:all 0.15s ease; color:var(--text);
}
.mini-dot:hover { background:rgba(0,200,255,0.12); border-color:rgba(0,200,255,0.3); }

/* NOTIFICATION BELL - USER */
.user-notif-btn {
  position:relative; background:rgba(255,255,255,0.06); border:1px solid rgba(255,255,255,0.12);
  border-radius:10px; width:38px; height:38px; display:flex; align-items:center; justify-content:center;
  cursor:pointer; transition:all 0.2s ease; font-size:1rem; flex-shrink:0;
}
.user-notif-btn:hover { background:rgba(0,200,255,0.12); border-color:rgba(0,200,255,0.3); }
.user-notif-badge {
  position:absolute; top:-5px; right:-5px;
  min-width:17px; height:17px; padding:0 3px;
  background:var(--error); color:#fff; font-size:0.6rem; font-weight:800;
  border-radius:9px; display:none; align-items:center; justify-content:center;
  box-shadow:0 0 10px rgba(255,77,109,0.8);
  animation: pulse-badge 1.5s ease-in-out infinite;
}
.user-notif-badge.visible { display:flex; }
@keyframes pulse-badge {
  0%,100% { box-shadow:0 0 10px rgba(255,77,109,0.8); transform:scale(1); }
  50% { box-shadow:0 0 20px rgba(255,77,109,1); transform:scale(1.1); }
}
.push-toast {
  position:fixed; top:80px; left:50%; transform:translateX(-50%); z-index:9999;
  background:rgba(8,18,40,0.97); border:1px solid rgba(0,200,255,0.3);
  border-radius:16px; padding:14px 18px; width:calc(100% - 32px); max-width:380px;
  box-shadow:0 8px 32px rgba(0,0,0,0.6);
  animation:toastSlide 0.4s cubic-bezier(0.16,1,0.3,1);
  cursor:pointer; display:flex; align-items:flex-start; gap:12px;
}
@keyframes toastSlide { from{opacity:0;transform:translateX(-50%) translateY(-20px)} to{opacity:1;transform:translateX(-50%) translateY(0)} }
.notif-sheet {
  position:fixed; inset:0; z-index:800;
  background:rgba(0,0,0,0.75); backdrop-filter:blur(10px);
  display:flex; align-items:flex-end;
  animation:fadeIn 0.2s ease;
}
@keyframes fadeIn { from{opacity:0} to{opacity:1} }
.notif-sheet-inner {
  width:100%; max-height:85vh; overflow-y:auto;
  background:rgba(6,14,32,0.98); border-radius:24px 24px 0 0;
  padding:24px 16px 40px;
  animation:sheetUp 0.35s cubic-bezier(0.16,1,0.3,1);
}
@keyframes sheetUp { from{transform:translateY(100%)} to{transform:translateY(0)} }
.notif-item { padding:14px; border-radius:14px; background:rgba(255,255,255,0.04); border:1px solid rgba(255,255,255,0.08); margin-bottom:10px; position:relative; }
.notif-item.unread { background:rgba(0,200,255,0.06); border-color:rgba(0,200,255,0.2); }
.notif-item.unread::before { content:''; position:absolute;top:14px;left:-4px;width:8px;height:8px;border-radius:50%;background:var(--primary);box-shadow:0 0 8px var(--primary); }

/* â”€â”€ FLOATING HELP BUTTON â”€â”€ */
.help-fab{
  position:fixed;bottom:24px;right:20px;z-index:9999;
  width:48px;height:48px;border-radius:50%;
  background:linear-gradient(135deg,rgba(0,136,204,.9),rgba(0,200,255,.9));
  border:1.5px solid rgba(0,200,255,.5);
  box-shadow:0 4px 20px rgba(0,200,255,.35),0 0 0 0 rgba(0,200,255,.4);
  display:flex;align-items:center;justify-content:center;
  font-family:'Space Mono',monospace;font-size:1.15rem;font-weight:700;color:#fff;
  cursor:grab;text-decoration:none;
  animation:fabPulse 3s ease-in-out infinite;
  transition:transform .2s,box-shadow .2s
}
.help-fab.dragging{cursor:grabbing;animation:none;transform:scale(1.1)}
.help-fab:not(.dragging):hover{transform:scale(1.12);box-shadow:0 6px 28px rgba(0,200,255,.55),0 0 0 8px rgba(0,200,255,.1)}
@keyframes fabPulse{0%,100%{box-shadow:0 4px 20px rgba(0,200,255,.35),0 0 0 0 rgba(0,200,255,.4)}50%{box-shadow:0 4px 20px rgba(0,200,255,.35),0 0 0 8px rgba(0,200,255,.05)}}
.help-fab-tooltip{
  position:fixed;z-index:9998;
  background:rgba(6,14,38,.95);border:1px solid rgba(0,200,255,.25);
  border-radius:10px;padding:7px 12px;
  font-family:'Exo 2',sans-serif;font-size:.72rem;font-weight:700;color:rgba(232,244,255,.8);
  white-space:nowrap;pointer-events:none;
  opacity:0;transition:all .2s
}
.help-fab:not(.dragging):hover + .help-fab-tooltip,.help-fab-tooltip.show{opacity:1}

</style>
</head>
<body>
<div class="bg-scene"></div>
<div class="grid-overlay"></div>

<div class="header">
  <img src="logo_saykyo.png" alt="Saykyo Club" style="height:60px;object-fit:contain;filter:drop-shadow(0 0 8px rgba(0,200,255,0.25))">
  <div class="header-user">
    <button class="user-notif-btn" id="userNotifBtn" onclick="toggleUserNotifSheet()" title="Notificaciones">
      ğŸ””
      <span class="user-notif-badge" id="userNotifBadge">0</span>
    </button>
    <img class="header-avatar" id="userAvatar" src="" alt="">
    <div>
      <div class="header-name" id="userName">Usuario</div>
      <div class="header-method" id="userMethod">RPE</div>
    </div>
    <button style="background:none;border:none;color:var(--text-muted);cursor:pointer;padding:6px;font-size:1.1rem" onclick="logout()">ğŸšª</button>
  </div>
</div>

<div id="expiryBanner" style="display:none"></div>

<div class="page page-wrap" id="mainPage">
  <div class="page-loading" style="display:flex;flex-direction:column;align-items:center;justify-content:center;padding:60px 20px;gap:12px">
    <div class="spinner"></div>
    <span>Cargando tu perfil...</span>
  </div>
</div>

<nav class="bottom-nav" id="bottomNav" style="display:none">
  <div class="nav-tab active" data-tab="entrenar" id="navTabEntrenar" onclick="switchTab('entrenar')">
    <span class="session-dot"></span>
    <span class="tab-icon">ğŸ’ª</span><span class="tab-label">Entrenar</span>
  </div>
  <div class="nav-tab" data-tab="progreso" onclick="switchTab('progreso')">
    <span class="tab-icon">ğŸ“ˆ</span><span class="tab-label">Progreso</span>
  </div>
  <div class="nav-tab" data-tab="perfil" onclick="switchTab('perfil')">
    <span class="tab-icon">ğŸ‘¤</span><span class="tab-label">Perfil</span>
  </div>
</nav>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import { getDatabase, ref, get, set, push, update, remove, onValue, off } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyCDlQGoWTNtAna8unwVNgJZH8WNRsYF0MU",
  authDomain: "entrenamiento-6b069.firebaseapp.com",
  projectId: "entrenamiento-6b069",
  storageBucket: "entrenamiento-6b069.firebasestorage.app",
  messagingSenderId: "818051143570",
  appId: "1:818051143570:web:c17fa58f4f98ce67b9534b",
  databaseURL: "https://entrenamiento-6b069-default-rtdb.firebaseio.com"
};
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const auth = getAuth(app);

// Auth
const session = sessionStorage.getItem('saykyo_user');
if(!session) { window.location.href='index.html'; }
const currentUser = JSON.parse(session||'{}');
if(currentUser.rol==='admin' || currentUser.rol==='superadmin') { window.location.href='dashboard.html'; }

// Setup header
document.getElementById('userName').textContent = currentUser.nombres;
document.getElementById('userMethod').textContent = currentUser.metodo||'RPE';
document.getElementById('userAvatar').src = currentUser.avatar || `https://api.dicebear.com/7.x/adventurer/svg?seed=${currentUser.usuario}`;

window.logout = () => { sessionStorage.removeItem('saykyo_user'); signOut(auth).finally(() => { window.location.href='index.html'; }); };

// ========== USER NOTIFICATIONS ==========
let userNotifListener = null;

function setupUserNotifListener() {
  const notifRef = ref(db, `notificaciones/${currentUser.id}`);
  if(userNotifListener) off(notifRef, 'value', userNotifListener);

  // Track which notif IDs we've already toasted this session (survives JS but not page reload)
  // Use sessionStorage so reload doesn't re-show toasts for old notifs
  const shownKey = `saykyo_shown_notifs_${currentUser.id}`;
  let shownIds = new Set(JSON.parse(sessionStorage.getItem(shownKey)||'[]'));

  userNotifListener = onValue(notifRef, (snap) => {
    const notifs = snap.val()||{};
    const unread = Object.values(notifs).filter(n=>!n.leida).length;
    const badge = document.getElementById('userNotifBadge');
    if(badge) {
      badge.textContent = unread > 99 ? '99+' : unread;
      badge.classList.toggle('visible', unread > 0);
    }
    window._userNotifData = notifs;

    // Push toast only for truly new notifications (not seen this session AND unread)
    const latest = Object.entries(notifs)
      .filter(([nid, n]) => !n.leida && !shownIds.has(nid))
      .sort((a,b) => b[1].creadaEn - a[1].creadaEn)[0];
    if(latest) {
      const [nid, n] = latest;
      showUserPushToast(n);
      shownIds.add(nid);
      sessionStorage.setItem(shownKey, JSON.stringify([...shownIds]));
    }
  });
}

// â”€â”€ AUDIO ENGINE â€” Web Audio API â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function playSaykyoNotifSound() {
  try {
    const ctx = new (window.AudioContext || window.webkitAudioContext)();
    const master = ctx.createGain();
    master.gain.setValueAtTime(0.18, ctx.currentTime);
    master.connect(ctx.destination);

    // Reverb convolver (impulse)
    const convolver = ctx.createConvolver();
    const irLen = ctx.sampleRate * 0.6;
    const ir = ctx.createBuffer(2, irLen, ctx.sampleRate);
    for (let c = 0; c < 2; c++) {
      const d = ir.getChannelData(c);
      for (let i = 0; i < irLen; i++) d[i] = (Math.random() * 2 - 1) * Math.pow(1 - i / irLen, 2.5);
    }
    convolver.buffer = ir;
    convolver.connect(master);

    function tone(freq, startT, dur, type, vol, fadeIn, fadeOut) {
      const osc = ctx.createOscillator();
      const g   = ctx.createGain();
      osc.type = type;
      osc.frequency.setValueAtTime(freq, ctx.currentTime + startT);
      g.gain.setValueAtTime(0, ctx.currentTime + startT);
      g.gain.linearRampToValueAtTime(vol, ctx.currentTime + startT + fadeIn);
      g.gain.setValueAtTime(vol, ctx.currentTime + startT + dur - fadeOut);
      g.gain.linearRampToValueAtTime(0, ctx.currentTime + startT + dur);
      osc.connect(g);
      g.connect(convolver);
      g.connect(master);
      osc.start(ctx.currentTime + startT);
      osc.stop(ctx.currentTime + startT + dur + 0.05);
    }

    // Secuencia: do-mi-sol acorde mayor ascendente â€” elegante "ping"
    tone(523.25, 0.00, 0.22, 'sine',     0.5,  0.005, 0.12);
    tone(659.25, 0.13, 0.22, 'sine',     0.45, 0.005, 0.12);
    tone(783.99, 0.26, 0.35, 'sine',     0.4,  0.005, 0.18);
    // Sub-armÃ³nico cÃ¡lido
    tone(261.63, 0.00, 0.40, 'triangle', 0.2,  0.01,  0.20);
    // Shimmer de alta frecuencia
    tone(1046.5,  0.26, 0.30, 'sine',    0.08, 0.02,  0.20);

    setTimeout(() => ctx.close(), 2000);
  } catch(e) { /* AudioContext no disponible */ }
}
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function showUserPushToast(n) {
  const existing = document.getElementById('userPushToast');
  if(existing) existing.remove();

  playSaykyoNotifSound();

  const toast = document.createElement('div');
  toast.id = 'userPushToast';
  toast.className = 'push-toast';
  toast.innerHTML = `
    <div style="font-size:1.3rem;flex-shrink:0">ğŸ’¬</div>
    <div style="flex:1">
      <div style="font-size:0.8rem;font-weight:700;color:var(--primary);margin-bottom:2px">Mensaje de tu entrenador</div>
      <div style="font-size:0.78rem;color:var(--text-muted);line-height:1.4"><strong>${n.deNombre||'Entrenador'}:</strong> ${n.mensaje}</div>
    </div>
    <button onclick="document.getElementById('userPushToast')?.remove()" style="background:none;border:none;color:var(--text-muted);font-size:0.9rem;cursor:pointer;position:absolute;top:8px;right:10px">âœ•</button>
  `;
  toast.style.position='fixed';
  toast.onclick = (e) => { if(e.target.tagName==='BUTTON') return; toggleUserNotifSheet(); toast.remove(); };
  document.body.appendChild(toast);
  setTimeout(()=>toast.remove?.(), 10000);
}

window.toggleUserNotifSheet = () => {
  const existing = document.getElementById('userNotifSheet');
  if(existing) { existing.remove(); return; }

  const notifs = window._userNotifData||{};
  const sorted = Object.entries(notifs).sort((a,b)=>b[1].creadaEn-a[1].creadaEn);

  const sheet = document.createElement('div');
  sheet.id = 'userNotifSheet';
  sheet.className = 'notif-sheet';
  sheet.innerHTML = `
    <div class="notif-sheet-inner">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px">
        <div style="font-size:1.1rem;font-weight:800">ğŸ”” Mis Notificaciones</div>
        <div style="display:flex;gap:8px;align-items:center">
          <button onclick="userMarkAllRead()" style="background:rgba(0,200,255,0.1);border:1px solid rgba(0,200,255,0.3);border-radius:8px;padding:4px 10px;color:var(--primary);font-size:0.72rem;cursor:pointer;font-family:'Exo 2',sans-serif">âœ“ Todo leÃ­do</button>
          <button onclick="userDeleteAllNotifs()" style="background:rgba(255,77,109,0.1);border:1px solid rgba(255,77,109,0.3);border-radius:8px;padding:4px 10px;color:#ff4d6d;font-size:0.72rem;cursor:pointer;font-family:'Exo 2',sans-serif">ğŸ—‘ï¸ Borrar todo</button>
          <button onclick="document.getElementById('userNotifSheet').remove()" style="background:rgba(255,255,255,0.06);border:none;color:var(--text-muted);width:28px;height:28px;border-radius:8px;cursor:pointer;font-size:0.9rem">âœ•</button>
        </div>
      </div>
      <div style="margin-bottom:16px;padding-bottom:16px;border-bottom:1px solid rgba(255,255,255,0.08)">
        <div style="font-size:0.8rem;color:var(--text-muted);margin-bottom:10px;text-transform:uppercase;letter-spacing:0.5px">ğŸ“£ Crear Alerta para tu entrenador</div>
        <textarea id="userAlertMsg" placeholder="Ej: Llego tarde a la sesiÃ³n, mucho trÃ¡fico..." style="background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:12px;padding:12px;color:var(--text);font-family:'Exo 2',sans-serif;font-size:0.88rem;width:100%;min-height:70px;resize:none;outline:none;margin-bottom:8px" onfocus="this.style.borderColor='var(--primary)'"></textarea>
        <button onclick="sendAlertToAdmins()" class="btn btn-primary btn-sm btn-full" style="width:100%;justify-content:center">âš¡ Enviar alerta al entrenador</button>
      </div>
      ${sorted.length===0
        ? '<div style="text-align:center;padding:32px;color:var(--text-muted)"><div style="font-size:3rem;margin-bottom:10px">ğŸ””</div>Sin notificaciones aÃºn</div>'
        : sorted.map(([nid,n])=>{
          // Tipos que llegan al usuario desde el entrenador:
          //   'respuesta_admin' â†’ entrenador respondiÃ³ a su alerta â†’ usuario PUEDE responder (una vez)
          //   'mensaje'         â†’ entrenador enviÃ³ mensaje directo â†’ usuario PUEDE responder (una vez)
          //   'respuesta_alerta'â†’ legacy (igual a respuesta_admin) â†’ PUEDE responder
          // El usuario NO ve 'alerta' ni 'respuesta_usuario' (esos los enviÃ³ Ã©l mismo)
          const isRespAdmin = n.tipo === 'respuesta_admin' || n.tipo === 'respuesta_alerta';
          const isMensaje = n.tipo === 'mensaje';
          const canReply = (isRespAdmin || isMensaje) && !n.respondida && n.deId;
          const iconLabel = isRespAdmin ? 'ğŸ’¬ Respuesta del entrenador'
            : isMensaje ? 'ğŸ“£ Mensaje de'
            : 'ğŸ“© NotificaciÃ³n de';
          return `
          <div class="notif-item ${n.leida?'':'unread'}" id="unotif_${nid}">
            <div style="display:flex;align-items:flex-start;gap:8px">
              <div style="flex:1;cursor:pointer;min-width:0" onclick="userMarkNotifRead('${nid}',document.getElementById('unotif_${nid}'))">
                <div style="font-size:0.72rem;color:var(--text-muted);margin-bottom:4px">${iconLabel} â€” <strong>${n.deNombre||'Entrenador'}</strong></div>
                <div style="font-size:0.9rem;font-weight:600;margin-bottom:6px">${n.mensaje}</div>
                ${n.respondida ? '<div style="font-size:0.72rem;color:var(--success);font-style:italic;margin-bottom:4px">âœ… Ya respondiste</div>' : ''}
                <div style="font-size:0.7rem;color:var(--text-muted)">${new Date(n.creadaEn).toLocaleString()}${!n.leida?'  <span style="color:var(--primary);font-weight:700">â— Sin leer</span>':''}</div>
              </div>
              <div style="display:flex;flex-direction:column;gap:4px;flex-shrink:0;align-items:flex-end">
                ${canReply ? `<button onclick="userReplyNotif('${nid}','${n.deId||''}')" style="background:rgba(0,200,255,0.12);border:1px solid rgba(0,200,255,0.3);border-radius:8px;color:var(--primary);padding:5px 8px;cursor:pointer;font-family:'Exo 2',sans-serif;font-size:0.7rem;font-weight:700;white-space:nowrap">ğŸ’¬ Responder</button>` : ''}
                <button onclick="userDeleteNotif('${nid}')" title="Eliminar" style="background:rgba(255,77,109,0.1);border:1px solid rgba(255,77,109,0.25);border-radius:8px;color:#ff4d6d;width:28px;height:28px;cursor:pointer;font-size:0.85rem;display:flex;align-items:center;justify-content:center" onmouseover="this.style.background='rgba(255,77,109,0.25)'" onmouseout="this.style.background='rgba(255,77,109,0.1)'">ğŸ—‘ï¸</button>
              </div>
            </div>
          </div>`;
        }).join('')
      }
    </div>
  `;
  sheet.addEventListener('click', e => { if(e.target===sheet) sheet.remove(); });
  document.body.appendChild(sheet);
};

window.userMarkNotifRead = async (nid, el) => {
  const notifRef = ref(db, `notificaciones/${currentUser.id}/${nid}`);
  await update(notifRef, {leida: true});
  el.classList.remove('unread');
  el.querySelector('[style*="Sin leer"]')?.remove();
};

window.userMarkAllRead = async () => {
  const notifs = window._userNotifData||{};
  const unread = Object.entries(notifs).filter(([,n])=>!n.leida);
  await Promise.all(unread.map(([nid])=>update(ref(db,`notificaciones/${currentUser.id}/${nid}`), {leida:true})));
  const sheet = document.getElementById('userNotifSheet');
  if(sheet) { sheet.remove(); setTimeout(()=>toggleUserNotifSheet(),50); }
};

window.userDeleteNotif = async (nid) => {
  await remove(ref(db,`notificaciones/${currentUser.id}/${nid}`));
  const el = document.getElementById(`unotif_${nid}`);
  if(el) el.remove();
  const notifs = window._userNotifData||{};
  delete notifs[nid];
  window._userNotifData = notifs;
  const unread = Object.values(notifs).filter(n=>!n.leida).length;
  const badge = document.getElementById('userNotifBadge');
  if(badge) { badge.textContent = unread; badge.classList.toggle('visible', unread>0); }
};

window.userDeleteAllNotifs = async () => {
  const notifs = window._userNotifData||{};
  if(!Object.keys(notifs).length) return;
  const res = await Swal.fire({
    icon:'warning', title:'Â¿Borrar todas las notificaciones?',
    text:'Esta acciÃ³n no se puede deshacer.',
    showCancelButton:true, confirmButtonText:'SÃ­, borrar todo',
    cancelButtonText:'Cancelar', confirmButtonColor:'#ff4d6d',
    background:'rgba(10,20,40,0.95)', color:'#e8f4ff'
  });
  if(!res.isConfirmed) return;
  await remove(ref(db,`notificaciones/${currentUser.id}`));
  const sheet = document.getElementById('userNotifSheet');
  if(sheet) { sheet.remove(); setTimeout(()=>toggleUserNotifSheet(),50); }
};

// Reply to admin's alert response â€” one-time reply
window.userReplyNotif = (nid, adminId) => {
  // Close current sheet
  document.getElementById('userNotifSheet')?.remove();

  // Show reply overlay
  const overlay = document.createElement('div');
  overlay.className = 'overlay-backdrop';
  overlay.innerHTML = `
    <div style="background:rgba(8,16,36,0.97);border:1px solid rgba(255,255,255,0.1);border-radius:24px;padding:28px;width:95%;max-width:480px;max-height:90vh;overflow-y:auto">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:20px">
        <div style="font-size:1.1rem;font-weight:800">ğŸ’¬ Tu respuesta</div>
        <button onclick="this.closest('.overlay-backdrop').remove()" style="background:rgba(255,255,255,0.06);border:none;color:var(--text-muted);width:32px;height:32px;border-radius:8px;cursor:pointer;font-size:1rem">âœ•</button>
      </div>
      <div style="font-size:0.82rem;color:var(--text-muted);margin-bottom:16px">Puedes enviar <strong>una sola respuesta</strong> a tu entrenador sobre este mensaje.</div>
      <textarea id="userReplyText" class="glass-input" rows="4" placeholder="Escribe tu respuesta..." style="width:100%;margin-bottom:16px;resize:none"></textarea>
      <div style="display:flex;gap:10px;justify-content:flex-end">
        <button onclick="this.closest('.overlay-backdrop').remove()" class="btn btn-secondary">Cancelar</button>
        <button onclick="submitUserReply('${nid}','${adminId}',this.closest('.overlay-backdrop'))" class="btn btn-primary">ğŸ“¤ Enviar respuesta</button>
      </div>
    </div>
  `;
  overlay.addEventListener('click', e => { if(e.target===overlay) overlay.remove(); });
  document.body.appendChild(overlay);
};

window.submitUserReply = async (nid, adminId, overlayEl) => {
  const msg = document.getElementById('userReplyText')?.value?.trim();
  if(!msg) return Swal.fire({icon:'warning',title:'Escribe tu respuesta',background:'rgba(10,20,40,0.95)',color:'#e8f4ff',confirmButtonColor:'#00c8ff'});

  // Send notification to admin as 'respuesta_usuario' â€” hilo cerrado, admin no puede responder
  const notif = {
    mensaje: msg,
    deId: currentUser.id,
    deNombre: `${currentUser.nombres} ${currentUser.apellidos||''} (Atleta â€” respuesta)`,
    tipo: 'respuesta_usuario',
    leida: false,
    creadaEn: Date.now()
  };

  const tasks = [];
  if(adminId) tasks.push(push(ref(db,`notificaciones/${adminId}`), notif));

  // Also find all group admins if adminId not set
  if(!adminId) {
    const userSnap = await get(ref(db,`usuarios/${currentUser.id}`));
    const userData = userSnap.val()||{};
    const gid = userData.grupoId;
    if(gid) {
      const gSnap = await get(ref(db,`grupos/${gid}`));
      const g = gSnap.val()||{};
      const adminIds = [g.adminDueno, ...Object.keys(g.adminsInvitados||{})].filter(Boolean);
      adminIds.forEach(aid => tasks.push(push(ref(db,`notificaciones/${aid}`), notif)));
    }
  }

  // Mark original notification as responded
  tasks.push(update(ref(db,`notificaciones/${currentUser.id}/${nid}`), {respondida: true, leida: true}));

  await Promise.all(tasks);
  if(overlayEl) overlayEl.remove();
  Swal.fire({icon:'success',title:'Â¡Respuesta enviada!',timer:2000,showConfirmButton:false,background:'rgba(10,20,40,0.95)',color:'#e8f4ff'});
};

window.sendAlertToAdmins = async () => {
  const msg = document.getElementById('userAlertMsg')?.value?.trim();
  if(!msg) {
    Swal.fire({icon:'warning',title:'Escribe tu alerta',background:'rgba(10,20,40,0.95)',color:'#e8f4ff',confirmButtonColor:'#00c8ff'});
    return;
  }
  // Find all admins in user's group
  const userSnap = await get(ref(db,`usuarios/${currentUser.id}`));
  const userData = userSnap.val()||{};
  const gid = userData.grupoId;
  if(!gid) {
    Swal.fire({icon:'info',title:'No estÃ¡s en ningÃºn grupo',text:'Contacta a tu entrenador para que te asigne a un grupo.',background:'rgba(10,20,40,0.95)',color:'#e8f4ff',confirmButtonColor:'#00c8ff'});
    return;
  }
  const gSnap = await get(ref(db,`grupos/${gid}`));
  const g = gSnap.val()||{};
  const adminIds = [g.adminDueno, ...Object.keys(g.adminsInvitados||{})].filter(Boolean);
  
  const notif = {
    mensaje: msg,
    deId: currentUser.id,
    deNombre: `${currentUser.nombres} ${currentUser.apellidos||''} (Atleta)`,
    tipo: 'alerta',
    leida: false,
    creadaEn: Date.now()
  };

  await Promise.all(adminIds.map(aid => push(ref(db,`notificaciones/${aid}`), notif)));

  document.getElementById('userNotifSheet')?.remove();
  Swal.fire({icon:'success',title:'Â¡Alerta enviada!',text:`NotificaciÃ³n enviada a ${adminIds.length} entrenador(es)`,timer:2000,showConfirmButton:false,background:'rgba(10,20,40,0.95)',color:'#e8f4ff'});
};

// Biblioteca de avatares (131 combinaciones Ãºnicas)
const AVATAR_LIST = [
  "https://api.dicebear.com/7.x/adventurer/svg?seed=Felix&backgroundColor=059ff2",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=Luna&backgroundColor=7b2fff",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=Zoe&backgroundColor=ff6b35",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=Mia&backgroundColor=00e5a0",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=Max&backgroundColor=ffd60a",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=Sam&backgroundColor=ff4d6d",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=Alex&backgroundColor=00c8ff",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=Jordan&backgroundColor=a855f7",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=Taylor&backgroundColor=f59e0b",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=Morgan&backgroundColor=10b981",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=Casey&backgroundColor=e74c3c",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=Riley&backgroundColor=2ecc71",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=Avery&backgroundColor=3498db",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=Quinn&backgroundColor=9b59b6",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=Sage&backgroundColor=1abc9c",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=River&backgroundColor=e67e22",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=Blake&backgroundColor=34495e",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=Drew&backgroundColor=16a085",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=Reese&backgroundColor=8e44ad",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=Hayden&backgroundColor=c0392b",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=Peyton&backgroundColor=27ae60",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=Logan&backgroundColor=2980b9",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=Rowan&backgroundColor=d35400",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=Emery&backgroundColor=2c3e50",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=Finley&backgroundColor=059ff2",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=Harper&backgroundColor=7b2fff",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=Skylar&backgroundColor=ff6b35",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=Phoenix&backgroundColor=00e5a0",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=Dakota&backgroundColor=ffd60a",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=Kendall&backgroundColor=ff4d6d",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=Adrian&backgroundColor=00c8ff",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=Beatriz&backgroundColor=a855f7",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=Carlos&backgroundColor=f59e0b",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=Diana&backgroundColor=10b981",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=Eduardo&backgroundColor=e74c3c",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=Fernanda&backgroundColor=2ecc71",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=Gabriel&backgroundColor=3498db",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=Helena&backgroundColor=9b59b6",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=Ivan&backgroundColor=1abc9c",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=Julia&backgroundColor=e67e22",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=Kevin&backgroundColor=34495e",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=Laura&backgroundColor=16a085",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=Miguel&backgroundColor=8e44ad",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=Natalia&backgroundColor=c0392b",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=Oscar&backgroundColor=27ae60",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=Patricia&backgroundColor=2980b9",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=Rafael&backgroundColor=d35400",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=Sofia&backgroundColor=2c3e50",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=Thomas&backgroundColor=059ff2",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=Valentina&backgroundColor=7b2fff",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=William&backgroundColor=ff6b35",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=Ximena&backgroundColor=00e5a0",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=Yamil&backgroundColor=ffd60a",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=Zara&backgroundColor=ff4d6d",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=Andres&backgroundColor=00c8ff",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=Brenda&backgroundColor=a855f7",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=Camilo&backgroundColor=f59e0b",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=Daniela&backgroundColor=10b981",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=Esteban&backgroundColor=e74c3c",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=Fatima&backgroundColor=2ecc71",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=Shadow&backgroundColor=3498db",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=Storm&backgroundColor=9b59b6",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=Blaze&backgroundColor=1abc9c",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=Frost&backgroundColor=e67e22",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=Thunder&backgroundColor=34495e",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=Viper&backgroundColor=16a085",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=Raven&backgroundColor=8e44ad",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=Wolf&backgroundColor=c0392b",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=Eagle&backgroundColor=27ae60",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=Fox&backgroundColor=2980b9",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=Cobra&backgroundColor=d35400",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=Titan&backgroundColor=2c3e50",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=Nova&backgroundColor=059ff2",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=Orion&backgroundColor=7b2fff",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=Atlas&backgroundColor=ff6b35",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=Zenith&backgroundColor=00e5a0",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=Apex&backgroundColor=ffd60a",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=Nexus&backgroundColor=ff4d6d",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=Vortex&backgroundColor=00c8ff",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=Cipher&backgroundColor=a855f7",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=User001&backgroundColor=f59e0b",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=User002&backgroundColor=10b981",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=User003&backgroundColor=e74c3c",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=User004&backgroundColor=2ecc71",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=User005&backgroundColor=3498db",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=User006&backgroundColor=9b59b6",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=User007&backgroundColor=1abc9c",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=User008&backgroundColor=e67e22",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=User009&backgroundColor=34495e",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=User010&backgroundColor=16a085",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=Alpha01&backgroundColor=8e44ad",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=Beta02&backgroundColor=c0392b",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=Gamma03&backgroundColor=27ae60",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=Delta04&backgroundColor=2980b9",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=Sigma05&backgroundColor=d35400",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=Omega06&backgroundColor=2c3e50",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=Lambda07&backgroundColor=059ff2",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=Theta08&backgroundColor=7b2fff",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=Kappa09&backgroundColor=ff6b35",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=Psi10&backgroundColor=00e5a0",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=OldMike&backgroundColor=ffd60a",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=GrayWolf&backgroundColor=ff4d6d",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=DarkBear&backgroundColor=00c8ff",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=IronMan&backgroundColor=a855f7",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=SteelFox&backgroundColor=f59e0b",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=BlackHawk&backgroundColor=10b981",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=GoldRush&backgroundColor=e74c3c",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=SilverBack&backgroundColor=2ecc71",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=BronzeAge&backgroundColor=3498db",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=CopperKing&backgroundColor=9b59b6",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=NightOwl&backgroundColor=1abc9c",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=DawnRider&backgroundColor=e67e22",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=DuskHunter&backgroundColor=34495e",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=MidnightRun&backgroundColor=16a085",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=SunriseHero&backgroundColor=8e44ad",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=CoachPro&backgroundColor=c0392b",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=TrainHard&backgroundColor=27ae60",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=LiftBig&backgroundColor=2980b9",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=RunFast&backgroundColor=d35400",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=pro_player9&backgroundColor=e74c3c",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=gym_rat_10&backgroundColor=2ecc71",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=iron_will11&backgroundColor=3498db",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=steel_mind12&backgroundColor=9b59b6",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=fire_soul13&backgroundColor=1abc9c",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=ice_veins14&backgroundColor=e67e22",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=thunder_fist&backgroundColor=34495e",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=lightning_kick&backgroundColor=16a085",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=shadow_punch&backgroundColor=8e44ad",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=golden_hook&backgroundColor=c0392b",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=silver_jab&backgroundColor=27ae60",
  "https://api.dicebear.com/7.x/adventurer/svg?seed=bronze_cross&backgroundColor=2980b9"
];
function getAvatarUrl(seed) {
  // Compatibilidad: si se pasa un seed antiguo, devolver primer avatar
  return AVATAR_LIST[0];
}

// State
let state = {
  tab: 'entrenar',
  sesionActiva: null,
  ejercicioActual: 0,
  seriesData: {},
  rutinaData: null,
  progreso: null,
  ejercicios: {},
  categorias: {}
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SESSION PERSISTENCE â€” guardada en Firebase para sobrevivir
// cambio de dispositivo, cierre de app, apagÃ³n de celular, etc.
// Ruta: sesiones_pendientes/{uid}
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const PENDING_REF = () => ref(db, `sesiones_pendientes/${currentUser.id}`);

async function savePendingSession() {
  if(!state.sesionActiva) return;
  // Asegurarse de que nivelCansancioInicio se preserve (puede haberse seteado antes del primer save)
  // ya estÃ¡ en state.sesionActiva, solo necesitamos persistirlo en Firebase junto con el resto.

  // Capturar snapshot del formulario actual
  const { mesActual=1, semanaActual=1, diaActual=1 } = state.progreso||{};
  const diaData = state.rutinaData?.meses?.[mesActual]?.semanas?.[semanaActual]?.dias?.[diaActual];
  const ejsDia  = Object.values(diaData?.ejercicios||{});
  const ejConfig = ejsDia[state.ejercicioActual];
  const n = ejConfig?.series||0;
  const ejInfo  = state.ejercicios[ejConfig?.ejercicioId]||{};
  const esBiext = ejInfo.biextremidad === true;

  const currentSeriesSnapshot = Array.from({length:n},(_,i)=>{
    const base = {
      reps: +document.getElementById(`reps_${i}`)?.value||0,
      peso: +document.getElementById(`peso_${i}`)?.value||0,
      completada: document.getElementById(`done_${i}`)?.classList.contains('checked')||false,
      comentario: document.getElementById(`comentario_${i}`)?.value?.trim()||''
    };
    if(esBiext) {
      base.rirRpeIzq = +document.getElementById(`rpe_izq_${i}`)?.value||0;
      base.rirRpeDer = +document.getElementById(`rpe_der_${i}`)?.value||0;
      const repsIzqEl = document.getElementById(`reps_izq_${i}`);
      const repsDerEl = document.getElementById(`reps_der_${i}`);
      if(repsIzqEl) base.repsIzq = +repsIzqEl.value||0;
      if(repsDerEl) base.repsDer = +repsDerEl.value||0;
    } else {
      base.rirRpe = +document.getElementById(`rpe_${i}`)?.value||0;
    }
    return base;
  });

  try {
    await set(PENDING_REF(), {
      sesionActiva: state.sesionActiva,
      ejercicioActual: state.ejercicioActual,
      currentSeriesSnapshot,
      savedAt: Date.now()
    });
  } catch(e) { console.warn('savePendingSession error:', e); }
}

async function loadPendingSession() {
  try {
    const snap = await get(PENDING_REF());
    if(!snap.exists()) return null;
    const data = snap.val();
    // Descartar sesiones de hace mÃ¡s de 24 horas
    if(Date.now() - (data.savedAt||0) > 24*60*60*1000) {
      await clearPendingSession();
      return null;
    }
    return data;
  } catch(e) { return null; }
}

async function clearPendingSession() {
  try { await remove(PENDING_REF()); } catch(e) {}
}

// Init
async function init() {
  const [anaSnap, progresoSnap, ejSnap, catSnap, histSnap, pendingSnap] = await Promise.all([
    get(ref(db,`anamnesis/${currentUser.id}`)),
    get(ref(db,`sesiones/${currentUser.id}/progreso`)),
    get(ref(db,'ejercicios')),
    get(ref(db,'categorias')),
    get(ref(db,`sesiones/${currentUser.id}/historial`)),
    get(PENDING_REF())
  ]);
  state.ejercicios = ejSnap.val()||{};
  state.categorias = catSnap.val()||{};
  state.historial  = histSnap.val()||{};
  
  const ana = anaSnap.val();
  if(!ana || !ana.completada) {
    renderAnamnesis();
    return;
  }
  
  state.progreso = progresoSnap.val()||{mesActual:1,semanaActual:1,diaActual:1};
  document.getElementById('bottomNav').style.display='flex';

  // â”€â”€ SUBSCRIPTION EXPIRY BANNER â”€â”€
  // diffDays compara fechas sin hora (hora local) para mostrar el nÃºmero correcto.
  if(currentUser.validoHasta) {
    const [_y,_m,_d] = currentUser.validoHasta.split('-').map(Number);
    const expiry = new Date(_y, _m - 1, _d); // medianoche local del dÃ­a de vencimiento
    const today  = new Date(); today.setHours(0,0,0,0);
    const diffDays = Math.round((expiry - today) / (1000 * 60 * 60 * 24));
    if(diffDays >= 0 && diffDays <= 7) {
      showExpiryBanner(diffDays, expiry);
    }
  }

  // â”€â”€ SESIÃ“N PENDIENTE: mostrar emergente al inicio desde cualquier dispositivo â”€â”€
  if(pendingSnap.exists()) {
    const pending = pendingSnap.val();
    const MAX_AGE = 24*60*60*1000;
    const tooOld = Date.now() - (pending.savedAt||0) > MAX_AGE;

    if(!tooOld && pending.sesionActiva) {
      const sa = pending.sesionActiva;
      const { mesActual=1, semanaActual=1, diaActual=1 } = state.progreso;
      const matchesDay = sa.mes === mesActual && sa.semana === semanaActual && sa.dia === diaActual;

      // Calcular tiempo transcurrido
      const minutos = Math.round((Date.now() - pending.savedAt) / 60000);
      const tiempoStr = minutos < 2 ? 'hace un momento' : minutos < 60 ? `hace ${minutos} min` : `hace ${Math.round(minutos/60)}h ${minutos%60}min`;

      // Info del ejercicio donde quedÃ³
      const rutinaSnap = await get(ref(db,`sesiones/${currentUser.id}/progreso`));
      const rutinaData = state.rutinaData; // puede ser null aÃºn, se carga luego
      const ejsHechos = Object.keys(sa.ejerciciosCompletados||{}).length;
      const ejActualIdx = pending.ejercicioActual || 0;

      // Buscar nombre del ejercicio donde quedÃ³ (si ya tenemos los ejercicios)
      let ejNombre = `Ejercicio ${ejActualIdx + 1}`;
      if(state.ejercicios && matchesDay) {
        const progreso = state.progreso;
        const rutSnap = await get(ref(db, `rutinas`));
        const rutinas = rutSnap.val()||{};
        const rutActiva = Object.values(rutinas).find(r => r.usuario === currentUser.id && r.activa);
        if(rutActiva) {
          const ejsDia = Object.values(rutActiva.meses?.[sa.mes]?.semanas?.[sa.semana]?.dias?.[sa.dia]?.ejercicios||{});
          const ejConfig = ejsDia[ejActualIdx];
          if(ejConfig) ejNombre = state.ejercicios[ejConfig.ejercicioId]?.nombre || ejNombre;
        }
      }

      const result = await Swal.fire({
        background: 'rgba(8,16,36,0.98)',
        color: '#e8f4ff',
        width: '360px',
        showConfirmButton: false,
        allowOutsideClick: false,
        allowEscapeKey: false,
        html: `
          <div style="text-align:left">
            <div style="display:flex;align-items:center;gap:10px;margin-bottom:20px">
              <div style="width:12px;height:12px;border-radius:50%;background:#00c8ff;box-shadow:0 0 12px #00c8ff;animation:pulse-dot 1.4s infinite;flex-shrink:0"></div>
              <div style="font-size:1.1rem;font-weight:800;color:#00c8ff">Entrenamiento en curso</div>
            </div>

            <div style="background:rgba(0,200,255,0.06);border:1px solid rgba(0,200,255,0.15);border-radius:14px;padding:16px;margin-bottom:16px">
              <div style="font-size:0.72rem;text-transform:uppercase;letter-spacing:1.5px;color:rgba(232,244,255,0.4);margin-bottom:10px">Donde quedaste</div>
              <div style="display:flex;gap:10px;margin-bottom:12px">
                <div style="flex:1;background:rgba(0,200,255,0.08);border:1px solid rgba(0,200,255,0.2);border-radius:10px;padding:10px;text-align:center">
                  <div style="font-size:1.4rem;font-weight:900;color:#00c8ff">${sa.mes}</div>
                  <div style="font-size:0.65rem;text-transform:uppercase;letter-spacing:1px;color:rgba(232,244,255,0.45);margin-top:2px">Mes</div>
                </div>
                <div style="flex:1;background:rgba(123,47,255,0.08);border:1px solid rgba(123,47,255,0.2);border-radius:10px;padding:10px;text-align:center">
                  <div style="font-size:1.4rem;font-weight:900;color:#a78bfa">${sa.semana}</div>
                  <div style="font-size:0.65rem;text-transform:uppercase;letter-spacing:1px;color:rgba(232,244,255,0.45);margin-top:2px">Semana</div>
                </div>
                <div style="flex:1;background:rgba(0,229,160,0.08);border:1px solid rgba(0,229,160,0.2);border-radius:10px;padding:10px;text-align:center">
                  <div style="font-size:1.4rem;font-weight:900;color:#00e5a0">${sa.dia}</div>
                  <div style="font-size:0.65rem;text-transform:uppercase;letter-spacing:1px;color:rgba(232,244,255,0.45);margin-top:2px">DÃ­a</div>
                </div>
              </div>
              <div style="display:flex;justify-content:space-between;font-size:0.8rem">
                <span style="color:rgba(232,244,255,0.5)">ğŸ“ En: <strong style="color:#e8f4ff">${ejNombre}</strong></span>
                <span style="color:rgba(232,244,255,0.4)">${tiempoStr}</span>
              </div>
              ${ejsHechos > 0 ? `<div style="margin-top:8px;font-size:0.8rem;color:#00e5a0">âœ… ${ejsHechos} ejercicio${ejsHechos!==1?'s':''} ya completado${ejsHechos!==1?'s':''}</div>` : ''}
            </div>

            ${!matchesDay ? `
            <div style="background:rgba(255,214,10,0.06);border:1px solid rgba(255,214,10,0.2);border-radius:10px;padding:10px;margin-bottom:16px;font-size:0.78rem;color:#ffd60a">
              âš ï¸ Este entrenamiento era del <strong>M${sa.mes}Â·S${sa.semana}Â·D${sa.dia}</strong> pero tu progreso actual es <strong>M${mesActual}Â·S${semanaActual}Â·D${diaActual}</strong>
            </div>` : ''}

            <div style="display:flex;flex-direction:column;gap:8px">
              <button id="swal-continuar" style="width:100%;padding:13px;background:linear-gradient(135deg,#0088cc,#00c8ff);border:none;border-radius:12px;color:#fff;font-family:'Exo 2',sans-serif;font-size:0.95rem;font-weight:700;cursor:pointer;letter-spacing:0.5px">
                â–¶ï¸ Continuar donde quedÃ©
              </button>
              <button id="swal-nueva" style="width:100%;padding:11px;background:rgba(255,255,255,0.06);border:1px solid rgba(255,255,255,0.12);border-radius:12px;color:rgba(232,244,255,0.6);font-family:'Exo 2',sans-serif;font-size:0.85rem;cursor:pointer">
                ğŸ”„ Descartar y empezar nueva sesiÃ³n
              </button>
            </div>
          </div>
        `,
        didOpen: () => {
          document.getElementById('swal-continuar').onclick = async () => {
            // Cargar la rutina si aÃºn no estÃ¡ disponible (ANTES de cerrar el Swal)
            if(!state.rutinaData) {
              const rutSnap = await get(ref(db,'rutinas'));
              const rutinas = rutSnap.val()||{};
              const rutActiva = Object.values(rutinas).find(r => r.usuario === currentUser.id && r.activa);
              if(rutActiva) {
                state.rutinaData = rutActiva;
                state.rutinaId   = Object.keys(rutinas).find(k => rutinas[k] === rutActiva);
              }
            }
            // Restaurar estado completo de la sesiÃ³n
            state.sesionActiva            = pending.sesionActiva;
            state.ejercicioActual         = pending.ejercicioActual || 0;
            state._pendingSeriesSnapshot  = pending.currentSeriesSnapshot;
            state._pendingSessionData     = null;
            updateSessionDot(true);
            // ğŸ‹ï¸ Notificar al entrenador que retomÃ³ el entrenamiento
            const sa = pending.sesionActiva;
            notifyTrainingStart(sa.mes||1, sa.semana||1, sa.dia||1, true);
            // Cambiar tab activo visualmente
            state.tab = 'entrenar';
            document.querySelectorAll('.nav-tab').forEach(t => t.classList.toggle('active', t.dataset.tab === 'entrenar'));
            // Flag para evitar que el renderTab('entrenar') posterior sobreescriba la vista
            state._resumeDirectly = true;
            Swal.close();
          };
          document.getElementById('swal-nueva').onclick = async () => {
            await clearPendingSession();
            updateSessionDot(false);
            Swal.close();
          };
        }
      });
    } else {
      // SesiÃ³n expirada â†’ limpiar silenciosamente
      await clearPendingSession();
    }
  }

  // Si el usuario eligiÃ³ continuar sesiÃ³n pendiente, ir directo al ejercicio
  if(state._resumeDirectly) {
    state._resumeDirectly = false;
    renderEjercicioActual();
    return;
  }

  renderTab('entrenar');
}

// â”€â”€ EXPIRY BANNER â”€â”€
function showExpiryBanner(daysLeft, expiryDate) {
  // Clave incluye los dÃ­as restantes: si quedan 7 dÃ­as y se descarta â†’ clave "d7".
  // Al dÃ­a siguiente quedan 6 â†’ clave "d6" â†’ no existe â†’ banner reaparece automÃ¡ticamente.
  const dismissedKey = `saykyo_expiry_dismissed_${currentUser.id}_d${daysLeft}`;
  if(localStorage.getItem(dismissedKey)) return;

  const banner = document.getElementById('expiryBanner');
  if(!banner) return;

  // Fecha en hora local â€” viene como objeto Date construido localmente desde init()
  const fechaTexto = expiryDate
    ? expiryDate.toLocaleDateString('es-CO', { day:'2-digit', month:'long' })
    : '';

  const urgency = daysLeft === 0;
  const title = urgency
    ? 'âš ï¸ Tu suscripciÃ³n vence HOY'
    : `âš ï¸ SuscripciÃ³n vence en ${daysLeft} dÃ­a${daysLeft===1?'':'s'}`;
  const sub = urgency
    ? 'Contacta a tu entrenador para renovar y no perder el acceso.'
    : `Tu membresÃ­a es vÃ¡lida hasta el ${fechaTexto}. Renueva con tu entrenador para continuar.`;

  banner.innerHTML = `
    <div class="expiry-banner-pulse"></div>
    <div class="expiry-banner-text">
      <div class="expiry-banner-title">${title}</div>
      <div class="expiry-banner-sub">${sub}</div>
    </div>
    <button class="expiry-banner-close" onclick="dismissExpiryBanner(${daysLeft})" title="Cerrar">âœ•</button>
  `;
  banner.style.display = 'flex';
}

window.dismissExpiryBanner = (daysLeft) => {
  const banner = document.getElementById('expiryBanner');
  if(banner) {
    banner.style.transition = 'opacity 0.3s ease, transform 0.3s ease';
    banner.style.opacity = '0';
    banner.style.transform = 'translateY(-8px)';
    setTimeout(() => { banner.style.display = 'none'; banner.style.opacity = ''; banner.style.transform = ''; }, 300);
  }
  // Guardar con clave especÃ­fica de dÃ­as: al dÃ­a siguiente la clave cambia y reaparece
  const dismissedKey = `saykyo_expiry_dismissed_${currentUser.id}_d${daysLeft}`;
  localStorage.setItem(dismissedKey, '1');
};

// ============ ANAMNESIS ============
// PREGUNTA_CONDICION_IDX = 4 (Ã­ndice de la pregunta de enfermedad/condiciÃ³n)
const ANAMNESIS_CONDICION_IDX = 4;
const PREGUNTAS = [
  { q:'Â¿CuÃ¡ntos aÃ±os tienes?', tipo:'number', placeholder:'Ej: 28' },
  { q:'Â¿CuÃ¡l es tu peso actual? (kg)', tipo:'number', placeholder:'Ej: 75' },
  { q:'Â¿CuÃ¡l es tu talla? (cm)', tipo:'number', placeholder:'Ej: 175' },
  { q:'Â¿CuÃ¡l es tu objetivo principal?', tipo:'opciones', opciones:['Ganar masa muscular','Perder grasa','Mejorar rendimiento','Mejorar salud general','Aumentar fuerza'] },
  { q:'Â¿Tienes alguna enfermedad, lesiÃ³n o condiciÃ³n mÃ©dica relevante?', tipo:'opciones', opciones:['No, ninguna','SÃ­, tengo una condiciÃ³n o lesiÃ³n'], esCondicion: true },
  { q:'Describe tu condiciÃ³n o lesiÃ³n', tipo:'text', placeholder:'Ej: Hernia discal L4-L5, hipotiroidismo...', soloSi: true },
  { q:'Â¿Tomas algÃºn medicamento actualmente?', tipo:'text', placeholder:'Nombre y dosis... o Ninguno', soloSi: true },
  { q:'Â¿CuÃ¡l es tu nivel de actividad fÃ­sica actual?', tipo:'opciones', opciones:['Sedentario','Poco activo','Moderadamente activo','Muy activo','Atleta competitivo'] },
  { q:'Â¿CuÃ¡ntos dÃ­as a la semana puedes entrenar?', tipo:'opciones', opciones:['2 dÃ­as','3 dÃ­as','4 dÃ­as','5 dÃ­as','6+ dÃ­as'] },
  { q:'Â¿CuÃ¡nto tiempo llevas entrenando?', tipo:'opciones', opciones:['Soy principiante','Menos de 1 aÃ±o','1-2 aÃ±os','2-4 aÃ±os','4+ aÃ±os'] },
  { q:'Â¿Realizas algÃºn deporte o actividad adicional?', tipo:'text', placeholder:'Ej: FÃºtbol los fines de semana, o "Ninguno"' },
  { q:'Â¿CuÃ¡l es tu horario preferido de entrenamiento?', tipo:'opciones', opciones:['MaÃ±ana (6am-10am)','MediodÃ­a (10am-2pm)','Tarde (2pm-6pm)','Noche (6pm-10pm)'] },
  { q:'Â¿Tomas algÃºn suplemento actualmente?', tipo:'text', placeholder:'ProteÃ­na, creatina, etc. o "Ninguno"' },
  { q:'Â¿CuÃ¡ntas horas duermes promedio por noche?', tipo:'opciones', opciones:['Menos de 5h','5-6h','6-7h','7-8h','MÃ¡s de 8h'] },
  { q:'Â¿Tienes alguna restricciÃ³n alimentaria?', tipo:'text', placeholder:'Vegetariano, alergias, etc. o "Ninguna"' },
  { q:'Â¿CuÃ¡l es tu nivel de estrÃ©s general? (1 = muy bajo, 10 = muy alto)', tipo:'slider', min:1, max:10 },
  { q:'Â¿QuÃ© esperas lograr en los prÃ³ximos 3 meses?', tipo:'text', placeholder:'Describe tu meta concreta...' }
];

// Helper: decide si un paso debe mostrarse segÃºn respuestas previas
function anamnesisStepVisible(idx) {
  const q = PREGUNTAS[idx];
  if(!q.soloSi) return true;
  // soloSi: solo mostrar si la condiciÃ³n mÃ©dica fue "SÃ­"
  return anamnesisRespuestas[`p${ANAMNESIS_CONDICION_IDX}`] === 'SÃ­, tengo una condiciÃ³n o lesiÃ³n';
}

// Avanza al siguiente paso visible
function anamnesisNextVisible(from) {
  let next = from + 1;
  while(next < PREGUNTAS.length && !anamnesisStepVisible(next)) next++;
  return next;
}

// Retrocede al paso visible anterior
function anamesisPrevVisible(from) {
  let prev = from - 1;
  while(prev >= 0 && !anamnesisStepVisible(prev)) prev--;
  return prev;
}

let anamnesisStep = 0;
let anamnesisRespuestas = {};

function renderAnamnesis() {
  document.getElementById('bottomNav').style.display='none';
  const p = document.getElementById('mainPage');
  p.innerHTML = renderAnamnesisStep();
}

function renderAnamnesisStep() {
  const q = PREGUNTAS[anamnesisStep];
  // Only count visible steps for display
  const visibleSteps = PREGUNTAS.map((_,i)=>anamnesisStepVisible(i) || i===anamnesisStep);
  const total = visibleSteps.filter(Boolean).length;
  const visibleIdx = visibleSteps.slice(0,anamnesisStep+1).filter(Boolean).length;
  const dots = PREGUNTAS.map((_,i)=>{
    if(!anamnesisStepVisible(i) && i!==anamnesisStep) return '';
    return `<div class="step-dot ${i<anamnesisStep && visibleSteps[i]?'done':i===anamnesisStep?'current':''}"></div>`;
  }).join('');
  
  let inputHtml = '';
  if(q.tipo==='text'||q.tipo==='number') {
    inputHtml = `<input class="glass-input" type="${q.tipo}" id="aInput" placeholder="${q.placeholder||''}" value="${anamnesisRespuestas[`p${anamnesisStep}`]||''}" style="margin-bottom:16px">`;
  } else if(q.tipo==='opciones') {
    inputHtml = `<div class="option-grid" style="margin-bottom:16px">${q.opciones.map(op=>`
      <button class="option-btn ${anamnesisRespuestas[`p${anamnesisStep}`]===op?'selected':''}" onclick="selectOption('${op}')">${op}</button>
    `).join('')}</div>`;
  } else if(q.tipo==='slider') {
    const val = anamnesisRespuestas[`p${anamnesisStep}`]||5;
    inputHtml = `
      <div style="margin-bottom:16px">
        <div style="text-align:center;font-size:2rem;font-weight:900;color:var(--primary);margin-bottom:12px" id="sliderVal">${val}</div>
        <input type="range" id="aInput" min="${q.min}" max="${q.max}" value="${val}" style="width:100%;accent-color:var(--primary)"
          oninput="document.getElementById('sliderVal').textContent=this.value">
        <div style="display:flex;justify-content:space-between;font-size:0.72rem;color:var(--text-muted);margin-top:4px">
          <span>Muy bajo</span><span>Muy alto</span>
        </div>
      </div>
    `;
  }

  return `
    <div class="glass-card question-step">
      <div style="font-size:0.8rem;color:var(--primary);font-weight:600;margin-bottom:16px;display:flex;justify-content:space-between;align-items:center">
        <span>ANAMNESIS INICIAL</span><span>${visibleIdx}/${total}</span>
      </div>
      <div class="step-progress">${dots}</div>
      <div class="q-number">PREGUNTA ${visibleIdx}</div>
      <div class="q-text">${q.q}</div>
      ${inputHtml}
      <div style="display:flex;gap:10px;justify-content:space-between">
        ${anamnesisStep>0?`<button class="btn btn-secondary" onclick="anamnesisBack()">â† AtrÃ¡s</button>`:'<div></div>'}
        <button class="btn btn-primary" onclick="anamnesisNext()">
          ${anamnesisNextVisible(anamnesisStep) >= PREGUNTAS.length?'âœ… Completar':'Siguiente â†’'}
        </button>
      </div>
    </div>
    <div style="text-align:center;padding:12px;color:var(--text-muted);font-size:0.8rem">
      Este cuestionario nos ayuda a personalizar tu entrenamiento ğŸ’ª
    </div>
  `;
}

window.selectOption = (val) => {
  anamnesisRespuestas[`p${anamnesisStep}`] = val;
  document.querySelectorAll('.option-btn').forEach(b=>b.classList.toggle('selected',b.textContent===val));
};

window.anamnesisBack = () => {
  anamnesisStep = anamesisPrevVisible(anamnesisStep);
  document.getElementById('mainPage').innerHTML = renderAnamnesisStep();
};

window.anamnesisNext = async () => {
  const q = PREGUNTAS[anamnesisStep];
  let val = anamnesisRespuestas[`p${anamnesisStep}`];
  
  if(q.tipo==='text'||q.tipo==='number'||q.tipo==='slider') {
    const inp = document.getElementById('aInput');
    if(inp) val = inp.value;
  }
  
  if(!val && val!==0) {
    return Swal.fire({icon:'warning',title:'Responde la pregunta',text:'Esta informaciÃ³n es importante para tu plan personalizado',background:'rgba(10,20,40,0.95)',color:'#e8f4ff',confirmButtonColor:'#00c8ff'});
  }
  
  anamnesisRespuestas[`p${anamnesisStep}`] = val;

  // Si respondiÃ³ "No" a condiciÃ³n mÃ©dica, limpiar las respuestas condicionales
  if(q.esCondicion && val === 'No, ninguna') {
    delete anamnesisRespuestas[`p${anamnesisStep+1}`];
    delete anamnesisRespuestas[`p${anamnesisStep+2}`];
  }

  // Buscar siguiente paso visible
  const nextStep = anamnesisNextVisible(anamnesisStep);
  
  if(nextStep >= PREGUNTAS.length) {
    // Save anamnesis
    await set(ref(db,`anamnesis/${currentUser.id}`), {
      completada:true, completadaEn:Date.now(), respuestas:anamnesisRespuestas
    });
    await Swal.fire({
      icon:'success',title:'Â¡Anamnesis completada! ğŸ‰',
      text:'Tu perfil estÃ¡ listo. Â¡A entrenar!',
      background:'rgba(10,20,40,0.95)',color:'#e8f4ff',confirmButtonColor:'#00c8ff',
      timer:2500,showConfirmButton:false
    });
    state.progreso = {mesActual:1,semanaActual:1,diaActual:1};
    document.getElementById('bottomNav').style.display='flex';
    renderTab('entrenar');
  } else {
    anamnesisStep = nextStep;
    document.getElementById('mainPage').innerHTML = renderAnamnesisStep();
  }
};

// ============ TABS ============
window.switchTab = (tab) => {
  state.tab = tab;
  document.querySelectorAll('.nav-tab').forEach(t=>t.classList.toggle('active',t.dataset.tab===tab));
  renderTab(tab);
};

async function checkRevisionesPendientes() {
  const progreso = state.progreso || {};
  const { mesActual=1, semanaActual=1 } = progreso;
  if(mesActual === 1 && semanaActual === 1) return false;

  // RevisiÃ³n mensual pendiente (inicio de mes nuevo)
  if(semanaActual === 1 && mesActual > 1) {
    const revMes = await get(ref(db, `revisiones_mes/${currentUser.id}/m${mesActual-1}`));
    if(!revMes.exists()) {
      await showRevisionMes(mesActual - 1);
      return true;
    }
  }

  // RevisiÃ³n semanal pendiente de la semana anterior
  let mesPend = mesActual, semPend = semanaActual - 1;
  if(semPend < 1) { mesPend = mesActual - 1; semPend = 4; }
  if(mesPend >= 1) {
    const revSem = await get(ref(db, `revisiones_semana/${currentUser.id}/m${mesPend}s${semPend}`));
    if(!revSem.exists()) {
      await showRevisionSemana(mesPend, semPend);
      return true;
    }
  }
  return false;
}

async function renderTab(tab) {
  if(tab==='entrenar') {
    await checkRevisionesPendientes();
    await renderEntrenar();
  }
  else if(tab==='progreso') await renderProgreso();
  else await renderPerfil();
}

// ============ ENTRENAR ============

// Helper: convert absolute day index (0-based) to {mes,semana,dia}
function absToMSD(abs) {
  const mes    = Math.floor(abs / 20) + 1;
  const semana = Math.floor((abs % 20) / 5) + 1;
  const dia    = (abs % 5) + 1;
  return { mes, semana, dia };
}
function msdToAbs(mes, semana, dia) {
  return (mes-1)*20 + (semana-1)*5 + (dia-1);
}

// Helper: check if a session was completed for a given day
function sesionCompletada(historial, mes, semana, dia) {
  return Object.values(historial||{}).some(s => s.mes===mes && s.semana===semana && s.dia===dia);
}

async function renderEntrenar() {
  const p = document.getElementById('mainPage');

  const rutSnap = await get(ref(db,'rutinas'));
  const rutinas = rutSnap.val()||{};
  const miRutina = Object.entries(rutinas).find(([,r])=>r.usuario===currentUser.id && r.activa);

  if(!miRutina) {
    p.innerHTML = `
      <div class="glass-card" style="text-align:center;padding:40px 20px">
        <div style="font-size:3rem;margin-bottom:16px">ğŸ‹ï¸</div>
        <h2 style="margin-bottom:10px">Sin rutina asignada</h2>
        <p style="color:var(--text-muted);font-size:0.9rem">Tu entrenador aÃºn no te ha asignado una rutina.</p>
      </div>`;
    return;
  }

  const [rutinaId, rutina] = miRutina;
  state.rutinaData = rutina;
  state.rutinaId   = rutinaId;

  // Load session history to know what's done
  const histSnap = await get(ref(db,`sesiones/${currentUser.id}/historial`));
  state.historial = histSnap.val()||{};

  const { mesActual=1, semanaActual=1, diaActual=1 } = state.progreso||{};

  // Build full day map for current semana
  const maxMes = Math.max(...Object.keys(rutina.meses||{1:{}}).map(Number));
  const currentAbs = msdToAbs(mesActual, semanaActual, diaActual);

  // Progress = completed days WITH exercises / total days WITH exercises
  let totalDiasConEj = 0;
  let diasCompletados = 0;
  for(let a=0; a<maxMes*20; a++) {
    const {mes:m,semana:s,dia:d} = absToMSD(a);
    if(m>maxMes) break;
    const ejsCount = Object.keys(rutina.meses?.[m]?.semanas?.[s]?.dias?.[d]?.ejercicios||{}).length;
    if(ejsCount>0) {
      totalDiasConEj++;
      if(sesionCompletada(state.historial, m, s, d)) diasCompletados++;
    }
  }
  const pct = totalDiasConEj>0 ? Math.round((diasCompletados/totalDiasConEj)*100) : 0;

  // Find all PENDING days (have exercises, not completed) BEFORE current position
  const pendingBefore = [];
  for(let a=0; a<currentAbs; a++) {
    const {mes,semana,dia} = absToMSD(a);
    if(mes>maxMes) break;
    const ejsCount = Object.keys(rutina.meses?.[mes]?.semanas?.[semana]?.dias?.[dia]?.ejercicios||{}).length;
    if(ejsCount>0 && !sesionCompletada(state.historial,mes,semana,dia)) {
      pendingBefore.push({mes,semana,dia,abs:a});
    }
  }

  const diaData = rutina.meses?.[mesActual]?.semanas?.[semanaActual]?.dias?.[diaActual];
  const ejsDia  = Object.values(diaData?.ejercicios||{});
  const yaCompletado = sesionCompletada(state.historial, mesActual, semanaActual, diaActual);

  // Build semana day pills for navigation
  const dayPills = [1,2,3,4,5].map(d => {
    const dd   = rutina.meses?.[mesActual]?.semanas?.[semanaActual]?.dias?.[d];
    const hasEj = Object.keys(dd?.ejercicios||{}).length > 0;
    const done  = sesionCompletada(state.historial, mesActual, semanaActual, d);
    const isCur = d === diaActual;
    let bg, border, icon;
    if(done)       { bg='rgba(0,229,160,0.15)'; border='rgba(0,229,160,0.5)'; icon='âœ…'; }
    else if(hasEj) { bg=isCur?'rgba(0,200,255,0.2)':'rgba(255,255,255,0.04)'; border=isCur?'var(--primary)':'rgba(255,255,255,0.1)'; icon='ğŸ’ª'; }
    else           { bg='rgba(255,255,255,0.03)'; border='rgba(255,255,255,0.06)'; icon='ğŸ˜´'; }
    return `<div onclick="irADia(${d})" style="flex:1;border-radius:12px;padding:8px 4px;cursor:pointer;background:${bg};border:2px solid ${border};text-align:center;transition:all 0.2s">
      <div style="font-size:1rem">${icon}</div>
      <div style="font-size:0.72rem;font-weight:${isCur?'800':'500'};color:${isCur?'var(--primary)':'var(--text-muted)'};margin-top:2px">D${d}</div>
    </div>`;
  }).join('');

  // Semana selector
  const semPills = [1,2,3,4].map(s => {
    const isCur = s===semanaActual;
    return `<div onclick="irASemana(${s})" style="flex:1;text-align:center;padding:6px;border-radius:10px;cursor:pointer;font-size:0.82rem;font-weight:${isCur?'700':'400'};background:${isCur?'rgba(0,200,255,0.15)':'rgba(255,255,255,0.04)'};border:1px solid ${isCur?'var(--primary)':'rgba(255,255,255,0.08)'};color:${isCur?'var(--primary)':'var(--text-muted)'}">S${s}</div>`;
  }).join('');

  // Pending alert banner
  const pendingBanner = pendingBefore.length > 0 ? `
    <div style="background:rgba(255,107,53,0.1);border:1px solid rgba(255,107,53,0.35);border-radius:16px;padding:14px;margin-bottom:12px">
      <div style="font-weight:700;font-size:0.9rem;color:#ff6b35;margin-bottom:8px">âš ï¸ Tienes ${pendingBefore.length} dÃ­a${pendingBefore.length>1?'s':''} pendiente${pendingBefore.length>1?'s':''}</div>
      <div style="display:flex;flex-wrap:wrap;gap:6px">
        ${pendingBefore.map(p=>`
          <button onclick="irADiaAbs(${p.abs})" style="background:rgba(255,107,53,0.15);border:1px solid rgba(255,107,53,0.4);border-radius:8px;padding:5px 10px;color:#ff6b35;font-size:0.78rem;font-weight:700;cursor:pointer">
            M${p.mes}Â·S${p.semana}Â·D${p.dia}
          </button>
        `).join('')}
      </div>
    </div>` : '';

  p.innerHTML = `
    <div class="progress-widget">
      <div style="font-size:0.8rem;color:var(--text-muted);margin-bottom:4px">ğŸ“‹ ${rutina.nombre}</div>
      <div class="progress-crumbs">
        <span class="crumb">Mes ${mesActual}</span>
        <span class="crumb">Semana ${semanaActual}</span>
        <span class="crumb">DÃ­a ${diaActual}</span>
      </div>
      <div class="progress-bar-wrap">
        <div class="progress-label"><span>Progreso (${diasCompletados}/${totalDiasConEj} dÃ­as)</span><span>${pct}%</span></div>
        <div class="progress-bar"><div class="progress-fill" style="width:${pct}%"></div></div>
      </div>
    </div>

    ${pendingBanner}

    <!-- DAY NAVIGATOR -->
    <div class="glass-card" style="padding:14px">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:10px">
        <span style="font-size:0.78rem;color:var(--text-muted);text-transform:uppercase;letter-spacing:1px">Semana actual</span>
        <div style="display:flex;gap:5px">${semPills}</div>
      </div>
      <div style="display:flex;gap:6px">${dayPills}</div>
      <div style="display:flex;justify-content:space-between;margin-top:10px;gap:8px">
        <button class="btn btn-secondary btn-sm" onclick="retrocederDia()" style="flex:1">â† Anterior</button>
        <button class="btn btn-secondary btn-sm" onclick="avanzarDia()" style="flex:1">Siguiente â†’</button>
        <button class="btn btn-danger btn-sm" onclick="resetProgreso()" style="padding:7px 10px">ğŸ”„</button>
      </div>
    </div>

    <div class="glass-card">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px">
        <div class="card-title" style="margin:0">ğŸ—“ï¸ ${diaData?.nombre||`DÃ­a ${diaActual}`}</div>
        ${yaCompletado?'<span style="background:rgba(0,229,160,0.15);border:1px solid rgba(0,229,160,0.4);border-radius:20px;padding:3px 10px;font-size:0.75rem;color:var(--success)">âœ… Completado</span>':''}
      </div>
      <div class="mini-stats">
        <div class="mini-stat"><div class="val">${ejsDia.length}</div><div class="lbl">Ejercicios</div></div>
        <div class="mini-stat"><div class="val">${ejsDia.reduce((a,e)=>a+(e.series||0),0)}</div><div class="lbl">Series</div></div>
        <div class="mini-stat"><div class="val">${currentUser.metodo}</div><div class="lbl">MÃ©todo</div></div>
      </div>
      ${ejsDia.length>0 ? (() => {
        if(yaCompletado) {
          return `
            <div style="text-align:center;padding:12px;background:rgba(0,229,160,0.06);border-radius:12px;margin-bottom:10px">
              <div style="font-size:0.85rem;color:var(--success);font-weight:600">âœ… Ya completaste este dÃ­a</div>
              <div style="font-size:0.78rem;color:var(--text-muted);margin-top:4px">Puedes repetirlo si lo deseas</div>
            </div>
            <button class="btn btn-secondary btn-full" onclick="iniciarSesion()">ğŸ” Repetir entrenamiento</button>`;
        }
        return `
          <button class="btn btn-primary btn-full" onclick="iniciarSesion()">âš¡ INICIAR ENTRENAMIENTO</button>
          <div style="font-size:0.78rem;color:var(--text-muted);text-align:center;margin-top:8px">Tap para empezar tu sesiÃ³n</div>`;
      })() : `
        <div style="text-align:center;padding:20px;color:var(--text-muted)">
          <div style="font-size:2rem;margin-bottom:8px">ğŸ˜´</div>
          <div>Este dÃ­a es descanso o no tiene ejercicios</div>
          <button class="btn btn-secondary btn-sm" style="margin-top:12px" onclick="avanzarDia()">Ir al siguiente dÃ­a â†’</button>
        </div>
      `}
    </div>

    ${ejsDia.length>0 ? `
    <div class="glass-card">
      <div class="card-title">ğŸ“‹ Ejercicios del dÃ­a</div>
      ${ejsDia.map((ej,i)=>{
        const ejInfo = state.ejercicios[ej.ejercicioId]||{};
        return `
          <div style="display:flex;align-items:center;gap:12px;padding:10px 0;border-bottom:1px solid rgba(255,255,255,0.05)">
            <div style="width:32px;height:32px;border-radius:50%;background:rgba(0,200,255,0.1);border:1px solid rgba(0,200,255,0.2);display:flex;align-items:center;justify-content:center;font-weight:700;font-size:0.85rem;color:var(--primary);flex-shrink:0">${i+1}</div>
            <div style="flex:1">
              <div style="font-weight:600;font-size:0.92rem">${ejInfo.nombre||'Ejercicio'}${ejInfo.biextremidad?'<span style="font-size:0.68rem;background:rgba(0,229,160,0.15);color:var(--success);border-radius:6px;padding:1px 6px;margin-left:6px">ğŸ¦¾ Biext</span>':''}</div>
              <div style="font-size:0.75rem;color:var(--text-muted)">${ej.series} series Â· ${ej.repsMin}-${ej.repsMax} reps Â· ${ej.peso}kg Â· ${currentUser.metodo} ${ej.rirRpe}${ej.metodo?` Â· <span style="color:#c084fc">âš¡ ${ej.metodo}</span>`:''}</div>
            </div>
          </div>`;
      }).join('')}
    </div>` : ''}
  `;
}

// Navigate to a specific day within current semana
window.irADia = async (dia) => {
  const { mesActual=1, semanaActual=1, diaActual=1 } = state.progreso||{};
  if(dia === diaActual) return;

  // Check if skipping over pending days with exercises
  const rutina = state.rutinaData;
  if(dia > diaActual) {
    const pendingInBetween = [];
    for(let d=diaActual; d<dia; d++) {
      const dd = rutina?.meses?.[mesActual]?.semanas?.[semanaActual]?.dias?.[d];
      const hasEj = Object.keys(dd?.ejercicios||{}).length > 0;
      const done = sesionCompletada(state.historial, mesActual, semanaActual, d);
      if(hasEj && !done) pendingInBetween.push(d);
    }
    if(pendingInBetween.length > 0) {
      const res = await Swal.fire({
        icon:'warning',
        title:'DÃ­as pendientes',
        html:`<div style="color:#e8f4ff">SaltarÃ¡s el DÃ­a ${pendingInBetween.join(', DÃ­a ')} que tiene${pendingInBetween.length>1?'n':''} ejercicios sin completar.<br><br>Â¿Deseas continuar igual?</div>`,
        showCancelButton:true, confirmButtonText:'SÃ­, saltar',
        cancelButtonText:'No, completar primero',
        confirmButtonColor:'#ff6b35', background:'rgba(10,20,40,0.95)', color:'#e8f4ff'
      });
      if(!res.isConfirmed) return;
    }
  }

  const newProgreso = { rutinaActiva:state.rutinaId, mesActual, semanaActual, diaActual:dia };
  state.progreso = newProgreso;
  await set(ref(db,`sesiones/${currentUser.id}/progreso`), newProgreso);
  renderTab('entrenar');
};

// Navigate to a specific semana (same mes)
window.irASemana = async (semana) => {
  const { mesActual=1, semanaActual=1, diaActual=1 } = state.progreso||{};
  if(semana === semanaActual) return;

  if(semana > semanaActual) {
    // Check for pending days in current semana
    const rutina = state.rutinaData;
    const pending = [];
    for(let d=diaActual; d<=5; d++) {
      const dd = rutina?.meses?.[mesActual]?.semanas?.[semanaActual]?.dias?.[d];
      const hasEj = Object.keys(dd?.ejercicios||{}).length > 0;
      const done = sesionCompletada(state.historial, mesActual, semanaActual, d);
      if(hasEj && !done) pending.push(`S${semanaActual}D${d}`);
    }
    if(pending.length > 0) {
      const res = await Swal.fire({
        icon:'warning', title:'DÃ­as pendientes en Semana ' + semanaActual,
        html:`<div style="color:#e8f4ff">Quedan dÃ­as con ejercicios sin completar: <strong>${pending.join(', ')}</strong><br><br>Â¿Avanzar a la Semana ${semana} de todas formas?</div>`,
        showCancelButton:true, confirmButtonText:'SÃ­, avanzar',
        cancelButtonText:'Completar primero',
        confirmButtonColor:'#ff6b35', background:'rgba(10,20,40,0.95)', color:'#e8f4ff'
      });
      if(!res.isConfirmed) return;
    }
  }

  const newProgreso = { rutinaActiva:state.rutinaId, mesActual, semanaActual:semana, diaActual:1 };
  state.progreso = newProgreso;
  await set(ref(db,`sesiones/${currentUser.id}/progreso`), newProgreso);
  renderTab('entrenar');
};

// Navigate directly to a pending day by absolute index
window.irADiaAbs = async (abs) => {
  const { mes, semana, dia } = absToMSD(abs);
  const newProgreso = { rutinaActiva:state.rutinaId, mesActual:mes, semanaActual:semana, diaActual:dia };
  state.progreso = newProgreso;
  await set(ref(db,`sesiones/${currentUser.id}/progreso`), newProgreso);
  renderTab('entrenar');
};

// Retroceder un dÃ­a
window.retrocederDia = async () => {
  const { mesActual=1, semanaActual=1, diaActual=1 } = state.progreso||{};
  const currentAbs = msdToAbs(mesActual, semanaActual, diaActual);
  if(currentAbs <= 0) return;
  const { mes, semana, dia } = absToMSD(currentAbs - 1);
  const newProgreso = { rutinaActiva:state.rutinaId, mesActual:mes, semanaActual:semana, diaActual:dia };
  state.progreso = newProgreso;
  await set(ref(db,`sesiones/${currentUser.id}/progreso`), newProgreso);
  renderTab('entrenar');
};

// ğŸ‹ï¸ Notifica a todos los admins del grupo que el usuario iniciÃ³/retomÃ³ entrenamiento.
async function notifyTrainingStart(mes, semana, dia, retomando) {
  try {
    const userSnap = await get(ref(db, `usuarios/${currentUser.id}`));
    const userData = userSnap.val() || {};
    const gid = userData.grupoId;
    if (!gid) return;
    const gSnap = await get(ref(db, `grupos/${gid}`));
    const g = gSnap.val() || {};
    const adminIds = [g.adminDueno, ...Object.keys(g.adminsInvitados || {})].filter(Boolean);
    if (!adminIds.length) return;
    const accion = retomando ? 'retomÃ³ el entrenamiento' : 'empezÃ³ a entrenar';
    const notif = {
      mensaje:  `${accion} â€” DÃ­a ${dia}, Semana ${semana}, Mes ${mes}`,
      deId:     currentUser.id,
      deNombre: `${currentUser.nombres} ${currentUser.apellidos || ''}`.trim(),
      avatar:   currentUser.avatar || '',
      tipo:     'training_start',
      leida:    false,
      creadaEn: Date.now()
    };
    await Promise.all(adminIds.map(aid => push(ref(db, `notificaciones/${aid}`), notif)));
  } catch(e) { console.warn('training notif failed', e); }
}

window.iniciarSesion = async () => {
  const { mesActual=1, semanaActual=1, diaActual=1 } = state.progreso||{};
  const diaData = state.rutinaData?.meses?.[mesActual]?.semanas?.[semanaActual]?.dias?.[diaActual];
  const ejsDia = Object.values(diaData?.ejercicios||{});
  if(ejsDia.length===0) return;

  // Refrescar historial
  const histSnap = await get(ref(db,`sesiones/${currentUser.id}/historial`));
  state.historial = histSnap.val()||{};

  // â”€â”€ Caso 1: Hay sesiÃ³n pendiente â†’ RETOMAR â”€â”€
  const pending = state._pendingSessionData;
  if(pending && pending.sesionActiva) {
    state.sesionActiva    = pending.sesionActiva;
    state.ejercicioActual = pending.ejercicioActual;
    state._pendingSeriesSnapshot = pending.currentSeriesSnapshot;
    state._pendingSessionData    = null;
    updateSessionDot(true);
    // Notificar que retomÃ³ (no bloquea el render)
    notifyTrainingStart(mesActual, semanaActual, diaActual, true);
    renderEjercicioActual();
    return;
  }

  // â”€â”€ Caso 2: SesiÃ³n nueva â”€â”€
  // Notificar ANTES del modal de fatiga para que llegue en el instante exacto
  await notifyTrainingStart(mesActual, semanaActual, diaActual, false);

  const nivel = await showFatigueModal('Â¿CÃ³mo llegaste a la sesiÃ³n de hoy?', 'pre');
  if(nivel===null) return;

  state.sesionActiva = {
    fechaInicio: Date.now(),
    mes: mesActual, semana: semanaActual, dia: diaActual,
    nivelCansancioInicio: nivel,
    ejerciciosCompletados: {}
  };
  state.ejercicioActual = 0;
  state.seriesData = {};
  state._pendingSeriesSnapshot = null;
  updateSessionDot(true);
  await savePendingSession();
  renderEjercicioActual();
};

// Descartar sesiÃ³n pendiente y empezar nueva
window.descartarSesionPendiente = async () => {
  const res = await Swal.fire({
    icon: 'warning',
    title: 'Â¿Descartar sesiÃ³n anterior?',
    text: 'Se perderÃ¡ el progreso no guardado de ese entrenamiento.',
    showCancelButton: true,
    confirmButtonText: 'SÃ­, empezar nueva',
    cancelButtonText: 'Cancelar',
    confirmButtonColor: '#ff6b35',
    background: 'rgba(10,20,40,0.98)',
    color: '#e8f4ff'
  });
  if(!res.isConfirmed) return;
  state._pendingSessionData = null;
  await clearPendingSession();
  updateSessionDot(false);
  renderTab('entrenar');
};

// Helper: find last recorded data for a given exercise from historial
function getUltimoRegistro(ejercicioId) {
  const historial = state.historial || {};
  let lastSesion = null;
  let lastFecha = 0;

  Object.values(historial).forEach(ses => {
    const sesDate = ses.fechaFin || ses.fechaInicio || ses.fecha || 0;
    if(sesDate > lastFecha) {
      const match = Object.values(ses.ejerciciosCompletados || {}).find(ec => ec.ejercicioId === ejercicioId);
      if(match && match.series && match.series.length > 0) {
        lastFecha = sesDate;
        lastSesion = { series: match.series, fecha: sesDate, mes: ses.mes, semana: ses.semana, dia: ses.dia };
      }
    }
  });
  return lastSesion;
}

function renderEjercicioActual() {
  const { mesActual=1, semanaActual=1, diaActual=1 } = state.progreso||{};
  const diaData = state.rutinaData?.meses?.[mesActual]?.semanas?.[semanaActual]?.dias?.[diaActual];
  const ejsDia = Object.values(diaData?.ejercicios||{});
  
  if(state.ejercicioActual >= ejsDia.length) {
    finalizarSesion();
    return;
  }

  const ejConfig = ejsDia[state.ejercicioActual];
  const ejInfo = state.ejercicios[ejConfig.ejercicioId]||{};
  const total = ejsDia.length;
  const current = state.ejercicioActual+1;
  const pct = Math.round(((current-1)/total)*100);

  // Last session data for this exercise
  const ultimoReg = getUltimoRegistro(ejConfig.ejercicioId);
  let ultimoBanner = '';
  if(ultimoReg) {
    const { series, fecha, mes, semana, dia } = ultimoReg;
    const esBiextUlt = series.some(s => s.rirRpeIzq != null);
    const fechaStr   = new Date(fecha).toLocaleDateString('es-CO', {day:'2-digit', month:'short'});
    const thSt = 'padding:4px 6px;font-size:0.68rem;color:rgba(167,139,250,0.6);font-weight:600;text-align:left;text-transform:uppercase;letter-spacing:0.5px;';
    const tdSt = 'padding:5px 6px;font-size:0.84rem;font-weight:700;color:#e8f4ff;';

    const thRpe = esBiextUlt
      ? `<th style="${thSt}color:#00e5a0">Izq reps</th><th style="${thSt}color:#ff6b35">Der reps</th><th style="${thSt}color:#00e5a0">Izq ${currentUser.metodo}</th><th style="${thSt}color:#ff6b35">Der ${currentUser.metodo}</th>`
      : `<th style="${thSt}color:#a78bfa">${currentUser.metodo}</th>`;

    const filas = series.map((s, i) => {
      const rpeCell = esBiextUlt
        ? `<td style="${tdSt}"><span style="color:#00e5a0">${s.repsIzq??s.reps??'â€”'}</span></td><td style="${tdSt}"><span style="color:#ff6b35">${s.repsDer??s.reps??'â€”'}</span></td><td style="${tdSt}"><span style="color:#00e5a0">${s.rirRpeIzq??'â€”'}</span></td><td style="${tdSt}"><span style="color:#ff6b35">${s.rirRpeDer??'â€”'}</span></td>`
        : `<td style="${tdSt};color:#a78bfa">${s.rirRpe??'â€”'}</td>`;
      return `
        <tr style="border-bottom:1px solid rgba(255,255,255,0.05)">
          <td style="${tdSt};color:#a78bfa;font-weight:700">${i+1}</td>
          ${esBiextUlt ? '' : `<td style="${tdSt}">${s.reps??'â€”'}</td>`}
          <td style="${tdSt}">${s.peso ? s.peso+' kg' : 'â€”'}</td>
          ${rpeCell}
          <td style="padding:5px 6px;font-size:0.72rem;font-style:italic;color:rgba(167,139,250,0.7)">${s.comentario ? 'ğŸ’¬ '+s.comentario : ''}</td>
        </tr>`;
    }).join('');

    ultimoBanner = `
      <div style="background:rgba(123,47,255,0.08);border:1px solid rgba(123,47,255,0.3);border-radius:14px;padding:12px 14px;margin-bottom:12px">
        <div style="font-size:0.68rem;color:#a78bfa;text-transform:uppercase;letter-spacing:1px;margin-bottom:10px;display:flex;align-items:center;gap:6px">
          <span>ğŸ“–</span> Ãšltima vez â€” M${mes}Â·S${semana}Â·D${dia} Â· ${fechaStr}
        </div>
        <div style="overflow-x:auto">
          <table style="width:100%;border-collapse:collapse;min-width:200px">
            <thead><tr style="border-bottom:1px solid rgba(123,47,255,0.3)">
              <th style="${thSt}">#</th>
              ${esBiextUlt ? '' : `<th style="${thSt}">Reps</th>`}
              <th style="${thSt}">Peso</th>
              ${thRpe}
              <th style="${thSt}">Nota</th>
            </tr></thead>
            <tbody>${filas}</tbody>
          </table>
        </div>
      </div>`;
  }

  // Detect if exercise belongs to Cardiovascular category â†’ always RPE
  const ejCategoriaNombre = (() => {
    const catId = ejInfo.categoria;
    if(!catId) return '';
    const cat = state.categorias[catId];
    return (cat?.nombre||cat?.name||'').toLowerCase();
  })();
  const esCardio = ejCategoriaNombre.includes('cardiovascular') || ejCategoriaNombre.includes('cardio');

  const metodoLabel = (currentUser.metodo === 'RPE' || esCardio) ? 'RPE (1-10)' : 'RIR (-1â†’6)';
  const metodoMin  = (currentUser.metodo === 'RPE' || esCardio) ? 1 : -1;
  const metodoMax  = (currentUser.metodo === 'RPE' || esCardio) ? 10 : 6;
  const esBiext    = ejInfo.biextremidad === true;

  // Helper: get per-serie value with fallback to global ejConfig
  const sc = ejConfig.seriesConfig; // may be undefined for legacy exercises
  const sv = (i, field, fallback) => (sc && sc[i] && sc[i][field] != null) ? sc[i][field] : (ejConfig[field] ?? fallback);

  const seriesRows = Array.from({length:ejConfig.series||3},(_,i)=>`
    <div class="serie-row">
      <div class="serie-header">
        <div class="serie-num">${i+1}</div>
        <div style="flex:1;font-size:0.8rem;color:var(--text-muted);font-weight:600">
          Serie ${i+1}
          ${sc?`<span style="font-size:0.7rem;color:rgba(0,229,160,0.6);margin-left:6px">â± ${sv(i,'descanso',90)}s descanso</span>`:''}
        </div>
        <button class="serie-done" id="done_${i}" onclick="toggleSerie(${i})">âœ“</button>
      </div>
      <div class="serie-inputs">
        ${esBiext ? `
        <div class="serie-field" style="grid-column:1/-1;display:grid;grid-template-columns:1fr 1fr;gap:6px;background:rgba(0,229,160,0.05);border-radius:10px;padding:6px;border:1px solid rgba(0,229,160,0.15)">
          <div style="grid-column:1/-1;font-size:0.68rem;color:#00e5a0;font-weight:700;text-transform:uppercase;letter-spacing:0.5px;padding-bottom:4px">ğŸ¦¾ Reps por lado</div>
          <div style="display:flex;flex-direction:column;gap:3px">
            <label style="font-size:0.65rem;color:#00e5a0">Izq reps</label>
            <input type="number" id="reps_izq_${i}" placeholder="${sv(i,'repsMin',0)}" min="0" value="${sv(i,'repsMin',0)}"
              style="background:rgba(0,229,160,0.08);border:1px solid rgba(0,229,160,0.3);border-radius:8px;padding:6px 8px;color:#e8f4ff;font-family:'Exo 2',sans-serif;font-size:0.88rem;width:100%;outline:none">
          </div>
          <div style="display:flex;flex-direction:column;gap:3px">
            <label style="font-size:0.65rem;color:#ff6b35">Der reps</label>
            <input type="number" id="reps_der_${i}" placeholder="${sv(i,'repsMin',0)}" min="0" value="${sv(i,'repsMin',0)}"
              style="background:rgba(255,107,53,0.08);border:1px solid rgba(255,107,53,0.3);border-radius:8px;padding:6px 8px;color:#e8f4ff;font-family:'Exo 2',sans-serif;font-size:0.88rem;width:100%;outline:none">
          </div>
        </div>
        <div class="serie-field" style="display:none"><input type="number" id="reps_${i}" value="${sv(i,'repsMin',0)}"></div>
        ` : `
        <div class="serie-field">
          <label>Reps</label>
          <input type="number" id="reps_${i}" placeholder="${sv(i,'repsMin',0)}-${sv(i,'repsMax',0)}" min="0" value="${sv(i,'repsMin',0)}">
        </div>
        `}
        <div class="serie-field">
          <label>Peso (kg)</label>
          <input type="number" id="peso_${i}" placeholder="${sv(i,'peso',0)}" min="0" step="0.5" value="${sv(i,'peso',0)}">
        </div>
        ${esBiext ? `
        <div class="serie-field">
          <label style="color:#00e5a0">ğŸ¦¾ Izq ${metodoLabel}</label>
          <input type="number" id="rpe_izq_${i}" placeholder="${sv(i,'rirRpe',0)}" min="${metodoMin}" max="${metodoMax}" value="${sv(i,'rirRpe',0)}"
            style="border-color:rgba(0,229,160,0.4);background:rgba(0,229,160,0.06)">
        </div>
        <div class="serie-field">
          <label style="color:#ff6b35">ğŸ¦¾ Der ${metodoLabel}</label>
          <input type="number" id="rpe_der_${i}" placeholder="${sv(i,'rirRpe',0)}" min="${metodoMin}" max="${metodoMax}" value="${sv(i,'rirRpe',0)}"
            style="border-color:rgba(255,107,53,0.4);background:rgba(255,107,53,0.06)">
        </div>
        ` : `
        <div class="serie-field">
          <label style="color:var(--primary)">${metodoLabel}</label>
          <input type="number" id="rpe_${i}" placeholder="${sv(i,'rirRpe',0)}" min="${metodoMin}" max="${metodoMax}" value="${sv(i,'rirRpe',0)}"
            style="border-color:rgba(0,200,255,0.3);background:rgba(0,200,255,0.06)">
        </div>
        `}
      </div>
      <input type="text" id="comentario_${i}" placeholder="ğŸ’¬ Comentario opcional (sensaciÃ³n, forma, ajuste...)"
        style="width:100%;background:rgba(255,255,255,0.04);border:1px solid rgba(255,255,255,0.08);border-radius:10px;padding:9px 12px;color:var(--text-muted);font-family:'Exo 2',sans-serif;font-size:0.82rem;outline:none;transition:all 0.2s ease"
        onfocus="this.style.borderColor='rgba(0,200,255,0.3)';this.style.color='var(--text)';this.style.background='rgba(0,200,255,0.04)'"
        onblur="this.style.borderColor='rgba(255,255,255,0.08)';this.style.color='var(--text-muted)';this.style.background='rgba(255,255,255,0.04)'">
    </div>
  `).join('');

  const p = document.getElementById('mainPage');
  p.innerHTML = `
    <div style="margin-bottom:12px">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <span style="font-size:0.8rem;color:var(--text-muted)">Ejercicio ${current} de ${total}</span>
        <span style="font-size:0.8rem;color:var(--primary);font-weight:600">${pct}% completado</span>
      </div>
      <div class="progress-bar"><div class="progress-fill" style="width:${pct}%"></div></div>
    </div>

    <div class="training-card">
      <div class="training-video" id="trainingVideoWrap">
        ${ejInfo.urlVideo?`<iframe id="trainingVideoIframe" src="${ejInfo.urlVideo}?autoplay=0&mute=0&controls=1" allowfullscreen allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"></iframe>}`:`<div class="no-video"><div style="font-size:3rem">ğŸ‹ï¸</div><div>Sin video disponible</div></div>`}
      </div>
      <div class="training-info">
        <div class="training-title">${ejInfo.nombre||'Ejercicio'}</div>
        <div class="training-meta">
          <span class="meta-pill">ğŸ“¦ ${ejConfig.series} series</span>
          <span class="meta-pill">ğŸ”¢ ${ejConfig.repsMin}-${ejConfig.repsMax} reps</span>
          <span class="meta-pill">âš–ï¸ ${ejConfig.peso}kg</span>
          <span class="meta-pill">${(currentUser.metodo === 'RPE' || esCardio) ? 'RPE' : currentUser.metodo} ${ejConfig.rirRpe}</span>
          <span class="meta-pill">â±ï¸ ${ejConfig.seriesConfig ? 'descanso por serie' : ejConfig.descanso+'s descanso'}</span>
          ${ejConfig.metodo?`<span class="meta-pill" style="background:rgba(123,47,255,0.15);border-color:rgba(123,47,255,0.35);color:#c084fc">âš¡ ${ejConfig.metodo}</span>`:''}
        </div>
        ${ejConfig.anotaciones?`<div style="background:rgba(255,210,0,0.08);border:1px solid rgba(255,210,0,0.15);border-radius:10px;padding:10px;font-size:0.82rem;color:#ffd60a;margin-bottom:14px">ğŸ“ ${ejConfig.anotaciones}</div>`:''}
        ${ejInfo.descripcion?`<div style="font-size:0.85rem;color:var(--text-muted);margin-bottom:16px">${ejInfo.descripcion}</div>`:''}
      </div>
    </div>

    ${ultimoBanner}
    <div class="glass-card">
      <div class="card-title">ğŸ“Š Registrar series</div>
      <div class="series-list">${seriesRows}</div>
      <button class="btn btn-success btn-full" onclick="completarEjercicio()">
        âœ… Completar ejercicio ${ejConfig.biextremidad?'(Cada lado)':''}
      </button>
      ${state.ejercicioActual>0?`<button class="btn btn-secondary btn-full" style="margin-top:8px" onclick="ejercicioAnterior()">â† Ejercicio anterior</button>`:''}
    </div>
  `;

  // Restaurar snapshot si viene de una sesiÃ³n pendiente recuperada
  const snap = state._pendingSeriesSnapshot;
  if(snap && Array.isArray(snap)) {
    snap.forEach((s, i) => {
      const repsEl = document.getElementById(`reps_${i}`);
      const pesoEl = document.getElementById(`peso_${i}`);
      const doneEl = document.getElementById(`done_${i}`);
      const comEl  = document.getElementById(`comentario_${i}`);
      if(repsEl && s.reps) repsEl.value = s.reps;
      if(pesoEl && s.peso) pesoEl.value = s.peso;
      if(comEl  && s.comentario) comEl.value = s.comentario;
      if(doneEl && s.completada) doneEl.classList.add('checked');
      if(esBiext) {
        const izqEl = document.getElementById(`rpe_izq_${i}`);
        const derEl = document.getElementById(`rpe_der_${i}`);
        if(izqEl && s.rirRpeIzq) izqEl.value = s.rirRpeIzq;
        if(derEl && s.rirRpeDer) derEl.value = s.rirRpeDer;
        const repsIzqEl = document.getElementById(`reps_izq_${i}`);
        const repsDerEl = document.getElementById(`reps_der_${i}`);
        if(repsIzqEl && s.repsIzq != null) repsIzqEl.value = s.repsIzq;
        if(repsDerEl && s.repsDer != null) repsDerEl.value = s.repsDer;
      } else {
        const rpeEl = document.getElementById(`rpe_${i}`);
        if(rpeEl && s.rirRpe != null) rpeEl.value = s.rirRpe;
      }
    });
    state._pendingSeriesSnapshot = null;
  }

  // Auto-save a Firebase en cada cambio de input
  document.querySelectorAll('.serie-field input, .serie-row input[type="text"]').forEach(input => {
    input.addEventListener('change', () => savePendingSession(), { passive: true });
  });
}

window.toggleSerie = (i) => {
  const btn = document.getElementById(`done_${i}`);
  const wasChecked = btn.classList.contains('checked');
  btn.classList.toggle('checked');
  const isNowChecked = !wasChecked;

  // 1. Haptic feedback (mobile) + desbloquear audio iOS sincrÃ³nicamente
  if(isNowChecked) {
    if(navigator.vibrate) navigator.vibrate(50);
    primeVoiceQueue(); // debe estar en el call-stack sÃ­ncrono del tap
  }

  // 2. Autosave micro-feedback + guardar en Firebase
  showAutosaveFeedback(btn);
  savePendingSession();

  // 3. Rest timer â€” only when marking as done
  if(isNowChecked) {
    const { mesActual=1, semanaActual=1, diaActual=1 } = state.progreso||{};
    const diaData = state.rutinaData?.meses?.[mesActual]?.semanas?.[semanaActual]?.dias?.[diaActual];
    const ejConfig = Object.values(diaData?.ejercicios||{})[state.ejercicioActual];
    const sc = ejConfig?.seriesConfig;
    const restSecs = (sc && sc[i] && sc[i].descanso != null) ? sc[i].descanso : (ejConfig?.descanso || 90);
    startRestTimer(restSecs);

    // 4. Session-in-progress indicator
    updateSessionDot(true);
  }
};

function showAutosaveFeedback(anchorEl) {
  const old = document.getElementById('autosaveBadge');
  if(old) old.remove();
  const badge = document.createElement('span');
  badge.id = 'autosaveBadge';
  badge.className = 'autosave-badge';
  badge.innerHTML = 'â˜ï¸ Guardado';
  badge.style.cssText = 'position:fixed;bottom:90px;left:50%;transform:translateX(-50%);z-index:700';
  document.body.appendChild(badge);
  setTimeout(() => badge.remove(), 1600);
}

function updateSessionDot(active) {
  const tab = document.getElementById('navTabEntrenar');
  if(tab) tab.classList.toggle('has-session', active);
}

// â”€â”€ REST TIMER (full overlay) â”€â”€
let _restTimerInterval = null;

// â”€â”€ AUDIO ENGINE â€” Web Audio API â”€â”€
// Lazy-init: el contexto se crea la primera vez que el usuario interactÃºa
let _audioCtx = null;

function getAudioCtx() {
  if(!_audioCtx) {
    try { _audioCtx = new (window.AudioContext || window.webkitAudioContext)(); } catch(e) {}
  }
  return _audioCtx;
}

// Sonido de tick sofisticado: oscilador sinusoidal + filtro paso-alto + envolvente suave
// freq    â†’ frecuencia base (Hz)
// gain    â†’ volumen pico (0-1)
// durationâ†’ duraciÃ³n total del sonido (segundos)
// attack  â†’ tiempo de subida (segundos)
// decay   â†’ tiempo de caÃ­da (segundos)
function playTick(freq = 880, gain = 0.18, duration = 0.08, attack = 0.004, decay = 0.06) {
  const ctx = getAudioCtx();
  if(!ctx) return;

  // Reanudar contexto si estaba suspendido (polÃ­tica autoplay)
  if(ctx.state === 'suspended') ctx.resume();

  const now = ctx.currentTime;

  // Oscilador principal â€” senoidal pura (suave, no agresiva)
  const osc = ctx.createOscillator();
  osc.type = 'sine';
  osc.frequency.setValueAtTime(freq, now);
  // Ligera caÃ­da de frecuencia para dar sensaciÃ³n de "golpe" suave
  osc.frequency.exponentialRampToValueAtTime(freq * 0.85, now + duration);

  // Oscilador de armÃ³nico â€” da cuerpo sin ser molesto
  const osc2 = ctx.createOscillator();
  osc2.type = 'sine';
  osc2.frequency.setValueAtTime(freq * 2, now);
  osc2.frequency.exponentialRampToValueAtTime(freq * 1.6, now + duration);

  // Ganancia del armÃ³nico (mÃ¡s suave que el principal)
  const gainArmonic = ctx.createGain();
  gainArmonic.gain.setValueAtTime(0, now);
  gainArmonic.gain.linearRampToValueAtTime(gain * 0.3, now + attack);
  gainArmonic.gain.exponentialRampToValueAtTime(0.0001, now + decay * 0.6);

  // Envolvente principal: attack suave â†’ decay exponencial
  const gainNode = ctx.createGain();
  gainNode.gain.setValueAtTime(0, now);
  gainNode.gain.linearRampToValueAtTime(gain, now + attack);
  gainNode.gain.exponentialRampToValueAtTime(0.0001, now + duration);

  // Filtro paso-alto para quitar baja frecuencia (evita "bum" molesto)
  const filter = ctx.createBiquadFilter();
  filter.type = 'highpass';
  filter.frequency.value = 200;
  filter.Q.value = 0.7;

  // Compresor suave para evitar clipping
  const compressor = ctx.createDynamicsCompressor();
  compressor.threshold.value = -18;
  compressor.knee.value = 6;
  compressor.ratio.value = 3;
  compressor.attack.value = 0.003;
  compressor.release.value = 0.08;

  // Conectar grafo de audio
  osc.connect(gainNode);
  osc2.connect(gainArmonic);
  gainNode.connect(filter);
  gainArmonic.connect(filter);
  filter.connect(compressor);
  compressor.connect(ctx.destination);

  osc.start(now);
  osc.stop(now + duration + 0.01);
  osc2.start(now);
  osc2.stop(now + duration + 0.01);
}

// Tick normal de descanso: tono suave y bajo (528 Hz â€” "healing frequency")
function playRestTick() {
  playTick(528, 0.14, 0.09, 0.005, 0.07);
}

// Tick de cuenta regresiva final (Ãºltimos 5s): tono mÃ¡s agudo y brillante
// idx 0=5s, 1=4s, 2=3s, 3=2s, 4=1s â†’ frecuencia y velocidad suben progresivamente
function playUrgentTick(idx) {
  // Escala: 880 â†’ 1047 â†’ 1175 â†’ 1319 â†’ 1480 Hz (notas A5â†’C6â†’D6â†’E6â†’F#6)
  const freqs = [880, 1047, 1175, 1319, 1480];
  const gains = [0.20, 0.22, 0.24, 0.26, 0.30];
  const freq = freqs[Math.min(idx, 4)];
  const gain = gains[Math.min(idx, 4)];
  playTick(freq, gain, 0.07, 0.003, 0.055);
}

// Fanfarria de finalizaciÃ³n: 3 notas ascendentes
function playFinishChime() {
  const ctx = getAudioCtx();
  if(!ctx) return;
  if(ctx.state === 'suspended') ctx.resume();
  // Notas: E5 â†’ G5 â†’ B5 (acorde mayor ascendente)
  const notes = [659, 784, 988];
  notes.forEach((freq, i) => {
    setTimeout(() => playTick(freq, 0.28, 0.22, 0.006, 0.18), i * 140);
  });
  // DespuÃ©s del chime, leer el mensaje de pantalla
  setTimeout(() => speakText('Â¡Sigamos!'), 500);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// VOZ â€” compatible Safari iOS + Android Chrome
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Safari iOS requiere que speechSynthesis.speak() se invoque
// dentro del call-stack SÃNCRONO de un gesto tÃ¡ctil.
// SoluciÃ³n: primeVoiceQueue() se llama desde toggleSerie()
// (el tap del usuario). Hace speak+pause+cancel en sync,
// "desbloqueando" el audio en iOS. Luego speakText() ya puede
// llamar speak() desde setTimeout sin restricciones.

let _bestVoice   = null;
let _voicesReady = false;
let _iosUnlocked = false;

const VOICE_TEXTS = [
  'Recupera la respiraci\u00f3n',
  'Descansa, lo mereces',
  'Casi listo',
  'Prep\u00e1rate',
  'Â¡Sigamos!',
];

function _stripEmoji(s) {
  return s.replace(/[\u{1F300}-\u{1FFFF}\u{2600}-\u{26FF}\u{2700}-\u{27BF}]/gu,'').trim();
}

function _pickVoice() {
  if(!window.speechSynthesis) return null;
  const voices = window.speechSynthesis.getVoices();
  const order = [
    v => v.name.includes('Google') && /es-(MX|CO|AR|CL|PE|VE|US)/i.test(v.lang),
    v => v.name.includes('Google') && /es/i.test(v.lang),
    v => /es-(MX|CO|AR|CL|PE|US)/i.test(v.lang) && v.localService,
    v => /es/i.test(v.lang) && v.localService,
    v => /es-(MX|CO|AR|CL|PE|US)/i.test(v.lang),
    v => /es/i.test(v.lang),
  ];
  for(const t of order){ const m=voices.find(t); if(m) return m; }
  return null;
}

function initVoices() {
  const load = () => {
    const v = window.speechSynthesis.getVoices();
    if(!v.length) return false;
    _bestVoice = _pickVoice();
    _voicesReady = true;
    return true;
  };
  if(!load()) window.speechSynthesis.onvoiceschanged = () => load();
}

function _makeUtter(text) {
  const clean = _stripEmoji(text);
  if(!clean) return null;
  const u = new SpeechSynthesisUtterance(clean);
  u.lang    = 'es-MX';
  u.rate    = 1.07;
  u.pitch   = 1.06;
  u.volume  = 1.0;
  const v   = _bestVoice || _pickVoice();
  if(v) u.voice = v;
  return u;
}

// Debe llamarse SINC\u00d3NICAMENTE desde el handler del tap del usuario.
// En iOS Safari hace speak+pause+cancel de una utterance dummy,
// lo que "desbloquea" el sistema de audio para llamadas futuras.
function primeVoiceQueue() {
  if(!window.speechSynthesis || _iosUnlocked) return;
  const u = _makeUtter('ok');
  if(!u) return;
  window.speechSynthesis.cancel();
  window.speechSynthesis.speak(u);
  window.speechSynthesis.pause();
  window.speechSynthesis.cancel();
  _iosUnlocked = true;
}

function speakText(rawText, delayMs = 0) {
  if(!window.speechSynthesis) return;
  const clean = _stripEmoji(rawText);
  if(!clean) return;
  const fire = () => {
    window.speechSynthesis.cancel();
    setTimeout(() => {
      const u = _makeUtter(clean);
      if(u) window.speechSynthesis.speak(u);
    }, 55);
  };
  if(delayMs > 0) setTimeout(fire, delayMs);
  else fire();
}

if(window.speechSynthesis) initVoices();

function startRestTimer(totalSecs) {
  if(_restTimerInterval) { clearInterval(_restTimerInterval); _restTimerInterval = null; }
  const existing = document.getElementById('restTimerToast');
  if(existing) existing.remove();
  const existingOvl = document.getElementById('restTimerOverlay');
  if(existingOvl) existingOvl.remove();

  let remaining = totalSecs;
  // r=95, circumference
  const R = 95;
  const C = 2 * Math.PI * R;

  // Color states: normal â†’ warm â†’ urgent â†’ done
  const getColors = (rem, tot) => {
    const pct = rem / tot;
    if(pct > 0.5)  return { color:'#00c8ff', glow:'rgba(0,200,255,0.55)' };
    if(pct > 0.25) return { color:'#ffd60a', glow:'rgba(255,214,10,0.55)' };
    return               { color:'#ff4d6d', glow:'rgba(255,77,109,0.6)' };
  };

  const getMsg = (rem, tot) => {
    const pct = rem / tot;
    if(pct > 0.75) return 'Recupera la respiraciÃ³n ğŸ’¨';
    if(pct > 0.45) return 'Descansa, lo mereces ğŸ§˜';
    if(pct > 0.15) return 'Casi listo... ğŸ’ª';
    if(rem > 0)    return 'Â¡PrepÃ¡rate! ğŸ”¥';
    return 'Â¡A por la siguiente serie! ğŸš€';
  };

  const { color, glow } = getColors(remaining, totalSecs);
  const offset = C * (1 - remaining / totalSecs);

  const ovl = document.createElement('div');
  ovl.id = 'restTimerOverlay';
  ovl.innerHTML = `
    <div class="rt-label">Tiempo de descanso</div>
    <div class="rt-series-badge">âœ… Serie completada</div>

    <div class="rt-ring-wrap" id="rtRingWrap">
      <svg width="220" height="220" viewBox="0 0 220 220">
        <circle class="rt-ring-bg"    cx="110" cy="110" r="${R}"/>
        <circle class="rt-ring-track" cx="110" cy="110" r="${R}"/>
        <circle class="rt-ring-inner" id="rtRingInner" cx="110" cy="110" r="${R-18}"
          stroke-dasharray="${2*Math.PI*(R-18)}" stroke-dashoffset="${2*Math.PI*(R-18)*(1-remaining/totalSecs)}"/>
        <circle class="rt-ring-fill"  id="rtRingFill"  cx="110" cy="110" r="${R}"
          stroke-dasharray="${C}" stroke-dashoffset="${offset}"/>
      </svg>
      <div class="rt-number">
        <span class="rt-count" id="rtCount">${remaining}</span>
        <span class="rt-secs-label">segundos</span>
      </div>
    </div>

    <div class="rt-msg" id="rtMsg">${getMsg(remaining, totalSecs)}</div>

    <div class="rt-progress-bar">
      <div class="rt-progress-fill" id="rtProgressFill" style="width:${(remaining/totalSecs)*100}%"></div>
    </div>

    <button class="rt-skip" onclick="skipRestTimer()">Saltar descanso</button>
  `;

  // Apply initial color via CSS variables
  ovl.style.setProperty('--rt-color', color);
  ovl.style.setProperty('--rt-glow',  glow);
  document.body.appendChild(ovl);

  _restTimerInterval = setInterval(() => {
    remaining--;

    // â”€â”€ Audio tick â”€â”€
    if(remaining > 0) {
      if(remaining <= 5) {
        playUrgentTick(5 - remaining);
      } else {
        playRestTick();
      }
    } else {
      playFinishChime();
    }

    // â”€â”€ Voz: hablar cuando el mensaje de pantalla cambia, 350ms despuÃ©s del tick â”€â”€
    if(remaining > 0) {
      const prevMsg = getMsg(remaining + 1, totalSecs);
      const currMsg = getMsg(remaining, totalSecs);
      if(currMsg !== prevMsg) {
        speakText(currMsg, 350);
      }
    }

    const countEl     = document.getElementById('rtCount');
    const ringFill    = document.getElementById('rtRingFill');
    const ringInner   = document.getElementById('rtRingInner');
    const msgEl       = document.getElementById('rtMsg');
    const progressEl  = document.getElementById('rtProgressFill');
    const ringWrap    = document.getElementById('rtRingWrap');
    const overlay     = document.getElementById('restTimerOverlay');

    if(!countEl || !overlay) { clearInterval(_restTimerInterval); return; }

    // Update number with pop animation
    countEl.textContent = remaining > 0 ? remaining : 'âœ“';
    countEl.style.animation = 'none';
    void countEl.offsetWidth; // reflow
    countEl.style.animation = 'rtCountPop 0.25s cubic-bezier(0.34,1.56,0.64,1)';

    // Update ring
    const newOffset = C * (1 - remaining / totalSecs);
    if(ringFill) ringFill.style.strokeDashoffset = newOffset;
    if(ringInner) ringInner.style.strokeDashoffset = 2*Math.PI*(R-18) * (1 - remaining/totalSecs);

    // Update progress bar
    if(progressEl) progressEl.style.width = `${Math.max(0, (remaining/totalSecs)*100)}%`;

    // Update message
    if(msgEl) msgEl.textContent = getMsg(remaining, totalSecs);

    // Update colors based on urgency
    const { color: c, glow: g } = getColors(remaining, totalSecs);
    overlay.style.setProperty('--rt-color', c);
    overlay.style.setProperty('--rt-glow',  g);

    // Urgent pulse when <= 10s
    if(ringWrap) ringWrap.classList.toggle('rt-urgent', remaining <= 10 && remaining > 0);

    if(remaining <= 0) {
      clearInterval(_restTimerInterval);
      _restTimerInterval = null;
      if(navigator.vibrate) navigator.vibrate([100, 50, 150]);

      overlay.classList.add('rt-done');
      overlay.style.setProperty('--rt-color', '#00e5a0');
      overlay.style.setProperty('--rt-glow',  'rgba(0,229,160,0.6)');
      if(ringWrap) ringWrap.classList.remove('rt-urgent');
      if(progressEl) progressEl.style.width = '0%';

      setTimeout(() => {
        const o = document.getElementById('restTimerOverlay');
        if(o) {
          o.classList.add('rt-exit');
          setTimeout(() => o.remove(), 320);
        }
      }, 1200);
    }
  }, 1000);
}

window.skipRestTimer = () => {
  if(_restTimerInterval) { clearInterval(_restTimerInterval); _restTimerInterval = null; }
  const o = document.getElementById('restTimerOverlay');
  if(o) { o.classList.add('rt-exit'); setTimeout(() => o.remove(), 300); }
};

// â”€â”€ LANDSCAPE VIDEO FULLSCREEN â”€â”€
window.toggleVideoFullscreen = () => {
  const iframe = document.getElementById('trainingVideoIframe');
  if(!iframe) return;
  if(iframe.requestFullscreen) iframe.requestFullscreen();
  else if(iframe.webkitRequestFullscreen) iframe.webkitRequestFullscreen();
  else if(iframe.mozRequestFullScreen) iframe.mozRequestFullScreen();
};

// Auto-expand on landscape
if(window.screen?.orientation) {
  screen.orientation.addEventListener('change', () => {
    const isLandscape = screen.orientation.type.includes('landscape');
    const iframe = document.getElementById('trainingVideoIframe');
    if(isLandscape && iframe) {
      if(iframe.requestFullscreen) iframe.requestFullscreen().catch(()=>{});
    }
  });
}

window.completarEjercicio = async () => {
  // Clear any running rest timer when moving to next exercise
  if(_restTimerInterval) { clearInterval(_restTimerInterval); _restTimerInterval = null; }
  const existing = document.getElementById('restTimerToast');
  if(existing) existing.remove();
  const existingOvl = document.getElementById('restTimerOverlay');
  if(existingOvl) existingOvl.remove();
  const { mesActual=1, semanaActual=1, diaActual=1 } = state.progreso||{};
  const diaData = state.rutinaData?.meses?.[mesActual]?.semanas?.[semanaActual]?.dias?.[diaActual];
  const ejConfig = Object.values(diaData?.ejercicios||{})[state.ejercicioActual];

  // Guard: if ejConfig lost reference (e.g. after resume), re-render and abort
  if(!ejConfig) {
    console.warn('completarEjercicio: ejConfig not found, re-rendering');
    renderEjercicioActual();
    return;
  }

  const n = ejConfig?.series||3;

  // Collect series data â€” RPE/RIR already filled per serie in the table
  const ejInfo2 = state.ejercicios[ejConfig.ejercicioId]||{};
  const esBiext2 = ejInfo2.biextremidad === true;
  const series = Array.from({length:n},(_,i)=>{
    const base = {
      reps: +document.getElementById(`reps_${i}`)?.value||0,
      peso: +document.getElementById(`peso_${i}`)?.value||0,
      completada: document.getElementById(`done_${i}`)?.classList.contains('checked'),
      comentario: document.getElementById(`comentario_${i}`)?.value?.trim()||''
    };
    if(esBiext2) {
      base.rirRpeIzq = +document.getElementById(`rpe_izq_${i}`)?.value||0;
      base.rirRpeDer = +document.getElementById(`rpe_der_${i}`)?.value||0;
      base.rirRpe = Math.round(((base.rirRpeIzq||0)+(base.rirRpeDer||0))/2);
      // Reps por lado
      const repsIzqVal = +document.getElementById(`reps_izq_${i}`)?.value;
      const repsDerVal = +document.getElementById(`reps_der_${i}`)?.value;
      if(!isNaN(repsIzqVal)) base.repsIzq = repsIzqVal;
      if(!isNaN(repsDerVal)) base.repsDer = repsDerVal;
      // reps general = promedio de ambos lados
      if(base.repsIzq != null && base.repsDer != null) {
        base.reps = Math.round((base.repsIzq + base.repsDer) / 2);
      } else {
        base.reps = base.repsIzq ?? base.repsDer ?? 0;
      }
    } else {
      base.rirRpe = +document.getElementById(`rpe_${i}`)?.value||0;
    }
    return base;
  });

  // Validate at least one serie completed
  const alguenCompleta = series.some(s=>s.completada);
  if(!alguenCompleta) {
    const res = await Swal.fire({
      icon:'warning', title:'Â¿Sin series completadas?',
      text:'No marcaste ninguna serie como hecha. Â¿Continuar igual?',
      showCancelButton:true, confirmButtonText:'SÃ­, continuar', cancelButtonText:'Volver',
      background:'rgba(10,20,40,0.95)', color:'#e8f4ff', confirmButtonColor:'#00c8ff'
    });
    if(!res.isConfirmed) return;
  }

  // Guard: ensure sesionActiva and ejerciciosCompletados are defined (bug fix for resumed sessions)
  if(!state.sesionActiva) {
    console.error('completarEjercicio: sesionActiva is undefined');
    return;
  }
  if(!state.sesionActiva.ejerciciosCompletados) {
    state.sesionActiva.ejerciciosCompletados = {};
  }
  state.sesionActiva.ejerciciosCompletados[state.ejercicioActual] = {
    ejercicioId: ejConfig.ejercicioId,
    series: series
  };

  state.ejercicioActual++;
  // Guardar progreso en Firebase tras completar cada ejercicio
  savePendingSession();
  renderEjercicioActual();
};

window.ejercicioAnterior = () => {
  state.ejercicioActual = Math.max(0, state.ejercicioActual-1);
  renderEjercicioActual();
};

async function finalizarSesion() {
  // Clear rest timer if running
  if(_restTimerInterval) { clearInterval(_restTimerInterval); _restTimerInterval = null; }
  const restToast = document.getElementById('restTimerToast');
  if(restToast) restToast.remove();
  const restOvl = document.getElementById('restTimerOverlay');
  if(restOvl) restOvl.remove();
  updateSessionDot(false);
  // Limpiar sesiÃ³n pendiente de Firebase â€” ya se va a guardar como sesiÃ³n completada
  await clearPendingSession();
  // Post-session fatigue
  const cansancio = await showFatigueModal('Â¿QuÃ© tan cansado quedaste?', 'post');
  if(cansancio===null) return;

  state.sesionActiva.nivelCansancioFin = cansancio;
  state.sesionActiva.fechaFin = Date.now();

  // Save session
  const sesId = `ses_${Date.now()}`;
  await set(ref(db,`sesiones/${currentUser.id}/historial/${sesId}`), state.sesionActiva);
  // Actualizar en memoria para que el calendario se vea al instante sin cachÃ© de Firebase
  if(!state.historial) state.historial = {};
  state.historial[sesId] = { ...state.sesionActiva };

  // Advance progress
  const { mesActual=1, semanaActual=1, diaActual=1 } = state.progreso||{};
  let newMes = mesActual, newSem = semanaActual, newDia = diaActual+1;
  const semanaTerminada = diaActual === 5; // last day of week
  const mesTerminado    = diaActual === 5 && semanaActual === 4; // last day of last week

  if(newDia>5) { newDia=1; newSem++; }
  if(newSem>4) { newSem=1; newMes++; }

  const maxMes = Math.max(...Object.keys(state.rutinaData?.meses||{1:{}}).map(Number));
  if(newMes>maxMes) { newMes=maxMes; newSem=4; newDia=5; }

  const newProgreso = { rutinaActiva:state.rutinaId, mesActual:newMes, semanaActual:newSem, diaActual:newDia };
  await set(ref(db,`sesiones/${currentUser.id}/progreso`), newProgreso);
  state.progreso = newProgreso;

  await Swal.fire({
    icon:'success',
    title:'ğŸ‰ Â¡SesiÃ³n completada!',
    html:`<div style="color:#e8f4ff">
      <div style="font-size:2rem;margin:10px 0">ğŸ’ª</div>
      <div>Siguiente: Mes ${newMes} Â· Sem ${newSem} Â· DÃ­a ${newDia}</div>
    </div>`,
    background:'rgba(8,16,36,0.98)', confirmButtonColor:'#00c8ff',
    confirmButtonText:'Continuar', timer:2000, showConfirmButton:true
  });

  // Check if monthly review is needed first (takes priority)
  if(mesTerminado) {
    const revSnap = await get(ref(db,`revisiones_mes/${currentUser.id}/m${mesActual}`));
    if(!revSnap.exists()) {
      await showRevisionMes(mesActual);
      switchTab('progreso'); return;
    }
  }
  // Check if weekly review is needed
  if(semanaTerminada) {
    const revSnap = await get(ref(db,`revisiones_semana/${currentUser.id}/m${mesActual}s${semanaActual}`));
    if(!revSnap.exists()) {
      await showRevisionSemana(mesActual, semanaActual);
      switchTab('progreso'); return;
    }
  }

  switchTab('progreso');
}

// ============================================================
// REVISION SEMANAL
// ============================================================
async function showRevisionSemana(mes, semana) {
  return new Promise(resolve => {
    const overlay = document.createElement('div');
    overlay.className = 'overlay-backdrop';
    overlay.style.alignItems = 'flex-start';
    overlay.style.paddingTop = '0';
    overlay.innerHTML = `
      <div class="overlay-sheet" style="border-radius:28px 28px 0 0;max-height:95vh;overflow-y:auto">
        <div class="sheet-handle"></div>
        <div style="text-align:center;margin-bottom:20px">
          <div style="font-size:2rem;margin-bottom:6px">ğŸ“‹</div>
          <div style="font-size:1.1rem;font-weight:800">RevisiÃ³n Semanal</div>
          <div style="font-size:0.82rem;color:var(--text-muted)">Mes ${mes} Â· Semana ${semana} â€” TÃ³mate un momento para reflexionar</div>
        </div>

        <!-- DOMS escala -->
        <div class="rev-block">
          <div class="rev-q">ğŸ’¢ Nivel de DOMS (dolor muscular) durante la semana</div>
          <div style="font-size:0.75rem;color:var(--text-muted);margin-bottom:10px">1 = sin dolor Â· 10 = dolor muy intenso</div>
          <div class="mini-scale" id="domsScale">
            ${Array.from({length:10},(_,i)=>`<div class="mini-dot" data-field="doms" data-val="${i+1}" onclick="selectRevVal('doms',${i+1})">${i+1}</div>`).join('')}
          </div>
          <div id="domsLabel" style="font-size:0.8rem;color:var(--text-muted);margin-top:6px;text-align:center">Selecciona</div>
        </div>

        <!-- MÃºsculo con mÃ¡s DOMS -->
        <div class="rev-block">
          <div class="rev-q">ğŸ‹ï¸ Â¿QuÃ© mÃºsculo sintiÃ³ mÃ¡s DOMS? (>6)</div>
          <input class="glass-input" id="revMuscDoms" placeholder="Ej: Pecho, CuÃ¡driceps...">
        </div>

        <!-- Ãnimo -->
        <div class="rev-block">
          <div class="rev-q">ğŸ˜Š Estado de Ã¡nimo general de la semana</div>
          <div style="font-size:0.75rem;color:var(--text-muted);margin-bottom:10px">1 = muy bajo Â· 5 = excelente</div>
          <div class="mini-scale" id="animoScale" style="display:grid;grid-template-columns:repeat(5,1fr);gap:6px">
            ${[{v:1,e:'ğŸ˜',l:'Muy bajo'},{v:2,e:'ğŸ˜”',l:'Bajo'},{v:3,e:'ğŸ˜',l:'Regular'},{v:4,e:'ğŸ™‚',l:'Bueno'},{v:5,e:'ğŸ˜„',l:'Excelente'}]
              .map(o=>`<div class="mini-dot" data-field="animo" data-val="${o.v}" onclick="selectRevVal('animo',${o.v})" style="aspect-ratio:auto;padding:8px 4px;flex-direction:column;gap:3px;min-width:0;width:100%;text-align:center">
                <span style="font-size:1.3rem">${o.e}</span><span style="font-size:0.62rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${o.l}</span>
              </div>`).join('')}
          </div>
        </div>

        <!-- Calidad de sueÃ±o -->
        <div class="rev-block">
          <div class="rev-q">ğŸ˜´ Calidad de sueÃ±o esta semana</div>
          <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:8px;margin-top:8px">
            ${['Excelente','Buena','Regular','Mala'].map(s=>`
              <button class="option-btn" data-field="sueno" data-val="${s}" onclick="selectRevOpt('sueno','${s}',this)">${s}</button>
            `).join('')}
          </div>
        </div>

        <!-- Dolor articular -->
        <div class="rev-block">
          <div class="rev-q">ğŸ¦´ Â¿Presentaste dolor articular o muscular con algÃºn ejercicio?</div>
          <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:8px;margin-top:8px;margin-bottom:10px">
            <button class="option-btn" data-field="dolor" data-val="No" onclick="selectRevOpt('dolor','No',this);document.getElementById('dolorDetail').style.display='none'">No</button>
            <button class="option-btn" data-field="dolor" data-val="Si" onclick="selectRevOpt('dolor','Si',this);document.getElementById('dolorDetail').style.display='block'">SÃ­</button>
          </div>
          <div id="dolorDetail" style="display:none">
            <input class="glass-input" id="revDolorEj" placeholder="Â¿CuÃ¡l ejercicio? Â¿En quÃ© zona?">
          </div>
        </div>

        <button class="btn btn-primary btn-full" style="margin-top:8px" onclick="guardarRevSemana(${mes},${semana})">
          âœ… Guardar revisiÃ³n semanal
        </button>
      </div>
    `;
    window._revSemanaResolve = resolve;
    document.body.appendChild(overlay);
    window._revSemanaOverlay = overlay;
  });
}

window.selectRevVal = (field, val) => {
  document.querySelectorAll(`[data-field="${field}"]`).forEach(d => {
    const active = +d.dataset.val === val;
    d.style.background = active ? 'var(--primary)' : 'rgba(255,255,255,0.05)';
    d.style.color = active ? '#000' : 'var(--text)';
    d.style.fontWeight = active ? '800' : '400';
    d.style.border = active ? '2px solid var(--primary)' : '1px solid rgba(255,255,255,0.1)';
    d.style.transform = active ? 'scale(1.08)' : 'scale(1)';
  });
  const lbl = document.getElementById(`${field}Label`);
  if(lbl) lbl.textContent = val + '/10';
  window[`_rev_${field}`] = val;
};

window.selectRevOpt = (field, val, el) => {
  el.closest('.rev-block').querySelectorAll('.option-btn').forEach(b => b.classList.remove('selected'));
  el.classList.add('selected');
  window[`_rev_${field}`] = val;
};

window.guardarRevSemana = async (mes, semana) => {
  const doms  = window._rev_doms;
  const animo = window._rev_animo;
  const sueno = window._rev_sueno;
  const dolor = window._rev_dolor;
  if(!doms || !animo || !sueno || !dolor) {
    return Swal.fire({icon:'warning',title:'Completa todos los campos',background:'rgba(10,20,40,0.95)',color:'#e8f4ff',confirmButtonColor:'#00c8ff'});
  }
  const data = {
    mes, semana,
    doms,
    musculoDoms: document.getElementById('revMuscDoms')?.value||'',
    animo,
    sueno,
    dolor,
    dolorDetalle: dolor==='Si' ? (document.getElementById('revDolorEj')?.value||'') : '',
    fecha: Date.now()
  };
  await set(ref(db,`revisiones_semana/${currentUser.id}/m${mes}s${semana}`), data);
  if(window._revSemanaOverlay) document.body.removeChild(window._revSemanaOverlay);
  // reset temp vars
  ['doms','animo','sueno','dolor'].forEach(k => delete window[`_rev_${k}`]);
  Swal.fire({icon:'success',title:'âœ… RevisiÃ³n guardada',timer:1500,showConfirmButton:false,background:'rgba(10,20,40,0.95)',color:'#e8f4ff'});
  if(window._revSemanaResolve) window._revSemanaResolve();
};

// ============================================================
// REVISION MENSUAL
// ============================================================
async function showRevisionMes(mes) {
  return new Promise(resolve => {
    const overlay = document.createElement('div');
    overlay.className = 'overlay-backdrop';
    overlay.style.alignItems = 'flex-start';
    overlay.style.paddingTop = '0';
    overlay.innerHTML = `
      <div class="overlay-sheet" style="border-radius:28px 28px 0 0;max-height:95vh;overflow-y:auto">
        <div class="sheet-handle"></div>
        <div style="text-align:center;margin-bottom:20px">
          <div style="font-size:2rem;margin-bottom:6px">ğŸ†</div>
          <div style="font-size:1.1rem;font-weight:800">RevisiÃ³n Mensual â€” Mes ${mes}</div>
          <div style="font-size:0.82rem;color:var(--text-muted)">Â¡Terminaste un mes! CuÃ©ntanos cÃ³mo te fue</div>
        </div>

        <div class="rev-block">
          <div class="rev-q">ğŸ“ˆ Â¿Sientes que mejoras en los entrenamientos?</div>
          <div style="font-size:0.75rem;color:var(--text-muted);margin-bottom:8px">Considera: ${currentUser.metodo}, kg, reps, recuperaciÃ³n...</div>
          <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:8px">
            ${['SÃ­, claramente','Un poco','Regular','No lo siento'].map(s=>`
              <button class="option-btn" data-field="mejora" onclick="selectRevOpt('mejora','${s}',this)">${s}</button>
            `).join('')}
          </div>
        </div>

        <div class="rev-block">
          <div class="rev-q">ğŸ¯ Â¿AlgÃºn ejercicio donde sientas que no progresas?</div>
          <input class="glass-input" id="revNoProgresa" placeholder="Ej: Sentadilla, Press banca... o 'Ninguno'">
        </div>

        <div class="rev-block">
          <div class="rev-q">ğŸ“… De todos tus dÃ­as de entrenamiento, Â¿cuÃ¡l te sientes con menos energÃ­a o mayor fatiga?</div>
          <div style="display:grid;grid-template-columns:repeat(5,1fr);gap:6px;margin-top:8px">
            ${[1,2,3,4,5].map(d=>`
              <button class="option-btn" data-field="diaMasFatiga" onclick="selectRevOpt('diaMasFatiga','DÃ­a ${d}',this)" style="padding:10px 4px">DÃ­a ${d}</button>
            `).join('')}
          </div>
        </div>

        <div class="rev-block">
          <div class="rev-q">â“ Â¿Por quÃ© motivo te sientes asÃ­ ese dÃ­a?</div>
          <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:8px;margin-top:8px;margin-bottom:10px">
            ${['EstrÃ©s laboral','Carga acadÃ©mica','Duermes menos','No me gusta esa sesiÃ³n','NutriciÃ³n','Otro'].map(s=>`
              <button class="option-btn" data-field="motivoFatiga" onclick="selectRevOpt('motivoFatiga','${s}',this)">${s}</button>
            `).join('')}
          </div>
          <input class="glass-input" id="revMotivoDetalle" placeholder="Detalles adicionales (opcional)">
        </div>

        <div class="rev-block">
          <div class="rev-q">ğŸ”„ Â¿AlgÃºn ejercicio que quieras cambiar, quitar o agregar?</div>
          <textarea class="glass-input" id="revCambioEj" rows="2" placeholder="Ej: Quitar curl de martillo, agregar face pull para hombro posterior..."></textarea>
        </div>

        <div class="rev-block">
          <div class="rev-q">ğŸ›Œ Â¿Sientes que necesitas un dÃ­a mÃ¡s de descanso?</div>
          <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:8px;margin-top:8px">
            <button class="option-btn" data-field="masDescanso" onclick="selectRevOpt('masDescanso','No',this)">No, estoy bien</button>
            <button class="option-btn" data-field="masDescanso" onclick="selectRevOpt('masDescanso','Si',this)">SÃ­, lo necesito</button>
          </div>
        </div>

        <button class="btn btn-primary btn-full" style="margin-top:8px" onclick="guardarRevMes(${mes})">
          ğŸ† Guardar revisiÃ³n mensual
        </button>
      </div>
    `;
    window._revMesResolve = resolve;
    document.body.appendChild(overlay);
    window._revMesOverlay = overlay;
  });
}

window.guardarRevMes = async (mes) => {
  const mejora      = window._rev_mejora;
  const diaMasFatiga = window._rev_diaMasFatiga;
  const motivoFatiga = window._rev_motivoFatiga;
  const masDescanso  = window._rev_masDescanso;
  if(!mejora || !diaMasFatiga || !motivoFatiga || !masDescanso) {
    return Swal.fire({icon:'warning',title:'Completa todos los campos',background:'rgba(10,20,40,0.95)',color:'#e8f4ff',confirmButtonColor:'#00c8ff'});
  }
  const data = {
    mes,
    mejora,
    noProgresa:    document.getElementById('revNoProgresa')?.value||'',
    diaMasFatiga,
    motivoFatiga,
    motivoDetalle: document.getElementById('revMotivoDetalle')?.value||'',
    cambioEjercicios: document.getElementById('revCambioEj')?.value||'',
    masDescanso,
    fecha: Date.now()
  };
  await set(ref(db,`revisiones_mes/${currentUser.id}/m${mes}`), data);
  if(window._revMesOverlay) document.body.removeChild(window._revMesOverlay);
  ['mejora','diaMasFatiga','motivoFatiga','masDescanso'].forEach(k => delete window[`_rev_${k}`]);
  Swal.fire({icon:'success',title:'ğŸ† Â¡RevisiÃ³n mensual guardada!',timer:2000,showConfirmButton:false,background:'rgba(10,20,40,0.95)',color:'#e8f4ff'});
  if(window._revMesResolve) window._revMesResolve();
};

// ============ EFFORT MODAL ============
async function showEffortModal() {
  return new Promise(resolve => {
    const isRPE = currentUser.metodo === 'RPE';
    
    let options;
    if(isRPE) {
      options = [
        {v:1,e:'ğŸ˜´',l:'1 - Muy fÃ¡cil'},{v:2,e:'ğŸ˜Š',l:'2 - FÃ¡cil'},
        {v:3,e:'ğŸ™‚',l:'3 - Moderado'},{v:4,e:'ğŸ˜',l:'4 - Algo difÃ­cil'},
        {v:5,e:'ğŸ˜¤',l:'5 - DifÃ­cil'},{v:6,e:'ğŸ˜°',l:'6 - Muy difÃ­cil'},
        {v:7,e:'ğŸ˜“',l:'7 - Muy duro'},{v:8,e:'ğŸ¥µ',l:'8 - Extremo'},
        {v:9,e:'ğŸ˜µ',l:'9 - Casi mÃ¡ximo'},{v:10,e:'ğŸ’€',l:'10 - MÃ¡ximo'}
      ];
    } else {
      options = [
        {v:-1,e:'ğŸ’€',l:'Fallo muscular'},{v:0,e:'ğŸ˜µ',l:'0 - Max esfuerzo'},
        {v:1,e:'ğŸ¥µ',l:'1 - Pude +1 rep'},{v:2,e:'ğŸ˜°',l:'2 - Pude +2 reps'},
        {v:3,e:'ğŸ˜“',l:'3 - Pude +3 reps'},{v:4,e:'ğŸ˜¤',l:'4 - Pude +4 reps'},
        {v:5,e:'ğŸ˜',l:'5 - Medio fÃ¡cil'},{v:6,e:'ğŸ™‚',l:'+6 - FÃ¡cil'}
      ];
    }
    
    let selected = null;
    const overlay = document.createElement('div');
    overlay.className = 'overlay-backdrop';
    overlay.innerHTML = `
      <div class="overlay-sheet">
        <div class="sheet-handle"></div>
        <div style="font-weight:700;font-size:1.1rem;margin-bottom:4px;text-align:center">Â¿CÃ³mo fue el esfuerzo?</div>
        <div style="font-size:0.82rem;color:var(--text-muted);text-align:center;margin-bottom:20px">Escala ${isRPE?'RPE (PercepciÃ³n del esfuerzo)':'RIR (Repeticiones en reserva)'}</div>
        <div class="effort-scale" id="effortGrid" style="grid-template-columns:repeat(${isRPE?5:4},1fr)">
          ${options.map(o=>`
            <div class="effort-option" data-val="${o.v}" onclick="selectEffort(${o.v})">
              <span class="effort-emoji">${o.e}</span>
              <span class="effort-label">${o.l}</span>
            </div>
          `).join('')}
        </div>
        <button class="btn btn-primary btn-full" style="margin-top:16px" id="confirmEffort" onclick="confirmEffortFn()" disabled>Confirmar</button>
      </div>
    `;
    
    window._effortResolve = resolve;
    window.selectEffort = (val) => {
      selected = val;
      document.querySelectorAll('.effort-option').forEach(o=>o.classList.toggle('selected',+o.dataset.val===val));
      const btn = document.getElementById('confirmEffort');
      if(btn) { btn.disabled = false; btn.style.opacity = '1'; }
    };
    window.confirmEffortFn = () => {
      if(selected!==null) { document.body.removeChild(overlay); resolve(selected); }
    };
    // Append FIRST, then style
    document.body.appendChild(overlay);
    const confirmBtn = document.getElementById('confirmEffort');
    if(confirmBtn) confirmBtn.style.opacity='0.5';
  });
}

async function showFatigueModal(title, mode) {
  return new Promise(resolve => {
    // mode 'pre':  1=muerto/sin energÃ­a â†’ 10=sÃºper descansado
    // mode 'post': 1=nada cansado      â†’ 10=totalmente agotado
    const colorsPre  = ['#b91c1c','#dc2626','#ef4444','#f97316','#ff6b35','#ffd60a','#a3e635','#4ade80','#00e5a0','#00c8ff'];
    const emojisPre  = ['ğŸ’€','ğŸ˜µ','ğŸ¥µ','ğŸ˜“','ğŸ˜°','ğŸ˜”','ğŸ˜‘','ğŸ˜','ğŸ™‚','ğŸ”¥'];
    const labelsPre  = ['1 - Sin energÃ­a','2 - Agotado','3 - Muy cansado','4 - Bastante cansado','5 - Cansado','6 - Regular','7 - Bien','8 - Muy bien','9 - Excelente','10 - SÃºper descansado'];
    const leftPre    = 'ğŸ’€ Sin energÃ­a';
    const rightPre   = 'SÃºper descansado ğŸ”¥';

    const colorsPost = ['#00c8ff','#00e5a0','#4ade80','#a3e635','#ffd60a','#ff6b35','#f97316','#ef4444','#dc2626','#b91c1c'];
    const emojisPost = ['ğŸ˜Š','ğŸ™‚','ğŸ˜','ğŸ˜‘','ğŸ˜”','ğŸ˜°','ğŸ˜“','ğŸ¥µ','ğŸ˜µ','ğŸ’€'];
    const labelsPost = ['1 - Nada cansado','2 - Muy poco cansado','3 - Poco cansado','4 - Algo cansado','5 - Moderadamente cansado','6 - Bastante cansado','7 - Muy cansado','8 - Agotado','9 - Muy agotado','10 - Totalmente destruido'];
    const leftPost   = 'ğŸ˜Š Nada cansado';
    const rightPost  = 'Totalmente agotado ğŸ’€';

    const colors = mode === 'pre' ? colorsPre : colorsPost;
    const emojis = mode === 'pre' ? emojisPre : emojisPost;
    const labels = mode === 'pre' ? labelsPre : labelsPost;
    const leftLabel  = mode === 'pre' ? leftPre  : leftPost;
    const rightLabel = mode === 'pre' ? rightPre : rightPost;

    let selected = null;
    const overlay = document.createElement('div');
    overlay.className = 'overlay-backdrop';

    const dotsHtml = Array.from({length:10}, (_,i) => {
      return '<div class="fatigue-dot" data-val="' + (i+1) + '" style="color:' + colors[i] + ';font-size:1.3rem" onclick="selectFatigue(' + (i+1) + ')" title="' + labels[i] + '">' + emojis[i] + '</div>';
    }).join('');

    overlay.innerHTML =
      '<div class="overlay-sheet">' +
        '<div class="sheet-handle"></div>' +
        '<div style="font-weight:700;font-size:1rem;margin-bottom:4px;text-align:center">' + title + '</div>' +
        '<div style="display:flex;justify-content:space-between;font-size:0.72rem;color:var(--text-muted);margin:12px 0 6px">' +
          '<span>' + leftLabel + '</span><span>' + rightLabel + '</span>' +
        '</div>' +
        '<div class="fatigue-scale" id="fatigueScale">' + dotsHtml + '</div>' +
        '<div style="text-align:center;margin:10px 0;font-size:0.85rem;font-weight:600" id="fatigueLabel">Selecciona una opciÃ³n</div>' +
        '<button class="btn btn-primary btn-full" style="margin-top:12px;opacity:0.5" id="confirmFatigue" onclick="confirmFatigueFn()" disabled>Confirmar</button>' +
      '</div>';

    window.selectFatigue = (val) => {
      selected = val;
      document.querySelectorAll('.fatigue-dot').forEach((d,i) => {
        const isSelected = (i+1) === val;
        d.style.background = isSelected ? colors[i] : 'rgba(255,255,255,0.04)';
        d.style.border = isSelected ? '2px solid ' + colors[i] : '1px solid rgba(255,255,255,0.08)';
        d.style.transform = isSelected ? 'scaleY(1.2)' : 'scaleY(1)';
        d.style.boxShadow = isSelected ? '0 0 14px ' + colors[i] + '88' : 'none';
      });
      const lbl = document.getElementById('fatigueLabel');
      lbl.textContent = labels[val-1];
      lbl.style.color = colors[val-1];
      document.getElementById('confirmFatigue').disabled = false;
      document.getElementById('confirmFatigue').style.opacity = '1';
    };
    window.confirmFatigueFn = () => {
      if(selected !== null) { document.body.removeChild(overlay); resolve(selected); }
    };
    document.body.appendChild(overlay);
  });
}

window.avanzarDia = async () => {
  const { mesActual=1, semanaActual=1, diaActual=1 } = state.progreso||{};
  const currentAbs = msdToAbs(mesActual, semanaActual, diaActual);

  // Check if current day has exercises and is not completed
  const diaData = state.rutinaData?.meses?.[mesActual]?.semanas?.[semanaActual]?.dias?.[diaActual];
  const hasEj = Object.keys(diaData?.ejercicios||{}).length > 0;
  const done  = sesionCompletada(state.historial, mesActual, semanaActual, diaActual);

  if(hasEj && !done) {
    const res = await Swal.fire({
      icon:'warning', title:'DÃ­a pendiente',
      html:`<div style="color:#e8f4ff">El dÃ­a actual tiene ejercicios sin completar.<br><br>Â¿Saltar al siguiente dÃ­a de todas formas?</div>`,
      showCancelButton:true, confirmButtonText:'SÃ­, saltar',
      cancelButtonText:'Quedarse aquÃ­',
      confirmButtonColor:'#ff6b35', background:'rgba(10,20,40,0.95)', color:'#e8f4ff'
    });
    if(!res.isConfirmed) return;
  }

  const maxMes = Math.max(...Object.keys(state.rutinaData?.meses||{1:{}}).map(Number));
  const maxAbs = maxMes * 20 - 1;
  const nextAbs = Math.min(currentAbs + 1, maxAbs);
  const { mes, semana, dia } = absToMSD(nextAbs);
  const newProgreso = { rutinaActiva:state.rutinaId, mesActual:mes, semanaActual:semana, diaActual:dia };
  state.progreso = newProgreso;
  await set(ref(db,`sesiones/${currentUser.id}/progreso`), newProgreso);
  renderTab('entrenar');
};

window.resetProgreso = async () => {
  const res = await Swal.fire({
    icon:'warning', title:'Â¿Reiniciar progreso?',
    text:'VolverÃ¡s al Mes 1, Semana 1, DÃ­a 1. El historial de sesiones se conserva.',
    showCancelButton:true, confirmButtonText:'SÃ­, reiniciar', cancelButtonText:'Cancelar',
    confirmButtonColor:'#ff4d6d', background:'rgba(10,20,40,0.95)', color:'#e8f4ff'
  });
  if(!res.isConfirmed) return;
  const newProgreso = { rutinaActiva:state.rutinaId, mesActual:1, semanaActual:1, diaActual:1 };
  state.progreso = newProgreso;
  await set(ref(db,`sesiones/${currentUser.id}/progreso`), newProgreso);
  Swal.fire({icon:'success',title:'Progreso reiniciado',timer:1500,showConfirmButton:false,background:'rgba(10,20,40,0.95)',color:'#e8f4ff'});
  renderTab('entrenar');
};

// ============ PROGRESO ============

// â”€â”€ Streak logic â”€â”€
// "Training streak" based on routine days with exercises.
// Weekend days (Sat/Sun) are NEVER counted as missed â€” they don't break a streak.
// A streak is consecutive calendar days where:
//   - The user trained (has a session recorded on that real date), OR
//   - It was a Saturday or Sunday (rest day by default), OR
//   - The user had no exercise scheduled in their routine for that day.
// A streak breaks when a weekday passes where the user had exercises in their routine
// but did NOT train, AND that day was more than 1 day ago (we don't penalize "today").
// Helper: convert timestamp to local 'YYYY-MM-DD' string (avoids UTC shift bugs)
function tsToLocalDateKey(ts) {
  const d = new Date(ts);
  const y = d.getFullYear();
  const m = String(d.getMonth()+1).padStart(2,'0');
  const day = String(d.getDate()).padStart(2,'0');
  return `${y}-${m}-${day}`;
}

function computeStreak(sesiones, rutinaData) {
  if(!sesiones.length) return { current: 0, max: 0, lastTrained: null, heatmap: {} };

  // Build a set of LOCAL dates (YYYY-MM-DD) when the user trained
  const trainedDates = new Set();
  sesiones.forEach(s => {
    const ts = s.fecha || s.fechaFin || s.fechaInicio || 0;
    if(ts) trainedDates.add(tsToLocalDateKey(ts));
  });

  // Find earliest training date and today (local)
  const allDates = [...trainedDates].sort();
  if(!allDates.length) return { current: 0, max: 0, lastTrained: null, heatmap: {} };

  const today = new Date();
  today.setHours(0,0,0,0);
  const todayKey = tsToLocalDateKey(today.getTime());

  // firstDate: parse local key to local midnight
  const [fy,fm,fd] = allDates[0].split('-').map(Number);
  const firstDate = new Date(fy, fm-1, fd);

  // Build heatmap for last 12 weeks (using local dates)
  const heatmap = {};
  for(let i=0; i<=84; i++) {
    const d = new Date(today);
    d.setDate(today.getDate() - i);
    const key = tsToLocalDateKey(d.getTime());
    const dow = d.getDay(); // 0=Sun 6=Sat
    if(trainedDates.has(key)) {
      heatmap[key] = 'trained';
    } else if(dow === 0 || dow === 6) {
      heatmap[key] = 'weekend';
    } else {
      heatmap[key] = 'missed';
    }
  }

  // Compute current streak (going backwards from today)
  // Rules:
  //   - If trained today â†’ count today, then look backwards
  //   - If NOT trained today â†’ start from yesterday (today doesn't break streak, it's still today)
  //   - Weekend days (Sat/Sun): skip silently, don't break streak
  //   - Weekday without training in the past â†’ breaks streak
  let streak = 0;
  let lastTrained = null;

  const trainedToday = trainedDates.has(todayKey);
  const startOffset = trainedToday ? 0 : 1;

  for(let offset = startOffset; offset <= 730; offset++) {
    const d = new Date(today);
    d.setDate(today.getDate() - offset);
    if(d < firstDate) break;
    const key = tsToLocalDateKey(d.getTime());
    const dow = d.getDay();

    if(trainedDates.has(key)) {
      streak++;
      if(!lastTrained) lastTrained = d;
    } else if(dow === 0 || dow === 6) {
      // Weekend: free pass, keep going
      continue;
    } else {
      // Missed weekday in the past â†’ break
      break;
    }
  }

  // If didn't train today but trained previously, still count as "streak" if no
  // weekday gap exists between last training and today
  // The loop above handles this correctly: it starts at yesterday (offset=1) and
  // breaks on the first missed weekday.

  const current = streak;

  // Compute max streak ever (forward pass over sorted allDates)
  let max = current;
  if(allDates.length >= 1) {
    let runStreak = 1, maxS = 1;
    for(let i=1; i<allDates.length; i++) {
      const [py,pm,pd] = allDates[i-1].split('-').map(Number);
      const [cy,cm,cd] = allDates[i].split('-').map(Number);
      const prev = new Date(py, pm-1, pd);
      const curr = new Date(cy, cm-1, cd);
      const diffDays = Math.round((curr - prev) / (1000*60*60*24));
      // Count intervening weekends as free
      let weekendsBetween = 0;
      for(let j=1; j<diffDays; j++) {
        const wd = new Date(prev); wd.setDate(prev.getDate()+j);
        if(wd.getDay()===0||wd.getDay()===6) weekendsBetween++;
      }
      const effectiveGap = diffDays - weekendsBetween;
      if(effectiveGap <= 1) { runStreak++; }
      else { maxS = Math.max(maxS, runStreak); runStreak = 1; }
    }
    max = Math.max(maxS, runStreak, current);
  }

  return { current, max, lastTrained, heatmap };
}

// â”€â”€ Monthly calendar renderer â”€â”€
// Helper: obtener dÃ­as del mes con sesiÃ³n (como Set de 'YYYY-MM-DD') y conteo total
function getSessionDaysForMonth(hist, year, month) {
  const days = new Set();
  let count = 0;
  Object.values(hist||{}).forEach(s => {
    const ts = s.fechaFin || s.fechaInicio || s.fecha || 0;
    if(!ts) return;
    const d = new Date(ts);
    if(d.getFullYear() === year && d.getMonth() === month) {
      const key = `${year}-${String(month+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
      days.add(key);
      count++;
    }
  });
  return { days, count };
}

// calHeatmap: the heatmap object {YYYY-MM-DD: 'trained'|'missed'|'weekend'}
// calYear/calMonth: currently displayed month (0-indexed)
let _calHeatmap = {};
let _calYear = new Date().getFullYear();
let _calMonth = new Date().getMonth();

function renderCalendar(heatmap, year, month, sessionDays, sessionCount) {
  _calHeatmap = heatmap;
  _calYear = year;
  _calMonth = month;

  const today = new Date(); today.setHours(0,0,0,0);
  const todayKey = tsToLocalDateKey(today.getTime());

  const monthName = new Date(year, month, 1).toLocaleDateString('es-CO', {month:'long', year:'numeric'});

  // First day of month (0=Sunâ€¦6=Sat), shift to Mon-first
  const firstDow = new Date(year, month, 1).getDay(); // 0=Sun
  const startOffset = firstDow === 0 ? 6 : firstDow - 1; // blanks before day 1
  const daysInMonth = new Date(year, month+1, 0).getDate();

  const DOW_LABELS = ['L','M','X','J','V','S','D'];

  // Can go back up to 3 months, can't go forward past current month
  const nowYear = today.getFullYear(), nowMonth = today.getMonth();
  const canPrev = !(year === nowYear - 1 && month === 0); // limit ~12 months back
  const canNext = !(year === nowYear && month === nowMonth);

  // Build day cells
  let cells = '';
  // Empty cells before day 1
  for(let i=0; i<startOffset; i++) {
    cells += `<div></div>`;
  }
  for(let day=1; day<=daysInMonth; day++) {
    const d = new Date(year, month, day);
    const key = `${year}-${String(month+1).padStart(2,'0')}-${String(day).padStart(2,'0')}`;
    const dow = d.getDay(); // 0=Sun 6=Sat
    const isWeekend = dow === 0 || dow === 6;
    const isFuture = d > today;
    const isToday = key === todayKey;
    const hasSessions = sessionDays && sessionDays.has(key);
    const status = hasSessions ? 'trained' : (heatmap[key] || (isFuture ? 'future' : isWeekend ? 'weekend' : 'missed'));

    let bg, border, emoji, textColor;
    if(status === 'trained') {
      bg = 'rgba(0,229,160,0.18)'; border = 'rgba(0,229,160,0.5)';
      emoji = 'ğŸ’ª'; textColor = 'var(--success)';
    } else if(status === 'weekend') {
      bg = 'rgba(123,47,255,0.12)'; border = 'rgba(123,47,255,0.2)';
      emoji = ''; textColor = 'rgba(232,244,255,0.35)';
    } else if(status === 'future') {
      bg = 'rgba(255,255,255,0.03)'; border = 'rgba(255,255,255,0.06)';
      emoji = ''; textColor = 'rgba(232,244,255,0.2)';
    } else {
      // missed weekday
      bg = 'rgba(255,77,109,0.1)'; border = 'rgba(255,77,109,0.25)';
      emoji = ''; textColor = 'rgba(255,77,109,0.7)';
    }

    const todayStyle = isToday
      ? `box-shadow:0 0 0 2px var(--primary);`
      : '';

    cells += `
      <div style="
        background:${bg};border:1px solid ${border};${todayStyle}
        border-radius:10px;padding:6px 4px;min-height:44px;
        display:flex;flex-direction:column;align-items:center;justify-content:center;gap:2px;
        position:relative;
      ">
        <div style="font-size:0.78rem;font-weight:${isToday?'900':'600'};color:${textColor};line-height:1">${day}</div>
        ${emoji ? `<div style="font-size:0.75rem;line-height:1">${emoji}</div>` : ''}
        ${isToday ? `<div style="position:absolute;top:3px;right:4px;width:5px;height:5px;border-radius:50%;background:var(--primary);box-shadow:0 0 6px var(--primary)"></div>` : ''}
      </div>`;
  }

  // Count trained days and missed days this month
  let calTrainedDays = 0, missedCount = 0;
  for(let day=1; day<=daysInMonth; day++) {
    const key = `${year}-${String(month+1).padStart(2,'0')}-${String(day).padStart(2,'0')}`;
    const d = new Date(year, month, day);
    const dow = d.getDay();
    const isWeekend = dow === 0 || dow === 6;
    const isFuture = d > today;
    if(!isWeekend && !isFuture) {
      const hasSess = sessionDays && sessionDays.has(key);
      if(hasSess || heatmap[key] === 'trained') calTrainedDays++;
      else missedCount++;
    }
  }
  // sessionCount = sesiones reales del mes (puede haber varias en un mismo dÃ­a)
  const trainedCount = (sessionCount !== undefined) ? sessionCount : calTrainedDays;

  return `
    <div id="streakCalendar">
      <!-- Header -->
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px">
        <button onclick="calNav(-1)" style="background:rgba(255,255,255,0.06);border:1px solid rgba(255,255,255,0.1);border-radius:8px;color:var(--text);width:32px;height:32px;cursor:pointer;font-size:1rem;display:flex;align-items:center;justify-content:center;${!canPrev?'opacity:0.3;pointer-events:none':''}">â€¹</button>
        <div style="font-size:0.9rem;font-weight:700;text-transform:capitalize;letter-spacing:0.5px">${monthName}</div>
        <button onclick="calNav(1)" style="background:rgba(255,255,255,0.06);border:1px solid rgba(255,255,255,0.1);border-radius:8px;color:var(--text);width:32px;height:32px;cursor:pointer;font-size:1rem;display:flex;align-items:center;justify-content:center;${!canNext?'opacity:0.3;pointer-events:none':''}">â€º</button>
      </div>

      <!-- Day labels -->
      <div style="display:grid;grid-template-columns:repeat(7,1fr);gap:4px;margin-bottom:4px">
        ${DOW_LABELS.map((l,i) => `<div style="text-align:center;font-size:0.65rem;font-weight:700;color:${i>=5?'rgba(123,47,255,0.7)':'var(--text-muted)'};text-transform:uppercase;letter-spacing:0.5px;padding:4px 0">${l}</div>`).join('')}
      </div>

      <!-- Day cells -->
      <div style="display:grid;grid-template-columns:repeat(7,1fr);gap:4px">
        ${cells}
      </div>

      <!-- Month summary -->
      <div style="display:flex;gap:8px;margin-top:12px;flex-wrap:wrap">
        <div style="flex:1;min-width:80px;background:rgba(0,229,160,0.08);border:1px solid rgba(0,229,160,0.2);border-radius:10px;padding:8px;text-align:center">
          <div style="font-size:1.3rem;font-weight:900;color:var(--success)">${trainedCount}</div>
          <div style="font-size:0.65rem;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.5px">DÃ­as entrenados</div>
        </div>
        <div style="flex:1;min-width:80px;background:rgba(255,77,109,0.08);border:1px solid rgba(255,77,109,0.2);border-radius:10px;padding:8px;text-align:center">
          <div style="font-size:1.3rem;font-weight:900;color:var(--error)">${missedCount}</div>
          <div style="font-size:0.65rem;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.5px">DÃ­as perdidos</div>
        </div>
        <div style="flex:1;min-width:80px;background:rgba(123,47,255,0.08);border:1px solid rgba(123,47,255,0.2);border-radius:10px;padding:8px;text-align:center">
          <div style="font-size:1.3rem;font-weight:900;color:var(--accent)">${trainedCount+missedCount>0?Math.round((trainedCount/(trainedCount+missedCount))*100):0}%</div>
          <div style="font-size:0.65rem;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.5px">Asistencia</div>
        </div>
      </div>

      <!-- Legend -->
      <div style="display:flex;gap:10px;margin-top:10px;flex-wrap:wrap">
        <div style="display:flex;align-items:center;gap:5px;font-size:0.7rem;color:var(--text-muted)"><div style="width:10px;height:10px;border-radius:3px;background:rgba(0,229,160,0.3);border:1px solid rgba(0,229,160,0.5)"></div>ğŸ’ª Entrenado</div>
        <div style="display:flex;align-items:center;gap:5px;font-size:0.7rem;color:var(--text-muted)"><div style="width:10px;height:10px;border-radius:3px;background:rgba(255,77,109,0.2);border:1px solid rgba(255,77,109,0.3)"></div>Perdido</div>
        <div style="display:flex;align-items:center;gap:5px;font-size:0.7rem;color:var(--text-muted)"><div style="width:10px;height:10px;border-radius:3px;background:rgba(123,47,255,0.15);border:1px solid rgba(123,47,255,0.25)"></div>Fin de semana</div>
      </div>
    </div>`;
}

window.calNav = (dir) => {
  let m = _calMonth + dir;
  let y = _calYear;
  if(m < 0) { m = 11; y--; }
  if(m > 11) { m = 0; y++; }
  const calEl = document.getElementById('streakCalendar');
  if(calEl) {
    const hist = state.historial || {};
    const { days, count } = getSessionDaysForMonth(hist, y, m);
    calEl.outerHTML = renderCalendar(_calHeatmap, y, m, days, count);
  }
};

async function renderProgreso() {
  const p = document.getElementById('mainPage');
  p.innerHTML = '<div class="loading-box"><div class="spinner"></div><span>Cargando progreso...</span></div>';

  const [histSnap, valSnap, rutSnap] = await Promise.all([
    get(ref(db,`sesiones/${currentUser.id}/historial`)),
    get(ref(db,`valoraciones/${currentUser.id}`)),
    get(ref(db,'rutinas'))
  ]);
  const hist = histSnap.val()||{};
  const sesiones = Object.values(hist).sort((a,b)=>(a.fecha||0)-(b.fecha||0));
  const valoraciones = Object.values(valSnap.val()||{}).sort((a,b)=>a.fecha-b.fecha);

  const rutinas = rutSnap.val()||{};
  const miRutina = Object.values(rutinas).find(r=>r.usuario===currentUser.id && r.activa);

  if(sesiones.length===0 && valoraciones.length===0) {
    p.innerHTML = `
      <div class="glass-card" style="text-align:center;padding:40px 20px">
        <div style="font-size:3rem;margin-bottom:16px">ğŸ“ˆ</div>
        <h2 style="margin-bottom:10px">Sin historial aÃºn</h2>
        <p style="color:var(--text-muted)">Completa tu primera sesiÃ³n para ver tu progreso aquÃ­</p>
        <button class="btn btn-primary" style="margin-top:16px" onclick="switchTab('entrenar')">ğŸ’ª Ir a entrenar</button>
      </div>`;
    return;
  }

  // â”€â”€â”€ Streak â”€â”€â”€
  const { current: streakActual, max: streakMax, lastTrained, heatmap } = computeStreak(sesiones, miRutina);
  const streakEmoji = streakActual >= 30 ? 'ğŸ”¥ğŸ”¥ğŸ”¥' : streakActual >= 14 ? 'ğŸ”¥ğŸ”¥' : streakActual >= 7 ? 'ğŸ”¥' : streakActual >= 3 ? 'âš¡' : 'ğŸ’ª';
  const streakMessage = streakActual === 0 ? 'Â¡Vuelve a entrenar hoy!' : streakActual === 1 ? 'Â¡Bien! Sigue maÃ±ana' : streakActual < 7 ? 'Â¡Vas bien! No pares' : streakActual < 14 ? 'Â¡Semana completa!' : streakActual < 30 ? 'Â¡Racha Ã©pica!' : 'Â¡LEYENDA DEL GYM! ğŸ†';

  // â”€â”€â”€ Charts data â”€â”€â”€
  const weekMap = {};
  sesiones.forEach(s => {
    const wk = `M${s.mes}S${s.semana}`;
    if(!weekMap[wk]) weekMap[wk] = {cansancioFin:[],series:0,sesiones:0};
    weekMap[wk].cansancioFin.push(s.nivelCansancioFin||0);
    weekMap[wk].sesiones++;
    Object.values(s.ejerciciosCompletados||{}).forEach(ec=>{
      weekMap[wk].series += (ec.series||[]).length;
    });
  });
  const wkLabels = Object.keys(weekMap);
  const avgCansancio = wkLabels.map(w=>weekMap[w].cansancioFin.reduce((a,b)=>a+b,0)/weekMap[w].cansancioFin.length);
  const totalSeries = wkLabels.map(w=>weekMap[w].series);
  const totalSeriesAll = Object.values(weekMap).reduce((a,w)=>a+w.series,0);

  const chartOpts = {
    responsive:true,maintainAspectRatio:false,
    plugins:{legend:{display:false}},
    scales:{
      x:{grid:{color:'rgba(255,255,255,0.05)'},ticks:{color:'rgba(232,244,255,0.5)',font:{size:10}}},
      y:{grid:{color:'rgba(255,255,255,0.05)'},ticks:{color:'rgba(232,244,255,0.5)',font:{size:10}}}
    }
  };

  // â”€â”€â”€ Valoraciones trend â”€â”€â”€
  const hasValoraciones = valoraciones.length >= 1;
  const lastVal = valoraciones[valoraciones.length-1];
  const firstVal = valoraciones[0];
  const anyHasMes = valoraciones.some(v => v.mes);
  const valLabels = valoraciones.map((v, i) => anyHasMes ? `Mes ${v.mes || (i+1)}` : new Date(v.fecha).toLocaleDateString('es-CO',{month:'short',year:'2-digit'}));

  // delta: el valor numÃ©rico del cambio. invertido=true significa que bajar es bueno (ej: grasa)
  const deltaFmt = (delta, invertido=false) => {
    if(delta===undefined||delta===null) return '';
    const n = parseFloat(delta).toFixed(1);
    const neutro = Math.abs(n) < 0.1;
    if(neutro) return `<span style="color:var(--text-muted)">â†’ sin cambio</span>`;
    const subio = parseFloat(n) > 0;
    const esBueno = invertido ? !subio : subio;
    const arrow = subio ? 'â–²' : 'â–¼';
    const sign = subio ? '+' : '';
    const color = esBueno ? 'var(--success)' : 'var(--error)';
    return `<span style="color:${color}">${arrow}${sign}${Math.abs(n)}</span>`;
  };

  const deltaGrasa = valoraciones.length>1 ? lastVal.grasa-firstVal.grasa : null;
  const deltaMuscular = valoraciones.length>1 ? lastVal.muscular-firstVal.muscular : null;
  const deltaPeso = valoraciones.length>1 ? lastVal.peso-firstVal.peso : null;

  p.innerHTML = `
    <!-- â•â•â• STREAK CARD â•â•â• -->
    <div class="glass-card" style="position:relative;overflow:hidden;background:linear-gradient(135deg,rgba(255,107,53,0.12),rgba(123,47,255,0.1),rgba(0,200,255,0.08));border-color:rgba(255,107,53,0.3)">
      <div style="position:absolute;inset:0;pointer-events:none;opacity:0.03;background:radial-gradient(circle at 80% 50%,#ff6b35 0%,transparent 60%)"></div>
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;flex-wrap:wrap;gap:8px">
        <div class="card-title" style="margin:0">ğŸ”¥ Racha de entrenamiento</div>
        <div style="font-size:0.75rem;color:var(--text-muted)">Fines de semana no cuentan</div>
      </div>

      <!-- NÃºmeros principales -->
      <div style="display:flex;align-items:center;gap:16px;margin-bottom:20px;flex-wrap:wrap">
        <div style="text-align:center;flex:1;min-width:100px">
          <div style="font-size:4rem;font-weight:900;line-height:1;background:linear-gradient(135deg,#ff6b35,#ffd60a);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text">${streakActual}</div>
          <div style="font-size:0.75rem;color:var(--text-muted);text-transform:uppercase;letter-spacing:1px;margin-top:4px">DÃ­as seguidos</div>
        </div>
        <div style="flex:0 0 1px;height:60px;background:rgba(255,255,255,0.1)"></div>
        <div style="text-align:center;flex:1;min-width:100px">
          <div style="font-size:3rem;font-weight:900;line-height:1;color:var(--accent)">${streakMax}</div>
          <div style="font-size:0.75rem;color:var(--text-muted);text-transform:uppercase;letter-spacing:1px;margin-top:4px">RÃ©cord personal</div>
        </div>
        <div style="flex:0 0 1px;height:60px;background:rgba(255,255,255,0.1)"></div>
        <div style="text-align:center;flex:1;min-width:100px">
          <div style="font-size:2.5rem;font-weight:900;line-height:1">${streakEmoji}</div>
          <div style="font-size:0.75rem;color:rgba(255,107,53,0.9);font-weight:700;margin-top:4px">${streakMessage}</div>
        </div>
      </div>

      <!-- Progress bar to next milestone -->
      ${(() => {
        const milestones = [3,7,14,21,30,60,90];
        const next = milestones.find(m=>m>streakActual) || 100;
        const prev = milestones[milestones.indexOf(next)-1] || 0;
        const pct = Math.round(((streakActual-prev)/(next-prev))*100);
        return `
          <div style="margin-bottom:14px">
            <div style="display:flex;justify-content:space-between;font-size:0.75rem;color:var(--text-muted);margin-bottom:5px">
              <span>PrÃ³ximo hito: ğŸ¯ ${next} dÃ­as</span><span>${streakActual}/${next}</span>
            </div>
            <div style="height:8px;background:rgba(255,255,255,0.08);border-radius:4px;overflow:hidden">
              <div style="height:100%;background:linear-gradient(90deg,#ff6b35,#ffd60a);border-radius:4px;width:${pct}%;transition:width 1.2s cubic-bezier(0.4,0,0.2,1);box-shadow:0 0 8px rgba(255,107,53,0.5)"></div>
            </div>
          </div>`;
      })()}

      <!-- Calendario -->
      <div>
        <div style="font-size:0.75rem;text-transform:uppercase;letter-spacing:1px;color:var(--text-muted);margin-bottom:10px">Calendario de entrenamientos</div>
        ${(() => {
          const cy = new Date().getFullYear(), cm = new Date().getMonth();
          const { days: sDays, count: sCount } = getSessionDaysForMonth(state.historial||{}, cy, cm);
          return renderCalendar(heatmap, cy, cm, sDays, sCount);
        })()}
      </div>
    </div>

    <!-- â•â•â• RESUMEN â•â•â• -->
    <div class="glass-card">
      <div class="card-title">ğŸ† Tu resumen</div>
      <div class="mini-stats">
        <div class="mini-stat"><div class="val">${sesiones.length}</div><div class="lbl">Sesiones</div></div>
        <div class="mini-stat"><div class="val">${totalSeriesAll}</div><div class="lbl">Series totales</div></div>
        <div class="mini-stat"><div class="val">M${state.progreso?.mesActual||1}Â·S${state.progreso?.semanaActual||1}</div><div class="lbl">PosiciÃ³n</div></div>
      </div>
    </div>

    <!-- â•â•â• VALORACIONES â•â•â• -->
    ${hasValoraciones ? `
    <div class="glass-card" style="background:linear-gradient(135deg,rgba(0,100,200,0.08),rgba(123,47,255,0.06));border-color:rgba(0,200,255,0.2)">
      <div class="card-title">âš–ï¸ Mi composiciÃ³n corporal</div>

      <!-- Current snapshot -->
      <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-bottom:16px">
        <div style="background:rgba(255,107,53,0.1);border:1px solid rgba(255,107,53,0.25);border-radius:14px;padding:12px;text-align:center">
          <div style="font-size:0.65rem;color:rgba(255,107,53,0.8);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:4px">% Grasa</div>
          <div style="font-size:1.7rem;font-weight:900;color:#ff6b35">${lastVal.grasa}%</div>
          ${valoraciones.length>1?`<div style="font-size:0.72rem;margin-top:2px">${deltaFmt(deltaGrasa, true)}</div>`:''}
        </div>
        <div style="background:rgba(0,229,160,0.1);border:1px solid rgba(0,229,160,0.25);border-radius:14px;padding:12px;text-align:center">
          <div style="font-size:0.65rem;color:rgba(0,229,160,0.8);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:4px">% MÃºsculo</div>
          <div style="font-size:1.7rem;font-weight:900;color:var(--success)">${lastVal.muscular}%</div>
          ${valoraciones.length>1?`<div style="font-size:0.72rem;margin-top:2px">${deltaFmt(deltaMuscular, false)}</div>`:''}
        </div>
        <div style="background:rgba(0,200,255,0.1);border:1px solid rgba(0,200,255,0.25);border-radius:14px;padding:12px;text-align:center">
          <div style="font-size:0.65rem;color:rgba(0,200,255,0.8);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:4px">Peso</div>
          <div style="font-size:1.7rem;font-weight:900;color:var(--primary)">${lastVal.peso}<span style="font-size:0.9rem">kg</span></div>
          ${valoraciones.length>1?`<div style="font-size:0.72rem;margin-top:2px">${deltaFmt(deltaPeso)}</div>`:''}
        </div>
      </div>

      ${valoraciones.length===1?`<div style="font-size:0.82rem;color:var(--text-muted);text-align:center;padding:8px;background:rgba(0,200,255,0.04);border-radius:10px;margin-bottom:10px">ğŸ“Š Tu entrenador agregarÃ¡ mÃ¡s valoraciones para mostrar tu tendencia</div>`:''}

      ${valoraciones.length >= 2 ? `
      <!-- Trend charts -->
      <div style="margin-bottom:12px">
        <div style="font-size:0.75rem;text-transform:uppercase;letter-spacing:1px;color:var(--text-muted);margin-bottom:8px">Tendencia: % Grasa vs % MÃºsculo</div>
        <div style="height:160px"><canvas id="chartComposicion"></canvas></div>
      </div>
      <div>
        <div style="font-size:0.75rem;text-transform:uppercase;letter-spacing:1px;color:var(--text-muted);margin-bottom:8px">Tendencia: Peso corporal</div>
        <div style="height:130px"><canvas id="chartPesoTrend"></canvas></div>
      </div>
      ` : ''}

      ${valoraciones.length >= 2 ? `
      <!-- Progress summary -->
      <div style="margin-top:14px;padding:12px;background:rgba(0,0,0,0.2);border-radius:12px;border:1px solid rgba(255,255,255,0.05)">
        <div style="font-size:0.78rem;color:var(--text-muted);margin-bottom:6px;font-weight:600;text-transform:uppercase;letter-spacing:0.5px">ğŸ“ˆ Cambio total desde inicio</div>
        <div style="display:flex;gap:8px;flex-wrap:wrap">
          <span style="font-size:0.8rem;background:rgba(255,107,53,0.1);border:1px solid rgba(255,107,53,0.2);border-radius:20px;padding:4px 10px">
            Grasa: ${deltaFmt(deltaGrasa, true)} % ${deltaGrasa<0?'ğŸ¯ Â¡BajÃ³!':deltaGrasa>0?'ğŸ“ˆ SubiÃ³':' ='}
          </span>
          <span style="font-size:0.8rem;background:rgba(0,229,160,0.1);border:1px solid rgba(0,229,160,0.2);border-radius:20px;padding:4px 10px">
            MÃºsculo: ${deltaFmt(deltaMuscular, false)} % ${deltaMuscular>0?'ğŸ’ª Â¡GanÃ³!':deltaMuscular<0?'ğŸ“‰ BajÃ³':' ='}
          </span>
          <span style="font-size:0.8rem;background:rgba(0,200,255,0.1);border:1px solid rgba(0,200,255,0.2);border-radius:20px;padding:4px 10px">
            Peso: ${deltaFmt(deltaPeso, false)} kg
          </span>
        </div>
      </div>` : ''}
    </div>
    ` : `
    <div class="glass-card" style="text-align:center;padding:20px">
      <div style="font-size:2rem;margin-bottom:8px">âš–ï¸</div>
      <div style="font-weight:700;margin-bottom:4px">Sin valoraciones aÃºn</div>
      <div style="font-size:0.82rem;color:var(--text-muted)">Tu entrenador agregarÃ¡ valoraciones de composiciÃ³n corporal para ver tu progreso</div>
    </div>`}

    <!-- â•â•â• FATIGA â•â•â• -->
    ${wkLabels.length > 0 ? `
    <div class="glass-card">
      <div class="card-title">ğŸ˜´ Cansancio al finalizar sesiÃ³n</div>
      <div style="height:180px"><canvas id="chartCansancio"></canvas></div>
    </div>

    <div class="glass-card">
      <div class="card-title">ğŸ“¦ Volumen semanal (series)</div>
      <div style="height:180px"><canvas id="chartVolumen"></canvas></div>
    </div>` : ''}

    <!-- â•â•â• HISTORIAL â•â•â• -->
    <div class="glass-card">
      <div class="card-title">ğŸ“… Ãšltimas sesiones</div>
      <div id="sesHistorialWrap">
      ${(()=>{
        const SES_PG = 8;
        const totalSesP = Math.ceil(sesiones.length / SES_PG);
        const renderSesPage = (pg) => {
          const slice = [...sesiones].reverse().slice(pg*SES_PG,(pg+1)*SES_PG);
          if(!slice.length) return '<div style="text-align:center;padding:20px;color:var(--text-muted)">Sin sesiones aÃºn</div>';
          return slice.map(s=>`
            <div style="display:flex;align-items:center;justify-content:space-between;padding:10px 0;border-bottom:1px solid rgba(255,255,255,0.05)">
              <div>
                <div style="font-weight:600;font-size:0.88rem">M${s.mes}Â·S${s.semana}Â·D${s.dia}</div>
                <div style="font-size:0.75rem;color:var(--text-muted)">${new Date(s.fecha||s.fechaFin||0).toLocaleDateString('es-CO',{day:'2-digit',month:'short',year:'2-digit'})}</div>
              </div>
              <div style="text-align:right;font-size:0.82rem">
                <div style="color:var(--primary)">${Object.values(s.ejerciciosCompletados||{}).length} ej.</div>
                <div style="color:var(--text-muted)">ğŸ˜“ ${s.nivelCansancioFin||'â€”'}/10</div>
              </div>
            </div>`).join('') +
            (totalSesP > 1 ? `<div style="display:flex;align-items:center;gap:6px;margin-top:12px">
              <span style="font-size:0.72rem;color:var(--text-muted)">${pg*SES_PG+1}â€“${Math.min((pg+1)*SES_PG,sesiones.length)} de ${sesiones.length}</span>
              <div style="margin-left:auto;display:flex;gap:4px">
                ${pg>0?`<button onclick="window._renderSesHistorial(${pg-1})" style="padding:5px 12px;border-radius:8px;border:1px solid rgba(255,255,255,0.12);background:rgba(255,255,255,0.05);color:var(--text-muted);font-family:'Exo 2',sans-serif;font-size:0.8rem;cursor:pointer">â€¹</button>`:''}
                ${pg<totalSesP-1?`<button onclick="window._renderSesHistorial(${pg+1})" style="padding:5px 12px;border-radius:8px;border:1px solid rgba(0,200,255,0.3);background:rgba(0,200,255,0.1);color:var(--primary);font-family:'Exo 2',sans-serif;font-size:0.8rem;cursor:pointer">â€º</button>`:''}
              </div>
            </div>` : '');
        };
        window._renderSesHistorial = (pg) => {
          const el = document.getElementById('sesHistorialWrap');
          if(el) el.innerHTML = renderSesPage(pg);
        };
        return sesiones.length===0 ? '<div style="text-align:center;padding:20px;color:var(--text-muted)">Sin sesiones aÃºn</div>' : renderSesPage(0);
      })()}
      </div>
    </div>
  `;

  setTimeout(()=>{
    const makeGrad = (ctx, c1, c2) => {
      const g = ctx.createLinearGradient(0,0,0,180);
      g.addColorStop(0,c1); g.addColorStop(1,c2); return g;
    };

    if(wkLabels.length > 0) {
      const cc = document.getElementById('chartCansancio');
      if(cc) new Chart(cc,{type:'line',data:{labels:wkLabels,datasets:[{label:'Cansancio',data:avgCansancio,borderColor:'#ff6b35',backgroundColor:(ctx)=>makeGrad(ctx.chart.ctx,'rgba(255,107,53,0.3)','rgba(255,107,53,0)'),tension:0.4,fill:true,pointBackgroundColor:'#ff6b35',pointRadius:4}]},options:chartOpts});
      const cv = document.getElementById('chartVolumen');
      if(cv) new Chart(cv,{type:'bar',data:{labels:wkLabels,datasets:[{label:'Series',data:totalSeries,backgroundColor:'rgba(0,200,255,0.25)',borderColor:'var(--primary)',borderWidth:2,borderRadius:6}]},options:chartOpts});
    }

    if(valoraciones.length >= 2) {
      const compOpts = {
        ...chartOpts,
        plugins:{legend:{display:true,labels:{color:'rgba(232,244,255,0.7)',font:{size:10},boxWidth:12}}}
      };
      const chartC = document.getElementById('chartComposicion');
      if(chartC) new Chart(chartC,{type:'line',data:{labels:valLabels,datasets:[
        {label:'% Grasa',data:valoraciones.map(v=>v.grasa),borderColor:'#ff6b35',backgroundColor:'rgba(255,107,53,0)',tension:0.4,pointBackgroundColor:'#ff6b35',pointRadius:5},
        {label:'% MÃºsculo',data:valoraciones.map(v=>v.muscular),borderColor:'#00e5a0',backgroundColor:'rgba(0,229,160,0)',tension:0.4,pointBackgroundColor:'#00e5a0',pointRadius:5}
      ]},options:compOpts});

      const chartP = document.getElementById('chartPesoTrend');
      if(chartP) new Chart(chartP,{type:'line',data:{labels:valLabels,datasets:[{
        label:'Peso (kg)',data:valoraciones.map(v=>v.peso),
        borderColor:'#00c8ff',
        backgroundColor:(ctx)=>{ const g=ctx.chart.ctx.createLinearGradient(0,0,0,130); g.addColorStop(0,'rgba(0,200,255,0.25)'); g.addColorStop(1,'rgba(0,200,255,0)'); return g; },
        tension:0.4,fill:true,pointBackgroundColor:'#00c8ff',pointRadius:5
      }]},options:chartOpts});
    }
  },120);
}

// ============ PERFIL ============
async function renderPerfil() {
  const anaSnap = await get(ref(db,`anamnesis/${currentUser.id}`));
  const ana = anaSnap.val()||{};
  const r = ana.respuestas||{};
  let selectedAvatarUser = currentUser.avatar || AVATAR_LIST[0];

  const QLABELS = ['Edad','Peso','Talla','Objetivo','Lesiones/condiciones','Nivel actividad','DÃ­as entrenamiento','Experiencia','Deporte adicional','Horario','Suplementos','Horas sueÃ±o','Restricciones alimentarias','Nivel estrÃ©s','Meta 3 meses'];

  // Cargar con src directo â€” SVGs DiceBear son ~3KB cada uno, no fotos pesadas
  const avatarGridHtml = AVATAR_LIST.map((url,i) => {
    const isSelected = selectedAvatarUser === url;
    return `<div class="av-opt ${isSelected?'selected':''}" onclick="pickAvatar('${url}',this)">
      <img src="${url}" loading="lazy" decoding="async"
        style="width:100%;height:100%;border-radius:50%;opacity:0;transition:opacity 0.2s"
        onload="this.style.opacity='1'"
        onerror="this.closest('.av-opt').style.display='none'">
    </div>`;
  }).join('');

  document.getElementById('mainPage').innerHTML = `
    <div class="glass-card">
      <div style="display:flex;align-items:center;gap:16px;margin-bottom:20px">
        <div style="position:relative;flex-shrink:0">
          <img id="perfilAvatar" src="${currentUser.avatar||getAvatarUrl(currentUser.usuario)}"
            style="width:80px;height:80px;border-radius:50%;border:3px solid var(--primary);box-shadow:0 0 20px rgba(0,200,255,0.3);cursor:pointer"
            onclick="toggleAvatarPicker()"
            title="Toca para cambiar avatar">
          <div style="position:absolute;bottom:0;right:0;width:24px;height:24px;background:var(--primary);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:0.7rem;cursor:pointer;box-shadow:0 2px 8px rgba(0,0,0,0.4)"
            onclick="toggleAvatarPicker()">âœï¸</div>
        </div>
        <div>
          <div style="font-size:1.2rem;font-weight:800">${currentUser.nombres} ${currentUser.apellidos||''}</div>
          <div style="font-size:0.8rem;color:var(--text-muted)">@${currentUser.usuario}</div>
          <span style="background:rgba(0,200,255,0.1);border:1px solid rgba(0,200,255,0.3);border-radius:20px;padding:3px 10px;font-size:0.72rem;color:var(--primary)">${currentUser.metodo}</span>
        </div>
      </div>
      <div style="display:flex;gap:8px;font-size:0.82rem">
        <div style="flex:1;background:rgba(0,229,160,0.08);border-radius:10px;padding:10px;border:1px solid rgba(0,229,160,0.15)">
          <div style="color:var(--success)">âœ… VÃ¡lido hasta</div>
          <div style="font-weight:700">${currentUser.validoHasta||'â€”'}</div>
        </div>
        <div style="flex:1;background:rgba(0,200,255,0.08);border-radius:10px;padding:10px;border:1px solid rgba(0,200,255,0.15)">
          <div style="color:var(--primary)">ğŸ“Š MÃ©todo</div>
          <div style="font-weight:700">${currentUser.metodo}</div>
        </div>
      </div>
    </div>

    <!-- Avatar picker FUERA del glass-card para tener ancho completo -->
    <div id="avatarPickerWrap" style="display:none;background:rgba(0,0,0,0.35);border-radius:16px;padding:16px;border:1px solid var(--glass-border);margin-bottom:16px">
      <div style="font-size:0.82rem;color:var(--text-muted);margin-bottom:12px;text-align:center;font-weight:600;letter-spacing:0.5px;text-transform:uppercase">Elige tu avatar</div>
      <div class="avatar-grid-user" id="avatarGrid">${avatarGridHtml}</div>
      <div style="display:flex;gap:8px;margin-top:14px;justify-content:flex-end">
        <button class="btn btn-secondary btn-sm" onclick="toggleAvatarPicker(false)">Cancelar</button>
        <button class="btn btn-primary btn-sm" onclick="saveAvatar()">ğŸ’¾ Guardar avatar</button>
      </div>
    </div>
    
    <div class="glass-card">
      <div class="card-title">ğŸ“‹ Mi Anamnesis</div>
      ${ana.completada?`
        <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(150px,1fr));gap:10px">
          ${QLABELS.map((lbl,i)=>`
            <div style="background:rgba(0,0,0,0.2);border-radius:10px;padding:10px;border:1px solid var(--glass-border)">
              <div style="font-size:0.68rem;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:4px">${lbl}</div>
              <div style="font-size:0.88rem;font-weight:600">${r[`p${i}`]||'â€”'}</div>
            </div>
          `).join('')}
        </div>
      `:`<div style="text-align:center;padding:20px;color:var(--text-muted)">Sin anamnesis completada</div>`}
    </div>
    <div style="text-align:center;padding:10px">
      <button class="btn btn-danger btn-sm" onclick="logout()">ğŸšª Cerrar SesiÃ³n</button>
    </div>
  `;

  // Funciones del picker â€” en scope de renderPerfil para capturar selectedAvatarUser
  window.toggleAvatarPicker = (forceState) => {
    const wrap = document.getElementById('avatarPickerWrap');
    if(!wrap) return;
    const isOpen = wrap.style.display !== 'none';
    const opening = forceState !== false ? !isOpen : false;
    wrap.style.display = opening ? 'block' : 'none';
    if(opening) wrap.scrollIntoView({ behavior:'smooth', block:'nearest' });
  };

  window.pickAvatar = (url, el) => {
    selectedAvatarUser = url;
    document.querySelectorAll('.av-opt').forEach(a => a.classList.remove('selected'));
    el.classList.add('selected');
    document.getElementById('perfilAvatar').src = url;
  };

  window.saveAvatar = async () => {
    try {
      await set(ref(db, `usuarios/${currentUser.id}/avatar`), selectedAvatarUser);
      // Actualizar sesiÃ³n local
      currentUser.avatar = selectedAvatarUser;
      sessionStorage.setItem('saykyo_user', JSON.stringify(currentUser));
      // Actualizar header
      document.getElementById('userAvatar').src = selectedAvatarUser;
      document.getElementById('avatarPickerWrap').style.display = 'none';
      Swal.fire({icon:'success',title:'Â¡Avatar actualizado!',timer:1500,showConfirmButton:false,
        background:'rgba(10,20,40,0.95)',color:'#e8f4ff'});
    } catch(e) {
      Swal.fire({icon:'error',title:'Error',text:e.message,background:'rgba(10,20,40,0.95)',color:'#e8f4ff',confirmButtonColor:'#ff4d6d'});
    }
  };
}

// â”€â”€ WATCHER DE SESIÃ“N EN TIEMPO REAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Abre un listener onValue sobre el nodo del usuario en Realtime DB.
// Si el admin desactiva la cuenta o vence la membresÃ­a con la sesiÃ³n abierta,
// detecta el cambio al instante y fuerza el cierre de sesiÃ³n.
//
// Por quÃ© es necesario: Firebase Auth NO revoca tokens automÃ¡ticamente cuando
// un campo de la base de datos cambia, por lo que onAuthStateChanged no dispara.
// Este watcher cubre ese hueco escuchando directamente el nodo del usuario.

let _swRef      = null;
let _swListener = null;
let _swBooted   = false; // ignora el primer disparo (estado inicial al conectar)

function parseEndOfLocalDay(str) {
  if (!str) return null;
  if (str.includes('T')) return new Date(str);
  const [y, m, d] = str.split('-').map(Number);
  // 23:59:59 local â€” el usuario tiene acceso todo el dÃ­a de vencimiento
  return new Date(y, m - 1, d, 23, 59, 59, 999);
}

let _membershipCheckInterval = null;

async function checkMembershipExpiry() {
  // Lee el nodo actual del usuario desde Firebase (no cachÃ©)
  try {
    const snap = await get(ref(db, `usuarios/${currentUser.id}`));
    if (!snap.exists()) return;
    const data = snap.val();
    let titulo = null, mensaje = null;
    if (data.activo === false) {
      titulo  = 'Cuenta desactivada';
      mensaje = 'Tu acceso fue desactivado. ComunÃ­cate con tu entrenador para mÃ¡s informaciÃ³n.';
    }
    if (!titulo && data.validoHasta) {
      const expiry = parseEndOfLocalDay(data.validoHasta);
      if (expiry && new Date() > expiry) {
        titulo  = 'MembresÃ­a vencida';
        mensaje = `Tu suscripciÃ³n venciÃ³ el ${expiry.toLocaleDateString('es-CO', { day:'2-digit', month:'long', year:'numeric' })}. Renueva con tu entrenador para continuar.`;
      }
    }
    if (titulo) {
      clearInterval(_membershipCheckInterval);
      if (_swRef) off(_swRef, 'value', _swListener);
      await Swal.fire({
        icon: 'warning', title: titulo, text: mensaje,
        background: 'rgba(10,20,40,0.97)', color: '#e8f4ff',
        confirmButtonColor: '#ff4d6d', confirmButtonText: 'Entendido',
        allowOutsideClick: false, allowEscapeKey: false
      });
      sessionStorage.removeItem('saykyo_user');
      signOut(auth).finally(() => { window.location.href = 'index.html'; });
    }
  } catch(e) { console.warn('checkMembershipExpiry error', e); }
}

function setupSessionWatcher(uid) {
  if (_swRef) off(_swRef, 'value', _swListener);
  _swRef    = ref(db, `usuarios/${uid}`);
  _swBooted = false;

  // â±ï¸ Verificar membresÃ­a cada 60s para detectar vencimiento automÃ¡tico (sin cambio en DB)
  if (_membershipCheckInterval) clearInterval(_membershipCheckInterval);
  _membershipCheckInterval = setInterval(checkMembershipExpiry, 60_000);

  _swListener = onValue(_swRef, async (snap) => {
    // Primer disparo = estado actual al registrar el listener, no un cambio real
    if (!_swBooted) { _swBooted = true; return; }
    if (!snap.exists()) return;

    const data = snap.val();
    let titulo  = null;
    let mensaje = null;

    // 1. Cuenta desactivada por el admin
    if (data.activo === false) {
      titulo  = 'Cuenta desactivada';
      mensaje = 'Tu acceso fue desactivado. ComunÃ­cate con tu entrenador para mÃ¡s informaciÃ³n.';
    }

    // 2. MembresÃ­a vencida â€” compara fin del dÃ­a LOCAL para evitar falsos positivos en UTC-5
    if (!titulo && data.validoHasta) {
      const expiry = parseEndOfLocalDay(data.validoHasta);
      if (expiry && new Date() > expiry) {
        titulo  = 'MembresÃ­a vencida';
        mensaje = `Tu suscripciÃ³n venciÃ³ el ${expiry.toLocaleDateString('es-CO', { day:'2-digit', month:'long', year:'numeric' })}. Renueva con tu entrenador para continuar.`;
      }
    }

    if (titulo) {
      clearInterval(_membershipCheckInterval);
      off(_swRef, 'value', _swListener); // detener listener antes del logout
      await Swal.fire({
        icon: 'warning',
        title: titulo,
        text: mensaje,
        background: 'rgba(10,20,40,0.97)',
        color: '#e8f4ff',
        confirmButtonColor: '#ff4d6d',
        confirmButtonText: 'Entendido',
        allowOutsideClick: false,
        allowEscapeKey: false
      });
      sessionStorage.removeItem('saykyo_user');
      signOut(auth).finally(() => { window.location.href = 'index.html'; });
    }
  });
}
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

// Init â€” esperar sesiÃ³n Firebase antes de leer DB
onAuthStateChanged(auth, (user) => {
  if (!user) {
    sessionStorage.removeItem('saykyo_user');
    window.location.href = 'index.html';
    return;
  }
  if (!window._initDone) {
    window._initDone = true;
    setupUserNotifListener();
    setupSessionWatcher(user.uid); // ğŸ”’ expulsiÃ³n en tiempo real si admin cambia estado
    init();
  }
});
</script>

<a class="help-fab" id="helpFab" href="manual.html" title="Abrir manual">?</a>
<div class="help-fab-tooltip" id="helpFabTooltip">ğŸ“– Manual de uso</div>

<script>
(function(){
  const fab = document.getElementById('helpFab');
  const tip = document.getElementById('helpFabTooltip');
  const KEY = 'saykyo_fab_pos';

  function updateTooltip(){
    const r = fab.getBoundingClientRect();
    const tipW = 140;
    if(r.left > tipW + 10){
      tip.style.left = (r.left - tipW - 8)+'px';
    } else {
      tip.style.left = (r.right + 8)+'px';
    }
    tip.style.top = (r.top + r.height/2 - 16)+'px';
    tip.style.right = 'auto';
    tip.style.bottom = 'auto';
  }

  try {
    const saved = JSON.parse(localStorage.getItem(KEY));
    if(saved) {
      fab.style.left=saved.l; fab.style.top=saved.t;
      fab.style.right='auto'; fab.style.bottom='auto';
      setTimeout(updateTooltip,0);
    }
  } catch(e){}

  let dragging=false, ox=0, oy=0, moved=false;

  fab.addEventListener('mousedown', e=>{
    dragging=true; moved=false;
    const r=fab.getBoundingClientRect();
    ox=e.clientX-r.left; oy=e.clientY-r.top;
    fab.classList.add('dragging');
    e.preventDefault();
  });

  document.addEventListener('mousemove', e=>{
    if(!dragging) return;
    moved=true;
    const x=Math.min(Math.max(e.clientX-ox,0),window.innerWidth-48);
    const y=Math.min(Math.max(e.clientY-oy,0),window.innerHeight-48);
    fab.style.left=x+'px'; fab.style.top=y+'px';
    fab.style.right='auto'; fab.style.bottom='auto';
    updateTooltip();
  });

  document.addEventListener('mouseup', ()=>{
    if(!dragging) return;
    dragging=false;
    fab.classList.remove('dragging');
    if(moved) try{ localStorage.setItem(KEY, JSON.stringify({l:fab.style.left,t:fab.style.top})); }catch(e){}
  });

  fab.addEventListener('touchstart', e=>{
    const t=e.touches[0];
    dragging=true; moved=false;
    const r=fab.getBoundingClientRect();
    ox=t.clientX-r.left; oy=t.clientY-r.top;
    fab.classList.add('dragging');
  },{passive:true});

  document.addEventListener('touchmove', e=>{
    if(!dragging) return;
    moved=true;
    const t=e.touches[0];
    const x=Math.min(Math.max(t.clientX-ox,0),window.innerWidth-48);
    const y=Math.min(Math.max(t.clientY-oy,0),window.innerHeight-48);
    fab.style.left=x+'px'; fab.style.top=y+'px';
    fab.style.right='auto'; fab.style.bottom='auto';
    e.preventDefault();
  },{passive:false});

  document.addEventListener('touchend', ()=>{
    if(!dragging) return;
    dragging=false;
    fab.classList.remove('dragging');
    if(moved) try{ localStorage.setItem(KEY, JSON.stringify({l:fab.style.left,t:fab.style.top})); }catch(e){}
  });

  fab.addEventListener('click', e=>{ if(moved){ e.preventDefault(); moved=false; } });

  updateTooltip();
  window.addEventListener('resize', updateTooltip);
})();
</script>
</body>
</html>
